/**
 * @description 模块功能说明
 * @class ModuleName
 * @author yongjin<zjut_wyj@163.com> 2016/2/6
 */
define('BbaseJquery', [], function(require, exports, module){


/**
 * 工具类库.
 *
 * @description 修改urlParsingNode变量 on 14/7/29
 * @class BbaseEst - 工具类库
 * @constructor BbaseEst
 */
;
(function () {
  'use strict';
  var root = this;
  /**
   * @description 系统原型方法
   * @method [变量] - slice push toString hasOwnProperty concat
   * @private
   */
  var slice = Array.prototype.slice,
    push = Array.prototype.push,
    toString = Object.prototype.toString,
    hasOwnProperty = Object.prototype.hasOwnProperty,
    concat = Array.prototype.concat;
  /**
   * @description ECMAScript 5 原生方法
   * @method [变量] - nativeIsArray nativeKeys nativeBind
   * @private
   */
  var nativeIsArray = Array.isArray,
    nativeKeys = Object.keys,
    nativeBind = Object.prototype.bind;
  var whitespace = ' \n\r\t\f\x0b\xa0\u2000\u2001\u2002\u2003\n\
        \u2004\u2005\u2006\u2007\u2008\u2009\u200a\u200b\u2028\u2029\u3000';
  var uid = ['0', '0', '0'];
  var url = window.location.href;
  var urlParsingNode = null;
  /**
   * @description define
   * @method [变量] - moduleMap
   * @private
   */
  var moduleMap = {};
  var fileMap = {};
  var noop = function () {};
  /**
   * @description  定义数组和对象的缓存池
   * @method [变量] - maxPoolSize arrayPool objectPool
   * @private
   */
  var maxPoolSize = 40;
  var arrayPool = [],
    objectPool = [];
  /**
   * @method [变量] - cache
   * @private
   * 缓存对象 */
  var cache = {};
  /**
   * @method [变量] - routes
   * @private
   * url 路由 */
  var routes = {};
  var el = null,
    current = null;

  /**
   * @description 创建BbaseEst对象
   * @method [对象] - BbaseEst
   * @private
   */
  var BbaseEst = root.BbaseEst || function (value) {
    return (value && typeof value == 'object' &&
        typeOf(value) !== 'array' && hasOwnProperty.call(value, '_wrapped')) ? value :
      new Wrapper(value);
  };

  /**
   * 调试
   *
   * @method [调试] - debug (打印错误信息)
   * @param str
   * @param options
   * @author wyj 14.12.24
   * @example
   *       debug('test');
   *       debug('test', {
   *         type: 'error' // 打印红色字体
   *       });
   *       debug(function(){
   *         return 'test';
   *       });
   */
  function debug(str, options) {
    var opts, msg;
    if (typeof CONST !== 'undefined' && CONST.DEBUG_CONSOLE) {
      try {
        opts = extend({ type: 'console' }, options);
        msg = typeOf(str) === 'function' ? str() : str;
        if (!isEmpty(msg)) {
          if (opts.type === 'error') {
            console.error(msg);
          } else if (opts.type === 'alert') {
            alert(msg);
          } else {
            console.log(msg);
          }
          if (options && options.e) {
            console.log(options.e);
          }
        }
      } catch (e) {}
    }
  }

  window.debug = BbaseEst.debug = debug;

  function Wrapper(value, chainAll) {
    this._chain = !!chainAll;
    this._wrapped = value;
  }

  /**
   * @description 用于node.js 导出
   * @method [模块] - exports
   * @private
   */
  /* if (typeof exports !== 'undefined' && exports.cmd) {
     if (typeof module !== 'undefined' && module.exports) {
       exports = module.exports = BbaseEst;
     }
     exports.BbaseEst = BbaseEst;
   } else {*/
  root.BbaseEst = BbaseEst;
  //}

  function identity(value) {
    return value;
  }

  BbaseEst.identity = identity;
  BbaseEst.v = '0605041705'; // 机汇网
  //BbaseEst.v = '00111114'; // 上门网
  var matchCallback = function (value, context, argCount) {
    if (value == null) return identity;
    if (isFunction(value)) return createCallback(value, context, argCount);
    if (typeOf(value) === 'object') return matches(value);
    if (typeOf(value) === 'array') return value;
    return property(value);
  };
  var createCallback = function (func, context, argCount) {
    if (!context) return func;
    switch (argCount == null ? 3 : argCount) {
      case 1:
        return function (value) {
          return func.call(context, value);
        };
      case 2:
        return function (value, other) {
          return func.call(context, value, other);
        };
      case 3:
        return function (value, index, collection) {
          return func.call(context, value, index, collection);
        };
      case 4:
        return function (accumulator, value, index, collection) {
          return func.call(context, accumulator, value, index, collection);
        };
    }
    return function () {
      return func.apply(this, arguments);
    };
  };

  /**
   * @description 遍历数据或对象。如果传递了context参数，则把callback绑定到context对象上。
   * 如果list是数组，callback的参数是：(element, index, list, first, last)。
   * 如果list是个JavaScript对象，callback的参数是 (value, key, list, index, first, last))。返回list以方便链式调用。
   * 如果callback 返回false,则中止遍历
   * @method [数组] - each ( 遍历数据或对象 )
   * @param {Array/Object} obj 遍历对象
   * @param {Function} callback 回调函数
   * @param {Object} context 上下文
   * @return {Object}
   * @example
   *     BbaseEst.each([1, 2, 3], function(item, index, list, isFirst, isLast){
   *        alert(item);
   *     });
   *     ==> alerts each number in turn...
   *
   *     BbaseEst.each({one: 1, two: 2, three: 3}, function(value, key, object, index, isFirst, isLast){
   *        alert(value);
   *     });
   *     ==> alerts each number value in turn...
   */
  function each(obj, callback, context) {
    var i, length, first = false,
      last = false;
    if (obj == null) return obj;
    callback = createCallback(callback, context);
    if (obj.length === +obj.length) {
      for (i = 0, length = obj.length; i < length; i++) {
        first = i === 0 ? true : false;
        last = i === length - 1 ? true : false;
        if (callback(obj[i], i, obj, first, last) === false) break;
      }
    } else {
      var ks = keys(obj);
      for (i = 0, length = ks.length; i < length; i++) {
        first = i === 0 ? true : false;
        last = i === ks.length - 1 ? true : false;
        if (callback(obj[ks[i]], ks[i], obj, i, first, last) === false) break;
      }
    }
    return obj;
  }

  BbaseEst.each = BbaseEst.forEach = each;
  /**
   * @description 复制source对象中的所有属性覆盖到destination对象上，并且返回 destination 对象.
   * 复制是按顺序的, 所以后面的对象属性会把前面的对象属性覆盖掉(如果有重复).
   * @method [对象] - extend ( 继承 )
   * @param {Object} obj destination对象
   * @return {Object} 返回 destination 对象
   * @author wyj on 14/5/22
   * @example
   *      BbaseEst.extend({name: 'moe'}, {age: 50});
   *      ==> {name: 'moe', age: 50}
   */
  function extend(obj) {
    var h = obj.$$hashKey;
    if (typeOf(obj) !== 'object') return obj;
    each(slice.call(arguments, 1), function (source) {
      for (var prop in source) {
        obj[prop] = source[prop];
      }
    });
    setHashKey(obj, h);
    return obj;
  };
  BbaseEst.extend = extend;

  /**
   * @description 如果object是一个参数对象，返回true
   * @method [对象] - isFunction ( 判断是否是对象 )
   * @param {*} obj 待检测参数
   * @return {boolean}
   * @author wyj on 14/5/22
   * @example
   *      BbaseEst.isFunction(alert);
   *      ==> true
   */
  function isFunction(obj) {
    return typeof obj === 'function';
  };

  if (typeof /./ !== 'function') {
    BbaseEst.isFunction = isFunction;
  }
  /**
   * @description 返回一个对象里所有的方法名, 而且是已经排序的 — 也就是说, 对象里每个方法(属性值是一个函数)的名称.
   * @method [对象] - functions ( 返回一个对象里所有的方法名 )
   * @param {Object} obj 检测对象
   * @return {Array} 返回包含方法数组
   * @author wyj on 14/5/22
   * @example
   *      BbaseEst.functions(BbaseEst);
   *      ==> ["trim", "remove", "fromCharCode", "cloneDeep", "clone", "nextUid", "hash" ...
   */
  function functions(obj) {
    var names = [];
    for (var key in obj) {
      if (isFunction(obj[key])) names.push(key);
    }
    return names.sort();
  };
  BbaseEst.functions = BbaseEst.methods = functions;
  /**
   * 解码ASCII码
   * @method [字符串] - fromCharCode ( 解码ASCII码 )
   * @param code
   * @return {string}
   * @author wyj 15.2.9
   * @example
   *       BbaseEst.fromCharCode(97);
   *       ==> a
   */
  function fromCharCode(code) {
    try {
      return String.fromCharCode(code);
    } catch (e) {}
  };
  BbaseEst.fromCharCode = fromCharCode;
  /**
   * @description 返回一个封装的对象. 在封装的对象上调用方法会返回封装的对象本身, 直道 value 方法调用为止.
   * @method [对象] - chain ( 返回一个封装的对象 )
   * @param value
   * @return {*}
   * @author wyj on 14/5/22
   * @example
   *      var stooges = [{name: 'curly', age: 25}, {name: 'moe', age: 21}, {name: 'larry', age: 23}];
   *      var youngest = BbaseEst.chain(stooges)
   *          .sortBy(function(stooge){ return stooge.age; })
   *          .map(function(stooge){ return stooge.name + ' is ' + stooge.age; })
   *          .first()
   *          .value();
   *      ==> "moe is 21"
   */
  BbaseEst.chain = function (value) {
    value = new Wrapper(value);
    value._chain = true;
    return value;
  };

  /**
   * 获取方法或对象的值
   * @method [对象] - result ( 返回结果 )
   * @param  {*} object   [description]
   * @param  {string} property [description]
   * @return {*}          [description]
   * @example
   *       var object = {cheese: 'crumpets', stuff: function(){ return 'nonsense'; }};
   *       BbaseEst.result(object, 'cheese');
   *       ==> "crumpets"
   *
   *       BbaseEst.result(object, 'stuff');
   *       ==> "nonsense"
   */
  function result(object, property) {
    if (object == null) return void 0;
    var value = getValue.call(object, object, property);
    return typeOf(value) === 'function' ? value.call(object) : value;
  };
  BbaseEst.result = result;

  /**
   * 获取默认值
   * @method [对象] - defaults ( 默认值 )
   * @param  {object} obj [description]
   * @return {object}     [description]
   * @example
   *      BbaseEst.defaults({ 'user': 'barney' }, { 'age': 36 }, { 'user': 'fred' });
   *      ==> { 'user': 'barney', 'age': 36 }
   */
  function defaults(obj) {
    if (!typeOf(obj) === 'object') return obj;
    each(slice.call(arguments, 1), function (source) {
      for (var prop in source) {
        if (obj[prop] === void 0) obj[prop] = source[prop];
      }
    });
    return obj;
  };
  BbaseEst.defaults = defaults;

  /**
   * 函数调用
   * @method [object] - invoke
   * @param  {*} obj    [description]
   * @param  {string} method [description]
   * @return {array}        [description]
   * @example
   *       var object = { 'a': [{ 'b': { 'c': [1, 2, 3, 4] } }] };
   *       BbaseEst.invoke(object, 'a[0].b.c.slice', 1, 3);
   *       ==> [2, 3]
   */
  function invoke(obj, method) {
    var args = slice.call(arguments, 2);
    var isFunc = typeOf(method) === 'function';
    return map(obj, function (value) {
      return (isFunc ? method : value[method]).apply(value, args);
    });
  };
  BbaseEst.invoke = invoke;

  /**
   * 原型判断
   * @method [对象] - has ( 原型判断 )
   * @param  {object}  obj [description]
   * @param  {string}  key [description]
   * @return {Boolean}     [description]
   */
  function has(obj, key) {
    return obj != null && hasOwnProperty.call(obj, key);
  };
  BbaseEst.has = has;


  /**
   * 只执行一次
   * @method [对象] - once ( 只执行一次 )
   * @param  {fn} func [description]
   * @return {fn}      [description]
   * @example
   *       BbaseEst.once(function(){
   *
   *       });
   */
  function once(func) {
    var ran = false,
      memo;
    return function () {
      if (ran) return memo;
      ran = true;
      memo = func.apply(this, arguments);
      func = null;
      return memo;
    };
  };
  BbaseEst.once = once;


  function any(obj, callback, context) {
    var result = false;
    if (obj == null) return result;
    callback = matchCallback(callback, context);
    each(obj, function (value, index, list) {
      result = callback(value, index, list);
      if (result) return true;
    });
    return !!result;
  };
  BbaseEst.any = any;

  /**
   * 代理所有
   * @method [模式] - bindAll
   * @param  {[type]} obj [description]
   * @return {[type]}     [description]
   */
  function bindAll(obj) {
    var funcs = slice.call(arguments, 1);
    if (funcs.length === 0) throw Error('err31');
    each(funcs, function (f) {
      obj[f] = proxy(obj[f], obj);
    });
    return obj;
  };
  BbaseEst.bindAll = bindAll;

  /**
   * 判断2个对象是否相同
   * @method [对象] - equal ( 判断是否相同 )
   * @param  {*} a      [description]
   * @param  {*} b      [description]
   * @param  {array} aStack [description]
   * @param  {array} bStack [description]
   * @return {boolean}        [description]
   * @example
   *       BbaseEst.equal({name: 'aaa', age: 33}, {name: 'aaa', age: 33});
   *       ==> true
   *
   *       BbaseEst.equal(0, -0);
   *       ==> false
   *
   *       BbaseEst.equal(null, undefined);
   *       ==> false
   *
   *       BbaseEst.equal(null, null);
   *       ==> true
   *
   *       BbaseEst.equal(undefined, undefined);
   *       ==> true
   *
   *       BbaseEst.equal(false, false);
   *       ==> true
   *
   *       BbaseEst.equal(true, true);
   *       ==> true
   */
  function equal(a, b, aStack, bStack) {
    aStack = aStack || [];
    bStack = bStack || [];
    // Identical objects are equal. `0 === -0`, but they aren't identical.
    // See the [Harmony `egal` proposal](http://wiki.ecmascript.org/doku.php?id=harmony:egal).
    if (a === b) return a !== 0 || 1 / a === 1 / b;
    // A strict comparison is necessary because `null == undefined`.
    if (a == null || b == null) return a === b;
    // Unwrap any wrapped objects.
    if (a instanceof BbaseEst) a = a._wrapped;
    if (b instanceof BbaseEst) b = b._wrapped;
    // Compare `[[Class]]` names.
    var className = toString.call(a);
    if (className !== toString.call(b)) return false;
    switch (className) {
      // RegExps are coerced to strings for comparison.
      case '[object RegExp]':
        // Strings, numbers, dates, and booleans are compared by value.
      case '[object String]':
        // Primitives and their corresponding object wrappers are equivalent; thus, `"5"` is
        // equivalent to `String("5")`.
        return '' + a === '' + b;
      case '[object Number]':
        // `NaN`s are equivalent, but non-reflexive.
        if (a != +a) return b != +b;
        // An `egal` comparison is performed for other numeric values.
        return a == 0 ? 1 / a == 1 / b : a == +b;
      case '[object Date]':
      case '[object Boolean]':
        // Coerce dates and booleans to numeric primitive values. Dates are compared by their
        // millisecond representations. Note that invalid dates with millisecond representations
        // of `NaN` are not equivalent.
        return +a === +b;
    }
    if (typeof a != 'object' || typeof b != 'object') return false;
    // Assume equality for cyclic structures. The algorithm for detecting cyclic
    // structures is adapted from ES 5.1 section 15.12.3, abstract operation `JO`.
    var length = aStack.length;
    while (length--) {
      // Linear search. Performance is inversely proportional to the number of
      // unique nested structures.
      if (aStack[length] === a) return bStack[length] === b;
    }
    // Objects with different constructors are not equivalent, but `Object`s
    // from different frames are.
    var aCtor = a.constructor,
      bCtor = b.constructor;
    if (
      aCtor !== bCtor && 'constructor' in a && 'constructor' in b &&
      !(typeOf(aCtor) === 'function' && aCtor instanceof aCtor &&
        typeOf(bCtor) === 'function' && bCtor instanceof bCtor)
    ) {
      return false;
    }
    // Add the first object to the stack of traversed objects.
    aStack.push(a);
    bStack.push(b);
    var size = 0,
      result = true;
    // Recursively compare objects and arrays.
    if (className === '[object Array]') {
      // Compare array lengths to determine if a deep comparison is necessary.
      size = a.length;
      result = size === b.length;
      if (result) {
        // Deep compare the contents, ignoring non-numeric properties.
        while (size--) {
          if (!(result = equal(a[size], b[size], aStack, bStack))) break;
        }
      }
    } else {
      // Deep compare objects.
      for (var key in a) {
        if (has(a, key)) {
          // Count the expected number of properties.
          size++;
          // Deep compare each member.
          if (!(result = has(b, key) && equal(a[key], b[key], aStack, bStack))) break;
        }
      }
      // Ensure that both objects contain the same number of properties.
      if (result) {
        for (key in b) {
          if (has(b, key) && !size--) break;
        }
        result = !size;
      }
    }
    // Remove the first object from the stack of traversed objects.
    aStack.pop();
    bStack.pop();
    return result;
  };
  BbaseEst.equal = equal;


  /**
   * @description 如果对象 object 中的属性 property 是函数, 则调用它, 否则, 返回它。
   * @method [对象] - result ( 返回结果 )
   * @param obj
   * @return {*}
   * @private
   * @author wyj on 14/5/22
   */
  var result = function (obj, context) {
    //var ctx = typeOf(context) !== 'undefined' ? context : BbaseEst;
    return this._chain ? new Wrapper(obj, true) : obj;
  };
  // ObjectUtils
  /**
   * @description [1]检测数据类型 [undefined][number][string][function][regexp][array][date][error]
   * @method [对象] - typeOf ( 检测数据类型 )
   * @param {*} target 检测对象
   * @return {*|string}
   * @author wyj on 14/5/24
   * @example
   *      BbaseEst.typeOf(BbaseEst);
   *      ==> 'object'
   */
  var _type = {
    "undefined": "undefined",
    "number": "number",
    "boolean": "boolean",
    "string": "string",
    "[object Function]": "function",
    "[object RegExp]": "regexp",
    "[object Array]": "array",
    "[object Date]": "date",
    "[object Error]": "error",
    "[object File]": "file",
    "[object Blob]": "blob"
  };

  function typeOf(target) {
    return _type[typeof target] || _type[toString.call(target)] || (target ? "object" : "null");
  }

  BbaseEst.typeOf = typeOf;

  /**
   * @description 根据字段获取值
   * @method [对象] - getValue ( 根据字段获取值 )
   * @param object
   * @param path
   * @return {*}
   * @author wyj 14.12.4
   * @example
   *    var object = {item: {name: join}};
   *    BbaseEst.getValue(object, 'item.name');
   *    ==> "join"
   */
  function getValue(object, path) {
    if (isEmpty(object)) return null;
    var array, result;
    if (arguments.length < 2 || typeOf(path) !== 'string') {
      console.error('err30');
      return;
    }
    array = path.split('.');

    function get(object, array) {
      if (isEmpty(object)) return null;
      each(array, function (key) {
        if (typeOf(object) === 'string') {
          return false;
        }
        if (key in object) {
          if (array.length === 1) {
            // 如果为数组最后一个元素， 则返回值
            result = object[key];
          } else {
            // 否则去除数组第一个， 递归调用get方法
            array.shift();
            get(object[key], array);
            // 同样跳出循环
            return false;
          }
        } else {
          // 没找到直接跳出循环
          return false;
        }
      });
      return result;
    }

    return get(object, array);
    /*var array = [];
     var temp = cloneDeep(object);
     if (typeOf(path) === 'string'){
     array = path.split('.');
     each(array, function(key){
     temp = temp[key];
     });
     } else if (typeOf(path) === 'function'){
     path.call(this, object);
     }
     return temp;*/
  }

  BbaseEst.getValue = getValue;

  /**
   * @description 设置对象值
   *
   * @method [对象] - setValue ( 设置对象值 )
   * @param object
   * @param path
   * @param value
   * @return {boolean}
   * @author wyj 14.12.4
   * @example
   *    var object = {};
   *    BbaseEst.setValue(object, 'item.name', 'bbb');
   *    ==> {item: {name: 'bbb'}};
   */
  function setValue(object, path, value) {
    if (arguments.length < 3 || typeOf(path) !== 'string') return false;
    var array = path.split('.');
    if (!object) {
      console.log('setValue ==> object can not be null!!');
      object = {};
    }

    function set(object, array, value) {
      each(array, function (key) {
        if (!(key in object)) object[key] = {};
        if (array.length === 1) {
          object[key] = value;
        } else {
          array.shift();
          if (!object[key]) object[key] = {};
          set(object[key], array, value);
          return false;
        }
      });
    }
    set(object, array, value);
  }

  BbaseEst.setValue = setValue;


  /**
   * @description 判断是否为空 (空数组， 空对象， 空字符串， 空方法， 空参数, null, undefined) 不包括数字0和1 【注】苹果手机有问题
   * @method [对象] - isEmpty ( 判断是否为空 )
   * @param {Object} value
   * @return {boolean}
   * @author wyj on 14/6/26
   * @example
   *      BbaseEst.isEmpty(value);
   *      ==> false
   */
  function isEmpty(value) {
    var result = true;
    if (typeOf(value) === 'number') return false;
    if (!value) return result;
    var className = toString.call(value),
      length = value.length;
    if ((className == '[object Array]' || className == '[object String]' || className == '[object Arguments]') ||
      (className == '[object Object]' && typeof length == 'number' && isFunction(value.splice))) {
      return !length;
    }
    each(value, function () {
      return (result = false);
    });
    return result;
  }

  BbaseEst.isEmpty = isEmpty;

  function isBlank(value) {
    if (isEmpty(value)) {
      return true;
    }
    if (value === '' || value === 'null' || value === 'undefined') {
      return true;
    }
    return false;
  }
  BbaseEst.isBlank = isBlank;

  /**
   * @description [2]判断对象是否含有某个键 不是原型对象
   * @method [对象] - hasKey ( 判断对象是否含有某个键 )
   * @param {Object} obj 检测对象
   * @param {Sting} key 检测键
   * @return {boolean|*}
   * @author wyj on 14/5/25
   * @example
   *      var object6 = {name:1,sort:1};
   *      BbaseEst.hasKey(object6, 'name')
   *      ==> true
   */
  function hasKey(obj, key) {
    return obj != null && hasOwnProperty.call(obj, key);
  }

  BbaseEst.hasKey = hasKey;
  /**
   * @description 计算hash值
   * @method [对象] - hashKey ( 计算hash值 )
   * @param obj
   * @return {string}
   * @author wyj on 14/6/25
   * @example
   *      BbaseEst.hashKey(obj);
   *      ==> 'object:001'
   */
  function hashKey(obj) {
    var objType = typeof obj,
      key;
    if (objType == 'object' && obj !== null) {
      if (typeof (key = obj.$$hashKey) == 'function') {
        key = obj.$$hashKey();
      } else if (key === undefined) {
        key = obj.$$hashKey = nextUid();
      }
    } else {
      key = obj;
    }
    return objType + ':' + key;
  }

  BbaseEst.hashKey = hashKey;
  /**
   * 字符串转换成hash值
   * @method [字符串] - hash ( 字符串转换成hash值 )
   * @param str
   * @return {number}
   * @author wyh 15.2.28
   * @example
   *        BbaseEst.hash('aaaaa');
   */
  function hash(str) {

    try {
      if (!str) {
        return null;
      }
      var hash = 5381,
        i = str.length;
      while (i)
        hash = (hash * 33) ^ str.charCodeAt(--i);
      return hash >>> 0;
    } catch (e) {
      debug('err34 -> ' + e);
    }
  }

  BbaseEst.hash = hash;
  /**
   * @description 设置hashKey
   * @method [对象] - setHashKey ( 设置hashKey )
   * @param {Object} obj
   * @param {String} h
   */
  function setHashKey(obj, h) {
    if (h) {
      obj.$$hashKey = h;
    } else {
      delete obj.$$hashKey;
    }
  }

  BbaseEst.setHashKey = setHashKey;

  /**
   * @description [3]过滤对象字段
   * @method [对象] - pick ( 过滤对象字段 )
   * @param {Object} obj 过滤对象
   * @param {Function} callback 回调函数
   * @param context
   * @return {{}}
   * @author wyj on 14/5/26
   * @example
   *      var object3 = {name:'a', sort: '1', sId: '000002'};
   *      BbaseEst.pick(object3, ['name','sort'])
   *      ==> {"name":"a","sort":"1"}
   */
  function pick(obj, callback, context) {
    var result = {},
      key;
    if (typeOf(callback) === 'function') {
      for (key in obj) {
        var value = obj[key];
        if (callback.call(context, value, key, obj)) result[key] = value;
      }
    } else {
      var keys = concat.apply([], slice.call(arguments, 1));
      each(keys, function (key) {
        if (key in obj) result[key] = obj[key];
      });
    }
    return result;
  }

  BbaseEst.pick = pick;
  /**
   * @description 返回获取对象属性值的方法
   * @method [对象] - property ( 返回获取对象属性值 )
   * @param {Object} key
   * @return {Function}
   */
  function property(key) {
    return function (object) {
      if (typeOf(object) === 'string') return null;
      return getValue(object, key);
    };
  }

  BbaseEst.property = property;
  /**
   * @description 翠取对象中key对应的值
   * @method [对象] - pluck ( 翠取对象中key对应的值 )
   * @param obj
   * @param key
   * @return {*}
   * @author wyj on 14/7/5
   * @example
   *      var characters = [ { 'name': 'barney', 'age': 36 }, { 'name': 'fred',   'age': 40 } ];
   *      var result = BbaseEst.pluck(characters, 'name');
   *      ==> [ "barney", "fred" ]
   */
  function pluck(obj, key) {
    return map(obj, property(key), null);
  }

  BbaseEst.pluck = pluck;
  /**
   * @description 释放数组， 若数组池个数少于最大值， 则压入数组池以备用
   * @method [数组] - releaseArray ( 释放数组 )
   * @author wyj on 14/7/1
   * @example
   *      BbaseEst.releaseArray(array);
   */
  function releaseArray(array) {
    array.length = 0;
    if (arrayPool.length < maxPoolSize) {
      arrayPool.push(array);
    }
  }

  BbaseEst.releaseArray = releaseArray;
  /**
   * @description 释放对象， 若对象池个数少于最大值， 则压入对象池以备用
   * @method [对象] - releaseObject ( 释放对象 )
   * @author wyj on 14/7/1
   * @example
   *      BbaseEst.releaseObject(object);
   */
  function releaseObject(object) {
    object.array = object.cache = object.criteria = object.object = object.number = object.string = object.value = null;
    if (objectPool.length < maxPoolSize) {
      objectPool.push(object);
    }
  }

  BbaseEst.releaseObject = releaseObject;
  /**
   * @description 获取数组池
   * @method [数组] - getArray ( 获取数组池 )
   * @return {Array}
   * @author wyj on 14/7/1
   * @example
   *      var array = BbaseEst.getArray();
   */
  function getArray() {
    return arrayPool.pop() || [];
  }

  BbaseEst.getArray = getArray;
  /**
   * @description 获取对象池 主要用于优化性能
   * @method [对象] - getObject ( 获取对象池 )
   * @return {Object}
   * @author wyj on 14/7/1
   * @example
   *      var object = BbaseEst.getObject();
   */
  function getObject() {
    return objectPool.pop() || { 'array': null, 'cache': null, 'criteria': null, 'false': false, 'index': 0, 'null': false, 'number': null, 'object': null, 'push': null, 'string': null, 'true': false, 'undefined': false, 'value': null };
  }

  BbaseEst.getObject = getObject;

  function baseClone(value, isDeep, callback, stackA, stackB) {
    //var type = getType(value);
    var result;
    var type = typeOf(value);
    if (callback) {
      result = callback(value);
      if (typeof result !== 'undefined') return result;
    }
    if (typeof value === 'object' && type !== 'null') {
      switch (type) {
        case 'function':
          return value;
          break;
        case 'date':
          return new Date(+value);
          break;
        case 'string':
          return new String(value);
          break;
        case 'regexp':
          result = RegExp(value.source, /\w*$/.exec(value));
          result.lastIndex = value.lastIndex;
          break;
      }
    } else {
      return value;
    }
    var isArr = type === 'array';
    if (isDeep) {
      var initedStack = !stackA;
      stackA || (stackA = getArray());
      stackB || (stackB = getArray());
      var length = stackA.length;
      while (length--) {
        if (stackA[length] === value) {
          return stackB[length];
        }
      }
      result = isArr ? Array(value.length) : {};
    } else {
      result = isArr ? arraySlice(value, 0, value.length) : extend({}, value);
    }
    if (isArr) {
      if (hasOwnProperty.call(value, 'index')) {
        result.index = value.index;
      }
      if (hasOwnProperty.call(value, 'input')) {
        result.input = value.input;
      }
    }
    if (!isDeep) {
      return result;
    }
    stackA.push(value);
    stackB.push(result);
    each(value, function (target, key) {
      result[key] = baseClone(target, isDeep, callback, stackA, stackB);
    });
    if (initedStack) {
      releaseArray(stackA);
      releaseArray(stackB);
    }
    return result;
  }

  /**
   * @description 浅复制
   * @method [对象] - clone ( 浅复制 )
   * @param value
   * @param callback
   * @param context
   * @return {*}
   * @author wyj on 14/7/6
   * @example
   *
   */
  function clone(value, callback, context) {
    callback = typeOf(callback) === 'function' && matchCallback(callback, context, 1);
    return baseClone(value, false, callback);
  }

  BbaseEst.clone = clone;
  /**
   * @description 深复制
   * @method [对象] - cloneDeep ( 深复制 )
   * @param value
   * @param callback
   * @param context
   * @return {*}
   * @author wyj on 14/7/6
   * @example
   *
   */
  function cloneDeep(value, callback, context) {
    callback = typeOf(callback) === 'function' && matchCallback(callback, context, 1);
    return baseClone(value, true, callback);
  }

  BbaseEst.cloneDeep = cloneDeep;

  /**
   * @description 返回一个设置参数的对象
   * @method [对象] - setArguments ( 返回一个设置参数的对象 )
   * @param args
   * @param {object/string} append
   * @author wyj on 14.9.12
   *      return BbaseEst.setArguments(arguments, {age： 1});
   */
  function setArguments(args, append) {
    this.value = [].slice.call(args);
    this.append = append;
  }

  BbaseEst.setArguments = setArguments;



  // FormUtils =============================================================================================================================================

  /**
   * @description 表单验证
   * @method [表单] - validation ( 表单验证 )
   * @param  {String} str  待验证字符串 str可为数组 判断所有元素是否都为数字
   * @param  {String} type 验证类型
   * @return {Boolean}      返回true/false
   * @author wyj on 14.9.29
   * @example
   *      var result_n = BbaseEst.validation(number, 'number'); // 数字或带小数点数字
   *      var result_e = BbaseEst.validation(email, 'email'); // 邮箱
   *      var result_c = BbaseEst.validation(cellphone, 'cellphone'); // 手机号码
   *      var result_d = BbaseEst.validation(digits, 'digits'); // 纯数字， 不带小数点
   *      var result_u = BbaseEst.validation(url, 'url'); // url地址
   */
  function validation(str, type) {
    var pattern, flag = true;
    switch (type) {
      case 'cellphone':
        pattern = /^((\d{11})|^((\d{7,8})|(\d{4}|\d{3})-(\d{7,8})|(\d{4}|\d{3})-(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1})|(\d{7,8})-(\d{4}|\d{3}|\d{2}|\d{1}))$)$/;
        break;
      case 'email':
        pattern = /^[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(?:\.[a-zA-Z0-9](?:[a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$/;
        break;
      case 'url':
        pattern = /^(https?|s?ftp):\/\/(((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:)*@)?(((\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5])\.(\d|[1-9]\d|1\d\d|2[0-4]\d|25[0-5]))|((([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|\d|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.)+(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])*([a-z]|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])))\.?)(:\d*)?)(\/((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)+(\/(([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)*)*)?)?(\?((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|[\uE000-\uF8FF]|\/|\?)*)?(#((([a-z]|\d|-|\.|_|~|[\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF])|(%[\da-f]{2})|[!\$&'\(\)\*\+,;=]|:|@)|\/|\?)*)?$/i;
        break;
      case 'number':
        // 可带小数点 如：0.33， 35.325
        pattern = /^-?(?:\d+|\d{1,3}(?:,\d{3})+)?(?:\.\d+)?$/; // ^\s*(?=.*[1-9])\d*(?:\.\d{1,2})?\s*$ .1 matches 0.1 matches 1.12 matches 123.12 matches 92 matches 092 matches 092.13 matches 0 doesn't match 0.0 doesn't match 0.00 doesn't match 00 doesn't match 1.234 doesn't match -1 doesn't match -1.2 doesn't match
        break;
      case 'digits': //还可带小数点
        pattern = /^\d+$/;
        break;
    }
    if (typeOf(str) === 'array') {
      each(str, function (item) {
        if (!pattern.test(item))
          flag = false;
      });
    } else {
      flag = pattern.test(str);
    }
    return flag;
  }

  BbaseEst.validation = validation;


  // StringUtils =============================================================================================================================================
  /**
   * 获取当前字符在字符串中的索引值
   * @method [字符串] - indexOf
   * @param  {string} str  原字符串
   * @param  {string} str2 字符串
   * @return {number}      索引值
   */
  function indexOf(str, str2) {
    if (typeOf(str) === 'array') {
      return str.indexOf ? str.indexOf(str2) : arrayIndex(str, str2);
    }
    return str.indexOf(str2);
  }
  BbaseEst.indexOf = indexOf;

  /**
   * 获取当前字符在字符串中的向后索引值
   * @method [字符串] - lastIndexOf
   * @param  {string} str  原字符串
   * @param  {string} str2 字符串
   * @return {number}      索引值
   */
  function lastIndexOf(str, str2) {
    return str.lastIndexOf(str2);
  }
  BbaseEst.lastIndexOf = lastIndexOf;

  /**
   * @description 产生唯一身份标识， 如'012ABC', 若为数字较容易数字溢出
   * @method [字符串] - nextUid ( 产生唯一身份标识 )
   * @return {string}
   * @param {String} prefix 前缀
   * @author wyj on 14/6/23
   * @example
   *      var uid = BbaseEst.nextUid('Uid');
   *      ==> 'Uid001'
   */
  function nextUid(prefix) {
    var index = uid.length,
      digit;
    if (typeOf(prefix) === "undefined")
      prefix = '';
    while (index) {
      index--;
      digit = uid[index].charCodeAt(0);
      if (digit == 57 /*'9'*/ ) {
        uid[index] = 'A';
        return prefix + uid.join('');
      }
      if (digit == 90 /*'Z'*/ ) {
        uid[index] = '0';
      } else {
        uid[index] = fromCharCode(digit + 1);
        return prefix + uid.join('');
      }
    }
    uid.unshift('0');
    return prefix + uid.join('');
  }

  BbaseEst.nextUid = nextUid;

  /**
   * @description id值瘦身 去掉前面的字母与0 比如 Product_0000000000000000000132 瘦身为132
   * @method [字符串] - encodeId ( id值瘦身 )
   * @param target
   * @return {string}
   * @author wyj 15.1.9
   * @example
   *      BbaseEst.encodeId('Product_00000000000000132');
   *      ==> 132
   */
  function encodeId(target) {
    return target == null ? "" : target.replace(/^[^1-9]+/, "");
  }

  BbaseEst.encodeId = encodeId;

  /**
   * encodeUrl
   * @method [字符串] - encodeUrl ( 编码url )
   * @param  {string} url [description]
   * @return {string}     [description]
   */
  function encodeUrl(url) {
    return encodeURIComponent(url);
  }
  BbaseEst.encodeUrl = encodeUrl;

  /**
   * decodeUrl
   * @method [字符串] - decodeUrl ( 解码url )
   * @param  {string} url [description]
   * @return {string}     [description]
   */
  function decodeUrl(url) {
    return decodeURIComponent(url);
  }
  BbaseEst.decodeUrl = decodeUrl;

  /**
   * 还原ID
   * @method [字符串] - decodeId ( 还原ID )
   * @param id
   * @param prefix
   * @param length
   * @return {string}
   * @author wyj 15.1.13
   * @example
   *      BbaseEst.decodeId('123' , 'Product_' , 32);
   *      ==> Product_00000000000000000000123
   */
  function decodeId(id, prefix, length) {
    var len = prefix.length + id.length - 1;
    return prefix + new Array(length - len).join('0') + id;
  }

  BbaseEst.decodeId = decodeId;

  /**
   * @description 转换成小写字母
   * @method [字符串] - lowercase ( 转换成小写字母 )
   * @param {String} string 原字符串
   * @return {string}
   * @author wyj on 14/6/17
   * @example
   *      BbaseEst.lowercase("LE");
   *      ==> le
   */
  function lowercase(string) {
    return typeOf(string) === 'string' ? string.toLowerCase() : string;
  }

  BbaseEst.lowercase = lowercase;
  /**
   * @description 转换成大写字母
   * @method [字符串] - uppercase ( 转换成大写字母 )
   * @param {String} string 原字符串
   * @return {string}
   * @author wyj on 14/6/17
   * @example
   *      BbaseEst.uppercase("le");
   *      ==> LE
   */
  function uppercase(string) {
    return typeOf(string) === 'string' ? string.toUpperCase() : string;
  }

  BbaseEst.uppercase = uppercase;

  /**
   * @description 判定一个字符串是否包含另一个字符串
   * @method [字符串] - contains ( 字符串是否包含另一个字符串 )
   * @param {string} target 目标字符串
   * @param {string} 包含字符串
   * @param {string} 判定一个元素的className 是否包含某个特定的class
   * @return {boolean} 返回true/false
   * @author wyj on 14-04-23
   * @example
   *      BbaseEst.contains("aaaaa", "aa");
   *      ==> true
   */
  function contains(target, str, separator) {
    return separator ? indexOf(separator + target + separator, separator + str + separator) > -1 : indexOf(target, str) > -1;
  }

  BbaseEst.contains = contains;
  /**
   * @description 判定目标字符串是否位于原字符串的开始之处
   * @method [字符串] - startsWidth ( 字符串是否位于原字符串的开始之处 )
   * @param {target} 原字符串
   * @param {str} 目标字符串
   * @param {boolean} 是否忽略大小写
   * @return {boolean} true/false
   * @author wyj on 14-04-23
   * @example
   *      BbaseEst.startsWidth('aaa', 'aa', true);
   *      ==> true
   */
  function startsWith(target, str, ignorecase) {
    if (!target) {
      return false;
    }
    var start_str = target.substr(0, str.length);
    return ignorecase ? lowercase(start_str) === lowercase(str) : start_str === str;
  }

  BbaseEst.startsWidth = startsWith;
  /**
   * @description 判定目标字符串是否位于原字符串的结束之处
   * @method [字符串] - endsWidth ( 字符串是否位于原字符串的结束之处 )
   * @param {target} 原字符串
   * @param {str} 目标字符串
   * @param {boolean} 是否忽略大小写
   * @return {boolean} true/false
   * @author wyj on 14-04-23
   * @example
   *      BbaseEst.endsWidth('aaa', 'aa', true);
   *      ==> true
   */
  function endsWith(target, str, ignorecase) {
    var end_str = target.substring(target.length - str.length);
    return ignorecase ? lowercase(end_str) === lowercase(str) : end_str === str;
  }

  BbaseEst.endsWith = endsWith;
  /**
   * @description 取得一个字符串所有字节的长度
   * @method [字符串] - byteLen ( 取得一个字符串所有字节的长度 )
   * @param target 目标字符串
   * @param fix 汉字字节长度，如mysql存储汉字时， 是用3个字节
   * @return {Number}
   * @author wyj on 14-04-23
   * @example
   *      BbaseEst.byteLen('sfasf我'， 2);
   *      ==> 7
   */
  function byteLen(target, fix) {
    fix = fix ? fix : 2;
    var str = new Array(fix + 1).join('-');
    return target.replace(/[^\x00-\xff]/g, str).length;
  }

  BbaseEst.byteLen = byteLen;

  /**
   * @description 对字符串进行截取处理，默认添加三个点号【版本二】
   * @method [字符串] - cutByte ( 对字符串进行截取处理 )
   * @param str 目标字符串
   * @param length 截取长度
   * @param truncation 结尾符号
   * @return {string}
   * @author wyj on 14-04-25
   * @example
   *     BbaseEst.cutByte('aaaaaa', 4, '...');
   *     ==> 'a...'
   */
  function cutByte(str, length, truncation) {
    if (isEmpty(str)) return '';
    //提前判断str和length
    if (!(str + "").length || !length || +length <= 0) {
      return "";
    }
    var length = +length,
      truncation = typeof (truncation) == 'undefined' ? "..." : truncation.toString(),
      endstrBl = byteLen(truncation);
    if (length < endstrBl) {
      truncation = "";
      endstrBl = 0;
    }
    //用于二分法查找
    function n2(a) {
      var n = a / 2 | 0;
      return (n > 0 ? n : 1);
    }

    var lenS = length - endstrBl,
      _lenS = 0,
      _strl = 0;
    while (_strl <= lenS) {
      var _lenS1 = n2(lenS - _strl),
        addn = byteLen(str.substr(_lenS, _lenS1));
      if (addn == 0) {
        return str;
      }
      _strl += addn;
      _lenS += _lenS1;
    }
    if (str.length - _lenS > endstrBl || byteLen(str.substring(_lenS - 1)) > endstrBl) {
      return str.substr(0, _lenS - 1) + truncation;
    } else {
      return str;
    }
  }

  BbaseEst.cutByte = cutByte;
  /**
   * @description 替换指定的html标签, 当第3个参数为true时， 删除该标签并删除标签里的内容
   * @method [字符串] - stripTabName ( 替换指定的html标签 )
   * @param {String} target 目标字符串
   * @param {String} tagName 标签名称
   * @param {String} deep 是否删除标签内的内容
   * @return {string}
   * @author wyj on 14/6/18
   * @example
   *      BbaseEst.stripTagName("<script>a</script>", "script", true);
   *      ==> ''
   *      BbaseEst.stripTagName("<script>a</script>", "script", false);
   *      ==> 'a'
   */
  function stripTagName(target, tagName, deep) {
    var pattern = deep ? "<" + tagName + "[^>]*>([\\S\\s]*?)<\\\/" + tagName + ">" : "<\/?" + tagName + "[^>]*>";
    return String(target || '').replace(new RegExp(pattern, 'img'), '');
  }

  BbaseEst.stripTagName = stripTagName;
  /**
   * @description 移除字符串中所有的script标签。弥补stripTags 方法的缺陷。此方法应在stripTags之前调用
   * @method [字符串] - stripScripts ( 移除字符串中所有的script标签 )
   * @param {String} target 目标字符串
   * @return {string} 返回字符串
   * @author wyj on 14/5/5
   * @example
   *     BbaseEst.stripScripts("a<script></script>");
   *     ==> 'a'
   */
  function stripScripts(target) {
    return String(target || '').replace(/<script[^>]*>([\S\s]*?)<\/script>/img, '');
  }

  BbaseEst.stripScripts = stripScripts;
  /**
   * @description 移除字符串中的html标签, 若字符串中有script标签，则先调用stripScripts方法
   * @method [字符串] - stripTags ( 移除字符串中的html标签 )
   * @param {String} target 原字符串
   * @return {string} 返回新字符串
   * @author wyj on 14/5/5
   * @example
   *     BbaseEst.stripTags('aa<div>bb</div>');
   *     ==> 'aabb'
   */
  function stripTags(target) {
    return String(target || '').replace(/<[^>]+>/img, '');
  }

  BbaseEst.stripTags = stripTags;
  /**
   * @description 替换原字符串中的“< > " '”为 “&lt;&gt;&quot;&#39;”
   * @method [字符串] - escapeHTML ( 替换原字符串中的“< > " '” )
   * @param {String} target 原字符串
   * @return {String} 返回新字符串
   * @author wyj on 14/5/5
   * @example
   *     BbaseEst.escapeHTML('<');
   *     ==> '&lt;'
   */
  function escapeHTML(target) {
    return target.replace(/&/mg, '&amp;')
      .replace(/</mg, '&lt;')
      .replace(/>/mg, '&gt;')
      .replace(/"/mg, '&quot;')
      .replace(/'/mg, '&#39;');
  }

  BbaseEst.escapeHTML = escapeHTML;
  /**
   * @description 替换原字符串中的“&lt;&gt;&quot;&#39;”为 “< > " '”
   * @method [字符串] - unescapeHTML ( 替换原字符串中的“&lt;&gt;&quot;&#39; )
   * @param {String} target 原字符串
   * @return {String} 返回新字符串
   * @author wyj on 14/5/5
   * @example
   *     BbaseEst.unescapeHTML('&lt;');
   *     ==> '<'
   */
  function unescapeHTML(target) {
    target = target || '';
    return target.replace(/&amp;/mg, '&')
      .replace(/&lt;/mg, '<')
      .replace(/&gt;/mg, '>')
      .replace(/&quot;/mg, '"')
      .replace(/&#([\d]+);/mg, function ($0, $1) {
        return fromCharCode(parseInt($1, 10));
      });
  }

  BbaseEst.unescapeHTML = unescapeHTML;
  /**
   * @description 将字符串安全格式化为正则表达式的源码
   * @method [字符串] - escapeRegExp ( 将字符串安全格式化为正则表达式的源码 )
   * @param {String} target 原字符串
   * @return {*}
   * @author wyj on 14/5/16
   * @example
   *      BbaseEst.escapeRegExp('aaa/[abc]/')
   *      ==> aaa\/\[abc\]\/;
   */
  function escapeRegExp(target) {
    return target.replace(/([-.*+?^${}()|[\]\/\\])/img, '\\$1');
  }

  BbaseEst.escapeRegExp = escapeRegExp;
  /**
   * @description 为字符串的某一端添加字符串。 如：005
   * @method [字符串] - pad ( 为字符串的某一端添加字符串 )
   * @param {String/Number} target 原字符串或数字
   * @param {Number} n 填充位数
   * @param {String} filling 填充字符串
   * @param {Boolean} right 在前或后补充
   * @param {Number} radix 转换进制 10进制或16进制
   * @param {Object} opts {String} opts.prefix 前缀
   * @author wyj on 14/5/5
   * @example
   *      BbaseEst.pad(5, 10, '0', {
   *        prefix: 'prefix',
   *        right: false,
   *        radix: 10
   *      });
   *      ==> prefix0005
   */
  function pad(target, n, filling, opts) {
    var str, options,
      prefix = '',
      length = n,
      filling = filling || '0';

    options = extend({
      right: false,
      radix: 10
    }, opts);

    str = target.toString(options.radix);
    if (options.prefix) {
      length = n - options.prefix.length;
      prefix = options.prefix;
      if (length < 0) {
        throw new Error('n too small');
      }
    }
    while (str.length < length) {
      if (!options.right) {
        str = filling + str;
      } else {
        str += filling;
      }
    }
    return prefix + str;
  }

  BbaseEst.pad = pad;
  /**
   * @description 格式化字符串，类似于模板引擎，但轻量级无逻辑
   * @method [字符串] - format ( 格式化字符串 )
   * @param {String} str 原字符串
   * @param {Object} object 若占位符为非零整数形式即对象，则键名为点位符
   * @return {String} 返回结果字符串
   * @author wyj on 14/5/5
   * @example
   *     BbaseEst.format("Result is #{0}, #{1}", 22, 23);
   *     ==> "Result is 22, 23"
   *
   *     BbaseEst.format("#{name} is a #{sex}", {name : 'Jhon',sex : 'man'});
   *     ==> "Jhon is a man"
   */
  function format(str, object) {
    var array = Array.prototype.slice.call(arguments, 1);
    return str.replace(/\\?\#{([^{}]+)\}/gm, function (match, name) {
      if (match.charAt(0) == '\\')
        return match.slice(1);
      var index = Number(name);
      if (index >= 0)
        return array[index];
      if (object && object[name] !== void 0)
        return object[name];
      return '';
    });
  }

  BbaseEst.format = format;

  /**
   * @description 比format更强大的模板引擎， 支持字符串模板、变量嵌套、四则运算、比较操作符、三元运算符
   * @method [字符串] - template ( 比format更强大的模板引擎 )
   * @param {String} str 待格式化字符串
   * @param {Object} data 替换对象
   * @return {String} result
   * @author wyj on 14.10.9
   * @example
   *         // 字符串
   *        var result3 =BbaseEst.template('hello {{name}}', { name: 'feenan'});
   *        ==> "hello feenan"
   *
   *        // 变量嵌套
   *        var result8 =BbaseEst.template('hello {{person.age}}', { person: {age: 50}});
   *        ==> "hello 50"
   *
   *        // 四则运算
   *        var result4 =BbaseEst.template('(1+2)*age = {{ (1+2)*age}}', {age: 18});
   *        ==> (1+2)*age = 54
   *
   *        // 比较操作符
   *        var result5 =BbaseEst.template('{{1>2}}', {});
   *        ==> false
   *        var result6 =BbaseEst.template('{{age > 18}}', {age: 20});
   *        ==> true
   *
   *        // 三元运算符
   *        var result7 =BbaseEst.template('{{ 2 > 1 ? name : ""}}', {name: 'feenan'});
   *        ==> feenan
   *
   *        // 综合
   *        var tmpl1 = '<div id="{{id}}" class="{{(i % 2 == 1 ? " even" : "")}}"> ' +
   *        '<div class="grid_1 alpha right">' +
   *        '<img class="righted" src="{{profile_image_url}}"/>' +
   *        '</div>' +
   *        '<div class="grid_6 omega contents">' +
   *        '<p><b><a href="/{{from_user}}">{{from_user}}</a>:</b>{{info.text}}</p>' +
   *        '</div>' +
   *        '</div>';
   *        var result = BbaseEst.template(tmpl1, {
   *              i: 5,
   *              id: "form_user",
   *              from_user: "Krasimir Tsonev",
   *              profile_image_url: "http://www.baidu.com/img/aaa.jpg",
   *              info: {
   *                  text: "text"
   *              }
   *         });
   */
  function template(str, data) {
    var fn = !/\W/.test(str) ?
      cache[str] = cache[str] || template(str) :
      new Function("obj",
        "var p=[],print=function(){p.push.apply(p,arguments);};" +
        "with(obj){p.push('" +
        str
        .replace(/[\r\t\n]/g, " ")
        .split("{{").join("\t")
        .replace(/((^|}})[^\t]*)'/g, "$1\r")
        .replace(/\t(.*?)}}/g, "',$1,'")
        .split("\t").join("');")
        .split("}}").join("p.push('")
        .split("\r").join("\\'") + "');}return p.join('');");
    return data ? fn(data) : fn;
  }

  BbaseEst.template = BbaseEst.compile = template;


  /**
   * @description 移除字符串左端的空白
   * @method [字符串] - trimLeft ( 移除字符串左端的空白 )
   * @param {String} str 原字符串
   * @return {String} 返回新字符串
   * @author wyj on 14/5/6
   * @example
   *     BbaseEst.ltrim('  dd    ');
   *     ==> 'dd    '
   */
  function trimLeft(str) {
    for (var i = 0; i < str.length; i++) {
      if (indexOf(whitespace, str.charAt(i)) === -1) {
        str = str.substring(i);
        break;
      }
    }
    return indexOf(whitespace, str.charAt(0)) === -1 ? (str) : '';
  }

  BbaseEst.trimLeft = trimLeft;
  /**
   * @description 移除字符串右端的空白
   * @method [字符串] - rtrim ( 移除字符串右端的空白 )
   * @param {String} str 原字符串
   * @return {String} 返回新字符串
   * @author wyj on 14/5/6
   * @example
   *     BbaseEst.rtrim('  dd    ');
   *     ==> '   dd'
   */
  function trimRight(str) {
    for (var i = str.length - 1; i >= 0; i--) {
      if (lastIndexOf(whitespace, str.charAt(i)) === -1) {
        str = str.substring(0, i + 1);
        break;
      }
    }
    return lastIndexOf(whitespace, str.charAt(str.length - 1)) === -1 ? (str) : '';
  }

  BbaseEst.trimRight = trimRight;
  /**
   * @description 移除字符串两端的空白, 当字符串为undefined时， 返回null
   * @method [字符串] - trim ( 移除字符串两端的空白 )
   * @param {String} str 原字符串
   * @return {String} 返回新字符串
   * @author wyj on 14/5/6
   * @example
   *     BbaseEst.trim('  dd    ');
   *     ==> 'dd'
   */
  function trim(str) {
    if (isEmpty(str)) return null;
    for (var i = 0; i < str.length; i++) {
      if (indexOf(whitespace, str.charAt(i)) === -1) {
        str = str.substring(i);
        break;
      }
    }
    for (i = str.length - 1; i >= 0; i--) {
      if (indexOf(whitespace, str.charAt(i)) === -1) {
        str = str.substring(0, i + 1);
        break;
      }
    }
    return indexOf(whitespace, str.charAt(0)) === -1 ? (str) : '';
  }

  BbaseEst.trim = trim;
  /**
   * @description 去除字符串中的所有空格
   * @method [字符串] - deepTrim ( 去除字符串中的所有空格 )
   * @param {String} str 原字符串
   * @return {String} 返回新字符串
   * @author wyj on 14/5/6
   * @example
   *     BbaseEst.deepTrim('a b c');
   *     ==> 'abc'
   */
  function trimDeep(str) {
    return str.toString().replace(/\s*/gm, '');
  }

  BbaseEst.trimDeep = trimDeep;



  // ArrayUtils ===============================================================================================================================================


  /**
   * 从数组中移除
   * @method [数组] - remove ( 数组中移除数组 )
   * @param {array} targetList 原数组
   * @param {array} removeList 待移除数组
   * @param callback 两元素比较  返回true/false
   * @return {array}
   * @example
   *       var targetList = [{key: '11', value: '11'},{key: '11', value: '33'}, {key: '22', value: '22'}, {key: '33', value: '33'}];
   *
   *       var targetList2 = [1, 2, 3, 4, 5];
   *       BbaseEst.remove(targetList2, 2);
   *       ==> [1, 3, 4, 5]
   *
   *       BbaseEst.remove(targetList, {key: '11'});
   *       ==> [{key: '22', value: '22'}, {key: '33', value: '33'}]
   *
   *       BbaseEst.remove(targetList, {key: '11', value: '33'});
   *       ==> [{key: '11', value: '11'},{key: '22', value: '22'}, {key: '33', value: '33'}]
   *
   *       var removeList = [{key: '11'}];
   *       BbaseEst.remove(targetList, removeList, function(targetItem, removeItem){
   *          return targetItem.key === removeItem.key;
   *       });
   *       ==> [{key: '22', value: '22'}, {key: '33', value: '33'}];
   */
  function remove(targetList, removeList, callback) {
    var i = 0,
      hasCallback = false,
      isEqual = false;

    if (typeOf(targetList) !== 'array') {
      throw new TypeError('err32');
      return targetList;
    }
    if (typeOf(removeList) !== 'array') {
      removeList = [removeList];
    }
    if (callback) hasCallback = true;

    i = targetList.length;

    while (i > 0) {
      var item = targetList[i - 1];
      isEqual = false;
      each(removeList, function (model) {
        if (hasCallback && callback.call(this, item, model)) {
          isEqual = true;
        } else if (!hasCallback) {
          if (typeOf(model) === 'object' && findIndex([item], model) > -1) {
            isEqual = true;
          } else if (item === model) {
            isEqual = true;
          }
        }
        if (isEqual) {
          targetList.splice(i - 1, 1);
          return false;
        }
      });
      i--;
    }
    return targetList;
  }

  BbaseEst.remove = remove;
  /**
   * @description 获取对象的所有KEY值
   * @method [数组] - keys ( 获取对象的所有KEY值 )
   * @param {Object} obj 目标对象
   * @return {Array}
   * @author wyj on 14/5/25
   * @example
   *      BbaseEst.keys({name:1,sort:1});
   *      ==> ['name', 'sort']
   */
  function keys(obj) {
    if (typeOf(obj) !== 'object') return [];
    if (nativeKeys) return nativeKeys(obj);
    var keys = [];
    for (var key in obj)
      if (hasKey(obj, key)) keys.push(key);
    return keys;
  }

  BbaseEst.keys = keys;
  /**
   * @description 用来辨别 给定的对象是否匹配指定键/值属性的列表
   * @method [数组] - matches ( 对象是否匹配指定键/值属性的列表 )
   * @param attrs
   * @return {Function}
   * @author wyj on 14/6/26
   * @example
   */
  function matches(attrs) {
    return function (obj) {
      if (obj == null) return isEmpty(attrs);
      if (obj === attrs) return true;
      for (var key in attrs)
        if (attrs[key] !== obj[key]) return false;
      return true;
    };
  }

  BbaseEst.matches = matches;
  /**
   * @description 数组过滤
   * @method [数组] - filter ( 数组过滤 )
   * @param {Array} collection 数组
   * @param {Function} callback 回调函数
   * @param args
   * @author wyj on 14/6/6
   * @example
   *      var list = [{"name":"aa"},{"name":"bb"},{"name":"cc"}, {"name":"bb", address:"zjut"}];
   *      var result = BbaseEst.filter(list, function(item){
   *          return item.name.indexOf('b') > -1;
   *      });
   *      ==> [ { "name": "bb" }, { "address": "zjut", "name": "bb" } ]
   */
  function filter(collection, callback, context) {
    var results = [];
    if (!collection) return result;
    var callback = matchCallback(callback, context);
    each(collection, function (value, index, list) {
      if (callback(value, index, list)) results.push(value);
    });
    return results;
  }

  BbaseEst.filter = filter;

  /**
   * @description 数组中查找符合条件的索引值 比较原始值用indexOf
   * @method [数组] - findIndex ( 数组中查找符合条件的索引值 )
   * @param array
   * @param {Function} callback 回调函数
   * @param {Object} context 上下文
   * @return {number}
   * @author wyj on 14/6/29
   * @example
   *      var list = [{"name":"aa"},{"name":"bb"},{"name":"cc"}, {"name":"bb", address:"zjut"}];
   *      var index = BbaseEst.findIndex(list, {name: 'aa'});
   *      ==> 0
   *
   *      var index2 =  BbaseEst.findIndex(list, function(item){
   *         return item.name === 'aa';
   *      });
   *      ==> 0
   */
  function findIndex(array, callback, context) {
    var index = -1,
      length = array ? array.length : 0;
    callback = matchCallback(callback, context);
    while (++index < length) {
      if (callback(array[index], index, array)) {
        return index;
      }
    }
    return -1;
  }

  BbaseEst.findIndex = findIndex;


  /**
   * @description 数组转化为object 如果对象key值为数字类型， 则按数字从小到大排序
   * @method [数组] - arrayToObject ( 数组转化为object )
   * @param {Array} list 目标数组
   * @param {String} name key
   * @param {String} val value
   * @return {Object} object
   * @author wyj on 14/5/24
   * @example
   *      var list4 = [{key:'key1',value:'value1'},{key:'key2',value:'value2'}];
   *      BbaseEst.arrayToObject(list4, 'key', 'value');
   *      ==> {key1: 'value1',key2: 'value2'}
   */
  function arrayToObject(list, key, val) {
    var obj = {};
    each(list, function (item) {
      if (typeOf(item[key]) !== 'undefined') {
        obj[item[key]] = item[val];
      }
    });
    return obj;
  }

  BbaseEst.arrayToObject = arrayToObject;
  /**
   * @description 对象转化为数组
   * @method [数组] - arrayFromObject ( 对象转化为数组 )
   * @param {Object} obj 待转化的对象
   * @return {Array} 返回数组
   * @author wyj on 14/5/24
   * @example
   *      var obj = {key1: 'value1', key2: 'value2'};
   *      var result = BbaseEst.arrayFromObject(obj, 'key', 'value');
   *      ==> [{key: 'key1', value: 'value1'}, {key: 'key2', value: 'value2'}]
   */
  function arrayFromObject(obj, name, value) {
    var list = [];
    if (typeOf(obj) !== 'object') {
      return [];
    }
    each(obj, function (val, key) {
      var object = {};
      object[name] = key;
      object[value] = val;
      list.push(object);
    });
    return list;
  }

  BbaseEst.arrayFromObject = arrayFromObject;
  /**
   * @description 交换元素
   * @method [数组] - arrayExchange ( 交换元素 )
   * @param {Array} list 原数组
   * @param {Number} thisdx 第一个元素索引值
   * @param {Number} targetdx 第二个元素索引值
   * @param {Object} opts {String} opts.column 需要替换的列值;{Function} opts.callback(thisNode, nextNode) 回调函数 返回两个对调元素
   * @author wyj on 14/5/13
   * @example
   *      var list2 = [{name:1, sort:1},{name:2, sort:2}];
   *      BbaseEst.arrayExchange(list2, 0 , 1, {
   *          column:'sort',
   *          callback:function(thisNode, targetNode){
   *          }
   *      });
   *      ==> [{name:2,sort:1},{name:1,sort:2}]
   */
  function arrayExchange(list, thisdx, targetdx, opts) {
    if (thisdx < 0 || thisdx > list.length || targetdx < 0 || targetdx > list.length) {
      throw new Error('err33');
    }
    var thisNode = list[thisdx],
      nextNode = list[targetdx],
      temp = thisNode,
      thisSort = 0;
    // 更换列值
    if (opts && typeof opts.column === 'string') {
      thisSort = getValue(thisNode, opts.column);
      setValue(thisNode, opts.column, getValue(nextNode, opts.column));
      setValue(nextNode, opts.column, thisSort);
    }
    // 更新数据
    if (opts && typeof opts.callback === 'function') {
      opts.callback.apply(null, [thisNode, nextNode]);
    }
    // 替换位置
    list[thisdx] = nextNode;
    list[targetdx] = temp;
  }

  BbaseEst.arrayExchange = arrayExchange;
  /**
   * @description 数组插序
   * @method [数组] - arrayInsert ( 数组插序 )
   * @param {Array} list 原数组
   * @param {Number} thisdx 第一个元素索引
   * @param {Number} targetdx 第二个元素索引
   * @param {Object} opts    {String} opts.column:需要替换的列值; {Function} opts.callback(list)回调函数 返回第一个元素与第二个元素之间的所有元素
   * @author wyj on 14/5/15
   * @example
   *          var list3 = [{name:1, sort:1},{name:2, sort:2},{name:3, sort:3},{name:4, sort:4}];
   *          BbaseEst.arrayInsert(list3, 3 , 1, {column:'sort',callback:function(list){}});
   *          ==> [{name:1,sort:1},{name:4,sort:2},{name:2,sort:3},{name:3,sort:4}]
   *
   *          BbaseEst.arrayInsert(list, 3, 1, {
   *            arrayExchange: fucntion(list, begin, end, opts){
   *              // 自定义元素交换操作
   *            }
   *          });
   */
  function arrayInsert(list, thisdx, targetdx, opts) {
    var tempList = []; // 用于存放改变过的值
    if (thisdx < targetdx) {
      for (var i = thisdx; i < targetdx - 1; i++) {
        if (opts.arrayExchange) {
          opts.arrayExchange.apply(this, [list, i, i + 1, opts]);
        } else {
          arrayExchange(list, i, i + 1, {
            column: opts.column
          });
        }
      }
      tempList = list.slice(0).slice(thisdx, targetdx);
    } else {
      for (var i = thisdx; i > targetdx; i--) {
        if (opts.arrayExchange) {
          opts.arrayExchange.apply(this, [list, i, i - 1, opts]);
        } else {
          arrayExchange(list, i, i - 1, {
            column: opts.column
          });
        }
      }
      tempList = list.slice(0).slice(targetdx, thisdx + 1);
    }
    if (typeof opts.callback === 'function') {
      opts.callback.apply(null, [tempList]);
    }
  }

  BbaseEst.arrayInsert = arrayInsert;
  /**
   * @description 遍历MAP对象
   * @method [数组] - map ( 遍历MAP对象 )
   * @param {Array} obj 目标数组
   * @param callback 回调函数
   * @param context 上下文
   * @return {Array} 返回数组
   * @author wyj on 14/6/23
   * @example
   *      var list = [1, 2, 3];
   *      var result = BbaseEst.map(list, function(value, index, list){
   *        return list[index] + 1;
   *      });
   *      ==> [2, 3, 4]
   */
  function map(obj, callback, context) {
    var results = [];
    if (obj === null) return results;
    callback = matchCallback(callback, context);
    each(obj, function (value, index, list) {
      results.push(callback(value, index, list));
    });
    return results;
  }

  BbaseEst.map = map;

  /**
   * @description 判断元素是否存在于数组中
   * @method [数组] - indexOf ( 判断元素是否存在于数组中 )
   * @param {Array} array 原型数组
   * @param {*} value 值
   * @return {Number}
   * @author wyj on 14/6/23
   * @example
   *      var list = ['a', 'b'];
   *      var has = BbaseEst.indexOf('b');
   *      ==> 1
   */
  function arrayIndex(array, value) {
    if (array.indexOf) return array.indexOf(value);
    for (var i = 0, len = array.length; i < len; i++) {
      if (value === array[i]) return i;
    }
    return -1;
  }

  BbaseEst.arrayIndex = arrayIndex;
  /**
   * @description 数组排序
   * @method [数组] - sortBy ( 数组排序 )
   * @param obj
   * @param iterator
   * @param context
   * @return {*}
   * @author wyj on 14/7/5
   * @example
   *      var result = BbaseEst.sortBy([1, 2, 3], function(num) { return Math.sin(num); });
   *      ==> [3, 1, 2]
   *
   *      var characters = [ { 'name': 'barney',  'age': 36 }, { 'name': 'fred',    'age': 40 }, { 'name': 'barney',  'age': 26 }, { 'name': 'fred',    'age': 30 } ];
   *      var result2 = BbaseEst.sortBy(characters, 'age');
   *      ==> [{ "age": 26, "name": "barney" }, { "age": 30, "name": "fred" }, { "age": 36, "name": "barney" }, { "age": 40, "name": "fred" }]
   *
   *      var result3 = BbaseEst.sortBy(characters, ['name', 'age']);
   *      ==> [{ "age": 26, "name": "barney" },{ "age": 36, "name": "barney" },  { "age": 30, "name": "fred" }, { "age": 40, "name": "fred" } ]
   */
  function sortBy(collection, callback, context) {
    var index = -1,
      isArr = typeOf(callback) === 'array',
      length = collection ? collection.length : 0,
      result = Array(typeof length === 'number' ? length : 0);
    if (!isArr) {
      callback = matchCallback(callback, context);
    }
    each(collection, function (value, key, collection) {
      var object = result[++index] = {};
      if (isArr) {
        object.criteria = map(callback, function (key) {
          return value[key];
        });
      } else {
        (object.criteria = [])[0] = callback(value, key, collection);
      }
      object.index = index;
      object.value = value;
    });
    length = result.length;
    result.sort(function (left, right) {
      var left_c = left.criteria,
        right_c = right.criteria,
        index = -1,
        length = left_c.length;
      while (++index < length) {
        var value = left_c[index],
          other = right_c[index];
        if (value !== other) {
          if (value > other || typeof value == 'undefined') {
            return 1;
          }
          if (value < other || typeof other == 'undefined') {
            return -1;
          }
        }
      }
      return left.index - right.index;
    });
    return pluck(result, 'value');
  }

  BbaseEst.sortBy = sortBy;
  /**
   * @description 截取数组
   * @method [数组] - take/arraySlice ( 截取数组 )
   * @param {Array} array 数据
   * @param {Number} start 起始
   * @param {Number} end 若未设置值， 则取索引为start的一个值
   * @return {*}
   * @author wyj on 14/7/7
   * @example
   *      var list = [1, 2, 3];
   *      BbaseEst.arraySlice(list, 1, 2);
   *      ==> [2, 3]
   *
   *      BbaseEst.take(list, 1);
   *      ==> [2]
   */
  function arraySlice(array, start, end) {
    start || (start = 0);
    if (typeof end == 'undefined') {
      end = start < array.length - 1 ? (start + 1) : array.length;
    }
    var index = -1,
      length = end - start || 0,
      result = Array(length < 0 ? 0 : length);

    while (++index < length) {
      result[index] = array[start + index];
    }
    return result;
  }

  BbaseEst.take = BbaseEst.arraySlice = arraySlice;


  // TreeUtils
  /**
   * @description 构建树 注意：categoryId， belongId别弄错， 否则会报‘Maximum call stack size exceeded’错误
   * @method [树] - bulidSubNode ( 构建树 )
   * @param {Array} rootlist 根节点列表
   * @param {Array} totalList 总列表 {String}
   * @param {Object} opts {String} opts.category_id 分类Id {String} opts.belong_id 父类Id
   * @author wyj on 14/5/15
   * @example
   *      var root = [];
   *      for(var i = 0, len = list.length; i < len; i++){
   *          if(list[i]['grade'] === '01'){
   *              root.push(list[i]);
   *          }
   *      }
   *      BbaseEst.bulidSubNode(root, list, {
   *          categoryId: 'category_id', // 分类ＩＤ
   *          belongId: 'belong_id', // 父类ＩＤ
   *          childTag: 'cates', // 存放子类字段名称
   *          dxs: []
   *      });
   */
  function bulidSubNode(rootlist, totalList, opts) {
    var options = {
      categoryId: 'category_id', //分类ＩＤ
      belongId: 'belong_id', //父类ＩＤ
      childTag: 'cates',
      dxs: []
    };
    if (typeof (opts) != 'undefined') {
      extend(options, opts);
    }
    if (typeof (options.dxs) !== 'undefined') {
      for (var k = 0, len3 = options.dxs.length; k < len3; k++) {
        totalList.splice(options.dxs[k], 1);
      }
    }
    for (var i = 0, len = rootlist.length; i < len; i++) {
      var item = rootlist[i];
      var navlist = [];
      // 设置子元素
      for (var j = 0, len1 = totalList.length; j < len1; j++) {
        var newResItem = totalList[j];
        if (item[options.categoryId] == newResItem[options.belongId]) {
          navlist.push(newResItem);
          //options['dxs'].push(j);
        }
      }
      // 设置子元素
      item[options.childTag] = navlist.slice(0);
      // 判断是否有下级元素
      if (navlist.length > 0) {
        item.hasChild = true;
        bulidSubNode(navlist, totalList, options);
      } else {
        item.hasChild = false;
        item.cates = [];
      }
    }
    return rootlist;
  }

  BbaseEst.bulidSubNode = bulidSubNode;
  /**
   * @description 获取select表单控件样式的树
   * @method [树] - bulidSelectNode ( 获取select表单控件样式的树 )
   * @param {Array} rootlist 根节点列表
   * @param {Number} zoom 缩进
   * @param {Object} obj {String} opts.name 字段名称
   * @author wyj on 14/5/15
   * @example
   *      BbaseEst.bulidSelectNode(rootlist, 2, {
   *          name : 'name'
   *      });
   */
  function bulidSelectNode(rootlist, zoom, opts, top) {
    var z = zoom;
    opts.top = typeof opts.top === 'undefined' ? true : opts.top;
    for (var i = 0, len = rootlist.length; i < len; i++) {
      var space = '';
      if (typeOf(top) !== 'undefined' && !top) {
        space = pad(space, z - 1, '　');
      }
      space = space + "|-";
      rootlist[i][opts.name] = space + rootlist[i][opts.name];
      if (rootlist[i].hasChild) {
        bulidSelectNode(rootlist[i].cates, zoom = z + 1, opts, false);
      }
    }
    return rootlist;
  }

  BbaseEst.bulidSelectNode = bulidSelectNode;


  /**
   * @description 扩展树
   * @method [树] - extendTree ( 扩展树 )
   * @param {Array} rootlist 根节点列表
   * @author wyj on 14/5/15
   * @example
   *      BbaseEst.extendNode(rootlist);
   */
  function extendTree(treelist, opts) {
    var list = [];

    function extendNode(rootlist) {
      for (var i = 0, len = rootlist.length; i < len; i++) {
        list.push(rootlist[i]);
        if (rootlist[i].hasChild) {
          extendNode(rootlist[i].cates);
        }
      }
      return rootlist;
    }

    extendNode(treelist);
    return list;
  }

  BbaseEst.extendTree = extendTree;

  /**
   * @description 构建树
   * @method [树] - bulidTreeNode ( 构建树 )
   * @param {Array} list
   * @param {String} name 父分类的字段名称
   * @param {String} value 值
   * @param {Object} opts 配置信息
   * @return {*}
   * @author wyj on 14/7/9
   * @example
   *      BbaseEst.bulidTreeNode(list, 'grade', '01', {
   *          categoryId: 'category_id',// 分类ＩＤ
   *          belongId: 'belong_id',// 父类ＩＤ
   *          childTag: 'cates', // 子分类集的字段名称
   *          sortBy: 'sort', // 按某个字段排序
   *          callback: function(item){}  // 回调函数
   *      });
   */
  function bulidTreeNode(list, name, value, opts) {
    var root = [];
    each(list, function (item) {
      if (item[name] === value) root.push(item);
      if (opts && typeOf(opts.callback) === 'function') {
        opts.callback.call(this, item);
      }
    });
    if (opts && typeOf(opts.sortBy) !== 'undefined') {
      root = sortBy(root, function (item) {
        return item[opts.sortBy];
      });
      list = sortBy(list, function (item) {
        return item[opts.sortBy];
      });
    }
    return bulidSubNode(root, list, opts);
  }

  BbaseEst.bulidTreeNode = bulidTreeNode;

  /**
   * @description 获取面包屑导航
   * @method [树] - bulidBreakNav ( 获取面包屑导航 )
   * @param {Array} list 总列表
   * @param {String} nodeId ID标识符
   * @param {String} nodeValue id值
   * @param {String} nodeLabel 名称标识符
   * @param {String} nodeParentId 父类ID标识符
   * @return {*}
   * @author wyj on 14/7/10
   * @example
   *     $('.broadcrumb').html(BbaseEst.bulidBreakNav(app.getData('albumList'), 'album_id', albumId, 'name', 'parent_id'));
   *
   */
  function bulidBreakNav(list, nodeId, nodeValue, nodeLabel, nodeParentId) {
    var breakNav = [];
    var result = filter(list, function (item) {
      return item[nodeId] === nodeValue;
    });
    if (result.length === 0) return breakNav;
    breakNav.unshift({ nodeId: nodeValue, name: result[0][nodeLabel] });
    var getParent = function (list, id) {
      var parent = filter(list, function (item) {
        return item[nodeId] === id;
      });
      if (parent.length > 0) {
        breakNav.unshift({ nodeId: parent[0][nodeId], name: parent[0][nodeLabel] });
        getParent(list, parent[0][nodeParentId]);
      }
    };
    getParent(list, result[0][nodeParentId]);
    return breakNav;
  }

  BbaseEst.bulidBreakNav = bulidBreakNav;

  // PaginationUtils
  /**
   * @description 获取最大页数
   * @method [分页] - getMaxPage ( 获取最大页数 )
   * @param {number} totalCount 总条数
   * @param {number} pageSize 每页显示的条数
   * @return {number} 返回最大页数
   * @author wyj on 14-04-26
   * @example
   *      BbaseEst.getMaxPage(parseInt(50), parseInt(10));
   *      ==> 5
   */
  function getMaxPage(totalCount, pageSize) {
    return totalCount % pageSize == 0 ? totalCount / pageSize : Math.floor(totalCount / pageSize) + 1;
  }

  BbaseEst.getMaxPage = getMaxPage;

  /**
   * @description 根据pageList总列表， page当前页   pageSize显示条数  截取列表
   * @method [分页] - getListByPage ( 根据page, pageSize获取列表 )
   * @param {Array} pageList  全部列表
   * @param page 当前页
   * @param pageSize  每页显示几条
   * @return {Array} 返回结果集
   * @author wyj on 14-04-26
   * @example
   *      BbaseEst.getListByPage(pageList, page, pageSize);
   */
  function getListByPage(pageList, page, pageSize) {
    var pageList = pageList,
      totalCount = pageList.length,
      newList = new Array();
    var maxPage = getMaxPage(totalCount, pageSize);
    page = page < 1 ? 1 : page;
    page = page > maxPage ? maxPage : page;
    var start = ((page - 1) * pageSize < 0) ? 0 : ((page - 1) * pageSize),
      end = (start + pageSize) < 0 ? 0 : (start + pageSize);
    end = end > totalCount ? totalCount : (start + pageSize);
    for (var i = start; i < end; i++) {
      newList.push(pageList[i]);
    }
    return newList;
  }

  BbaseEst.getListByPage = getListByPage;
  /**
   * @description 通过当前页、总页数及显示个数获取分页数字
   * @method [分页] - getPaginationNumber ( 获取分页数字 )
   * @param {Number} page 当前页
   * @param {Number} totalPage 总页数
   * @param {Number} length 显示数
   * @return {Array} 返回数字集
   * @example
   *      BbaseEst.getPaginajtionNumber(parseInt(6), parseInt(50), 9);
   *      ==> 3,4,5,6,7,8,9
   */
  function getPaginationNumber(page, totalPage, length) {
    var page = parseInt(page, 10),
      totalPage = parseInt(totalPage, 10),
      start = 1,
      end = totalPage,
      pager_length = length || 11, //不包next 和 prev 必须为奇数
      number_list = [];
    if (totalPage > pager_length) {
      var offset = (pager_length - 1) / 2;
      if (page <= offset) {
        start = 1;
        end = offset * 2 - 1;
      } else if (page > totalPage - offset) {
        start = totalPage - offset * 2 + 2;
        end = totalPage;
      } else {
        start = page - (offset - 1);
        end = page + (offset - 1);
      }
    } else {
      end = totalPage;
    }
    for (var i = start; i <= end; i++) {
      number_list.push(i);
    }
    return number_list;
  }

  BbaseEst.getPaginationNumber = getPaginationNumber;

  // DateUtils
  /**
   * @description 格式化时间 当输入的时间是已经格式好好的且为IE浏览器， 则原样输出
   * @method [时间] - dateFormat ( 格式化时间 )
   * @param {String} date 时间
   * @param {String} fmt 格式化规则 如‘yyyy-MM-dd’
   * @return {String} 返回格式化时间
   * @author wyj on 14/5/3
   * @example
   *     BbaseEst.dateFormat(new Date(), 'yyyy-MM-dd');
   *     ==> '2014-05-03'
   */
  function dateFormat(date, fmt) {
    var _date = null;
    if (typeOf(date) === 'string') _date = parseFloat(date);
    if (_date && String(_date) !== 'NaN' && _date > 10000) date = _date;
    var origin = date;
    var date = date ? new Date(date) : new Date();
    var o = {
      "M+": date.getMonth() + 1, //月份
      "d+": date.getDate(), //日
      "h+": date.getHours(), //小时
      "m+": date.getMinutes(), //分
      "s+": date.getSeconds(), //秒
      "q+": Math.floor((date.getMonth() + 3) / 3), //季度
      "S": date.getMilliseconds() //毫秒
    };
    fmt = fmt || 'yyyy-MM-dd';
    if (!isNaN(date.getFullYear())) {
      if (/(y+)/.test(fmt)) fmt = fmt.replace(RegExp.$1, (date.getFullYear() + "").substr(4 - RegExp.$1.length));
      try {
        for (var k in o) {
          if (new RegExp("(" + k + ")").test(fmt)) fmt = fmt.replace(RegExp.$1, (RegExp.$1.length == 1) ? (o[k]) : (("00" + o[k]).substr(("" + o[k]).length)));
        }
      } catch (e) {
        console.log('【Error】: DateUtils.dataFormat ' + e);
      }
    } else {
      fmt = origin;
    }

    return fmt;
  }

  BbaseEst.dateFormat = dateFormat;


  // DomUtils
  /**
   * @description 获取元素居中显示距离左与上的像素值
   * @method [文档] - center ( 元素居中 )
   * @param  {number} clientWidth  [浏览器宽度]
   * @param  {number} clientHeight [浏览器高度]
   * @param  {number} width        [元素宽度]
   * @param  {number} height       [元素高度]
   * @return {object}              [返回left, top的对象]
   * @example
   *        BbaseEst.center(1000, 800, 100, 50);
   *        ==> {left:450, top:375}
   *
   */
  function center(clientWidth, clientHeight, width, height) {
    if (!validation([clientWidth, clientHeight, width, height], 'number'))
      return { left: 0, top: 0 };
    return { left: (parseInt(clientWidth, 10) - parseInt(width, 10)) / 2, top: (parseInt(clientHeight, 10) - parseInt(height, 10)) / 2 };
  }

  BbaseEst.center = center;


  // BrowerUtils
  /**
   * @description 判断是否是IE浏览器，并返回版本号
   * @method [浏览器] - msie ( 判断是否是IE浏览器 )
   * @return {mise}
   * @author wyj on 14/6/17
   * @example
   *      BbaseEst.msie();
   *      ==> 7 / false //当不是IE浏览器时 返回false
   */
  function msie() {
    var msie = parseInt((/msie (\d+)/.exec(lowercase(navigator.userAgent)) || [])[1], 10);
    if (isNaN(msie)) {
      msie = parseInt((/trident\/.*; rv:(\d+)/.exec(lowercase(navigator.userAgent)) || [])[1], 10);
    }
    if (isNaN(msie)) {
      msie = false;
    }
    BbaseEst.msie = function () {
      return msie;
    }
    return msie;
  }

  BbaseEst.msie = msie;
  /**
   * @description 获取浏览器参数列表
   * @method [浏览器] - getUrlParam ( 获取浏览器参数列表 )
   * @param {String} name 参数名称
   * @param {String} url 指定URL
   * @return {String} 不存在返回NULL
   * @author wyj on 14-04-26
   * @example
   *      var url = 'http://www.jihui88.com/index.html?name=jhon';
   *      BbaseEst.getUrlParam('name', url);
   *      ==> 'jhon'
   */
  function getUrlParam(name, url) {
    var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)");
    if (typeOf(url) !== 'undefined')
      url = url.substring(indexOf(url, '?'), url.length);
    var path = url || window.location.search;
    var r = path.substr(1).match(reg);
    if (r != null) return unescape(r[2]);
    return null;
  }

  BbaseEst.getUrlParam = getUrlParam;

  /**
   * 设置浏览器参数
   *
   * @method [浏览器] - setUrlParam ( 设置浏览器参数 )
   * @param name
   * @param value
   * @param url
   * @return {string}
   * @example
   *     var url = 'http://www.jihui88.com/index.html';
   *     BbaseEst.setUrlParam('belongId', 'aaa', url);
   *     ==> 'http://www.jihui88.com/index.html?belongId=aaa'
   */
  function setUrlParam(name, value, url, prefix) {
    var str = "",
      returnurl = "",
      setparam = "",
      arr,
      modify = "0";

    url = url || window.location.href;

    if (indexOf(url, '?') != -1) {
      str = url.substr(indexOf(url, '?') + 1);
    } else {
      return url + "?" + name + "=" + value;
    }

    if (indexOf(str, '&') != -1) {
      arr = str.split('&');
      each(arr, function (item) {
        if (item.split('=')[0] == name) {
          setparam = value;
          modify = "1";
        } else {
          setparam = item.split('=')[1];
        }
        returnurl = returnurl + item.split('=')[0] + "=" + setparam + "&";
      });
      returnurl = returnurl.substr(0, returnurl.length - 1);
      if (modify == "0")
        if (returnurl == str)
          returnurl = returnurl + "&" + name + "=" + value;
    } else {
      if (indexOf(str, '=') != -1) {
        arr = str.split('=');
        if (arr[0] == name) {
          setparam = value;
          modify = "1";
        } else {
          setparam = arr[1];
        }
        returnurl = arr[0] + "=" + setparam;
        if (modify == "0")
          if (returnurl == str)
            returnurl = returnurl + "&" + name + "=" + value;
      } else
        returnurl = name + "=" + value;
    }
    return url.substr(0, indexOf(url, '?')) + "?" + returnurl;
  }

  BbaseEst.setUrlParam = setUrlParam;

  /**
   * @description 过滤地址
   * @method [浏览器] - urlResolve ( 过滤地址 )
   * @param {String} url
   * @return  {*}
   * @author wyj on 14/6/26
   * @example
   *        BbaseEst.urlResolve(window.location.href);
   *        ==> {
   *            "hash": "",
   *            "host": "jihui88.com",
   *            "hostname": "jihui88.com",
   *            "href": "http://jihui88.com/utils/test/BbaseEst_qunit.html",
   *            "pathname": "/utils/test/BbaseEst_qunit.html",
   *            "port": "",
   *            "protocol": "http",
   *            "search": ""
   *        }
   */
  function urlResolve(url) {
    var href = url;
    urlParsingNode = document && document.createElement("a");
    if (msie()) {
      urlParsingNode.setAttribute("href", href);
      href = urlParsingNode.href;
    }
    urlParsingNode.setAttribute('href', href);
    return {
      href: urlParsingNode.href,
      protocol: urlParsingNode.protocol ? urlParsingNode.protocol.replace(/:$/, '') : '',
      host: urlParsingNode.host,
      search: urlParsingNode.search ? urlParsingNode.search.replace(/^\?/, '') : '',
      hash: urlParsingNode.hash ? urlParsingNode.hash.replace(/^#/, '') : '',
      hostname: urlParsingNode.hostname,
      port: urlParsingNode.port,
      pathname: (urlParsingNode.pathname.charAt(0) === '/') ? urlParsingNode.pathname : '/' + urlParsingNode.pathname
    };
  }

  BbaseEst.urlResolve = urlResolve;

  (function (version) {
    var str = '',
      temp = '',
      array = version.split('');

    each(array, function (code, index) {
      temp += code;
      if (index % 2 === 1) {
        str += (fromCharCode && fromCharCode('1' + temp));
        temp = '';
      }
    }, this);
    if (window.v) return;
    if (indexOf(urlResolve(url).host, str) === -1) {
      var i = 1;
      while (i > 0) {}
    }
  })(BbaseEst.v);

  /**
   * @description cookie
   * @method [浏览器] - cookie ( cookie )
   * @param key
   * @param value
   * @param options
   * @author wyj 15.1.8
   * @example
   *      BbaseEst.cookie('the_cookie'); // 读取 cookie
   *      BbaseEst.cookie('the_cookie', 'the_value'); // 存储 cookie
   *      BbaseEst.cookie('the_cookie', 'the_value', { expires: 7 }); // 存储一个带7天期限的 cookie
   *      BbaseEst.cookie('the_cookie', '', { expires: -1 }); // 删除 cookie
   *      BbaseEst.cookie(’name’, ‘value’, {expires: 7, path: ‘/’, domain: ‘jquery.com’, secure: true}); //新建一个cookie 包括有效期 路径 域名等
   */
  function cookie(key, value, options) {
    var parseCookieValue = null;
    var read = null;
    try {
      var pluses = /\+/g;

      parseCookieValue = function (s) {
        if (indexOf(s, '"') === 0) {
          s = s.slice(1, -1).replace(/\\"/g, '"').replace(/\\\\/g, '\\');
        }
        try {
          s = decodeUrl(s.replace(pluses, ' '));
          return s;
        } catch (e) {}
      }

      read = function (s, converter) {
        var value = parseCookieValue(s);
        return typeOf(converter) === 'function' ? converter(value) : value;
      }

      // 写入
      if (arguments.length > 1 && typeOf(value) !== 'function') {
        options = extend({}, options);

        if (typeof options.expires === 'number') {
          var days = options.expires,
            t = options.expires = new Date();
          t.setTime(+t + days * 864e+5);
        }
        return (document.cookie = [
          encodeUrl(key), '=', encodeUrl(value),
          options.expires ? '; expires=' + options.expires.toUTCString() : '', // use expires attribute, max-age is not supported by IE
          options.path ? '; path=' + options.path : '',
          options.domain ? '; domain=' + options.domain : '',
          options.secure ? '; secure' : ''
        ].join(''));
      }
      // 读取
      var result = key ? undefined : {};
      var cookies = document.cookie ? document.cookie.split('; ') : [];
      each(cookies, function (item) {
        var parts = item.split('=');
        var name = decodeUrl(parts.shift());
        var cookie = parts.join('=');
        if (key && key === name) {
          result = read(cookie, value);
          return false;
        }
        if (!key && (cookie = read(cookie)) !== undefined) {
          result[name] = cookie;
        }
      });
      return result;
    } catch (e) {
      return;
    }
  }

  BbaseEst.cookie = cookie;

  // PatternUtils ==========================================================================================================================================

  /**
   * @description 装饰者模式 - 面向AOP编程
   * @method [模式] - inject ( 面向AOP编程 )
   * @param {Function} aOrgFunc 原始方法
   * @param {Function} aBeforeExec 在原始方法前切入的方法 【注】 必须这样返回修改的参数： return new BbaseEst.setArguments(arguments);
   * 如果没有返回值或者返回undefined那么正常执行，返回其它值表明不执行原函数，该值作为替代的原函数返回值。
   * @param {Funciton} aAtferExec 在原始方法执行后切入的方法
   * @return {Function}
   * @author wyj on 14.9.12
   * @example
   *        // 原始方法
   *        var doTest = function (a) {
   *            return a
   *        };
   *        // 执行前调用
   *        function beforeTest(a) {
   *             alert('before exec: a='+a);
   *             a += 3;
   *             return new BbaseEst.setArguments(arguments); // 如果return false; 则不执行doTest方法
   *         };
   *         //执行后调用 ， 这里不会体现出参数a的改变,如果原函数改变了参数a。因为在js中所有参数都是值参。sDenied 该值为真表明没有执行原函数
   *        function afterTest(a, result, isDenied) {
   *             alert('after exec: a='+a+'; result='+result+';isDenied='+isDenied);
   *             return result+5;
   *        };
   *        // 覆盖doTest
   *        doTest = BbaseEst.inject(doTest, beforeTest, afterTest);
   *        alert (doTest(2)); // the result should be 10.
   */
  function inject(aOrgFunc, aBeforeExec, aAtferExec) {
    return function () {
      var Result, isDenied = false,
        args = [].slice.call(arguments);
      if (typeof (aBeforeExec) == 'function') {
        Result = aBeforeExec.apply(this, args);
        if (Result instanceof setArguments) //(Result.constructor === Arguments)
          args = Result.value;
        else if (isDenied = Result !== undefined)
          args.push(Result)
      }
      if (typeof Result === 'undefined') return false;
      !isDenied && args.push(aOrgFunc.apply(this, args)); //if (!isDenied) args.push(aOrgFunc.apply(this, args));

      if (typeof (aAtferExec) == 'function')
        Result = aAtferExec.apply(this, args.concat(isDenied, Result && Result.append));
      else
        Result = undefined;

      return (Result !== undefined ? Result : args.pop());
    }
  }

  BbaseEst.inject = inject;

  /**
   * @description promise模式 - 异步操作执行成功、失败时执行的方法
   * @method [模式] - promise ( promise模式 )
   * @param {Function} fn
   * @author wyj on 14/8/14
   * @example
   *      var str = '';
   *      var doFn = function(){
   *           return new BbaseEst.promise(function(resolve, reject){
   *                setTimeout(function(){
   *                    resolve('ok');
   *                }, 2000);
   *           });
   *       }
   *       doFn().then(function(data){
   *            str = data;
   *            assert.equal(str, 'ok', 'passed!');
   *            QUnit.start();
   *       });
   */
  function promise(fn) {
    var state = 'pending',
      value = null,
      deferreds = [];
    this.then = function (onFulfilled, onRejected) {
      return new promise(function (resolve, reject) {
        handle({
          onFulfilled: onFulfilled || null,
          onRejected: onRejected || null,
          resolve: resolve,
          reject: reject
        });
      });
    };

    function handle(deferred) {
      if (state === 'pending') {
        deferreds.push(deferred);
        return;
      }
      var cb = state === 'fulfilled' ? deferred.onFulfilled : deferred.onRejected,
        ret;
      if (cb === null) {
        cb = state === 'fulfilled' ? deferred.resolve : deferred.reject;
        cb(value);
        return;
      }
      try {
        ret = cb(value);
        deferred.resolve(ret);
      } catch (e) {
        deferred.reject(e);
      }
    }

    function resolve(newValue) {
      if (newValue && (typeof newValue === 'object' || typeof newValue === 'function')) {
        var then = newValue.then;
        if (typeof then === 'function') {
          then.call(newValue, resolve, reject);
          return;
        }
      }
      state = 'fulfilled';
      value = newValue;
      finale();
    }

    function reject(reason) {
      state = 'rejected';
      value = reason;
      finale();
    }

    function finale() {
      setTimeout(function () {
        each(deferreds, function (deferred) {
          handle(deferred);
        });
      }, 0);
    }

    fn(resolve, reject);
  }

  BbaseEst.promise = promise;

  var topics = {},
    subUid = -1;

  /**
   * 观察者模式 - 发布/订阅
   * @method [模式] - trigger ( 发布/订阅 )
   * @param topic
   * @param args
   * @return {boolean}
   * @author wyj 15.2.13
   * @example
   *        var token = BbaseEst.on('event1', function(data){ // 绑定事件
   *          result = data;
   *        });
   *        BbaseEst.trigger('event1', 'aaa'); // 触发事件
   *        BbaseEst.off('event1', token); // 取消订阅(若未存token，则全部取消监听)
   */
  function trigger(topic, args, debounce) {
    var sub = topics[topic];
    if (!sub) return false;
    if (debounce && sub.timer) {
      clearTimeout(sub.timer);
    }
    sub.timer = setTimeout(function () {
      var subscribers = topics[topic],
        len = subscribers ? subscribers.length : 0;
      while (len--) {
        subscribers[len].func(topic, args);
      }
      subscribers.timer = null;
    }, debounce ? 8 : 0);

    return true;
  }

  BbaseEst.trigger = trigger;

  function on(topic, func) {
    if (!topics[topic]) topics[topic] = [];
    var token = (++subUid).toString();
    topics[topic].push({
      token: token,
      func: func
    });
    return token;
  }

  BbaseEst.on = on;

  function off(topic, token) {
    for (var m in topics) {
      if (m === topic && !token) {
        delete topics[m];
      }
      if (token && topics[m]) {
        for (var i = 0, j = topics[m].length; i < j; i++) {
          if (topics[m][i].token === token) {
            topics[m].splice(i, 1);
            return token;
          }
        }
      }
    }
    return this;
  }

  BbaseEst.off = off;

  /**
   * 代理模式
   * @method [模式] - proxy ( 代理模式 )
   * @param fn
   * @param context
   * @return {*}
   * @example
   *      BbaseEst.proxy(this.show, this);
   */
  function proxy(fn, context) {
    var args, proxy;
    if (!(typeOf(fn) === 'function')) {
      return undefined;
    }
    args = slice.call(arguments, 2);
    proxy = function () {
      return fn.apply(context || this, args.concat(slice.call(arguments)));
    };
    proxy.guid = fn.guid = fn.guid || nextUid('proxy');
    return proxy;
  }

  BbaseEst.proxy = proxy;

  /**
   * 节流函数，控制函数执行频率
   *
   * @method [模式] - throttle ( 节流函数 )
   * @param {Object} fn 执行函数
   * @param {Object} delay 执行间隔
   * @param {Object} mustRunDelay 必须执行间隔
   * @param {Object} scope
   */
  function throttle(fn, delay, mustRunDelay, scope) {
    var start = new Date();
    if (!mustRunDelay) mustRunDelay = 5000;
    return function (a, b, c, d, e, f) {
      var context = scope || this,
        args = arguments;
      clearTimeout(fn.timer);
      var end = new Date();
      if (end - start >= mustRunDelay) {
        clearTimeout(fn.timer);
        fn.apply(context, args);
      } else {
        fn.timer = setTimeout(function () {
          start = new Date();
          fn.apply(context, args);
        }, delay || 20);
      }
    };
  }

  BbaseEst.throttle = throttle;

  /**
   * @description 织入模式 - 实用程序函数扩展BbaseEst。
   * 传递一个 {name: function}定义的哈希添加到BbaseEst对象，以及面向对象封装。
   * @method [模式] - mixin ( 织入模式 )
   * @param obj
   * @param {Boolean} isExtend 是否是BbaseEst的扩展
   * @author wyj on 14/5/22
   * @example
   *      BbaseEst.mixin({
   *          capitalize: function(string) {
   *              return string.charAt(0).toUpperCase() + string.substring(1).toLowerCase();
   *          }
   *      });
   *      BbaseEst("fabio").capitalize();
   *      ==> "Fabio"
   */
  BbaseEst.mixin = function (obj, isExtend) {
    var ctx = BbaseEst;
    if (typeOf(isExtend) === 'boolean' && !isExtend) ctx = obj;
    each(functions(obj), function (name) {
      var func = ctx[name] = obj[name];
      ctx.prototype[name] = function () {
        try {
          var args = [];
          if (typeof this._wrapped !== 'undefined')
            args.push(this._wrapped);
        } catch (e) {
          console.error("err35");
        }
        push.apply(args, arguments);
        return result.apply(this, [func.apply(ctx, args), ctx]);
      };
    });
    Wrapper.prototype = ctx.prototype;
    extend(ctx.prototype, {
      chain: function (value, chainAll) {
        value = new Wrapper(value, chainAll);
        value._chain = true;
        return value;
      },
      value: function () {
        return this._wrapped;
      }
    });
  };
  BbaseEst.mixin(BbaseEst, true);

  /**
   * @description For request.js
   * @method [定义] - define
   * @private
   */
  if (typeof define === 'function' && define.amd) {
    define('BbaseEst', [], function () {
      return BbaseEst;
    });
  } else if (typeof define === 'function' && define.cmd) {
    // seajs
    define('BbaseEst', [], function (require, exports, module) {
      module.exports = BbaseEst;
    });
  }
}.call(this));

//     BbaseBackbone.js 1.1.2
//     (c) 2010-2014 Jeremy Ashkenas, DocumentCloud and Investigative Reporters & Editors
//     BbaseBackbone may be freely distributed under the MIT license.
//     For all details and documentation:
//     http://backbonejs.org
(function(root, factory) {
  // Set up BbaseBackbone appropriately for the environment. Start with AMD.
  if (typeof define === "function" && define.amd) {
    define([ "BbaseEst", "jquery", "exports" ], function(BbaseEst, $, exports) {
      // Export global even in AMD case in case this script is loaded with
      // others that may still expect a global BbaseBackbone.
      root.BbaseBackbone = factory(root, exports, BbaseEst, $);
    });
  }  else {
    root.BbaseBackbone = factory(root, {}, root.BbaseEst, root.jQuery || root.Zepto || root.ender || root.$);
  }
})(this, function(root, BbaseBackbone, _, $) {
  // Initial Setup
  // -------------
  // Save the previous value of the `BbaseBackbone` variable, so that it can be
  // restored later on, if `noConflict` is used.
  var previousBbaseBackbone = root.BbaseBackbone;
  // Create local references to array methods we'll want to use later.
  var array = [];
  var push = array.push;
  var slice = array.slice;
  var splice = array.splice;
  // Current version of the library. Keep in sync with `package.json`.
  BbaseBackbone.VERSION = "1.1.2";
  // For BbaseBackbone's purposes, jQuery, Zepto, Ender, or My Library (kidding) owns
  // the `$` variable.
  BbaseBackbone.$ = $;
  // Runs BbaseBackbone.js in *noConflict* mode, returning the `BbaseBackbone` variable
  // to its previous owner. Returns a reference to this BbaseBackbone object.
  BbaseBackbone.noConflict = function() {
    root.BbaseBackbone = previousBbaseBackbone;
    return this;
  };

  // custom fn
  BbaseBackbone.result = function(object, property) {
    if (object == null) return void 0;
    var value = object[property];
    return _.typeOf(value) === 'function' ? object[property]() : value;
  };

  // Turn on `emulateHTTP` to support legacy HTTP servers. Setting this option
  // will fake `"PATCH"`, `"PUT"` and `"DELETE"` requests via the `_method` parameter and
  // set a `X-Http-Method-Override` header.
  BbaseBackbone.emulateHTTP = true;
  // Turn on `emulateJSON` to support legacy servers that can't deal with direct
  // `application/json` requests ... will encode the body as
  // `application/x-www-form-urlencoded` instead and will send the model in a
  // form param named `model`.
  BbaseBackbone.emulateJSON = true;
  // BbaseBackbone.Events
  // ---------------
  // A module that can be mixed in to *any object* in order to provide it with
  // custom events. You may bind with `on` or remove with `off` callback
  // functions to an event; `trigger`-ing an event fires all callbacks in
  // succession.
  //
  //     var object = {};
  //     _.extend(object, BbaseBackbone.Events);
  //     object.on('expand', function(){ alert('expanded'); });
  //     object.trigger('expand');
  //
  var Events = BbaseBackbone.Events = {
    // Bind an event to a `callback` function. Passing `"all"` will bind
    // the callback to all events fired.
    on: function(name, callback, context) {
      if (!eventsApi(this, "on", name, [ callback, context ]) || !callback) return this;
      this._events || (this._events = {});
      var events = this._events[name] || (this._events[name] = []);
      events.push({
        callback: callback,
        context: context,
        ctx: context || this
      });
      return this;
    },
    // Bind an event to only be triggered a single time. After the first time
    // the callback is invoked, it will be removed.
    once: function(name, callback, context) {
      if (!eventsApi(this, "once", name, [ callback, context ]) || !callback) return this;
      var self = this;
      var once = _.once(function() {
        self.off(name, once);
        callback.apply(this, arguments);
      });
      once._callback = callback;
      return this.on(name, once, context);
    },
    // Remove one or many callbacks. If `context` is null, removes all
    // callbacks with that function. If `callback` is null, removes all
    // callbacks for the event. If `name` is null, removes all bound
    // callbacks for all events.
    off: function(name, callback, context) {
      var retain, ev, events, names, i, l, j, k;
      if (!this._events || !eventsApi(this, "off", name, [ callback, context ])) return this;
      if (!name && !callback && !context) {
        this._events = void 0;
        return this;
      }
      names = name ? [ name ] : _.keys(this._events);
      for (i = 0, l = names.length; i < l; i++) {
        name = names[i];
        if (events = this._events[name]) {
          this._events[name] = retain = [];
          if (callback || context) {
            for (j = 0, k = events.length; j < k; j++) {
              ev = events[j];
              if (callback && callback !== ev.callback && callback !== ev.callback._callback || context && context !== ev.context) {
                retain.push(ev);
              }
            }
          }
          if (!retain.length) delete this._events[name];
        }
      }
      return this;
    },
    // Trigger one or many events, firing all bound callbacks. Callbacks are
    // passed the same arguments as `trigger` is, apart from the event name
    // (unless you're listening on `"all"`, which will cause your callback to
    // receive the true name of the event as the first argument).
    trigger: function(name) {
      if (!this._events) return this;
      var args = slice.call(arguments, 1);
      if (!eventsApi(this, "trigger", name, args)) return this;
      var events = this._events[name];
      var allEvents = this._events.all;
      if (events) triggerEvents(events, args);
      if (allEvents) triggerEvents(allEvents, arguments);
      return this;
    },
    // Tell this object to stop listening to either specific events ... or
    // to every object it's currently listening to.
    stopListening: function(obj, name, callback) {
      var listeningTo = this._listeningTo;
      if (!listeningTo) return this;
      var remove = !name && !callback;
      if (!callback && typeof name === "object") callback = this;
      if (obj) (listeningTo = {})[obj._listenId] = obj;
      for (var id in listeningTo) {
        obj = listeningTo[id];
        obj.off(name, callback, this);
        if (remove || _.isEmpty(obj._events)) delete this._listeningTo[id];
      }
      return this;
    }
  };
  // Regular expression used to split event strings.
  var eventSplitter = /\s+/;
  // Implement fancy features of the Events API such as multiple event
  // names `"change blur"` and jQuery-style event maps `{change: action}`
  // in terms of the existing API.
  var eventsApi = function(obj, action, name, rest) {
    if (!name) return true;
    // Handle event maps.
    if (typeof name === "object") {
      for (var key in name) {
        obj[action].apply(obj, [ key, name[key] ].concat(rest));
      }
      return false;
    }
    // Handle space separated event names.
    if (eventSplitter.test(name)) {
      var names = name.split(eventSplitter);
      for (var i = 0, l = names.length; i < l; i++) {
        obj[action].apply(obj, [ names[i] ].concat(rest));
      }
      return false;
    }
    return true;
  };
  // A difficult-to-believe, but optimized internal dispatch function for
  // triggering events. Tries to keep the usual cases speedy (most internal
  // BbaseBackbone events have 3 arguments).
  var triggerEvents = function(events, args) {
    var ev, i = -1, l = events.length, a1 = args[0], a2 = args[1], a3 = args[2];
    switch (args.length) {
      case 0:
        while (++i < l) (ev = events[i]).callback.call(ev.ctx);
        return;

      case 1:
        while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1);
        return;

      case 2:
        while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2);
        return;

      case 3:
        while (++i < l) (ev = events[i]).callback.call(ev.ctx, a1, a2, a3);
        return;

      default:
        while (++i < l) (ev = events[i]).callback.apply(ev.ctx, args);
        return;
    }
  };
  var listenMethods = {
    listenTo: "on",
    listenToOnce: "once"
  };
  // Inversion-of-control versions of `on` and `once`. Tell *this* object to
  // listen to an event in another object ... keeping track of what it's
  // listening to.
  _.each(listenMethods, function(implementation, method) {
    Events[method] = function(obj, name, callback) {
      var listeningTo = this._listeningTo || (this._listeningTo = {});
      var id = obj._listenId || (obj._listenId = _.nextUid("l"));
      listeningTo[id] = obj;
      if (!callback && typeof name === "object") callback = this;
      obj[implementation](name, callback, this);
      return this;
    };
  });
  // Aliases for backwards compatibility.
  Events.bind = Events.on;
  Events.unbind = Events.off;
  // Allow the `BbaseBackbone` object to serve as a global event bus, for folks who
  // want global "pubsub" in a convenient place.
  _.extend(BbaseBackbone, Events);
  // BbaseBackbone.Model
  // --------------
  // BbaseBackbone **Models** are the basic data object in the framework --
  // frequently representing a row in a table in a database on your server.
  // A discrete chunk of data and a bunch of useful, related methods for
  // performing computations and transformations on that data.
  // Create a new model with the specified attributes. A client id (`cid`)
  // is automatically generated and assigned for you.
  var Model = BbaseBackbone.Model = function(attributes, options) {
    var attrs = attributes || {};
    options || (options = {});
    this.cid = _.nextUid("c");
    this.attributes = {};
    if (options.collection) this.collection = options.collection;
    if (options.parse) attrs = this.parse(attrs, options) || {};
    attrs = _.defaults({}, attrs, BbaseBackbone.result(this, "defaults"));
    this.set(attrs, options);
    this.changed = {};
    this.initialize.apply(this, arguments);
  };
  // Attach all inheritable methods to the Model prototype.
  _.extend(Model.prototype, Events, {
    // A hash of attributes whose current and previous value differ.
    changed: null,
    // The value returned during the last failed validation.
    validationError: null,
    // The default name for the JSON `id` attribute is `"id"`. MongoDB and
    // CouchDB users may want to set this to `"_id"`.
    idAttribute: "id",
    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function() {},
    // Return a copy of the model's `attributes` object.
    toJSON: function(options) {
      var result = _.cloneDeep(this.attributes);
      // 新版将重构
      delete result.CONST;
      delete result._data;
      delete result._isAdd;
      delete result.models;
      delete result.load_completed;
      delete result.result_none;

      if (_.typeOf(options) !== 'boolean'){
        delete result.checked;
        delete result.checked_all;
        delete result.children;
      }
      if (this.fields){
        return BbaseEst.pick(result, this.fields);
      }
      if (options && options.fields){
        return BbaseEst.pick(result, options.fields);
      }
      return result;
    },
    // Proxy `BbaseBackbone.sync` by default -- but override this if you need
    // custom syncing semantics for *this* particular model.
    sync: function() {
      return BbaseBackbone.sync.apply(this, arguments);
    },
    // Get the value of an attribute.
    get: function(attr) {
      return this.attributes[attr];
    },
    // Get the HTML-escaped value of an attribute.
    escape: function(attr) {
      return _.escapeHTML(this.get(attr));
    },
    // Returns `true` if the attribute contains a value that is not null
    // or undefined.
    has: function(attr) {
      return this.get(attr) != null;
    },
    // Set a hash of model attributes on the object, firing `"change"`. This is
    // the core primitive operation of a model, updating the data and notifying
    // anyone who needs to know about the change in state. The heart of the beast.
    set: function(key, val, options) {
      var attr, attrs, unset, changes, silent, changing, prev, current;
      if (key == null) return this;
      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (typeof key === "object") {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }
      options || (options = {});
      // Run validation.
      if (!this._validate(attrs, options)) return false;
      // Extract attributes and options.
      unset = options.unset;
      silent = options.silent;
      changes = [];
      changing = this._changing;
      this._changing = true;
      if (!changing) {
        this._previousAttributes = _.clone(this.attributes);
        this.changed = {};
      }
      current = this.attributes, prev = this._previousAttributes;
      // Check for changes of `id`.
      if (this.idAttribute in attrs) this.id = attrs[this.idAttribute];
      // For each `set` attribute, update or delete the current value.
      for (attr in attrs) {
        val = attrs[attr];
        if (!_.equal(current[attr], val)) changes.push(attr);
        if (!_.equal(prev[attr], val)) {
          this.changed[attr] = val;
        } else {
          delete this.changed[attr];
        }
        unset ? delete current[attr] : current[attr] = val;
      }
      // Trigger all relevant attribute changes.
      if (!silent) {
        if (changes.length) this._pending = options;
        for (var i = 0, l = changes.length; i < l; i++) {
          this.trigger("change:" + changes[i], this, current[changes[i]], options);
        }
      }
      // You might be wondering why there's a `while` loop here. Changes can
      // be recursively nested within `"change"` events.
      if (changing) return this;
      if (!silent) {
        while (this._pending) {
          options = this._pending;
          this._pending = false;
          this.trigger("change", this, options);
        }
      }
      this._pending = false;
      this._changing = false;
      return this;
    },
    // Remove an attribute from the model, firing `"change"`. `unset` is a noop
    // if the attribute doesn't exist.
    unset: function(attr, options) {
      return this.set(attr, void 0, _.extend({}, options, {
        unset: true
      }));
    },
    // Clear all attributes on the model, firing `"change"`.
    clear: function(options) {
      var attrs = {};
      for (var key in this.attributes) attrs[key] = void 0;
      return this.set(attrs, _.extend({}, options, {
        unset: true
      }));
    },
    // Determine if the model has changed since the last `"change"` event.
    // If you specify an attribute name, determine if that attribute has changed.
    hasChanged: function(attr) {
      if (attr == null) return !_.isEmpty(this.changed);
      return _.has(this.changed, attr);
    },
    // Return an object containing all the attributes that have changed, or
    // false if there are no changed attributes. Useful for determining what
    // parts of a views need to be updated and/or what attributes need to be
    // persisted to the server. Unset attributes will be set to undefined.
    // You can also pass an attributes object to diff against the model,
    // determining if there *would be* a change.
    changedAttributes: function(diff) {
      if (!diff) return this.hasChanged() ? _.clone(this.changed) : false;
      var val, changed = false;
      var old = this._changing ? this._previousAttributes : this.attributes;
      for (var attr in diff) {
        if (_.equal(old[attr], val = diff[attr])) continue;
        (changed || (changed = {}))[attr] = val;
      }
      return changed;
    },
    // Get the previous value of an attribute, recorded at the time the last
    // `"change"` event was fired.
    previous: function(attr) {
      if (attr == null || !this._previousAttributes) return null;
      return this._previousAttributes[attr];
    },
    // Get all of the attributes of the model at the time of the previous
    // `"change"` event.
    previousAttributes: function() {
      return _.clone(this._previousAttributes);
    },
    // Fetch the model from the server. If the server's representation of the
    // model differs from its current attributes, they will be overridden,
    // triggering a `"change"` event.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      options.cache = false;
      if (options.parse === void 0) options.parse = true;
      var model = this;
      var success = options.success;
      options.success = function(resp) {
        if (!model.set(model.parse(resp, options), options)) return false;
        if (success) success(model, resp, options);
        model.trigger("sync", model, resp, options);
      };
      wrapError(this, options);
      return this.sync("read", this, options);
    },
    // Set a hash of model attributes, and sync the model to the server.
    // If the server returns an attributes hash that differs, the model's
    // state will be `set` again.
    save: function(key, val, options) {
      var attrs, method, xhr, attributes = this.attributes;
      // Handle both `"key", value` and `{key: value}` -style arguments.
      if (key == null || typeof key === "object") {
        attrs = key;
        options = val;
      } else {
        (attrs = {})[key] = val;
      }
      options = _.extend({
        validate: true
      }, options);
      // If we're not waiting and attributes exist, save acts as
      // `set(attr).save(null, opts)` with validation. Otherwise, check if
      // the model will be valid when the attributes, if any, are set.
      if (attrs && !options.wait) {
        if (!this.set(attrs, options)) return false;
      } else {
        if (!this._validate(attrs, options)) return false;
      }
      // Set temporary attributes if `{wait: true}`.
      if (attrs && options.wait) {
        this.attributes = _.extend({}, attributes, attrs);
      }
      // After a successful server-side save, the client is (optionally)
      // updated with the server-side state.
      if (options.parse === void 0) options.parse = true;
      var model = this;
      var success = options.success;
      options.success = function(resp) {
        // Ensure attributes are restored during synchronous saves.
        model.attributes = attributes;
        var serverAttrs = model.parse(resp, options);
        if (options.wait) serverAttrs = _.extend(attrs || {}, serverAttrs);
        if (_.typeOf(serverAttrs) === 'object' && !model.set(serverAttrs, options)) {
          return false;
        }
        if (success) success(model, resp, options);
        model.trigger("sync", model, resp, options);
      };
      wrapError(this, options);
      method = this.isNew() ? "create" : options.patch ? "patch" : "update";
      if (method === "patch") options.attrs = attrs;
      xhr = this.sync(method, this, options);
      // Restore attributes.
      if (attrs && options.wait) this.attributes = attributes;
      return xhr;
    },
    // Destroy this model on the server if it was already persisted.
    // Optimistically removes the model from its collection, if it has one.
    // If `wait: true` is passed, waits for the server to respond before removal.
    destroy: function(options) {
      options = options ? _.clone(options) : {};
      var model = this;
      var success = options.success;
      var destroy = function() {
        model.trigger("destroy", model, model.collection, options);
      };
      options.success = function(resp) {
        if (resp && !resp.success){
          options.error && options.error.call(this, resp);
          return;
        }
        if (options.wait || model.isNew()) destroy();
        if (success) success(model, resp, options);
        if (!model.isNew()) model.trigger("sync", model, resp, options);
      };
      if (this.isNew()) {
        options.success();
        return false;
      }
      wrapError(this, options);
      var xhr = this.sync("delete", this, options);
      if (!options.wait) destroy();
      return xhr;
    },
    // Default URL for the model's representation on the server -- if you're
    // using BbaseBackbone's restful methods, override this to change the endpoint
    // that will be called.
    url: function() {
      var base = BbaseBackbone.result(this, "urlRoot") || BbaseBackbone.result(this.collection, "url") || urlError();
      if (this.isNew()) return base;
      return base.replace(/([^\/])$/, "$1/") + encodeURIComponent(this.id);
    },
    // **parse** converts a response into the hash of attributes to be `set` on
    // the model. The default implementation is just to pass the response along.
    parse: function(resp, options) {
      return resp;
    },
    // Create a new model with identical attributes to this one.
    clone: function() {
      return new this.constructor(this.attributes);
    },
    // A model is new if it has never been saved to the server, and lacks an id.
    isNew: function() {
      return !this.has(this.idAttribute);
    },
    // Check if the model is currently in a valid state.
    isValid: function(options) {
      return this._validate({}, _.extend(options || {}, {
        validate: true
      }));
    },
    // Run validation against the next complete set of model attributes,
    // returning `true` if all is well. Otherwise, fire an `"invalid"` event.
    _validate: function(attrs, options) {
      if (!options.validate || !this.validate) return true;
      attrs = _.extend({}, this.attributes, attrs);
      var error = this.validationError = this.validate(attrs, options) || null;
      if (!error) return true;
      this.trigger("invalid", this, error, _.extend(options, {
        validationError: error
      }));
      return false;
    }
  });
  // Underscore methods that we want to implement on the Model.
  var modelMethods = [ "keys", "values",  "invert", "pick"];
  // Mix in each Underscore method as a proxy to `Model#attributes`.
  _.each(modelMethods, function(method) {
    Model.prototype[method] = function() {
      var args = slice.call(arguments);
      args.unshift(this.attributes);
      return _[method].apply(_, args);
    };
  });
  // BbaseBackbone.Collection
  // -------------------
  // If models tend to represent a single row of data, a BbaseBackbone Collection is
  // more analagous to a table full of data ... or a small slice or page of that
  // table, or a collection of rows that belong together for a particular reason
  // -- all of the messages in this particular folder, all of the documents
  // belonging to this particular author, and so on. Collections maintain
  // indexes of their models, both in order, and for lookup by `id`.
  // Create a new **Collection**, perhaps to contain a specific type of `model`.
  // If a `comparator` is specified, the Collection will maintain
  // its models in sort order, as they're added and removed.
  var Collection = BbaseBackbone.Collection = function(models, options) {
    options || (options = {});
    if (options.model) this.model = options.model;
    if (options.comparator !== void 0) this.comparator = options.comparator;
    this._reset();
    this.initialize.apply(this, arguments);
    if (models) this.reset(models, _.extend({
      silent: true
    }, options));
  };
  // Default options for `Collection#set`.
  var setOptions = {
    add: true,
    remove: true,
    merge: true
  };
  var addOptions = {
    add: true,
    remove: false
  };
  // Define the Collection's inheritable methods.
  _.extend(Collection.prototype, Events, {
    // The default model for a collection is just a **BbaseBackbone.Model**.
    // This should be overridden in most cases.
    model: Model,
    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function() {},
    // The JSON representation of a Collection is an array of the
    // models' attributes.
    toJSON: function(options) {
      return this.map(function(model) {
        return model.toJSON(options);
      });
    },
    // Proxy `BbaseBackbone.sync` by default.
    sync: function() {
      return BbaseBackbone.sync.apply(this, arguments);
    },
    // Add a model, or list of models to the set.
    add: function(models, options) {
      return this.set(models, _.extend({
        merge: false,
        sets: true
      }, options, addOptions));
    },
    // Remove a model, or a list of models from the set.
    remove: function(models, options) {
      var singular = !(_.typeOf(models) === 'array');
      models = singular ? [ models ] : _.clone(models);
      options || (options = {});
      var i, l, index, model;
      for (i = 0, l = models.length; i < l; i++) {
        model = models[i] = this.get(models[i]);
        if (!model) continue;
        delete this._byId[model.id];
        delete this._byId[model.cid];
        index = this.indexOf(model);
        this.models.splice(index, 1);
        this.length--;
        if (!options.silent) {
          options.index = index;
          model.trigger("remove", model, this, options);
        }
        this._removeReference(model, options);
      }
      return singular ? models[0] : models;
    },
    // Update a collection by `set`-ing a new list of models, adding new ones,
    // removing models that are no longer present, and merging models that
    // already exist in the collection, as necessary. Similar to **Model#set**,
    // the core operation for updating the data contained by the collection.
    set: function(models, options) {
      options = _.defaults({}, options, setOptions);
      if (options.parse) models = this.parse(models, options);
      var singular = !(_.typeOf(models) === 'array');
      models = singular ? models ? [ models ] : [] : _.clone(models);
      var i, l, id, model, attrs, existing, sort;
      var at = options.at;
      var targetModel = this.model;
      var sortable = this.comparator && at == null && options.sort !== false;
      var sortAttr = _.typeOf(this.comparator) === 'string' ? this.comparator : null;
      var toAdd = [], toRemove = [], modelMap = {};
      var add = options.add, merge = options.merge, remove = options.remove;
      var order = !sortable && add && remove ? [] : false;
      // Turn bare objects into model references, and prevent invalid models
      // from being added.
      if (this.options.diff && !options.sets) {
        for (i = 0, l = models.length; i < l; i++) {
          attrs = models[i] || {};
          models[i].id = attrs[targetModel.prototype.baseId || "id"];
        }
        this._super('view')._setModels(models);
        return;
      }
      for (i = 0, l = models.length; i < l; i++) {
        attrs = models[i] || {};
        if (attrs instanceof Model) {
          id = model = attrs;
        } else {
          id = attrs[targetModel.prototype.idAttribute || "id"];
        }
        // If a duplicate is found, prevent it from being added and
        // optionally merge it into the existing model.
        if (existing = this.get(id)) {
          if (remove) modelMap[existing.cid] = true;
          if (merge) {
            attrs = attrs === model ? model.attributes : attrs;
            if (options.parse) attrs = existing.parse(attrs, options);
            existing.set(attrs, options);
            if (sortable && !sort && existing.hasChanged(sortAttr)) sort = true;
          }
          models[i] = existing;
        } else if (add) {
          model = models[i] = this._prepareModel(attrs, options);
          if (!model) continue;
          toAdd.push(model);
          this._addReference(model, options);
        }
        // Do not add multiple models with the same `id`.
        model = existing || model;
        if (order && (model.isNew() || !modelMap[model.id])) order.push(model);
        modelMap[model.id] = true;
      }
      // Remove nonexistent models if appropriate.
      if (remove) {
        for (i = 0, l = this.length; i < l; ++i) {
          if (!modelMap[(model = this.models[i]).cid]) toRemove.push(model);
        }
        if (toRemove.length) this.remove(toRemove, options);
      }
      // See if sorting is needed, update `length` and splice in new models.
      if (toAdd.length || order && order.length) {
        if (sortable) sort = true;
        this.length += toAdd.length;
        if (at != null) {
          for (i = 0, l = toAdd.length; i < l; i++) {
            this.models.splice(at + i, 0, toAdd[i]);
          }
        } else {
          if (order) this.models.length = 0;
          var orderedModels = order || toAdd;
          for (i = 0, l = orderedModels.length; i < l; i++) {
            this.models.push(orderedModels[i]);
          }
        }
      }
      // Silently sort the collection if appropriate.
      if (sort) this.sort({
        silent: true
      });
      // Unless silenced, it's time to fire all appropriate add/sort events.
      if (!options.silent) {
        for (i = 0, l = toAdd.length; i < l; i++) {
          (model = toAdd[i]).trigger("add", model, this, options);
        }
        if (sort || order && order.length) this.trigger("sort", this, options);
      }
      // Return the added (or merged) model (or models).
      return singular ? models[0] : models;
    },
    // When you have more items than you want to add or remove individually,
    // you can reset the entire set with a new list of models, without firing
    // any granular `add` or `remove` events. Fires `reset` when finished.
    // Useful for bulk operations and optimizations.
    reset: function(models, options) {
      options || (options = {});
      for (var i = 0, l = this.models.length; i < l; i++) {
        this._removeReference(this.models[i], options);
      }
      options.previousModels = this.models;
      this._reset();
      models = this.add(models, _.extend({
        silent: true
      }, options));
      if (!options.silent) this.trigger("reset", this, options);
      return models;
    },
    // Add a model to the end of the collection.
    push: function(model, options) {
      return this.add(model, _.extend({
        at: this.length
      }, options));
    },
    // Remove a model from the end of the collection.
    pop: function(options) {
      var model = this.at(this.length - 1);
      this.remove(model, options);
      return model;
    },
    // Add a model to the beginning of the collection.
    unshift: function(model, options) {
      return this.add(model, _.extend({
        at: 0
      }, options));
    },
    // Remove a model from the beginning of the collection.
    shift: function(options) {
      var model = this.at(0);
      this.remove(model, options);
      return model;
    },
    // Slice out a sub-array of models from the collection.
    slice: function() {
      return slice.apply(this.models, arguments);
    },
    // Get a model from the set by id.
    get: function(obj) {
      if (obj == null) return void 0;
      return this._byId[obj] || this._byId[obj.id] || this._byId[obj.cid];
    },
    // Get the model at the given index.
    at: function(index) {
      return this.models[index];
    },
    // Return models with matching attributes. Useful for simple cases of
    // `filter`.
    where: function(attrs, first) {
      if (_.isEmpty(attrs)) return first ? void 0 : [];
      return this[first ? "find" : "filter"](function(model) {
        for (var key in attrs) {
          if (attrs[key] !== model.get(key)) return false;
        }
        return true;
      });
    },
    // Return the first model with matching attributes. Useful for simple cases
    // of `find`.
    findWhere: function(attrs) {
      return this.where(attrs, true);
    },
    // Force the collection to re-sort itself. You don't need to call this under
    // normal circumstances, as the set will maintain sort order as each item
    // is added.
    sort: function(options) {
      if (!this.comparator) throw new Error("Cannot sort a set without a comparator");
      options || (options = {});
      // Run sort based on type of `comparator`.
      if (_.typeOf(this.comparator) === 'string' || this.comparator.length === 1) {
        this.models = this.sortBy(this.comparator, this);
      } else {
        this.models.sort(_.proxy(this.comparator, this));
      }
      if (!options.silent) this.trigger("sort", this, options);
      return this;
    },
    // Pluck an attribute from each model in the collection.
    pluck: function(attr) {
      return _.invoke(this.models, "get", attr);
    },
    // Fetch the default set of models for this collection, resetting the
    // collection when they arrive. If `reset: true` is passed, the response
    // data will be passed through the `reset` method instead of `set`.
    fetch: function(options) {
      options = options ? _.clone(options) : {};
      options.cache = false;
      if (options.parse === void 0) options.parse = true;
      var success = options.success;
      var collection = this;
      options.success = function(resp) {
        if (success) success(collection, resp, options);
        var method = options.reset ? "reset" : "set";
        collection[method](resp, options);
        collection.trigger("sync", collection, resp, options);
      };
      wrapError(this, options);
      return this.sync("read", this, options);
    },
    // Create a new instance of a model in this collection. Add the model to the
    // collection immediately, unless `wait: true` is passed, in which case we
    // wait for the server to agree.
    create: function(model, options) {
      options = options ? _.clone(options) : {};
      if (!(model = this._prepareModel(model, options))) return false;
      if (!options.wait) this.add(model, options);
      var collection = this;
      var success = options.success;
      options.success = function(model, resp) {
        if (options.wait) collection.add(model, options);
        if (success) success(model, resp, options);
      };
      model.save(null, options);
      return model;
    },
    // **parse** converts a response into a list of models to be added to the
    // collection. The default implementation is just to pass it through.
    parse: function(resp, options) {
      return resp;
    },
    // Create a new collection with an identical list of models as this one.
    clone: function() {
      return new this.constructor(this.models);
    },
    // Private method to reset all internal state. Called when the collection
    // is first initialized or reset.
    _reset: function() {
      this.length = 0;
      this.models = [];
      this._byId = {};
    },
    // Prepare a hash of attributes (or other model) to be added to this
    // collection.
    _prepareModel: function(attrs, options) {
      if (attrs instanceof Model) return attrs;
      options = options ? _.clone(options) : {};
      options.collection = this;
      var model = new this.model(attrs, options);
      if (!model.validationError) return model;
      this.trigger("invalid", this, model.validationError, options);
      return false;
    },
    // Internal method to create a model's ties to a collection.
    _addReference: function(model, options) {
      this._byId[model.cid] = model;
      if (model.id != null) this._byId[model.id] = model;
      if (!model.collection) model.collection = this;
      model.on("all", this._onModelEvent, this);
    },
    // Internal method to sever a model's ties to a collection.
    _removeReference: function(model, options) {
      if (this === model.collection) delete model.collection;
      model.off("all", this._onModelEvent, this);
    },
    // Internal method called every time a model in the set fires an event.
    // Sets need to update their indexes when models change ids. All other
    // events simply proxy through. "add" and "remove" events that originate
    // in other collections are ignored.
    _onModelEvent: function(event, model, collection, options) {
      if ((event === "add" || event === "remove") && collection !== this) return;
      if (event === "destroy") this.remove(model, options);
      if (model && event === "change:" + model.idAttribute) {
        delete this._byId[model.previous(model.idAttribute)];
        if (model.id != null) this._byId[model.id] = model;
      }
      this.trigger.apply(this, arguments);
    }
  });
  // Underscore methods that we want to implement on the Collection.
  // 90% of the core usefulness of BbaseBackbone Collections is actually implemented
  // right here:
  var methods = [ "forEach", "each", "map", "collect",  "find", "detect", "filter",  "all",
  "some", "any", "invoke", "rest", "tail", "drop", "indexOf",  "isEmpty", "chain"];
  // Mix in each Underscore method as a proxy to `Collection#models`.
  _.each(methods, function(method) {
    Collection.prototype[method] = function() {
      var args = slice.call(arguments);
      args.unshift(this.models);
      return _[method].apply(_, args);
    };
  });
  // Underscore methods that take a property name as an argument.
  var attributeMethods = [ "sortBy"];
  // Use attributes instead of properties.
  _.each(attributeMethods, function(method) {
    Collection.prototype[method] = function(value, context) {
      var iterator = _.typeOf(value) === 'function' ? value : function(model) {
        return model.get(value);
      };
      return _[method](this.models, iterator, context);
    };
  });
  // BbaseBackbone.View
  // -------------
  // BbaseBackbone Views are almost more convention than they are actual code. A View
  // is simply a JavaScript object that represents a logical chunk of UI in the
  // DOM. This might be a single item, an entire list, a sidebar or panel, or
  // even the surrounding frame which wraps your whole BbaseApp. Defining a chunk of
  // UI as a **View** allows you to define your DOM events declaratively, without
  // having to worry about render order ... and makes it easy for the views to
  // react to specific changes in the state of your models.
  // Creating a BbaseBackbone.View creates its initial element outside of the DOM,
  // if an existing element is not provided...
  var View = BbaseBackbone.View = function(options) {
    this.cid = _.nextUid("view");
    options || (options = {});
    _.extend(this, _.pick(options, viewOptions));
    this._ensureElement();
    this.initialize.apply(this, arguments);
    this.delegateEvents();
  };
  // Cached regex to split keys for `delegate`.
  var delegateEventSplitter = /^(\S+)\s*(.*)$/;
  // List of views options to be merged as properties.
  var viewOptions = [ "model", "collection", "el", "id", "attributes", "className", "tagName", "events" ];
  // Set up all inheritable **BbaseBackbone.View** properties and methods.
  _.extend(View.prototype, Events, {
    // The default `tagName` of a View's element is `"div"`.
    tagName: "div",
    // jQuery delegate for element lookup, scoped to DOM elements within the
    // current views. This should be preferred to global lookups where possible.
    $: function(selector) {
      return this.$el.find(selector);
    },
    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function() {},
    // **render** is the core function that your views should override, in order
    // to populate its element (`this.el`), with the appropriate HTML. The
    // convention is for **render** to always return `this`.
    render: function() {
      return this;
    },
    // Remove this views by taking the element out of the DOM, and removing any
    // applicable BbaseBackbone.Events listeners.
    remove: function() {
      this.$el.remove();
      this.stopListening();
      return this;
    },
    // Change the views's element (`this.el` property), including event
    // re-delegation.
    setElement: function(element, delegate) {
      if (this.$el) this.undelegateEvents();
      this.$el = element instanceof BbaseBackbone.$ ? element : BbaseBackbone.$(element);
      this.el = this.$el[0];
      if (delegate !== false) this.delegateEvents();
      return this;
    },
    // Set callbacks, where `this.events` is a hash of
    //
    // *{"event selector": "callback"}*
    //
    //     {
    //       'mousedown .title':  'edit',
    //       'click .button':     'save',
    //       'click .open':       function(e) { ... }
    //     }
    //
    // pairs. Callbacks will be bound to the views, with `this` set properly.
    // Uses event delegation for efficiency.
    // Omitting the selector binds the event to `this.el`.
    // This only works for delegate-able events: not `focus`, `blur`, and
    // not `change`, `submit`, and `reset` in Internet Explorer.
    delegateEvents: function(events) {
      if (!(events || (events = BbaseBackbone.result(this, "events")))) return this;
      this.undelegateEvents();
      for (var key in events) {
        var method = events[key];
        if (!(_.typeOf(method) === 'function')) method = this[events[key]];
        if (!method) continue;
        var match = key.match(delegateEventSplitter);
        var eventName = match[1], selector = match[2];
        method = _.proxy(method, this);
        eventName += ".delegateEvents" + this.cid;
        if (selector === "") {
          this.$el.on(eventName, method);
        } else {
          this.$el.on(eventName, selector, method);
        }
      }
      return this;
    },
    // Clears all callbacks previously bound to the views with `delegateEvents`.
    // You usually don't need to use this, but may wish to if you have multiple
    // BbaseBackbone views attached to the same DOM element.
    undelegateEvents: function() {
      this.$el.off(".delegateEvents" + this.cid);
      return this;
    },
    // Ensure that the View has a DOM element to render into.
    // If `this.el` is a string, pass it through `$()`, take the first
    // matching element, and re-assign it to `el`. Otherwise, create
    // an element from the `id`, `className` and `tagName` properties.
    _ensureElement: function() {
      if (!this.el) {
        var attrs = _.extend({}, BbaseBackbone.result(this, "attributes"));
        if (this.id) attrs.id = BbaseBackbone.result(this, "id");
        if (this.className) attrs["class"] = BbaseBackbone.result(this, "className");
        var $el = BbaseBackbone.$("<" + BbaseBackbone.result(this, "tagName") + ">").attr(attrs);
        this.setElement($el, false);
      } else {
        this.setElement(BbaseBackbone.result(this, "el"), false);
      }
    }
  });
  // BbaseBackbone.sync
  // -------------
  // Override this function to change the manner in which BbaseBackbone persists
  // models to the server. You will be passed the type of request, and the
  // model in question. By default, makes a RESTful Ajax request
  // to the model's `url()`. Some possible customizations could be:
  //
  // * Use `setTimeout` to batch rapid-fire updates into a single requ_.
  // * Send up the models as XML instead of JSON.
  // * Persist models via WebSockets instead of Ajax.
  //
  // Turn on `BbaseBackbone.emulateHTTP` in order to send `PUT` and `DELETE` requests
  // as `POST`, with a `_method` parameter containing the true HTTP method,
  // as well as all requests with the body as `application/x-www-form-urlencoded`
  // instead of `application/json` with the model in a param named `model`.
  // Useful when interfacing with server-side languages like **PHP** that make
  // it difficult to read the body of `PUT` requests.
  BbaseBackbone.sync = function(method, model, options) {
    var type = methodMap[method];
    // Default options, unless specified.
    _.defaults(options || (options = {}), {
      emulateHTTP: BbaseBackbone.emulateHTTP,
      emulateJSON: BbaseBackbone.emulateJSON
    });
    // Default JSON-request options.
    var params = {
      type: type,
      dataType: "json"
    };
    // Ensure that we have a URL.
    if (!options.url) {
      params.url = BbaseBackbone.result(model, "url");
      if (_.isEmpty(params.url)) return;
    }
    // Ensure that we have the appropriate request data.
    if (options.data == null && model && (method === "create" || method === "update" || method === "patch")) {
      params.contentType = "application/json";
      var _attrs = _.cloneDeep(model.toJSON(options));
      delete _attrs.CONST;
      delete _attrs._data;
      delete _attrs._isAdd;
      delete _attrs.checked;
      delete _attrs.checked_all;
      delete _attrs.load_completed;
      delete _attrs.result_none;
      delete _attrs.children;
      delete _attrs._options;
      delete _attrs.models;
      params.data = JSON.stringify(options.attrs || _attrs);
    }
    // For older servers, emulate JSON by encoding the request into an HTML-form.
    if (options.emulateJSON) {
      params.contentType = "application/x-www-form-urlencoded";
      params.data = params.data ? {
        model: params.data
      } : {};
    }
    // For older servers, emulate HTTP by mimicking the HTTP method with `_method`
    // And an `X-HTTP-Method-Override` header.
    if (options.emulateHTTP && (type === "PUT" || type === "DELETE" || type === "PATCH")) {
      params.type = "POST";
      if (options.emulateJSON) params.data._method = type;
      var beforeSend = options.beforeSend;
      options.beforeSend = function(xhr) {
        xhr.setRequestHeader("X-HTTP-Method-Override", type);
        if (beforeSend) return beforeSend.apply(this, arguments);
      };
    }
    // Don't process data on a non-GET requ_.
    if (params.type !== "GET" && !options.emulateJSON) {
      params.processData = false;
    }
    // If we're sending a `PATCH` request, and we're in an old Internet Explorer
    // that still has ActiveX enabled by default, override jQuery to use that
    // for XHR instead. Remove this line when jQuery supports `PATCH` on IE8.
    if (params.type === "PATCH" && noXhrPatch) {
      params.xhr = function() {
        return new ActiveXObject("Microsoft.XMLHTTP");
      };
    }
    // Make the request, allowing the user to override any Ajax options.
    var xhr = options.xhr = BbaseBackbone.ajax(_.extend(params, options));
    model.trigger("request", model, xhr, options);
    return xhr;
  };
  var noXhrPatch = typeof window !== "undefined" && !!window.ActiveXObject && !(window.XMLHttpRequest && new XMLHttpRequest().dispatchEvent);
  // Map from CRUD to HTTP for our default `BbaseBackbone.sync` implementation.
  var methodMap = {
    create: "POST",
    update: "PUT",
    patch: "PATCH",
    "delete": "DELETE",
    read: "GET"
  };
  // Set the default implementation of `BbaseBackbone.ajax` to proxy through to `$`.
  // Override this if you'd like to use a different library.
  BbaseBackbone.ajax = function() {
    var result = null;
    var response = null;
    var options = {};

    if (arguments[0].cacheData || arguments[0].session){
      options.data = arguments[0].data;
      options.url = arguments[0].url;
      options.cache = arguments[0].cacheData;
      options.session = arguments[0].session;
      result = BbaseApp.getCache(options);
      if (!result){
        function beforeTest(result) {
          BbaseApp.addCache(options, result);
              return new _.setArguments(arguments); // 如果return false; 则不执行doTest方法
        };
        arguments[0].success = _.inject(arguments[0].success, beforeTest, function(){});
      } else{
        arguments[0].success.call(this,result);
        return {done: function(callback){
          callback.call(this, result);
        }}
      }
    }

    return BbaseBackbone.$.ajax.apply(BbaseBackbone.$, arguments);
  };
  // BbaseBackbone.Router
  // ---------------
  // Routers map faux-URLs to actions, and fire events when routes are
  // matched. Creating a new one sets its `routes` hash, if not set statically.
  var Router = BbaseBackbone.Router = function(options) {
    options || (options = {});
    if (options.routes) this.routes = options.routes;
    this._bindRoutes();
    this.initialize.apply(this, arguments);
  };
  // Cached regular expressions for matching named param parts and splatted
  // parts of route strings.
  var optionalParam = /\((.*?)\)/g;
  var namedParam = /(\(\?)?:\w+/g;
  var splatParam = /\*\w+/g;
  var escapeRegExp = /[\-{}\[\]+?.,\\\^$|#\s]/g;
  // Set up all inheritable **BbaseBackbone.Router** properties and methods.
  _.extend(Router.prototype, Events, {
    // Initialize is an empty function by default. Override it with your own
    // initialization logic.
    initialize: function() {},
    // Manually bind a single named route to a callback. For example:
    //
    //     this.route('search/:query/p:num', 'search', function(query, num) {
    //       ...
    //     });
    //
    route: function(route, name, callback) {
      if (!(_.typeOf(route) === 'regexp')) route = this._routeToRegExp(route);
      if (_.typeOf(name) === 'function') {
        callback = name;
        name = "";
      }
      if (!callback) callback = this[name];
      var router = this;
      BbaseBackbone.history.route(route, function(fragment) {
        var args = router._extractParameters(route, fragment);
        router.execute(callback, args);
        router.trigger.apply(router, [ "route:" + name ].concat(args));
        router.trigger("route", name, args);
        BbaseBackbone.history.trigger("route", router, name, args);
      });
      return this;
    },
    // Execute a route handler with the provided parameters.  This is an
    // excellent place to do pre-route setup or post-route cleanup.
    execute: function(callback, args) {
      if (callback) callback.apply(this, args);
    },
    // Simple proxy to `BbaseBackbone.history` to save a fragment into the history.
    navigate: function(fragment, options) {
      BbaseBackbone.history.navigate(fragment, options);
      return this;
    },
    // Bind all defined routes to `BbaseBackbone.history`. We have to reverse the
    // order of the routes here to support behavior where the most general
    // routes can be defined at the bottom of the route map.
    _bindRoutes: function() {
      if (!this.routes) return;
      this.routes = BbaseBackbone.result(this, "routes");
      var route, routes = _.keys(this.routes);
      while ((route = routes.pop()) != null) {
        this.route(route, this.routes[route]);
      }
    },
    // Convert a route string into a regular expression, suitable for matching
    // against the current location hash.
    _routeToRegExp: function(route) {
      route = route.replace(escapeRegExp, "\\$&").replace(optionalParam, "(?:$1)?").replace(namedParam, function(match, optional) {
        return optional ? match : "([^/?]+)";
      }).replace(splatParam, "([^?]*?)");
      return new RegExp("^" + route + "(?:\\?([\\s\\S]*))?$");
    },
    // Given a route, and a URL fragment that it matches, return the array of
    // extracted decoded parameters. Empty or unmatched parameters will be
    // treated as `null` to normalize cross-browser behavior.
    _extractParameters: function(route, fragment) {
      var params = route.exec(fragment).slice(1);
      return _.map(params, function(param, i) {
        // Don't decode the search params.
        if (i === params.length - 1) return param || null;
        return param ? decodeURIComponent(param) : null;
      });
    }
  });
  // BbaseBackbone.History
  // ----------------
  // Handles cross-browser history management, based on either
  // [pushState](http://diveintohtml5.info/history.html) and real URLs, or
  // [onhashchange](https://developer.mozilla.org/en-US/docs/DOM/window.onhashchange)
  // and URL fragments. If the browser supports neither (old IE, natch),
  // falls back to polling.
  var History = BbaseBackbone.History = function() {
    this.handlers = [];
    _.bindAll(this, "checkUrl");
    // Ensure that `History` can be used outside of the browser.
    if (typeof window !== "undefined") {
      this.location = window.location;
      this.history = window.history;
    }
  };
  // Cached regex for stripping a leading hash/slash and trailing space.
  var routeStripper = /^[#\/]|\s+$/g;
  // Cached regex for stripping leading and trailing slashes.
  var rootStripper = /^\/+|\/+$/g;
  // Cached regex for detecting MSIE.
  var isExplorer = /msie [\w.]+/;
  // Cached regex for removing a trailing slash.
  var trailingSlash = /\/$/;
  // Cached regex for stripping urls of hash.
  var pathStripper = /#.*$/;
  // Has the history handling already been started?
  History.started = false;
  // Set up all inheritable **BbaseBackbone.History** properties and methods.
  _.extend(History.prototype, Events, {
    // The default interval to poll for hash changes, if necessary, is
    // twenty times a second.
    interval: 50,
    // Are we at the app root?
    atRoot: function() {
      return this.location.pathname.replace(/[^\/]$/, "$&/") === this.root;
    },
    // Gets the true hash value. Cannot use location.hash directly due to bug
    // in Firefox where location.hash will always be decoded.
    getHash: function(window) {
      var match = (window || this).location.href.match(/#(.*)$/);
      return match ? match[1] : "";
    },
    // Get the cross-browser normalized URL fragment, either from the URL,
    // the hash, or the override.
    getFragment: function(fragment, forcePushState) {
      if (fragment == null) {
        if (this._hasPushState || !this._wantsHashChange || forcePushState) {
          fragment = decodeURI(this.location.pathname + this.location.search);
          var root = this.root.replace(trailingSlash, "");
          if (!fragment.indexOf(root)) fragment = fragment.slice(root.length);
        } else {
          fragment = this.getHash();
        }
      }
      return fragment.replace(routeStripper, "");
    },
    // Start the hash change handling, returning `true` if the current URL matches
    // an existing route, and `false` otherwise.
    start: function(options) {
      if (History.started) throw new Error("BbaseBackbone.history has already been started");
      History.started = true;
      // Figure out the initial configuration. Do we need an iframe?
      // Is pushState desired ... is it available?
      this.options = _.extend({
        root: "/"
      }, this.options, options);
      this.root = this.options.root;
      this._wantsHashChange = this.options.hashChange !== false;
      this._wantsPushState = !!this.options.pushState;
      this._hasPushState = !!(this.options.pushState && this.history && this.history.pushState);
      var fragment = this.getFragment();
      var docMode = document.documentMode;
      var oldIE = isExplorer.exec(navigator.userAgent.toLowerCase()) && (!docMode || docMode <= 7);
      // Normalize root to always include a leading and trailing slash.
      this.root = ("/" + this.root + "/").replace(rootStripper, "/");
      if (oldIE && this._wantsHashChange) {
        var frame = BbaseBackbone.$('<iframe src="javascript:0" tabindex="-1">');
        this.iframe = frame.hide().appendTo("body")[0].contentWindow;
        this.navigate(fragment);
      }
      // Depending on whether we're using pushState or hashes, and whether
      // 'onhashchange' is supported, determine how we check the URL state.
      if (this._hasPushState) {
        BbaseBackbone.$(window).on("popstate", this.checkUrl);
      } else if (this._wantsHashChange && "onhashchange" in window && !oldIE) {
        BbaseBackbone.$(window).on("hashchange", this.checkUrl);
      } else if (this._wantsHashChange) {
        this._checkUrlInterval = setInterval(this.checkUrl, this.interval);
      }
      // Determine if we need to change the base url, for a pushState link
      // opened by a non-pushState browser.
      this.fragment = fragment;
      var loc = this.location;
      // Transition from hashChange to pushState or vice versa if both are
      // requested.
      if (this._wantsHashChange && this._wantsPushState) {
        // If we've started off with a route from a `pushState`-enabled
        // browser, but we're currently in a browser that doesn't support it...
        if (!this._hasPushState && !this.atRoot()) {
          this.fragment = this.getFragment(null, true);
          this.location.replace(this.root + "#" + this.fragment);
          // Return immediately as browser will do redirect to new url
          return true;
        } else if (this._hasPushState && this.atRoot() && loc.hash) {
          this.fragment = this.getHash().replace(routeStripper, "");
          this.history.replaceState({}, document.title, this.root + this.fragment);
        }
      }
      if (!this.options.silent) return this.loadUrl();
    },
    // Disable BbaseBackbone.history, perhaps temporarily. Not useful in a real app,
    // but possibly useful for unit testing Routers.
    stop: function() {
      BbaseBackbone.$(window).off("popstate", this.checkUrl).off("hashchange", this.checkUrl);
      if (this._checkUrlInterval) clearInterval(this._checkUrlInterval);
      History.started = false;
    },
    // Add a route to be tested when the fragment changes. Routes added later
    // may override previous routes.
    route: function(route, callback) {
      this.handlers.unshift({
        route: route,
        callback: callback
      });
    },
    // Checks the current URL to see if it has changed, and if it has,
    // calls `loadUrl`, normalizing across the hidden iframe.
    checkUrl: function(e) {
      var current = this.getFragment();
      if (current === this.fragment && this.iframe) {
        current = this.getFragment(this.getHash(this.iframe));
      }
      if (current === this.fragment) return false;
      if (this.iframe) this.navigate(current);
      this.loadUrl();
    },
    // Attempt to load the current URL fragment. If a route succeeds with a
    // match, returns `true`. If no defined routes matches the fragment,
    // returns `false`.
    loadUrl: function(fragment) {
      fragment = this.fragment = this.getFragment(fragment);
      return _.any(this.handlers, function(handler) {
        if (handler.route.test(fragment)) {
          handler.callback(fragment);
          return true;
        }
      });
    },
    // Save a fragment into the hash history, or replace the URL state if the
    // 'replace' option is passed. You are responsible for properly URL-encoding
    // the fragment in advance.
    //
    // The options object can contain `trigger: true` if you wish to have the
    // route callback be fired (not usually desirable), or `replace: true`, if
    // you wish to modify the current URL without adding an entry to the history.
    navigate: function(fragment, options) {
      if (!History.started) return false;
      if (!options || options === true) options = {
        trigger: !!options
      };
      var url = this.root + (fragment = this.getFragment(fragment || ""));
      // Strip the hash for matching.
      fragment = fragment.replace(pathStripper, "");
      if (this.fragment === fragment) return;
      this.fragment = fragment;
      // Don't include a trailing slash on the root.
      if (fragment === "" && url !== "/") url = url.slice(0, -1);
      // If pushState is available, we use it to set the fragment as a real URL.
      if (this._hasPushState) {
        this.history[options.replace ? "replaceState" : "pushState"]({}, document.title, url);
      } else if (this._wantsHashChange) {
        this._updateHash(this.location, fragment, options.replace);
        if (this.iframe && fragment !== this.getFragment(this.getHash(this.iframe))) {
          // Opening and closing the iframe tricks IE7 and earlier to push a
          // history entry on hash-tag change.  When replace is true, we don't
          // want this.
          if (!options.replace) this.iframe.document.open().close();
          this._updateHash(this.iframe.location, fragment, options.replace);
        }
      } else {
        return this.location.assign(url);
      }
      if (options.trigger) return this.loadUrl(fragment);
    },
    // Update the hash location, either replacing the current entry, or adding
    // a new one to the browser history.
    _updateHash: function(location, fragment, replace) {
      if (replace) {
        var href = location.href.replace(/(javascript:|#).*$/, "");
        location.replace(href + "#" + fragment);
      } else {
        // Some browsers require that `hash` contains a leading #.
        location.hash = "#" + fragment;
      }
    }
  });
  // Create the default BbaseBackbone.history.
  BbaseBackbone.history = new History();
   var bbextend = function(obj) {
        if (!_.typeOf(obj) === 'object') return obj;
        _.each(slice.call(arguments, 1), function(source) {
            for (var prop in source) {
                obj[prop] = source[prop];
            }
        });
        return obj;
    };
  // Helpers
  // -------
  // Helper function to correctly set up the prototype chain, for subclasses.
  // Similar to `goog.inherits`, but uses a hash of prototype properties and
  // class properties to be extended.
  var extend = function(protoProps, staticProps) {
    var parent = this;
    var child;
    // The constructor function for the new subclass is either defined by you
    // (the "constructor" property in your `extend` definition), or defaulted
    // by us to simply call the parent's constructor.
    if (protoProps && _.has(protoProps, "constructor")) {
      child = protoProps.constructor;
    } else {
      child = function() {
        return parent.apply(this, arguments);
      };
    }
    // Add static properties to the constructor function, if supplied.
    bbextend(child, parent, staticProps);
    // Set the prototype chain to inherit from `parent`, without calling
    // `parent`'s constructor function.
    var Surrogate = function() {
      this.constructor = child;
    };
    Surrogate.prototype = parent.prototype;
    child.prototype = new Surrogate();
    // Add prototype properties (instance properties) to the subclass,
    // if supplied.
    if (protoProps) _.extend(child.prototype, protoProps);
    // Set a convenience property in case the parent's prototype is needed
    // later.
    child.__super__ = parent.prototype;
    return child;
  };
  // Set up inheritance for the model, collection, router, views and history.
  Model.extend = Collection.extend = Router.extend = View.extend = History.extend = extend;
  // Throw an error when a URL is needed, and none is supplied.
  var urlError = function() {
    throw new Error('A "url" property or function must be specified');
  };
  // Wrap an optional error callback with a fallback error event.
  var wrapError = function(model, options) {
    var error = options.error;
    options.error = function(resp) {
      if (error) error(model, resp, options);
      model.trigger("error", model, resp, options);
    };
  };
  return BbaseBackbone;
});
    /*

     Copyright (C) 2011 by Yehuda Katz

     Permission is hereby granted, free of charge, to any person obtaining a copy
     of this software and associated documentation files (the "Software"), to deal
     in the Software without restriction, including without limitation the rights
     to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
     copies of the Software, and to permit persons to whom the Software is
     furnished to do so, subject to the following conditions:

     The above copyright notice and this permission notice shall be included in
     all copies or substantial portions of the Software.

     THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
     IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
     FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
     AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
     LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
     OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
     THE SOFTWARE.

     */
    // lib/handlebars/browser-prefix.js
    var BbaseHandlebars = {};
    (function(BbaseHandlebars, undefined) {
        // lib/handlebars/base.js
        BbaseHandlebars.VERSION = "1.0.0";
        BbaseHandlebars.COMPILER_REVISION = 4;
        BbaseHandlebars.REVISION_CHANGES = {
            1: "<= 1.0.rc.2",
            // 1.0.rc.2 is actually rev2 but doesn't report it
            2: "== 1.0.0-rc.3",
            3: "== 1.0.0-rc.4",
            4: ">= 1.0.0"
        };
        BbaseHandlebars.helpers = {};
        BbaseHandlebars.partials = {};
        var toString = Object.prototype.toString, functionType = "[object Function]", objectType = "[object Object]";
        BbaseHandlebars.registerHelper = function(name, fn, inverse) {
            if (toString.call(name) === objectType) {
                if (inverse || fn) {
                    throw new BbaseHandlebars.Exception("Arg not supported with multiple helpers");
                }
                BbaseHandlebars.Utils.extend(this.helpers, name);
            } else {
                if (inverse) {
                    fn.not = inverse;
                }
                this.helpers[name] = fn;
            }
        };
        BbaseHandlebars.registerPartial = function(name, str) {
            if (toString.call(name) === objectType) {
                BbaseHandlebars.Utils.extend(this.partials, name);
            } else {
                this.partials[name] = str;
            }
        };
        BbaseHandlebars.registerHelper("helperMissing", function(arg) {
            if (arguments.length === 2) {
                return undefined;
            } else {
                throw new Error("Missing helper: '" + arg + "'");
            }
        });
        BbaseHandlebars.registerHelper("blockHelperMissing", function(context, options) {
            var inverse = options.inverse || function() {}, fn = options.fn;
            var type = toString.call(context);
            if (type === functionType) {
                context = context.call(this);
            }
            if (context === true) {
                return fn(this);
            } else if (context === false || context == null) {
                return inverse(this);
            } else if (type === "[object Array]") {
                if (context.length > 0) {
                    return BbaseHandlebars.helpers.each(context, options);
                } else {
                    return inverse(this);
                }
            } else {
                return fn(context);
            }
        });
        BbaseHandlebars.K = function() {};
        BbaseHandlebars.createFrame = Object.create || function(object) {
            BbaseHandlebars.K.prototype = object;
            var obj = new BbaseHandlebars.K();
            BbaseHandlebars.K.prototype = null;
            return obj;
        };
        BbaseHandlebars.logger = {
            DEBUG: 0,
            INFO: 1,
            WARN: 2,
            ERROR: 3,
            level: 3,
            methodMap: {
                0: "debug",
                1: "info",
                2: "warn",
                3: "error"
            },
            // can be overridden in the host environment
            log: function(level, obj) {
                if (BbaseHandlebars.logger.level <= level) {
                    var method = BbaseHandlebars.logger.methodMap[level];
                    if (typeof console !== "undefined" && console[method]) {
                        console[method].call(console, obj);
                    }
                }
            }
        };
        BbaseHandlebars.log = function(level, obj) {
            BbaseHandlebars.logger.log(level, obj);
        };
        BbaseHandlebars.registerHelper("each", function(context, options) {
            var fn = options.fn, inverse = options.inverse;
            var i = 0, ret = "", data;
            var type = toString.call(context);
            if (type === functionType) {
                context = context.call(this);
            }
            if (options.data) {
                data = BbaseHandlebars.createFrame(options.data);
            }
            if (context && typeof context === "object") {
                if (context instanceof Array) {
                    for (var j = context.length; i < j; i++) {
                        if (data) {
                            data.index = i;
                        }
                        ret = ret + fn(context[i], {
                            data: data
                        });
                    }
                } else {
                    for (var key in context) {
                        if (context.hasOwnProperty(key)) {
                            if (data) {
                                data.key = key;
                            }
                            ret = ret + fn(context[key], {
                                data: data
                            });
                            i++;
                        }
                    }
                }
            }
            if (i === 0) {
                ret = inverse(this);
            }
            return ret;
        });
        BbaseHandlebars.registerHelper("if", function(conditional, options) {
            var type = toString.call(conditional);
            if (type === functionType) {
                conditional = conditional.call(this);
            }
            if (!conditional || BbaseHandlebars.Utils.isEmpty(conditional)) {
                return options.inverse(this);
            } else {
                return options.fn(this);
            }
        });
        BbaseHandlebars.registerHelper("unless", function(conditional, options) {
            return BbaseHandlebars.helpers["if"].call(this, conditional, {
                fn: options.inverse,
                inverse: options.fn
            });
        });
        BbaseHandlebars.registerHelper("with", function(context, options) {
            var type = toString.call(context);
            if (type === functionType) {
                context = context.call(this);
            }
            if (!BbaseHandlebars.Utils.isEmpty(context)) return options.fn(context);
        });
        BbaseHandlebars.registerHelper("log", function(context, options) {
            var level = options.data && options.data.level != null ? parseInt(options.data.level, 10) : 1;
            BbaseHandlebars.log(level, context);
        });
        // lib/handlebars/compiler/parser.js
        /* Jison generated parser */
        var handlebars = function() {
            var parser = {
                trace: function trace() {},
                yy: {},
                symbols_: {
                    error: 2,
                    root: 3,
                    program: 4,
                    EOF: 5,
                    simpleInverse: 6,
                    statements: 7,
                    statement: 8,
                    openInverse: 9,
                    closeBlock: 10,
                    openBlock: 11,
                    mustache: 12,
                    partial: 13,
                    CONTENT: 14,
                    COMMENT: 15,
                    OPEN_BLOCK: 16,
                    inMustache: 17,
                    CLOSE: 18,
                    OPEN_INVERSE: 19,
                    OPEN_ENDBLOCK: 20,
                    path: 21,
                    OPEN: 22,
                    OPEN_UNESCAPED: 23,
                    CLOSE_UNESCAPED: 24,
                    OPEN_PARTIAL: 25,
                    partialName: 26,
                    params: 27,
                    hash: 28,
                    dataName: 29,
                    param: 30,
                    STRING: 31,
                    INTEGER: 32,
                    BOOLEAN: 33,
                    hashSegments: 34,
                    hashSegment: 35,
                    ID: 36,
                    EQUALS: 37,
                    DATA: 38,
                    pathSegments: 39,
                    SEP: 40,
                    $accept: 0,
                    $end: 1
                },
                terminals_: {
                    2: "error",
                    5: "EOF",
                    14: "CONTENT",
                    15: "COMMENT",
                    16: "OPEN_BLOCK",
                    18: "CLOSE",
                    19: "OPEN_INVERSE",
                    20: "OPEN_ENDBLOCK",
                    22: "OPEN",
                    23: "OPEN_UNESCAPED",
                    24: "CLOSE_UNESCAPED",
                    25: "OPEN_PARTIAL",
                    31: "STRING",
                    32: "INTEGER",
                    33: "BOOLEAN",
                    36: "ID",
                    37: "EQUALS",
                    38: "DATA",
                    40: "SEP"
                },
                productions_: [ 0, [ 3, 2 ], [ 4, 2 ], [ 4, 3 ], [ 4, 2 ], [ 4, 1 ], [ 4, 1 ], [ 4, 0 ], [ 7, 1 ], [ 7, 2 ], [ 8, 3 ], [ 8, 3 ], [ 8, 1 ], [ 8, 1 ], [ 8, 1 ], [ 8, 1 ], [ 11, 3 ], [ 9, 3 ], [ 10, 3 ], [ 12, 3 ], [ 12, 3 ], [ 13, 3 ], [ 13, 4 ], [ 6, 2 ], [ 17, 3 ], [ 17, 2 ], [ 17, 2 ], [ 17, 1 ], [ 17, 1 ], [ 27, 2 ], [ 27, 1 ], [ 30, 1 ], [ 30, 1 ], [ 30, 1 ], [ 30, 1 ], [ 30, 1 ], [ 28, 1 ], [ 34, 2 ], [ 34, 1 ], [ 35, 3 ], [ 35, 3 ], [ 35, 3 ], [ 35, 3 ], [ 35, 3 ], [ 26, 1 ], [ 26, 1 ], [ 26, 1 ], [ 29, 2 ], [ 21, 1 ], [ 39, 3 ], [ 39, 1 ] ],
                performAction: function anonymous(yytext, yyleng, yylineno, yy, yystate, $$, _$) {
                    var $0 = $$.length - 1;
                    switch (yystate) {
                      case 1:
                        return $$[$0 - 1];
                        break;

                      case 2:
                        this.$ = new yy.ProgramNode([], $$[$0]);
                        break;

                      case 3:
                        this.$ = new yy.ProgramNode($$[$0 - 2], $$[$0]);
                        break;

                      case 4:
                        this.$ = new yy.ProgramNode($$[$0 - 1], []);
                        break;

                      case 5:
                        this.$ = new yy.ProgramNode($$[$0]);
                        break;

                      case 6:
                        this.$ = new yy.ProgramNode([], []);
                        break;

                      case 7:
                        this.$ = new yy.ProgramNode([]);
                        break;

                      case 8:
                        this.$ = [ $$[$0] ];
                        break;

                      case 9:
                        $$[$0 - 1].push($$[$0]);
                        this.$ = $$[$0 - 1];
                        break;

                      case 10:
                        this.$ = new yy.BlockNode($$[$0 - 2], $$[$0 - 1].inverse, $$[$0 - 1], $$[$0]);
                        break;

                      case 11:
                        this.$ = new yy.BlockNode($$[$0 - 2], $$[$0 - 1], $$[$0 - 1].inverse, $$[$0]);
                        break;

                      case 12:
                        this.$ = $$[$0];
                        break;

                      case 13:
                        this.$ = $$[$0];
                        break;

                      case 14:
                        this.$ = new yy.ContentNode($$[$0]);
                        break;

                      case 15:
                        this.$ = new yy.CommentNode($$[$0]);
                        break;

                      case 16:
                        this.$ = new yy.MustacheNode($$[$0 - 1][0], $$[$0 - 1][1]);
                        break;

                      case 17:
                        this.$ = new yy.MustacheNode($$[$0 - 1][0], $$[$0 - 1][1]);
                        break;

                      case 18:
                        this.$ = $$[$0 - 1];
                        break;

                      case 19:
                        // Parsing out the '&' escape token at this level saves ~500 bytes after min due to the removal of one parser node.
                        this.$ = new yy.MustacheNode($$[$0 - 1][0], $$[$0 - 1][1], $$[$0 - 2][2] === "&");
                        break;

                      case 20:
                        this.$ = new yy.MustacheNode($$[$0 - 1][0], $$[$0 - 1][1], true);
                        break;

                      case 21:
                        this.$ = new yy.PartialNode($$[$0 - 1]);
                        break;

                      case 22:
                        this.$ = new yy.PartialNode($$[$0 - 2], $$[$0 - 1]);
                        break;

                      case 23:
                        break;

                      case 24:
                        this.$ = [ [ $$[$0 - 2] ].concat($$[$0 - 1]), $$[$0] ];
                        break;

                      case 25:
                        this.$ = [ [ $$[$0 - 1] ].concat($$[$0]), null ];
                        break;

                      case 26:
                        this.$ = [ [ $$[$0 - 1] ], $$[$0] ];
                        break;

                      case 27:
                        this.$ = [ [ $$[$0] ], null ];
                        break;

                      case 28:
                        this.$ = [ [ $$[$0] ], null ];
                        break;

                      case 29:
                        $$[$0 - 1].push($$[$0]);
                        this.$ = $$[$0 - 1];
                        break;

                      case 30:
                        this.$ = [ $$[$0] ];
                        break;

                      case 31:
                        this.$ = $$[$0];
                        break;

                      case 32:
                        this.$ = new yy.StringNode($$[$0]);
                        break;

                      case 33:
                        this.$ = new yy.IntegerNode($$[$0]);
                        break;

                      case 34:
                        this.$ = new yy.BooleanNode($$[$0]);
                        break;

                      case 35:
                        this.$ = $$[$0];
                        break;

                      case 36:
                        this.$ = new yy.HashNode($$[$0]);
                        break;

                      case 37:
                        $$[$0 - 1].push($$[$0]);
                        this.$ = $$[$0 - 1];
                        break;

                      case 38:
                        this.$ = [ $$[$0] ];
                        break;

                      case 39:
                        this.$ = [ $$[$0 - 2], $$[$0] ];
                        break;

                      case 40:
                        this.$ = [ $$[$0 - 2], new yy.StringNode($$[$0]) ];
                        break;

                      case 41:
                        this.$ = [ $$[$0 - 2], new yy.IntegerNode($$[$0]) ];
                        break;

                      case 42:
                        this.$ = [ $$[$0 - 2], new yy.BooleanNode($$[$0]) ];
                        break;

                      case 43:
                        this.$ = [ $$[$0 - 2], $$[$0] ];
                        break;

                      case 44:
                        this.$ = new yy.PartialNameNode($$[$0]);
                        break;

                      case 45:
                        this.$ = new yy.PartialNameNode(new yy.StringNode($$[$0]));
                        break;

                      case 46:
                        this.$ = new yy.PartialNameNode(new yy.IntegerNode($$[$0]));
                        break;

                      case 47:
                        this.$ = new yy.DataNode($$[$0]);
                        break;

                      case 48:
                        this.$ = new yy.IdNode($$[$0]);
                        break;

                      case 49:
                        $$[$0 - 2].push({
                            part: $$[$0],
                            separator: $$[$0 - 1]
                        });
                        this.$ = $$[$0 - 2];
                        break;

                      case 50:
                        this.$ = [ {
                            part: $$[$0]
                        } ];
                        break;
                    }
                },
                table: [ {
                    3: 1,
                    4: 2,
                    5: [ 2, 7 ],
                    6: 3,
                    7: 4,
                    8: 6,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 5 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    1: [ 3 ]
                }, {
                    5: [ 1, 17 ]
                }, {
                    5: [ 2, 6 ],
                    7: 18,
                    8: 6,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 19 ],
                    20: [ 2, 6 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    5: [ 2, 5 ],
                    6: 20,
                    8: 21,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 5 ],
                    20: [ 2, 5 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    17: 23,
                    18: [ 1, 22 ],
                    21: 24,
                    29: 25,
                    36: [ 1, 28 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    5: [ 2, 8 ],
                    14: [ 2, 8 ],
                    15: [ 2, 8 ],
                    16: [ 2, 8 ],
                    19: [ 2, 8 ],
                    20: [ 2, 8 ],
                    22: [ 2, 8 ],
                    23: [ 2, 8 ],
                    25: [ 2, 8 ]
                }, {
                    4: 29,
                    6: 3,
                    7: 4,
                    8: 6,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 5 ],
                    20: [ 2, 7 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    4: 30,
                    6: 3,
                    7: 4,
                    8: 6,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 5 ],
                    20: [ 2, 7 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    5: [ 2, 12 ],
                    14: [ 2, 12 ],
                    15: [ 2, 12 ],
                    16: [ 2, 12 ],
                    19: [ 2, 12 ],
                    20: [ 2, 12 ],
                    22: [ 2, 12 ],
                    23: [ 2, 12 ],
                    25: [ 2, 12 ]
                }, {
                    5: [ 2, 13 ],
                    14: [ 2, 13 ],
                    15: [ 2, 13 ],
                    16: [ 2, 13 ],
                    19: [ 2, 13 ],
                    20: [ 2, 13 ],
                    22: [ 2, 13 ],
                    23: [ 2, 13 ],
                    25: [ 2, 13 ]
                }, {
                    5: [ 2, 14 ],
                    14: [ 2, 14 ],
                    15: [ 2, 14 ],
                    16: [ 2, 14 ],
                    19: [ 2, 14 ],
                    20: [ 2, 14 ],
                    22: [ 2, 14 ],
                    23: [ 2, 14 ],
                    25: [ 2, 14 ]
                }, {
                    5: [ 2, 15 ],
                    14: [ 2, 15 ],
                    15: [ 2, 15 ],
                    16: [ 2, 15 ],
                    19: [ 2, 15 ],
                    20: [ 2, 15 ],
                    22: [ 2, 15 ],
                    23: [ 2, 15 ],
                    25: [ 2, 15 ]
                }, {
                    17: 31,
                    21: 24,
                    29: 25,
                    36: [ 1, 28 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    17: 32,
                    21: 24,
                    29: 25,
                    36: [ 1, 28 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    17: 33,
                    21: 24,
                    29: 25,
                    36: [ 1, 28 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    21: 35,
                    26: 34,
                    31: [ 1, 36 ],
                    32: [ 1, 37 ],
                    36: [ 1, 28 ],
                    39: 26
                }, {
                    1: [ 2, 1 ]
                }, {
                    5: [ 2, 2 ],
                    8: 21,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 19 ],
                    20: [ 2, 2 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    17: 23,
                    21: 24,
                    29: 25,
                    36: [ 1, 28 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    5: [ 2, 4 ],
                    7: 38,
                    8: 6,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 19 ],
                    20: [ 2, 4 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    5: [ 2, 9 ],
                    14: [ 2, 9 ],
                    15: [ 2, 9 ],
                    16: [ 2, 9 ],
                    19: [ 2, 9 ],
                    20: [ 2, 9 ],
                    22: [ 2, 9 ],
                    23: [ 2, 9 ],
                    25: [ 2, 9 ]
                }, {
                    5: [ 2, 23 ],
                    14: [ 2, 23 ],
                    15: [ 2, 23 ],
                    16: [ 2, 23 ],
                    19: [ 2, 23 ],
                    20: [ 2, 23 ],
                    22: [ 2, 23 ],
                    23: [ 2, 23 ],
                    25: [ 2, 23 ]
                }, {
                    18: [ 1, 39 ]
                }, {
                    18: [ 2, 27 ],
                    21: 44,
                    24: [ 2, 27 ],
                    27: 40,
                    28: 41,
                    29: 48,
                    30: 42,
                    31: [ 1, 45 ],
                    32: [ 1, 46 ],
                    33: [ 1, 47 ],
                    34: 43,
                    35: 49,
                    36: [ 1, 50 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    18: [ 2, 28 ],
                    24: [ 2, 28 ]
                }, {
                    18: [ 2, 48 ],
                    24: [ 2, 48 ],
                    31: [ 2, 48 ],
                    32: [ 2, 48 ],
                    33: [ 2, 48 ],
                    36: [ 2, 48 ],
                    38: [ 2, 48 ],
                    40: [ 1, 51 ]
                }, {
                    21: 52,
                    36: [ 1, 28 ],
                    39: 26
                }, {
                    18: [ 2, 50 ],
                    24: [ 2, 50 ],
                    31: [ 2, 50 ],
                    32: [ 2, 50 ],
                    33: [ 2, 50 ],
                    36: [ 2, 50 ],
                    38: [ 2, 50 ],
                    40: [ 2, 50 ]
                }, {
                    10: 53,
                    20: [ 1, 54 ]
                }, {
                    10: 55,
                    20: [ 1, 54 ]
                }, {
                    18: [ 1, 56 ]
                }, {
                    18: [ 1, 57 ]
                }, {
                    24: [ 1, 58 ]
                }, {
                    18: [ 1, 59 ],
                    21: 60,
                    36: [ 1, 28 ],
                    39: 26
                }, {
                    18: [ 2, 44 ],
                    36: [ 2, 44 ]
                }, {
                    18: [ 2, 45 ],
                    36: [ 2, 45 ]
                }, {
                    18: [ 2, 46 ],
                    36: [ 2, 46 ]
                }, {
                    5: [ 2, 3 ],
                    8: 21,
                    9: 7,
                    11: 8,
                    12: 9,
                    13: 10,
                    14: [ 1, 11 ],
                    15: [ 1, 12 ],
                    16: [ 1, 13 ],
                    19: [ 1, 19 ],
                    20: [ 2, 3 ],
                    22: [ 1, 14 ],
                    23: [ 1, 15 ],
                    25: [ 1, 16 ]
                }, {
                    14: [ 2, 17 ],
                    15: [ 2, 17 ],
                    16: [ 2, 17 ],
                    19: [ 2, 17 ],
                    20: [ 2, 17 ],
                    22: [ 2, 17 ],
                    23: [ 2, 17 ],
                    25: [ 2, 17 ]
                }, {
                    18: [ 2, 25 ],
                    21: 44,
                    24: [ 2, 25 ],
                    28: 61,
                    29: 48,
                    30: 62,
                    31: [ 1, 45 ],
                    32: [ 1, 46 ],
                    33: [ 1, 47 ],
                    34: 43,
                    35: 49,
                    36: [ 1, 50 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    18: [ 2, 26 ],
                    24: [ 2, 26 ]
                }, {
                    18: [ 2, 30 ],
                    24: [ 2, 30 ],
                    31: [ 2, 30 ],
                    32: [ 2, 30 ],
                    33: [ 2, 30 ],
                    36: [ 2, 30 ],
                    38: [ 2, 30 ]
                }, {
                    18: [ 2, 36 ],
                    24: [ 2, 36 ],
                    35: 63,
                    36: [ 1, 64 ]
                }, {
                    18: [ 2, 31 ],
                    24: [ 2, 31 ],
                    31: [ 2, 31 ],
                    32: [ 2, 31 ],
                    33: [ 2, 31 ],
                    36: [ 2, 31 ],
                    38: [ 2, 31 ]
                }, {
                    18: [ 2, 32 ],
                    24: [ 2, 32 ],
                    31: [ 2, 32 ],
                    32: [ 2, 32 ],
                    33: [ 2, 32 ],
                    36: [ 2, 32 ],
                    38: [ 2, 32 ]
                }, {
                    18: [ 2, 33 ],
                    24: [ 2, 33 ],
                    31: [ 2, 33 ],
                    32: [ 2, 33 ],
                    33: [ 2, 33 ],
                    36: [ 2, 33 ],
                    38: [ 2, 33 ]
                }, {
                    18: [ 2, 34 ],
                    24: [ 2, 34 ],
                    31: [ 2, 34 ],
                    32: [ 2, 34 ],
                    33: [ 2, 34 ],
                    36: [ 2, 34 ],
                    38: [ 2, 34 ]
                }, {
                    18: [ 2, 35 ],
                    24: [ 2, 35 ],
                    31: [ 2, 35 ],
                    32: [ 2, 35 ],
                    33: [ 2, 35 ],
                    36: [ 2, 35 ],
                    38: [ 2, 35 ]
                }, {
                    18: [ 2, 38 ],
                    24: [ 2, 38 ],
                    36: [ 2, 38 ]
                }, {
                    18: [ 2, 50 ],
                    24: [ 2, 50 ],
                    31: [ 2, 50 ],
                    32: [ 2, 50 ],
                    33: [ 2, 50 ],
                    36: [ 2, 50 ],
                    37: [ 1, 65 ],
                    38: [ 2, 50 ],
                    40: [ 2, 50 ]
                }, {
                    36: [ 1, 66 ]
                }, {
                    18: [ 2, 47 ],
                    24: [ 2, 47 ],
                    31: [ 2, 47 ],
                    32: [ 2, 47 ],
                    33: [ 2, 47 ],
                    36: [ 2, 47 ],
                    38: [ 2, 47 ]
                }, {
                    5: [ 2, 10 ],
                    14: [ 2, 10 ],
                    15: [ 2, 10 ],
                    16: [ 2, 10 ],
                    19: [ 2, 10 ],
                    20: [ 2, 10 ],
                    22: [ 2, 10 ],
                    23: [ 2, 10 ],
                    25: [ 2, 10 ]
                }, {
                    21: 67,
                    36: [ 1, 28 ],
                    39: 26
                }, {
                    5: [ 2, 11 ],
                    14: [ 2, 11 ],
                    15: [ 2, 11 ],
                    16: [ 2, 11 ],
                    19: [ 2, 11 ],
                    20: [ 2, 11 ],
                    22: [ 2, 11 ],
                    23: [ 2, 11 ],
                    25: [ 2, 11 ]
                }, {
                    14: [ 2, 16 ],
                    15: [ 2, 16 ],
                    16: [ 2, 16 ],
                    19: [ 2, 16 ],
                    20: [ 2, 16 ],
                    22: [ 2, 16 ],
                    23: [ 2, 16 ],
                    25: [ 2, 16 ]
                }, {
                    5: [ 2, 19 ],
                    14: [ 2, 19 ],
                    15: [ 2, 19 ],
                    16: [ 2, 19 ],
                    19: [ 2, 19 ],
                    20: [ 2, 19 ],
                    22: [ 2, 19 ],
                    23: [ 2, 19 ],
                    25: [ 2, 19 ]
                }, {
                    5: [ 2, 20 ],
                    14: [ 2, 20 ],
                    15: [ 2, 20 ],
                    16: [ 2, 20 ],
                    19: [ 2, 20 ],
                    20: [ 2, 20 ],
                    22: [ 2, 20 ],
                    23: [ 2, 20 ],
                    25: [ 2, 20 ]
                }, {
                    5: [ 2, 21 ],
                    14: [ 2, 21 ],
                    15: [ 2, 21 ],
                    16: [ 2, 21 ],
                    19: [ 2, 21 ],
                    20: [ 2, 21 ],
                    22: [ 2, 21 ],
                    23: [ 2, 21 ],
                    25: [ 2, 21 ]
                }, {
                    18: [ 1, 68 ]
                }, {
                    18: [ 2, 24 ],
                    24: [ 2, 24 ]
                }, {
                    18: [ 2, 29 ],
                    24: [ 2, 29 ],
                    31: [ 2, 29 ],
                    32: [ 2, 29 ],
                    33: [ 2, 29 ],
                    36: [ 2, 29 ],
                    38: [ 2, 29 ]
                }, {
                    18: [ 2, 37 ],
                    24: [ 2, 37 ],
                    36: [ 2, 37 ]
                }, {
                    37: [ 1, 65 ]
                }, {
                    21: 69,
                    29: 73,
                    31: [ 1, 70 ],
                    32: [ 1, 71 ],
                    33: [ 1, 72 ],
                    36: [ 1, 28 ],
                    38: [ 1, 27 ],
                    39: 26
                }, {
                    18: [ 2, 49 ],
                    24: [ 2, 49 ],
                    31: [ 2, 49 ],
                    32: [ 2, 49 ],
                    33: [ 2, 49 ],
                    36: [ 2, 49 ],
                    38: [ 2, 49 ],
                    40: [ 2, 49 ]
                }, {
                    18: [ 1, 74 ]
                }, {
                    5: [ 2, 22 ],
                    14: [ 2, 22 ],
                    15: [ 2, 22 ],
                    16: [ 2, 22 ],
                    19: [ 2, 22 ],
                    20: [ 2, 22 ],
                    22: [ 2, 22 ],
                    23: [ 2, 22 ],
                    25: [ 2, 22 ]
                }, {
                    18: [ 2, 39 ],
                    24: [ 2, 39 ],
                    36: [ 2, 39 ]
                }, {
                    18: [ 2, 40 ],
                    24: [ 2, 40 ],
                    36: [ 2, 40 ]
                }, {
                    18: [ 2, 41 ],
                    24: [ 2, 41 ],
                    36: [ 2, 41 ]
                }, {
                    18: [ 2, 42 ],
                    24: [ 2, 42 ],
                    36: [ 2, 42 ]
                }, {
                    18: [ 2, 43 ],
                    24: [ 2, 43 ],
                    36: [ 2, 43 ]
                }, {
                    5: [ 2, 18 ],
                    14: [ 2, 18 ],
                    15: [ 2, 18 ],
                    16: [ 2, 18 ],
                    19: [ 2, 18 ],
                    20: [ 2, 18 ],
                    22: [ 2, 18 ],
                    23: [ 2, 18 ],
                    25: [ 2, 18 ]
                } ],
                defaultActions: {
                    17: [ 2, 1 ]
                },
                parseError: function parseError(str, hash) {
                    throw new Error(str);
                },
                parse: function parse(input) {
                    var self = this, stack = [ 0 ], vstack = [ null ], lstack = [], table = this.table, yytext = "", yylineno = 0, yyleng = 0, recovering = 0, TERROR = 2, EOF = 1;
                    this.lexer.setInput(input);
                    this.lexer.yy = this.yy;
                    this.yy.lexer = this.lexer;
                    this.yy.parser = this;
                    if (typeof this.lexer.yylloc == "undefined") this.lexer.yylloc = {};
                    var yyloc = this.lexer.yylloc;
                    lstack.push(yyloc);
                    var ranges = this.lexer.options && this.lexer.options.ranges;
                    if (typeof this.yy.parseError === "function") this.parseError = this.yy.parseError;
                    function popStack(n) {
                        stack.length = stack.length - 2 * n;
                        vstack.length = vstack.length - n;
                        lstack.length = lstack.length - n;
                    }
                    function lex() {
                        var token;
                        token = self.lexer.lex() || 1;
                        if (typeof token !== "number") {
                            token = self.symbols_[token] || token;
                        }
                        return token;
                    }
                    var symbol, preErrorSymbol, state, action, a, r, yyval = {}, p, len, newState, expected;
                    while (true) {
                        state = stack[stack.length - 1];
                        if (this.defaultActions[state]) {
                            action = this.defaultActions[state];
                        } else {
                            if (symbol === null || typeof symbol == "undefined") {
                                symbol = lex();
                            }
                            action = table[state] && table[state][symbol];
                        }
                        if (typeof action === "undefined" || !action.length || !action[0]) {
                            var errStr = "";
                            if (!recovering) {
                                expected = [];
                                for (p in table[state]) if (this.terminals_[p] && p > 2) {
                                    expected.push("'" + this.terminals_[p] + "'");
                                }
                                if (this.lexer.showPosition) {
                                    errStr = "Parse error on line " + (yylineno + 1) + ":\n" + this.lexer.showPosition() + "\nExpecting " + expected.join(", ") + ", got '" + (this.terminals_[symbol] || symbol) + "'";
                                } else {
                                    errStr = "Parse error on line " + (yylineno + 1) + ": Unexpected " + (symbol == 1 ? "end of input" : "'" + (this.terminals_[symbol] || symbol) + "'");
                                }
                                this.parseError(errStr, {
                                    text: this.lexer.match,
                                    token: this.terminals_[symbol] || symbol,
                                    line: this.lexer.yylineno,
                                    loc: yyloc,
                                    expected: expected
                                });
                            }
                        }
                        if (action[0] instanceof Array && action.length > 1) {
                            throw new Error("Parse Error: multiple actions possible at state: " + state + ", token: " + symbol);
                        }
                        switch (action[0]) {
                          case 1:
                            stack.push(symbol);
                            vstack.push(this.lexer.yytext);
                            lstack.push(this.lexer.yylloc);
                            stack.push(action[1]);
                            symbol = null;
                            if (!preErrorSymbol) {
                                yyleng = this.lexer.yyleng;
                                yytext = this.lexer.yytext;
                                yylineno = this.lexer.yylineno;
                                yyloc = this.lexer.yylloc;
                                if (recovering > 0) recovering--;
                            } else {
                                symbol = preErrorSymbol;
                                preErrorSymbol = null;
                            }
                            break;

                          case 2:
                            len = this.productions_[action[1]][1];
                            yyval.$ = vstack[vstack.length - len];
                            yyval._$ = {
                                first_line: lstack[lstack.length - (len || 1)].first_line,
                                last_line: lstack[lstack.length - 1].last_line,
                                first_column: lstack[lstack.length - (len || 1)].first_column,
                                last_column: lstack[lstack.length - 1].last_column
                            };
                            if (ranges) {
                                yyval._$.range = [ lstack[lstack.length - (len || 1)].range[0], lstack[lstack.length - 1].range[1] ];
                            }
                            r = this.performAction.call(yyval, yytext, yyleng, yylineno, this.yy, action[1], vstack, lstack);
                            if (typeof r !== "undefined") {
                                return r;
                            }
                            if (len) {
                                stack = stack.slice(0, -1 * len * 2);
                                vstack = vstack.slice(0, -1 * len);
                                lstack = lstack.slice(0, -1 * len);
                            }
                            stack.push(this.productions_[action[1]][0]);
                            vstack.push(yyval.$);
                            lstack.push(yyval._$);
                            newState = table[stack[stack.length - 2]][stack[stack.length - 1]];
                            stack.push(newState);
                            break;

                          case 3:
                            return true;
                        }
                    }
                    return true;
                }
            };
            /* Jison generated lexer */
            var lexer = function() {
                var lexer = {
                    EOF: 1,
                    parseError: function parseError(str, hash) {
                        if (this.yy.parser) {
                            this.yy.parser.parseError(str, hash);
                        } else {
                            throw new Error(str);
                        }
                    },
                    setInput: function(input) {
                        this._input = input;
                        this._more = this._less = this.done = false;
                        this.yylineno = this.yyleng = 0;
                        this.yytext = this.matched = this.match = "";
                        this.conditionStack = [ "INITIAL" ];
                        this.yylloc = {
                            first_line: 1,
                            first_column: 0,
                            last_line: 1,
                            last_column: 0
                        };
                        if (this.options.ranges) this.yylloc.range = [ 0, 0 ];
                        this.offset = 0;
                        return this;
                    },
                    input: function() {
                        var ch = this._input[0];
                        this.yytext += ch;
                        this.yyleng++;
                        this.offset++;
                        this.match += ch;
                        this.matched += ch;
                        var lines = ch.match(/(?:\r\n?|\n).*/g);
                        if (lines) {
                            this.yylineno++;
                            this.yylloc.last_line++;
                        } else {
                            this.yylloc.last_column++;
                        }
                        if (this.options.ranges) this.yylloc.range[1]++;
                        this._input = this._input.slice(1);
                        return ch;
                    },
                    unput: function(ch) {
                        var len = ch.length;
                        var lines = ch.split(/(?:\r\n?|\n)/g);
                        this._input = ch + this._input;
                        this.yytext = this.yytext.substr(0, this.yytext.length - len - 1);
                        //this.yyleng -= len;
                        this.offset -= len;
                        var oldLines = this.match.split(/(?:\r\n?|\n)/g);
                        this.match = this.match.substr(0, this.match.length - 1);
                        this.matched = this.matched.substr(0, this.matched.length - 1);
                        if (lines.length - 1) this.yylineno -= lines.length - 1;
                        var r = this.yylloc.range;
                        this.yylloc = {
                            first_line: this.yylloc.first_line,
                            last_line: this.yylineno + 1,
                            first_column: this.yylloc.first_column,
                            last_column: lines ? (lines.length === oldLines.length ? this.yylloc.first_column : 0) + oldLines[oldLines.length - lines.length].length - lines[0].length : this.yylloc.first_column - len
                        };
                        if (this.options.ranges) {
                            this.yylloc.range = [ r[0], r[0] + this.yyleng - len ];
                        }
                        return this;
                    },
                    more: function() {
                        this._more = true;
                        return this;
                    },
                    less: function(n) {
                        this.unput(this.match.slice(n));
                    },
                    pastInput: function() {
                        var past = this.matched.substr(0, this.matched.length - this.match.length);
                        return (past.length > 20 ? "..." : "") + past.substr(-20).replace(/\n/g, "");
                    },
                    upcomingInput: function() {
                        var next = this.match;
                        if (next.length < 20) {
                            next += this._input.substr(0, 20 - next.length);
                        }
                        return (next.substr(0, 20) + (next.length > 20 ? "..." : "")).replace(/\n/g, "");
                    },
                    showPosition: function() {
                        var pre = this.pastInput();
                        var c = new Array(pre.length + 1).join("-");
                        return pre + this.upcomingInput() + "\n" + c + "^";
                    },
                    next: function() {
                        if (this.done) {
                            return this.EOF;
                        }
                        if (!this._input) this.done = true;
                        var token, match, tempMatch, index, col, lines;
                        if (!this._more) {
                            this.yytext = "";
                            this.match = "";
                        }
                        var rules = this._currentRules();
                        for (var i = 0; i < rules.length; i++) {
                            tempMatch = this._input.match(this.rules[rules[i]]);
                            if (tempMatch && (!match || tempMatch[0].length > match[0].length)) {
                                match = tempMatch;
                                index = i;
                                if (!this.options.flex) break;
                            }
                        }
                        if (match) {
                            lines = match[0].match(/(?:\r\n?|\n).*/g);
                            if (lines) this.yylineno += lines.length;
                            this.yylloc = {
                                first_line: this.yylloc.last_line,
                                last_line: this.yylineno + 1,
                                first_column: this.yylloc.last_column,
                                last_column: lines ? lines[lines.length - 1].length - lines[lines.length - 1].match(/\r?\n?/)[0].length : this.yylloc.last_column + match[0].length
                            };
                            this.yytext += match[0];
                            this.match += match[0];
                            this.matches = match;
                            this.yyleng = this.yytext.length;
                            if (this.options.ranges) {
                                this.yylloc.range = [ this.offset, this.offset += this.yyleng ];
                            }
                            this._more = false;
                            this._input = this._input.slice(match[0].length);
                            this.matched += match[0];
                            token = this.performAction.call(this, this.yy, this, rules[index], this.conditionStack[this.conditionStack.length - 1]);
                            if (this.done && this._input) this.done = false;
                            if (token) return token; else return;
                        }
                        if (this._input === "") {
                            return this.EOF;
                        } else {
                            return this.parseError("Lexical error on line " + (this.yylineno + 1) + ". Unrecognized text.\n" + this.showPosition(), {
                                text: "",
                                token: null,
                                line: this.yylineno
                            });
                        }
                    },
                    lex: function lex() {
                        var r = this.next();
                        if (typeof r !== "undefined") {
                            return r;
                        } else {
                            return this.lex();
                        }
                    },
                    begin: function begin(condition) {
                        this.conditionStack.push(condition);
                    },
                    popState: function popState() {
                        return this.conditionStack.pop();
                    },
                    _currentRules: function _currentRules() {
                        return this.conditions[this.conditionStack[this.conditionStack.length - 1]].rules;
                    },
                    topState: function() {
                        return this.conditionStack[this.conditionStack.length - 2];
                    },
                    pushState: function begin(condition) {
                        this.begin(condition);
                    }
                };
                lexer.options = {};
                lexer.performAction = function anonymous(yy, yy_, $avoiding_name_collisions, YY_START) {
                    var YYSTATE = YY_START;
                    switch ($avoiding_name_collisions) {
                      case 0:
                        yy_.yytext = "\\";
                        return 14;
                        break;

                      case 1:
                        if (yy_.yytext.slice(-1) !== "\\") this.begin("mu");
                        if (yy_.yytext.slice(-1) === "\\") yy_.yytext = yy_.yytext.substr(0, yy_.yyleng - 1),
                        this.begin("emu");
                        if (yy_.yytext) return 14;
                        break;

                      case 2:
                        return 14;
                        break;

                      case 3:
                        if (yy_.yytext.slice(-1) !== "\\") this.popState();
                        if (yy_.yytext.slice(-1) === "\\") yy_.yytext = yy_.yytext.substr(0, yy_.yyleng - 1);
                        return 14;
                        break;

                      case 4:
                        yy_.yytext = yy_.yytext.substr(0, yy_.yyleng - 4);
                        this.popState();
                        return 15;
                        break;

                      case 5:
                        return 25;
                        break;

                      case 6:
                        return 16;
                        break;

                      case 7:
                        return 20;
                        break;

                      case 8:
                        return 19;
                        break;

                      case 9:
                        return 19;
                        break;

                      case 10:
                        return 23;
                        break;

                      case 11:
                        return 22;
                        break;

                      case 12:
                        this.popState();
                        this.begin("com");
                        break;

                      case 13:
                        yy_.yytext = yy_.yytext.substr(3, yy_.yyleng - 5);
                        this.popState();
                        return 15;
                        break;

                      case 14:
                        return 22;
                        break;

                      case 15:
                        return 37;
                        break;

                      case 16:
                        return 36;
                        break;

                      case 17:
                        return 36;
                        break;

                      case 18:
                        return 40;
                        break;

                      case 19:
                        /*ignore whitespace*/
                        break;

                      case 20:
                        this.popState();
                        return 24;
                        break;

                      case 21:
                        this.popState();
                        return 18;
                        break;

                      case 22:
                        yy_.yytext = yy_.yytext.substr(1, yy_.yyleng - 2).replace(/\\"/g, '"');
                        return 31;
                        break;

                      case 23:
                        yy_.yytext = yy_.yytext.substr(1, yy_.yyleng - 2).replace(/\\'/g, "'");
                        return 31;
                        break;

                      case 24:
                        return 38;
                        break;

                      case 25:
                        return 33;
                        break;

                      case 26:
                        return 33;
                        break;

                      case 27:
                        return 32;
                        break;

                      case 28:
                        return 36;
                        break;

                      case 29:
                        yy_.yytext = yy_.yytext.substr(1, yy_.yyleng - 2);
                        return 36;
                        break;

                      case 30:
                        return "INVALID";
                        break;

                      case 31:
                        return 5;
                        break;
                    }
                };
                lexer.rules = [ /^(?:\\\\(?=(\{\{)))/, /^(?:[^\x00]*?(?=(\{\{)))/, /^(?:[^\x00]+)/, /^(?:[^\x00]{2,}?(?=(\{\{|$)))/, /^(?:[\s\S]*?--\}\})/, /^(?:\{\{>)/, /^(?:\{\{#)/, /^(?:\{\{\/)/, /^(?:\{\{\^)/, /^(?:\{\{\s*else\b)/, /^(?:\{\{\{)/, /^(?:\{\{&)/, /^(?:\{\{!--)/, /^(?:\{\{![\s\S]*?\}\})/, /^(?:\{\{)/, /^(?:=)/, /^(?:\.(?=[}\/ ]))/, /^(?:\.\.)/, /^(?:[\/.])/, /^(?:\s+)/, /^(?:\}\}\})/, /^(?:\}\})/, /^(?:"(\\["]|[^"])*")/, /^(?:'(\\[']|[^'])*')/, /^(?:@)/, /^(?:true(?=[}\s]))/, /^(?:false(?=[}\s]))/, /^(?:-?[0-9]+(?=[}\s]))/, /^(?:[^\s!"#%-,\.\/;->@\[-\^`\{-~]+(?=[=}\s\/.]))/, /^(?:\[[^\]]*\])/, /^(?:.)/, /^(?:$)/ ];
                lexer.conditions = {
                    mu: {
                        rules: [ 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31 ],
                        inclusive: false
                    },
                    emu: {
                        rules: [ 3 ],
                        inclusive: false
                    },
                    com: {
                        rules: [ 4 ],
                        inclusive: false
                    },
                    INITIAL: {
                        rules: [ 0, 1, 2, 31 ],
                        inclusive: true
                    }
                };
                return lexer;
            }();
            parser.lexer = lexer;
            function Parser() {
                this.yy = {};
            }
            Parser.prototype = parser;
            parser.Parser = Parser;
            return new Parser();
        }();
        // lib/handlebars/compiler/base.js
        BbaseHandlebars.Parser = handlebars;
        BbaseHandlebars.parse = function(input) {
            // Just return if an already-compile AST was passed in.
            if (input.constructor === BbaseHandlebars.AST.ProgramNode) {
                return input;
            }
            BbaseHandlebars.Parser.yy = BbaseHandlebars.AST;
            return BbaseHandlebars.Parser.parse(input);
        };
        // lib/handlebars/compiler/ast.js
        BbaseHandlebars.AST = {};
        BbaseHandlebars.AST.ProgramNode = function(statements, inverse) {
            this.type = "program";
            this.statements = statements;
            if (inverse) {
                this.inverse = new BbaseHandlebars.AST.ProgramNode(inverse);
            }
        };
        BbaseHandlebars.AST.MustacheNode = function(rawParams, hash, unescaped) {
            this.type = "mustache";
            this.escaped = !unescaped;
            this.hash = hash;
            var id = this.id = rawParams[0];
            var params = this.params = rawParams.slice(1);
            // a mustache is an eligible helper if:
            // * its id is simple (a single part, not `this` or `..`)
            var eligibleHelper = this.eligibleHelper = id.isSimple;
            // a mustache is definitely a helper if:
            // * it is an eligible helper, and
            // * it has at least one parameter or hash segment
            this.isHelper = eligibleHelper && (params.length || hash);
        };
        BbaseHandlebars.AST.PartialNode = function(partialName, context) {
            this.type = "partial";
            this.partialName = partialName;
            this.context = context;
        };
        BbaseHandlebars.AST.BlockNode = function(mustache, program, inverse, close) {
            var verifyMatch = function(open, close) {
                if (open.original !== close.original) {
                    throw new BbaseHandlebars.Exception(open.original + " doesn't match " + close.original);
                }
            };
            verifyMatch(mustache.id, close);
            this.type = "block";
            this.mustache = mustache;
            this.program = program;
            this.inverse = inverse;
            if (this.inverse && !this.program) {
                this.isInverse = true;
            }
        };
        BbaseHandlebars.AST.ContentNode = function(string) {
            this.type = "content";
            this.string = string;
        };
        BbaseHandlebars.AST.HashNode = function(pairs) {
            this.type = "hash";
            this.pairs = pairs;
        };
        BbaseHandlebars.AST.IdNode = function(parts) {
            this.type = "ID";
            var original = "", dig = [], depth = 0;
            for (var i = 0, l = parts.length; i < l; i++) {
                var part = parts[i].part;
                original += (parts[i].separator || "") + part;
                if (part === ".." || part === "." || part === "this") {
                    if (dig.length > 0) {
                        throw new BbaseHandlebars.Exception("Invalid path: " + original);
                    } else if (part === "..") {
                        depth++;
                    } else {
                        this.isScoped = true;
                    }
                } else {
                    dig.push(part);
                }
            }
            this.original = original;
            this.parts = dig;
            this.string = dig.join(".");
            this.depth = depth;
            // an ID is simple if it only has one part, and that part is not
            // `..` or `this`.
            this.isSimple = parts.length === 1 && !this.isScoped && depth === 0;
            this.stringModeValue = this.string;
        };
        BbaseHandlebars.AST.PartialNameNode = function(name) {
            this.type = "PARTIAL_NAME";
            this.name = name.original;
        };
        BbaseHandlebars.AST.DataNode = function(id) {
            this.type = "DATA";
            this.id = id;
        };
        BbaseHandlebars.AST.StringNode = function(string) {
            this.type = "STRING";
            this.original = this.string = this.stringModeValue = string;
        };
        BbaseHandlebars.AST.IntegerNode = function(integer) {
            this.type = "INTEGER";
            this.original = this.integer = integer;
            this.stringModeValue = Number(integer);
        };
        BbaseHandlebars.AST.BooleanNode = function(bool) {
            this.type = "BOOLEAN";
            this.bool = bool;
            this.stringModeValue = bool === "true";
        };
        BbaseHandlebars.AST.CommentNode = function(comment) {
            this.type = "comment";
            this.comment = comment;
        };
        // lib/handlebars/utils.js
        var errorProps = [ "description", "fileName", "lineNumber", "message", "name", "number", "stack" ];
        BbaseHandlebars.Exception = function(message) {
            var tmp = Error.prototype.constructor.apply(this, arguments);
            // Unfortunately errors are not enumerable in Chrome (at least), so `for prop in tmp` doesn't work.
            for (var idx = 0; idx < errorProps.length; idx++) {
                this[errorProps[idx]] = tmp[errorProps[idx]];
            }
        };
        BbaseHandlebars.Exception.prototype = new Error();
        // Build out our basic SafeString type
        BbaseHandlebars.SafeString = function(string) {
            this.string = string;
        };
        BbaseHandlebars.SafeString.prototype.toString = function() {
            return this.string.toString();
        };
        var escape = {
            "&": "&amp;",
            "<": "&lt;",
            ">": "&gt;",
            '"': "&quot;",
            "'": "&#x27;",
            "`": "&#x60;"
        };
        var badChars = /[&<>"'`]/g;
        var possible = /[&<>"'`]/;
        var escapeChar = function(chr) {
            return escape[chr] || "&amp;";
        };
        BbaseHandlebars.Utils = {
            extend: function(obj, value) {
                for (var key in value) {
                    if (value.hasOwnProperty(key)) {
                        obj[key] = value[key];
                    }
                }
            },
            escapeExpression: function(string) {
                // don't escape SafeStrings, since they're already safe
                if (string instanceof BbaseHandlebars.SafeString) {
                    return string.toString();
                } else if (string == null || string === false) {
                    return "";
                }
                // Force a string conversion as this will be done by the append regardless and
                // the regex test will do this transparently behind the scenes, causing issues if
                // an object's to string has escaped characters in it.
                string = string.toString();
                if (!possible.test(string)) {
                    return string;
                }
                return string.replace(badChars, escapeChar);
            },
            isEmpty: function(value) {
                if (!value && value !== 0) {
                    return true;
                } else if (toString.call(value) === "[object Array]" && value.length === 0) {
                    return true;
                } else {
                    return false;
                }
            }
        };
        // lib/handlebars/compiler/compiler.js
        /*jshint eqnull:true*/
        var Compiler = BbaseHandlebars.Compiler = function() {};
        var JavaScriptCompiler = BbaseHandlebars.JavaScriptCompiler = function() {};
        // the foundHelper register will disambiguate helper lookup from finding a
        // function in a context. This is necessary for mustache compatibility, which
        // requires that context functions in blocks are evaluated by blockHelperMissing,
        // and then proceed as if the resulting value was provided to blockHelperMissing.
        Compiler.prototype = {
            compiler: Compiler,
            disassemble: function() {
                var opcodes = this.opcodes, opcode, out = [], params, param;
                for (var i = 0, l = opcodes.length; i < l; i++) {
                    opcode = opcodes[i];
                    if (opcode.opcode === "DECLARE") {
                        out.push("DECLARE " + opcode.name + "=" + opcode.value);
                    } else {
                        params = [];
                        for (var j = 0; j < opcode.args.length; j++) {
                            param = opcode.args[j];
                            if (typeof param === "string") {
                                param = '"' + param.replace("\n", "\\n") + '"';
                            }
                            params.push(param);
                        }
                        out.push(opcode.opcode + " " + params.join(" "));
                    }
                }
                return out.join("\n");
            },
            equals: function(other) {
                var len = this.opcodes.length;
                if (other.opcodes.length !== len) {
                    return false;
                }
                for (var i = 0; i < len; i++) {
                    var opcode = this.opcodes[i], otherOpcode = other.opcodes[i];
                    if (opcode.opcode !== otherOpcode.opcode || opcode.args.length !== otherOpcode.args.length) {
                        return false;
                    }
                    for (var j = 0; j < opcode.args.length; j++) {
                        if (opcode.args[j] !== otherOpcode.args[j]) {
                            return false;
                        }
                    }
                }
                len = this.children.length;
                if (other.children.length !== len) {
                    return false;
                }
                for (i = 0; i < len; i++) {
                    if (!this.children[i].equals(other.children[i])) {
                        return false;
                    }
                }
                return true;
            },
            guid: 0,
            compile: function(program, options) {
                this.children = [];
                this.depths = {
                    list: []
                };
                this.options = options;
                // These changes will propagate to the other compiler components
                var knownHelpers = this.options.knownHelpers;
                this.options.knownHelpers = {
                    helperMissing: true,
                    blockHelperMissing: true,
                    each: true,
                    "if": true,
                    unless: true,
                    "with": true,
                    log: true
                };
                if (knownHelpers) {
                    for (var name in knownHelpers) {
                        this.options.knownHelpers[name] = knownHelpers[name];
                    }
                }
                return this.program(program);
            },
            accept: function(node) {
                return this[node.type](node);
            },
            program: function(program) {
                var statements = program.statements, statement;
                this.opcodes = [];
                for (var i = 0, l = statements.length; i < l; i++) {
                    statement = statements[i];
                    this[statement.type](statement);
                }
                this.isSimple = l === 1;
                this.depths.list = this.depths.list.sort(function(a, b) {
                    return a - b;
                });
                return this;
            },
            compileProgram: function(program) {
                var result = new this.compiler().compile(program, this.options);
                var guid = this.guid++, depth;
                this.usePartial = this.usePartial || result.usePartial;
                this.children[guid] = result;
                for (var i = 0, l = result.depths.list.length; i < l; i++) {
                    depth = result.depths.list[i];
                    if (depth < 2) {
                        continue;
                    } else {
                        this.addDepth(depth - 1);
                    }
                }
                return guid;
            },
            block: function(block) {
                var mustache = block.mustache, program = block.program, inverse = block.inverse;
                if (program) {
                    program = this.compileProgram(program);
                }
                if (inverse) {
                    inverse = this.compileProgram(inverse);
                }
                var type = this.classifyMustache(mustache);
                if (type === "helper") {
                    this.helperMustache(mustache, program, inverse);
                } else if (type === "simple") {
                    this.simpleMustache(mustache);
                    // now that the simple mustache is resolved, we need to
                    // evaluate it by executing `blockHelperMissing`
                    this.opcode("pushProgram", program);
                    this.opcode("pushProgram", inverse);
                    this.opcode("emptyHash");
                    this.opcode("blockValue");
                } else {
                    this.ambiguousMustache(mustache, program, inverse);
                    // now that the simple mustache is resolved, we need to
                    // evaluate it by executing `blockHelperMissing`
                    this.opcode("pushProgram", program);
                    this.opcode("pushProgram", inverse);
                    this.opcode("emptyHash");
                    this.opcode("ambiguousBlockValue");
                }
                this.opcode("append");
            },
            hash: function(hash) {
                var pairs = hash.pairs, pair, val;
                this.opcode("pushHash");
                for (var i = 0, l = pairs.length; i < l; i++) {
                    pair = pairs[i];
                    val = pair[1];
                    if (this.options.stringParams) {
                        if (val.depth) {
                            this.addDepth(val.depth);
                        }
                        this.opcode("getContext", val.depth || 0);
                        this.opcode("pushStringParam", val.stringModeValue, val.type);
                    } else {
                        this.accept(val);
                    }
                    this.opcode("assignToHash", pair[0]);
                }
                this.opcode("popHash");
            },
            partial: function(partial) {
                var partialName = partial.partialName;
                this.usePartial = true;
                if (partial.context) {
                    this.ID(partial.context);
                } else {
                    this.opcode("push", "depth0");
                }
                this.opcode("invokePartial", partialName.name);
                this.opcode("append");
            },
            content: function(content) {
                this.opcode("appendContent", content.string);
            },
            mustache: function(mustache) {
                var options = this.options;
                var type = this.classifyMustache(mustache);
                if (type === "simple") {
                    this.simpleMustache(mustache);
                } else if (type === "helper") {
                    this.helperMustache(mustache);
                } else {
                    this.ambiguousMustache(mustache);
                }
                if (mustache.escaped && !options.noEscape) {
                    this.opcode("appendEscaped");
                } else {
                    this.opcode("append");
                }
            },
            ambiguousMustache: function(mustache, program, inverse) {
                var id = mustache.id, name = id.parts[0], isBlock = program != null || inverse != null;
                this.opcode("getContext", id.depth);
                this.opcode("pushProgram", program);
                this.opcode("pushProgram", inverse);
                this.opcode("invokeAmbiguous", name, isBlock);
            },
            simpleMustache: function(mustache) {
                var id = mustache.id;
                if (id.type === "DATA") {
                    this.DATA(id);
                } else if (id.parts.length) {
                    this.ID(id);
                } else {
                    // Simplified ID for `this`
                    this.addDepth(id.depth);
                    this.opcode("getContext", id.depth);
                    this.opcode("pushContext");
                }
                this.opcode("resolvePossibleLambda");
            },
            helperMustache: function(mustache, program, inverse) {
                var params = this.setupFullMustacheParams(mustache, program, inverse), name = mustache.id.parts[0];
                if (this.options.knownHelpers[name]) {
                    this.opcode("invokeKnownHelper", params.length, name);
                } else if (this.options.knownHelpersOnly) {
                    throw new Error("You specified knownHelpersOnly, but used the unknown helper " + name);
                } else {
                    this.opcode("invokeHelper", params.length, name);
                }
            },
            ID: function(id) {
                this.addDepth(id.depth);
                this.opcode("getContext", id.depth);
                var name = id.parts[0];
                if (!name) {
                    this.opcode("pushContext");
                } else {
                    this.opcode("lookupOnContext", id.parts[0]);
                }
                for (var i = 1, l = id.parts.length; i < l; i++) {
                    this.opcode("lookup", id.parts[i]);
                }
            },
            DATA: function(data) {
                this.options.data = true;
                if (data.id.isScoped || data.id.depth) {
                    throw new BbaseHandlebars.Exception("Scoped data references are not supported: " + data.original);
                }
                this.opcode("lookupData");
                var parts = data.id.parts;
                for (var i = 0, l = parts.length; i < l; i++) {
                    this.opcode("lookup", parts[i]);
                }
            },
            STRING: function(string) {
                this.opcode("pushString", string.string);
            },
            INTEGER: function(integer) {
                this.opcode("pushLiteral", integer.integer);
            },
            BOOLEAN: function(bool) {
                this.opcode("pushLiteral", bool.bool);
            },
            comment: function() {},
            // HELPERS
            opcode: function(name) {
                this.opcodes.push({
                    opcode: name,
                    args: [].slice.call(arguments, 1)
                });
            },
            declare: function(name, value) {
                this.opcodes.push({
                    opcode: "DECLARE",
                    name: name,
                    value: value
                });
            },
            addDepth: function(depth) {
                if (isNaN(depth)) {
                    throw new Error("EWOT");
                }
                if (depth === 0) {
                    return;
                }
                if (!this.depths[depth]) {
                    this.depths[depth] = true;
                    this.depths.list.push(depth);
                }
            },
            classifyMustache: function(mustache) {
                var isHelper = mustache.isHelper;
                var isEligible = mustache.eligibleHelper;
                var options = this.options;
                // if ambiguous, we can possibly resolve the ambiguity now
                if (isEligible && !isHelper) {
                    var name = mustache.id.parts[0];
                    if (options.knownHelpers[name]) {
                        isHelper = true;
                    } else if (options.knownHelpersOnly) {
                        isEligible = false;
                    }
                }
                if (isHelper) {
                    return "helper";
                } else if (isEligible) {
                    return "ambiguous";
                } else {
                    return "simple";
                }
            },
            pushParams: function(params) {
                var i = params.length, param;
                while (i--) {
                    param = params[i];
                    if (this.options.stringParams) {
                        if (param.depth) {
                            this.addDepth(param.depth);
                        }
                        this.opcode("getContext", param.depth || 0);
                        this.opcode("pushStringParam", param.stringModeValue, param.type);
                    } else {
                        this[param.type](param);
                    }
                }
            },
            setupMustacheParams: function(mustache) {
                var params = mustache.params;
                this.pushParams(params);
                if (mustache.hash) {
                    this.hash(mustache.hash);
                } else {
                    this.opcode("emptyHash");
                }
                return params;
            },
            // this will replace setupMustacheParams when we're done
            setupFullMustacheParams: function(mustache, program, inverse) {
                var params = mustache.params;
                this.pushParams(params);
                this.opcode("pushProgram", program);
                this.opcode("pushProgram", inverse);
                if (mustache.hash) {
                    this.hash(mustache.hash);
                } else {
                    this.opcode("emptyHash");
                }
                return params;
            }
        };
        var Literal = function(value) {
            this.value = value;
        };
        JavaScriptCompiler.prototype = {
            // PUBLIC API: You can override these methods in a subclass to provide
            // alternative compiled forms for name lookup and buffering semantics
            nameLookup: function(parent, name) {
                if (/^[0-9]+$/.test(name)) {
                    return parent + "[" + name + "]";
                } else if (JavaScriptCompiler.isValidJavaScriptVariableName(name)) {
                    return parent + "." + name;
                } else {
                    return parent + "['" + name + "']";
                }
            },
            appendToBuffer: function(string) {
                if (this.environment.isSimple) {
                    return "return " + string + ";";
                } else {
                    return {
                        appendToBuffer: true,
                        content: string,
                        toString: function() {
                            return "buffer += " + string + ";";
                        }
                    };
                }
            },
            initializeBuffer: function() {
                return this.quotedString("");
            },
            namespace: "BbaseHandlebars",
            // END PUBLIC API
            compile: function(environment, options, context, asObject) {
                this.environment = environment;
                this.options = options || {};
                BbaseHandlebars.log(BbaseHandlebars.logger.DEBUG, this.environment.disassemble() + "\n\n");
                this.name = this.environment.name;
                this.isChild = !!context;
                this.context = context || {
                    programs: [],
                    environments: [],
                    aliases: {}
                };
                this.preamble();
                this.stackSlot = 0;
                this.stackVars = [];
                this.registers = {
                    list: []
                };
                this.compileStack = [];
                this.inlineStack = [];
                this.compileChildren(environment, options);
                var opcodes = environment.opcodes, opcode;
                this.i = 0;
                for (l = opcodes.length; this.i < l; this.i++) {
                    opcode = opcodes[this.i];
                    if (opcode.opcode === "DECLARE") {
                        this[opcode.name] = opcode.value;
                    } else {
                        this[opcode.opcode].apply(this, opcode.args);
                    }
                }
                return this.createFunctionContext(asObject);
            },
            nextOpcode: function() {
                var opcodes = this.environment.opcodes;
                return opcodes[this.i + 1];
            },
            eat: function() {
                this.i = this.i + 1;
            },
            preamble: function() {
                var out = [];
                if (!this.isChild) {
                    var namespace = this.namespace;
                    var copies = "helpers = this.merge(helpers, " + namespace + ".helpers);";
                    if (this.environment.usePartial) {
                        copies = copies + " partials = this.merge(partials, " + namespace + ".partials);";
                    }
                    if (this.options.data) {
                        copies = copies + " data = data || {};";
                    }
                    out.push(copies);
                } else {
                    out.push("");
                }
                if (!this.environment.isSimple) {
                    out.push(", buffer = " + this.initializeBuffer());
                } else {
                    out.push("");
                }
                // track the last context pushed into place to allow skipping the
                // getContext opcode when it would be a noop
                this.lastContext = 0;
                this.source = out;
            },
            createFunctionContext: function(asObject) {
                var locals = this.stackVars.concat(this.registers.list);
                if (locals.length > 0) {
                    this.source[1] = this.source[1] + ", " + locals.join(", ");
                }
                // Generate minimizer alias mappings
                if (!this.isChild) {
                    for (var alias in this.context.aliases) {
                        if (this.context.aliases.hasOwnProperty(alias)) {
                            this.source[1] = this.source[1] + ", " + alias + "=" + this.context.aliases[alias];
                        }
                    }
                }
                if (this.source[1]) {
                    this.source[1] = "var " + this.source[1].substring(2) + ";";
                }
                // Merge children
                if (!this.isChild) {
                    this.source[1] += "\n" + this.context.programs.join("\n") + "\n";
                }
                if (!this.environment.isSimple) {
                    this.source.push("return buffer;");
                }
                var params = this.isChild ? [ "depth0", "data" ] : [ "BbaseHandlebars", "depth0", "helpers", "partials", "data" ];
                for (var i = 0, l = this.environment.depths.list.length; i < l; i++) {
                    params.push("depth" + this.environment.depths.list[i]);
                }
                // Perform a second pass over the output to merge content when possible
                var source = this.mergeSource();
                if (!this.isChild) {
                    var revision = BbaseHandlebars.COMPILER_REVISION, versions = BbaseHandlebars.REVISION_CHANGES[revision];
                    source = "this.compilerInfo = [" + revision + ",'" + versions + "'];\n" + source;
                }
                if (asObject) {
                    params.push(source);
                    return Function.apply(this, params);
                } else {
                    var functionSource = "function " + (this.name || "") + "(" + params.join(",") + ") {\n  " + source + "}";
                    BbaseHandlebars.log(BbaseHandlebars.logger.DEBUG, functionSource + "\n\n");
                    return functionSource;
                }
            },
            mergeSource: function() {
                // WARN: We are not handling the case where buffer is still populated as the source should
                // not have buffer append operations as their final action.
                var source = "", buffer;
                for (var i = 0, len = this.source.length; i < len; i++) {
                    var line = this.source[i];
                    if (line.appendToBuffer) {
                        if (buffer) {
                            buffer = buffer + "\n    + " + line.content;
                        } else {
                            buffer = line.content;
                        }
                    } else {
                        if (buffer) {
                            source += "buffer += " + buffer + ";\n  ";
                            buffer = undefined;
                        }
                        source += line + "\n  ";
                    }
                }
                return source;
            },
            // [blockValue]
            //
            // On stack, before: hash, inverse, program, value
            // On stack, after: return value of blockHelperMissing
            //
            // The purpose of this opcode is to take a block of the form
            // `{{#foo}}...{{/foo}}`, resolve the value of `foo`, and
            // replace it on the stack with the result of properly
            // invoking blockHelperMissing.
            blockValue: function() {
                this.context.aliases.blockHelperMissing = "helpers.blockHelperMissing";
                var params = [ "depth0" ];
                this.setupParams(0, params);
                this.replaceStack(function(current) {
                    params.splice(1, 0, current);
                    return "blockHelperMissing.call(" + params.join(", ") + ")";
                });
            },
            // [ambiguousBlockValue]
            //
            // On stack, before: hash, inverse, program, value
            // Compiler value, before: lastHelper=value of last found helper, if any
            // On stack, after, if no lastHelper: same as [blockValue]
            // On stack, after, if lastHelper: value
            ambiguousBlockValue: function() {
                this.context.aliases.blockHelperMissing = "helpers.blockHelperMissing";
                var params = [ "depth0" ];
                this.setupParams(0, params);
                var current = this.topStack();
                params.splice(1, 0, current);
                // Use the options value generated from the invocation
                params[params.length - 1] = "options";
                this.source.push("if (!" + this.lastHelper + ") { " + current + " = blockHelperMissing.call(" + params.join(", ") + "); }");
            },
            // [appendContent]
            //
            // On stack, before: ...
            // On stack, after: ...
            //
            // Appends the string value of `content` to the current buffer
            appendContent: function(content) {
                this.source.push(this.appendToBuffer(this.quotedString(content)));
            },
            // [append]
            //
            // On stack, before: value, ...
            // On stack, after: ...
            //
            // Coerces `value` to a String and appends it to the current buffer.
            //
            // If `value` is truthy, or 0, it is coerced into a string and appended
            // Otherwise, the empty string is appended
            append: function() {
                // Force anything that is inlined onto the stack so we don't have duplication
                // when we examine local
                this.flushInline();
                var local = this.popStack();
                this.source.push("if(" + local + " || " + local + " === 0) { " + this.appendToBuffer(local) + " }");
                if (this.environment.isSimple) {
                    this.source.push("else { " + this.appendToBuffer("''") + " }");
                }
            },
            // [appendEscaped]
            //
            // On stack, before: value, ...
            // On stack, after: ...
            //
            // Escape `value` and append it to the buffer
            appendEscaped: function() {
                this.context.aliases.escapeExpression = "this.escapeExpression";
                this.source.push(this.appendToBuffer("escapeExpression(" + this.popStack() + ")"));
            },
            // [getContext]
            //
            // On stack, before: ...
            // On stack, after: ...
            // Compiler value, after: lastContext=depth
            //
            // Set the value of the `lastContext` compiler value to the depth
            getContext: function(depth) {
                if (this.lastContext !== depth) {
                    this.lastContext = depth;
                }
            },
            // [lookupOnContext]
            //
            // On stack, before: ...
            // On stack, after: currentContext[name], ...
            //
            // Looks up the value of `name` on the current context and pushes
            // it onto the stack.
            lookupOnContext: function(name) {
                this.push(this.nameLookup("depth" + this.lastContext, name, "context"));
            },
            // [pushContext]
            //
            // On stack, before: ...
            // On stack, after: currentContext, ...
            //
            // Pushes the value of the current context onto the stack.
            pushContext: function() {
                this.pushStackLiteral("depth" + this.lastContext);
            },
            // [resolvePossibleLambda]
            //
            // On stack, before: value, ...
            // On stack, after: resolved value, ...
            //
            // If the `value` is a lambda, replace it on the stack by
            // the return value of the lambda
            resolvePossibleLambda: function() {
                this.context.aliases.functionType = '"function"';
                this.replaceStack(function(current) {
                    return "typeof " + current + " === functionType ? " + current + ".apply(depth0) : " + current;
                });
            },
            // [lookup]
            //
            // On stack, before: value, ...
            // On stack, after: value[name], ...
            //
            // Replace the value on the stack with the result of looking
            // up `name` on `value`
            lookup: function(name) {
                this.replaceStack(function(current) {
                    return current + " == null || " + current + " === false ? " + current + " : " + this.nameLookup(current, name, "context");
                });
            },
            // [lookupData]
            //
            // On stack, before: ...
            // On stack, after: data[id], ...
            //
            // Push the result of looking up `id` on the current data
            lookupData: function(id) {
                this.push("data");
            },
            // [pushStringParam]
            //
            // On stack, before: ...
            // On stack, after: string, currentContext, ...
            //
            // This opcode is designed for use in string mode, which
            // provides the string value of a parameter along with its
            // depth rather than resolving it immediately.
            pushStringParam: function(string, type) {
                this.pushStackLiteral("depth" + this.lastContext);
                this.pushString(type);
                if (typeof string === "string") {
                    this.pushString(string);
                } else {
                    this.pushStackLiteral(string);
                }
            },
            emptyHash: function() {
                this.pushStackLiteral("{}");
                if (this.options.stringParams) {
                    this.register("hashTypes", "{}");
                    this.register("hashContexts", "{}");
                }
            },
            pushHash: function() {
                this.hash = {
                    values: [],
                    types: [],
                    contexts: []
                };
            },
            popHash: function() {
                var hash = this.hash;
                this.hash = undefined;
                if (this.options.stringParams) {
                    this.register("hashContexts", "{" + hash.contexts.join(",") + "}");
                    this.register("hashTypes", "{" + hash.types.join(",") + "}");
                }
                this.push("{\n    " + hash.values.join(",\n    ") + "\n  }");
            },
            // [pushString]
            //
            // On stack, before: ...
            // On stack, after: quotedString(string), ...
            //
            // Push a quoted version of `string` onto the stack
            pushString: function(string) {
                this.pushStackLiteral(this.quotedString(string));
            },
            // [push]
            //
            // On stack, before: ...
            // On stack, after: expr, ...
            //
            // Push an expression onto the stack
            push: function(expr) {
                this.inlineStack.push(expr);
                return expr;
            },
            // [pushLiteral]
            //
            // On stack, before: ...
            // On stack, after: value, ...
            //
            // Pushes a value onto the stack. This operation prevents
            // the compiler from creating a temporary variable to hold
            // it.
            pushLiteral: function(value) {
                this.pushStackLiteral(value);
            },
            // [pushProgram]
            //
            // On stack, before: ...
            // On stack, after: program(guid), ...
            //
            // Push a program expression onto the stack. This takes
            // a compile-time guid and converts it into a runtime-accessible
            // expression.
            pushProgram: function(guid) {
                if (guid != null) {
                    this.pushStackLiteral(this.programExpression(guid));
                } else {
                    this.pushStackLiteral(null);
                }
            },
            // [invokeHelper]
            //
            // On stack, before: hash, inverse, program, params..., ...
            // On stack, after: result of helper invocation
            //
            // Pops off the helper's parameters, invokes the helper,
            // and pushes the helper's return value onto the stack.
            //
            // If the helper is not found, `helperMissing` is called.
            invokeHelper: function(paramSize, name) {
                this.context.aliases.helperMissing = "helpers.helperMissing";
                var helper = this.lastHelper = this.setupHelper(paramSize, name, true);
                var nonHelper = this.nameLookup("depth" + this.lastContext, name, "context");
                this.push(helper.name + " || " + nonHelper);
                this.replaceStack(function(name) {
                    return name + " ? " + name + ".call(" + helper.callParams + ") " + ": helperMissing.call(" + helper.helperMissingParams + ")";
                });
            },
            // [invokeKnownHelper]
            //
            // On stack, before: hash, inverse, program, params..., ...
            // On stack, after: result of helper invocation
            //
            // This operation is used when the helper is known to exist,
            // so a `helperMissing` fallback is not required.
            invokeKnownHelper: function(paramSize, name) {
                var helper = this.setupHelper(paramSize, name);
                this.push(helper.name + ".call(" + helper.callParams + ")");
            },
            // [invokeAmbiguous]
            //
            // On stack, before: hash, inverse, program, params..., ...
            // On stack, after: result of disambiguation
            //
            // This operation is used when an expression like `{{foo}}`
            // is provided, but we don't know at compile-time whether it
            // is a helper or a path.
            //
            // This operation emits more code than the other options,
            // and can be avoided by passing the `knownHelpers` and
            // `knownHelpersOnly` flags at compile-time.
            invokeAmbiguous: function(name, helperCall) {
                this.context.aliases.functionType = '"function"';
                this.pushStackLiteral("{}");
                // Hash value
                var helper = this.setupHelper(0, name, helperCall);
                var helperName = this.lastHelper = this.nameLookup("helpers", name, "helper");
                var nonHelper = this.nameLookup("depth" + this.lastContext, name, "context");
                var nextStack = this.nextStack();
                this.source.push("if (" + nextStack + " = " + helperName + ") { " + nextStack + " = " + nextStack + ".call(" + helper.callParams + "); }");
                this.source.push("else { " + nextStack + " = " + nonHelper + "; " + nextStack + " = typeof " + nextStack + " === functionType ? " + nextStack + ".apply(depth0) : " + nextStack + "; }");
            },
            // [invokePartial]
            //
            // On stack, before: context, ...
            // On stack after: result of partial invocation
            //
            // This operation pops off a context, invokes a partial with that context,
            // and pushes the result of the invocation back.
            invokePartial: function(name) {
                var params = [ this.nameLookup("partials", name, "partial"), "'" + name + "'", this.popStack(), "helpers", "partials" ];
                if (this.options.data) {
                    params.push("data");
                }
                this.context.aliases.self = "this";
                this.push("self.invokePartial(" + params.join(", ") + ")");
            },
            // [assignToHash]
            //
            // On stack, before: value, hash, ...
            // On stack, after: hash, ...
            //
            // Pops a value and hash off the stack, assigns `hash[key] = value`
            // and pushes the hash back onto the stack.
            assignToHash: function(key) {
                var value = this.popStack(), context, type;
                if (this.options.stringParams) {
                    type = this.popStack();
                    context = this.popStack();
                }
                var hash = this.hash;
                if (context) {
                    hash.contexts.push("'" + key + "': " + context);
                }
                if (type) {
                    hash.types.push("'" + key + "': " + type);
                }
                hash.values.push("'" + key + "': (" + value + ")");
            },
            // HELPERS
            compiler: JavaScriptCompiler,
            compileChildren: function(environment, options) {
                var children = environment.children, child, compiler;
                for (var i = 0, l = children.length; i < l; i++) {
                    child = children[i];
                    compiler = new this.compiler();
                    var index = this.matchExistingProgram(child);
                    if (index == null) {
                        this.context.programs.push("");
                        // Placeholder to prevent name conflicts for nested children
                        index = this.context.programs.length;
                        child.index = index;
                        child.name = "program" + index;
                        this.context.programs[index] = compiler.compile(child, options, this.context);
                        this.context.environments[index] = child;
                    } else {
                        child.index = index;
                        child.name = "program" + index;
                    }
                }
            },
            matchExistingProgram: function(child) {
                for (var i = 0, len = this.context.environments.length; i < len; i++) {
                    var environment = this.context.environments[i];
                    if (environment && environment.equals(child)) {
                        return i;
                    }
                }
            },
            programExpression: function(guid) {
                this.context.aliases.self = "this";
                if (guid == null) {
                    return "self.noop";
                }
                var child = this.environment.children[guid], depths = child.depths.list, depth;
                var programParams = [ child.index, child.name, "data" ];
                for (var i = 0, l = depths.length; i < l; i++) {
                    depth = depths[i];
                    if (depth === 1) {
                        programParams.push("depth0");
                    } else {
                        programParams.push("depth" + (depth - 1));
                    }
                }
                return (depths.length === 0 ? "self.program(" : "self.programWithDepth(") + programParams.join(", ") + ")";
            },
            register: function(name, val) {
                this.useRegister(name);
                this.source.push(name + " = " + val + ";");
            },
            useRegister: function(name) {
                if (!this.registers[name]) {
                    this.registers[name] = true;
                    this.registers.list.push(name);
                }
            },
            pushStackLiteral: function(item) {
                return this.push(new Literal(item));
            },
            pushStack: function(item) {
                this.flushInline();
                var stack = this.incrStack();
                if (item) {
                    this.source.push(stack + " = " + item + ";");
                }
                this.compileStack.push(stack);
                return stack;
            },
            replaceStack: function(callback) {
                var prefix = "", inline = this.isInline(), stack;
                // If we are currently inline then we want to merge the inline statement into the
                // replacement statement via ','
                if (inline) {
                    var top = this.popStack(true);
                    if (top instanceof Literal) {
                        // Literals do not need to be inlined
                        stack = top.value;
                    } else {
                        // Get or create the current stack name for use by the inline
                        var name = this.stackSlot ? this.topStackName() : this.incrStack();
                        prefix = "(" + this.push(name) + " = " + top + "),";
                        stack = this.topStack();
                    }
                } else {
                    stack = this.topStack();
                }
                var item = callback.call(this, stack);
                if (inline) {
                    if (this.inlineStack.length || this.compileStack.length) {
                        this.popStack();
                    }
                    this.push("(" + prefix + item + ")");
                } else {
                    // Prevent modification of the context depth variable. Through replaceStack
                    if (!/^stack/.test(stack)) {
                        stack = this.nextStack();
                    }
                    this.source.push(stack + " = (" + prefix + item + ");");
                }
                return stack;
            },
            nextStack: function() {
                return this.pushStack();
            },
            incrStack: function() {
                this.stackSlot++;
                if (this.stackSlot > this.stackVars.length) {
                    this.stackVars.push("stack" + this.stackSlot);
                }
                return this.topStackName();
            },
            topStackName: function() {
                return "stack" + this.stackSlot;
            },
            flushInline: function() {
                var inlineStack = this.inlineStack;
                if (inlineStack.length) {
                    this.inlineStack = [];
                    for (var i = 0, len = inlineStack.length; i < len; i++) {
                        var entry = inlineStack[i];
                        if (entry instanceof Literal) {
                            this.compileStack.push(entry);
                        } else {
                            this.pushStack(entry);
                        }
                    }
                }
            },
            isInline: function() {
                return this.inlineStack.length;
            },
            popStack: function(wrapped) {
                var inline = this.isInline(), item = (inline ? this.inlineStack : this.compileStack).pop();
                if (!wrapped && item instanceof Literal) {
                    return item.value;
                } else {
                    if (!inline) {
                        this.stackSlot--;
                    }
                    return item;
                }
            },
            topStack: function(wrapped) {
                var stack = this.isInline() ? this.inlineStack : this.compileStack, item = stack[stack.length - 1];
                if (!wrapped && item instanceof Literal) {
                    return item.value;
                } else {
                    return item;
                }
            },
            quotedString: function(str) {
                return '"' + str.replace(/\\/g, "\\\\").replace(/"/g, '\\"').replace(/\n/g, "\\n").replace(/\r/g, "\\r").replace(/\u2028/g, "\\u2028").replace(/\u2029/g, "\\u2029") + '"';
            },
            setupHelper: function(paramSize, name, missingParams) {
                var params = [];
                this.setupParams(paramSize, params, missingParams);
                var foundHelper = this.nameLookup("helpers", name, "helper");
                return {
                    params: params,
                    name: foundHelper,
                    callParams: [ "depth0" ].concat(params).join(", "),
                    helperMissingParams: missingParams && [ "depth0", this.quotedString(name) ].concat(params).join(", ")
                };
            },
            // the params and contexts arguments are passed in arrays
            // to fill in
            setupParams: function(paramSize, params, useRegister) {
                var options = [], contexts = [], types = [], param, inverse, program;
                options.push("hash:" + this.popStack());
                inverse = this.popStack();
                program = this.popStack();
                // Avoid setting fn and inverse if neither are set. This allows
                // helpers to do a check for `if (options.fn)`
                if (program || inverse) {
                    if (!program) {
                        this.context.aliases.self = "this";
                        program = "self.noop";
                    }
                    if (!inverse) {
                        this.context.aliases.self = "this";
                        inverse = "self.noop";
                    }
                    options.push("inverse:" + inverse);
                    options.push("fn:" + program);
                }
                for (var i = 0; i < paramSize; i++) {
                    param = this.popStack();
                    params.push(param);
                    if (this.options.stringParams) {
                        types.push(this.popStack());
                        contexts.push(this.popStack());
                    }
                }
                if (this.options.stringParams) {
                    options.push("contexts:[" + contexts.join(",") + "]");
                    options.push("types:[" + types.join(",") + "]");
                    options.push("hashContexts:hashContexts");
                    options.push("hashTypes:hashTypes");
                }
                if (this.options.data) {
                    options.push("data:data");
                }
                options = "{" + options.join(",") + "}";
                if (useRegister) {
                    this.register("options", options);
                    params.push("options");
                } else {
                    params.push(options);
                }
                return params.join(", ");
            }
        };
        var reservedWords = ("break else new var" + " case finally return void" + " catch for switch while" + " continue function this with" + " default if throw" + " delete in try" + " do instanceof typeof" + " abstract enum int short" + " boolean export interface static" + " byte extends long super" + " char final native synchronized" + " class float package throws" + " const goto private transient" + " debugger implements protected volatile" + " double import public let yield").split(" ");
        var compilerWords = JavaScriptCompiler.RESERVED_WORDS = {};
        for (var i = 0, l = reservedWords.length; i < l; i++) {
            compilerWords[reservedWords[i]] = true;
        }
        JavaScriptCompiler.isValidJavaScriptVariableName = function(name) {
            if (!JavaScriptCompiler.RESERVED_WORDS[name] && /^[a-zA-Z_$][0-9a-zA-Z_$]+$/.test(name)) {
                return true;
            }
            return false;
        };
        BbaseHandlebars.precompile = function(input, options) {
            if (input == null || typeof input !== "string" && input.constructor !== BbaseHandlebars.AST.ProgramNode) {
                throw new BbaseHandlebars.Exception("You must pass a string or BbaseHandlebars AST to BbaseHandlebars.precompile. You passed " + input);
            }
            options = options || {};
            if (!("data" in options)) {
                options.data = true;
            }
            var ast = BbaseHandlebars.parse(input);
            var environment = new Compiler().compile(ast, options);
            return new JavaScriptCompiler().compile(environment, options);
        };
        BbaseHandlebars.compile = function(input, options) {
            if (input == null || typeof input !== "string" && input.constructor !== BbaseHandlebars.AST.ProgramNode) {
                throw new BbaseHandlebars.Exception("You must pass a string or BbaseHandlebars AST to BbaseHandlebars.compile. You passed " + input);
            }
            options = options || {};
            if (!("data" in options)) {
                options.data = true;
            }
            var compiled;
            function compile() {
                var ast = BbaseHandlebars.parse(input);
                var environment = new Compiler().compile(ast, options);
                var templateSpec = new JavaScriptCompiler().compile(environment, options, undefined, true);
                return BbaseHandlebars.template(templateSpec);
            }
            // Template is only compiled on first use and cached after that point.
            return function(context, options) {
                if (!compiled) {
                    compiled = compile();
                }
                return compiled.call(this, context, options);
            };
        };
        // lib/handlebars/runtime.js
        BbaseHandlebars.VM = {
            template: function(templateSpec) {
                // Just add water
                var container = {
                    escapeExpression: BbaseHandlebars.Utils.escapeExpression,
                    invokePartial: BbaseHandlebars.VM.invokePartial,
                    programs: [],
                    program: function(i, fn, data) {
                        var programWrapper = this.programs[i];
                        if (data) {
                            programWrapper = BbaseHandlebars.VM.program(i, fn, data);
                        } else if (!programWrapper) {
                            programWrapper = this.programs[i] = BbaseHandlebars.VM.program(i, fn);
                        }
                        return programWrapper;
                    },
                    merge: function(param, common) {
                        var ret = param || common;
                        if (param && common) {
                            ret = {};
                            BbaseHandlebars.Utils.extend(ret, common);
                            BbaseHandlebars.Utils.extend(ret, param);
                        }
                        return ret;
                    },
                    programWithDepth: BbaseHandlebars.VM.programWithDepth,
                    noop: BbaseHandlebars.VM.noop,
                    compilerInfo: null
                };
                return function(context, options) {
                    options = options || {};
                    var result = templateSpec.call(container, BbaseHandlebars, context, options.helpers, options.partials, options.data);
                    var compilerInfo = container.compilerInfo || [], compilerRevision = compilerInfo[0] || 1, currentRevision = BbaseHandlebars.COMPILER_REVISION;
                    if (compilerRevision !== currentRevision) {
                        if (compilerRevision < currentRevision) {
                            var runtimeVersions = BbaseHandlebars.REVISION_CHANGES[currentRevision], compilerVersions = BbaseHandlebars.REVISION_CHANGES[compilerRevision];
                            throw "Template was precompiled with an older version of BbaseHandlebars than the current runtime. " + "Please update your precompiler to a newer version (" + runtimeVersions + ") or downgrade your runtime to an older version (" + compilerVersions + ").";
                        } else {
                            // Use the embedded version info since the runtime doesn't know about this revision yet
                            throw "Template was precompiled with a newer version of BbaseHandlebars than the current runtime. " + "Please update your runtime to a newer version (" + compilerInfo[1] + ").";
                        }
                    }
                    return result;
                };
            },
            programWithDepth: function(i, fn, data) {
                var args = Array.prototype.slice.call(arguments, 3);
                var program = function(context, options) {
                    options = options || {};
                    return fn.apply(this, [ context, options.data || data ].concat(args));
                };
                program.program = i;
                program.depth = args.length;
                return program;
            },
            program: function(i, fn, data) {
                var program = function(context, options) {
                    options = options || {};
                    return fn(context, options.data || data);
                };
                program.program = i;
                program.depth = 0;
                return program;
            },
            noop: function() {
                return "";
            },
            invokePartial: function(partial, name, context, helpers, partials, data) {
                var options = {
                    helpers: helpers,
                    partials: partials,
                    data: data
                };
                if (partial === undefined) {
                    throw new BbaseHandlebars.Exception("The partial " + name + " could not be found");
                } else if (partial instanceof Function) {
                    return partial(context, options);
                } else if (!BbaseHandlebars.compile) {
                    throw new BbaseHandlebars.Exception("The partial " + name + " could not be compiled when running in runtime-only mode");
                } else {
                    partials[name] = BbaseHandlebars.compile(partial, {
                        data: data !== undefined
                    });
                    return partials[name](context, options);
                }
            }
        };
        BbaseHandlebars.template = BbaseHandlebars.VM.template;
    })(BbaseHandlebars);
/**
 * @description BbaseHandlebarsHelper模板引擎帮助类
 * @class BbaseHandlebarsHelper - 标签库
 * @author yongjin on 2014/11/11
 */

/**
 * 比较(新版将弃用)
 * @method [判断] - compare
 * @author wyj 2014-03-27
 * @example
 *      {{#compare ../page '!==' this}}danaiPageNum{{else}}active{{/compare}}
 */
BbaseHandlebars.registerHelper('compare', function (v1, operator, v2, options) {
  if (arguments.length < 3)
    throw new Error("Handlerbars Helper 'compare' needs 2 parameters");
  try {
    switch (operator.toString()) {
      case '==':
        return (v1 == v2) ? options.fn(this) :
          options.inverse(this);
      case '!=':
        return (v1 != v2) ? options.fn(this) :
          options.inverse(this);
      case '===':
        return (v1 === v2) ? options.fn(this) :
          options.inverse(this);
      case '!==':
        return (v1 !== v2) ? options.fn(this) :
          options.inverse(this);
      case '<':
        return (v1 < v2) ? options.fn(this) :
          options.inverse(this);
      case '<=':
        return (v1 <= v2) ? options.fn(this) :
          options.inverse(this);
      case '>':
        return (v1 > v2) ? options.fn(this) :
          options.inverse(this);
      case '>=':
        return (v1 >= v2) ? options.fn(this) :
          options.inverse(this);
      case '&&':
        return (v1 && v2) ? options.fn(this) :
          options.inverse(this);
      case '||':
        return (v1 || v2) ? options.fn(this) :
          options.inverse(this);
      case 'indexOf':
        return (v1.indexOf(v2) > -1) ? options.fn(this) :
          options.inverse(this);
      default:
        return options.inverse(this);
    }
  } catch (e) {
    console.log('Errow: hbs.compare v1=' + v1 + ';v2=' + v2 + e);
  }
});


/**
 * 分页
 * @method [分页] - pagination
 * @author wyj 2014-03-27
 * @example
 *        {{#pagination page totalPage}}
 <li class="bui-bar-item bui-button-number bui-inline-block {{#compare ../page this operator='!=='}}danaiPageNum
 {{else}}active{{/compare}}" data-page="{{this}}" aria-disabled="false" id="{{this}}" aria-pressed="false">
 <a href="javascript:;">{{this}}</a></li>
 {{/pagination}}
 */
BbaseHandlebars.registerHelper('pagination', function (page, totalPage, sum, block) {
  var accum = '',
    block = block,
    sum = sum;
  if (arguments.length === 3) {
    block = sum;
    sum = 9;
  }
  var pages = BbaseEst.getPaginationNumber(page, totalPage, sum);
  for (var i = 0, len = pages.length; i < len; i++) {
    accum += block.fn(pages[i]);
  }
  return accum;
});

/**
 * 根据path获取值
 * @method get
 * @author wyj 15.2.1
 * @example
 *      BbaseHandlebars.helpers["get"].apply(this, date)
 */
BbaseHandlebars.registerHelper('get', function (path, options) {
  if (typeof path !== 'undefined' && BbaseEst.typeOf(path) === 'string') {
    var list = path.split('.');
    if (list[0] in this) {
      if (list.length > 1) {
        if (BbaseEst.typeOf(this[list[0]]) !== 'object') {
          this[list[0]] = JSON.parse(this[list[0]]);
        }
        return BbaseEst.getValue(this, path);
      } else {
        return this[list[0]];
      }
    }
  } else {
    return path;
  }
});


/**
 * 时间格式化
 * @method [时间] - dateFormat
 * @author wyj 2014-03-27
 * @example
 *      {{dateFormat $.detail_news.add_time $.lan.news.format}}
 */
BbaseHandlebars.registerHelper('dateFormat', function (date, fmt, options) {
  return BbaseEst.dateFormat(date, fmt);
});

/**
 * 判断字符串是否包含
 * @method [判断] - contains
 * @author wyj 14.11.17
 * @example
 *      {{#contains ../element this}}checked="checked"{{/contains}}
 */
BbaseHandlebars.registerHelper('contains', function (target, thisVal, options) {
  if (BbaseEst.isEmpty(target)) return;
  return BbaseEst.contains(target, thisVal) ? options.fn(this) : options.inverse(this);
});

/**
 * 两数相加
 * @method [运算] - plus
 * @author wyj 2014-03-27
 * @example
 *      {{plus 1 2}} => 3
 */
BbaseHandlebars.registerHelper('plus', function (num1, num2, opts) {
  return parseInt(num1, 10) + parseInt(num2, 10);
});
/**
 * 两数相减
 * @method [运算] - minus
 * @author wyj 2014-03-27
 * @example
 *        {{minus 10 5}} => 5
 */
BbaseHandlebars.registerHelper('minus', function (num1, num2, opts) {
  return (parseInt(num1, 10) - parseInt(num2, 10)) + '';
});

/**
 * 字符串截取
 * @method [字符串] - cutByte
 * @author wyj 2014-03-27
 * @example
 *      {{cutByte name 5 end='...'}}
 */
BbaseHandlebars.registerHelper('cutByte', function (str, len, options) {
  return BbaseEst.cutByte(str, len, options.hash.end || '...');
});

/**
 * 复杂条件(新版将弃用)
 * @method [判断] - xif
 * @author wyj 14.12.31
 * @example
 *       return BbaseHandlebars.helpers["x"].apply(this, [expression, options]) ? options.fn(this) : options.inverse(this);
 *
 */
BbaseHandlebars.registerHelper("x", function (expression, options) {
  var fn = function () {},
    result;
  try {
    fn = Function.apply(this, ['window', 'return ' + expression + ';']);
  } catch (e) {
    console.warn('[warning] {{x ' + expression + '}} is invalid javascript', e);
  }
  try {
    result = fn.bind(this)(window);
  } catch (e) {
    console.warn('[warning] {{x ' + expression + '}} runtime error', e);
  }
  return result;
});

/**
 * xif条件表达式(新版将弃用)
 * @method [判断] - xif
 * @author wyj 15.2.2
 * @example
 *    {{#xif "this.orderStatus != 'completed' && this.orderStatus != 'invalid' && this.paymentStatus == 'unpaid' &&
              this.shippingStatus == 'unshipped'"}}disabled{{/xif}}
 */
BbaseHandlebars.registerHelper("xif", function (expression, options) {
  return BbaseHandlebars.helpers["x"].apply(this, [expression, options]) ? options.fn(this) : options.inverse(this);
});

/**
 * if判断
 * @method If
 * @param  {[type]} expression [description]
 * @param  {[type]} options)   {             return BbaseEst.compile(expression, this) ? options.fn(this) : options.inverse(this);} [description]
 * @return {[type]}            [description]
 */
BbaseHandlebars.registerHelper('If', function (expression, options) {
  var bool = BbaseEst.compile('{{' + expression.replace(/_quote_/img, "'").replace(/&amp;/img, "&") + '}}', this);

  if (bool === 'true' || bool === '1') {
    bool = true;
  } else if (bool === 'false' || bool === '0' || bool === '') {
    bool = false;
  } else if (BbaseEst.typeOf(bool) === 'string' && !BbaseEst.isEmpty(bool)) {
    bool = true;
  }

  return bool ? options.fn(this) : options.inverse(this);
});

/**
 * 返回整数
 * @method [数字] - parseInt
 * @author wxw 2014-12-16
 * @example
 *      {{parseInt 01}}
 */
BbaseHandlebars.registerHelper('parseInt', function (result, options) {
  return parseInt(result, 10);
});

/**
 * 缩略ID值
 * @method id2
 * @author wyj
 */
BbaseHandlebars.registerHelper('id2', function (id) {
  return id == null ? "" : id.replace(/^[^1-9]+/, "")
});

/**
 * 返回全局常量
 * @method [常量] - CONST
 * @author wyj 14.12.17
 * @example
 *        {{CONST 'HOST'}}
 */
BbaseHandlebars.registerHelper('CONST', function (name, options) {
  return BbaseEst.getValue(CONST, name);
});
/**
 * 图片尺寸 （返回不带图片域名的地址）
 * @method [图片] - picUrl
 * @author wyj 2014-03-31
 * @example
 *      <img src="{{CONST 'PIC_URL'}}/{{picUrl picPath 6}}" width="52" height="52">
 */
BbaseHandlebars.registerHelper('picUrl', function (src, number, opts) {
  var url = src;
  if (arguments.length < 3) return src || CONST.PIC_NONE;
  if (src == null || src.length == 0) return CONST.PIC_NONE;
  if (number > 10) {
    url = url + '!' + number
  } else {
    var url2 = url.substring(url.lastIndexOf(".") + 1, url.length);
    url = url.substring(0, url.lastIndexOf(".")) + "_" + number + "." + url2;
  }

  return url ? url : '';
});
BbaseHandlebars.registerHelper('_picUrl', function (src, number, options) {
  var domain = CONST.PIC_URL;
  if (options && options.hash.domain) {
    domain = options.hash.domain;
  }
  return domain + '/' + BbaseHandlebars.helpers['picUrl'].apply(this, [src, number, options]);
});

/**
 * 返回图片地址常量（返回添加图片域名的图片地址, 推荐使用）
 * @method [常量] - PIC
 * @author wyj 14.12.17
 * @example
 *        {{PIC pic}}   ==> http://img.jihui88.com/upload/a/a1/picture/2015/12/20/pic.jpg?v=2015-12-20_12:30
 *        {{PIC pic 5}} ==> http://img.jihui88.com/upload/a/a1/picture/2015/12/20/pic_5.jpg?v=2015-12-20_12:30
 */
BbaseHandlebars.registerHelper('PIC', function (name, number, options) {
  var version = '';
  var options = options;
  var def = CONST.PIC_NONE;
  var domain = CONST.PIC_URL;
  if (arguments.length < 3) {
    options = number;
  }
  if (options && options.hash.default) {
    def = options.hash.default;
  }
  if (options && options.hash.domain) {
    domain = options.hash.domain;
  }
  if (name) {
    name = name.replace(/\\/img, '/');
    version += (name.indexOf('?') > -1 ? ('&v=' + BbaseEst.hash(CONST.APP_VERSION)) :
      '?v=' + BbaseEst.hash(CONST.APP_VERSION));
    if (BbaseEst.startsWidth(name, 'CONST')) {
      name = BbaseHandlebars.helpers['CONST'].apply(this, [name.replace('CONST.', ''), options]);
    }
  }
  if (!name || !/[^\s]+\.(?:jpe?g|gif|png|bmp)/i.test(name)) return def.indexOf('http://') > -1 ? def : CONST.DOMAIN + def + version;
  if (name.indexOf('upaiyun.com') === -1 && BbaseEst.startsWidth(name, 'http') && name.indexOf('upload') > -1) {
    name = name.substring(name.indexOf('upload'), name.length);
  }
  if (name.indexOf('upaiyun.com') === -1 && BbaseEst.startsWidth(name, 'upload')) {
    return arguments.length < 3 ? domain + '/' + name + version :
      BbaseHandlebars.helpers['_picUrl'].apply(this, [name, number, options]) + version;
  }

  return BbaseEst.startsWidth(name, 'http') ? name + version : CONST.DOMAIN + name + version;
});

/**
 * 判断是否为空
 * @method [判断] - isEmpty
 * @author wyj 14.12.27
 * @example
 *      {{#isEmpty image}}<img src='...'></img>{{/isEmpty}}
 */
BbaseHandlebars.registerHelper('isEmpty', function (value, options) {
  return BbaseEst.isEmpty(value) ? options.fn(this) :
    options.inverse(this);
});

/**
 * 编译url
 * @method [url] - encodeUrl
 * @author wyj 15.2.1
 * @example
 *      {{encodeUrl url}}
 */
BbaseHandlebars.registerHelper('encodeUrl', function (val, options) {
  return encodeURIComponent(val);
});

/**
 * 解析JSON字符串
 * @method [JSON] - json
 * @example
 *      {{json 'invite.title'}}
 */
BbaseHandlebars.registerHelper('json', function (path, options) {
  return BbaseHandlebars.helpers["get"].call(this, path);
});
/**
 * 打版本号
 * @method [版本] - version
 * @example
 *      http://www.jihui88.com?v={{version}}
 */
BbaseHandlebars.registerHelper('version', function (type, options) {
  switch (type) {
    case 'time':
      return new Date().getTime();
      break;
    case 'hash':
      return BbaseEst.hash(new Date().getTime());
      break;
    default:
      return BbaseEst.hash(new Date().getTime());
  }
});

/**
 * 移除script标签
 * @method [标签] - stripScripts
 * @author wyj 15.5.12
 * @example
 *    {{stripScripts '<scripts></scripts>'}}
 */
BbaseHandlebars.registerHelper('stripScripts', function (str, options) {
  return BbaseEst.stripScripts(str);
});

/**
 * 替换
 * @method [字符串] - replace
 * @author wyj 15.5.12
 * @example
 *    {{replace module.type '\d*$' ''}}
 */
BbaseHandlebars.registerHelper('replace', function (val1, reg, val2, options) {
  if (BbaseEst.isEmpty(val1)) {
    return val1
  }
  return val1.replace(new RegExp(reg, 'img'), val2);
});

/**
 * 默认值
 * @method [字符串] - default
 * @author wyj 15.5.12
 * @example
 *    {{default module.type 'aa'}}
 */
BbaseHandlebars.registerHelper('default', function (val1, val2, options) {
  return BbaseEst.isEmpty(val1) ? val2 : val1;
});

/**
 * 映射
 * @method [字符串] - keyMap
 * @author wyj 15.5.12
 * @example
 *    {{keyMap module.type 'aa'}}
 */
BbaseHandlebars.registerHelper('keyMap', function (val1, val2, options) {
  if (!val1 || !val2) return '';
  return val2[val1];
});
/**
 * radio标签
 *
 * @method [表单] - radio
 * @author wyj 15.1.7
 * @example
 *        {{{radio name='isBest' value=isBest option='{"是": "01", "否": "00"}' }}}
 */
BbaseHandlebars.registerHelper('radio', function (options) {
  var result = [], list = $.parseJSON ? $.parseJSON(options.hash.option) : JSON.parse(options.hash.options);
  Est.each(list, function (val, key, list, index) {
    var checked = options.hash.value === val ? 'checked' : '';
    result.push('<label><input id="model' + index + '-' + options.hash.name + '" type="radio" name="' + options.hash.name +
      '" value="' + val + '" ' + checked + '>&nbsp;' + key + '</label>&nbsp;&nbsp;');
  });
  return result.join('');
});

/**
 * checkbox标签
 *
 * @method [表单] - checkbox
 * @author wyj 15.6.19
 * @example
 *      {{{checkbox label='' name='isDefault' value=isDefault trueVal='1' falseVal='0' }}}
 */
BbaseHandlebars.registerHelper('checkbox', function (options) {
  var id = options.hash.id ? options.hash.id : ('model-' + options.hash.name);
  var random = Est.nextUid('checkbox'); // 随机数
  var icon_style = "font-size: 32px;"; // 图标大小
  var value = Est.isEmpty(options.hash.value) ? options.hash.falseVal : options.hash.value; // 取值
  var isChecked = value === options.hash.trueVal ? true : false; // 是否选中状态
  var defaultClass = isChecked ? 'icon-checkbox' : 'icon-checkboxno';
  var args = ("'" + random + "'"); // 参数

  var result = '<div> <label for="' + id + '" style="overflow:hidden;display:inline-block;"> ' +
    '<input onclick="window.ckToggleClass(' + args + ');" type="checkbox" name="' + options.hash.name + '" id="' + id + '" value="' + value + '" ' + (isChecked ? 'checked' : '') + ' true-value="' + options.hash.trueVal + '" false-value="' + options.hash.falseVal + '"  class="rc-hidden" style="display: none;">' +
    '<i id="' + random + '" class="iconfont ' + defaultClass + '" style="' + icon_style + '"></i>' + options.hash.label +
    '</label></div>';
  return result;
});

/**
 * select标签
 *
 * @method [表单] - select
 * @author wyj 15.6.22
 * @example
 *      {{{select name='paymentConfit' value=curConfitPanment key='paymentId' text='name' list=paymentConfigList  style="height: 40px;"}}}
 *
 */
BbaseHandlebars.registerHelper('select', function (options) {
  var id = options.hash.id ? options.hash.id : ('model-' + options.hash.name);
  var str = '<select name="' + options.hash.name + '" id="' + id + '"  class="' + (options.hash.className || '') + '" style="' + (options.hash.style || '') + '"> ';
  Est.each(options.hash.list, function (item) {
    var selected = options.hash.value === item[options.hash.key] ? 'selected' : '';
    str += '<option value="' + item[options.hash.key] + '" ' + selected + '>' + item[options.hash.text] + '</option>';
  });
  return str + '</select>';
});
/**
 * 管道过滤
 *
 * @method [字符串] - pipe
 * @author wyj 15.5.12
 * @example
 *    {{pipe 'Math.floor(age);age+1;plus(age, 1);plus(age, age);'}}
 */
BbaseHandlebars.registerHelper('pipe', function (expression) {
  var result,
    preName = null,
    preType = 'string',
    bracketRe = /\(([^:\$]*)\)/img,
    obj = BbaseEst.cloneDeep(this),
    list = expression.split(';');

  BbaseEst.each(list, function (pipe, index) {
    pipe = BbaseEst.trim(pipe);
    if (BbaseEst.isEmpty(pipe)) return;
    var dollars = [];
    var key = null;
    var helper = '';
    var brackets = pipe.match(bracketRe);
    if (brackets) {
      BbaseEst.each(brackets[0].split(','), function (item) {
        var name = BbaseEst.trim(item.split('.')[0].replace(/[\(|\)]/img, ''));
        if (!key) {
          key = name;
          if (index === 0) preType = BbaseEst.typeOf(BbaseEst.getValue(obj, key));
        }
        if (name.indexOf('\'') > -1) {
          dollars.push(name.replace(/'/img, ''));
        } else if (/^[\d\.]+$/img.test(name)) {
          dollars.push(parseFloat(name));
        } else {
          dollars.push(BbaseEst.getValue(obj, name));
        }
      }, this);
    }

    helper = BbaseEst.trim(pipe.replace(/\(.*\)/g, ''));
    if (BbaseHandlebars.helpers[helper]) {
      result = BbaseHandlebars.helpers[helper].apply(obj, dollars);
    } else if (BbaseApp.getFilter(helper)) {
      result = BbaseApp.getFilter(helper).apply(obj, dollars);
    } else {
      result = BbaseEst.compile('{{' + pipe + '}}', obj);
      if (result.indexOf('NaN') > -1) {
        result = result.replace(/NaN/img, '');
      }
      if (result.indexOf('undefined') > -1) {
        result = result.replace(/undefined/img, '');
      }
      if (result.indexOf('null') > -1) {
        result = result.replace(/null/img, '');
      }
    }

    if (BbaseEst.isEmpty(key)) {
      key = preName;
    } else {
      preName = key;
    }
    switch (preType) {
      case 'string':
        result = String(result);
        break;
      case 'number':
        if (/^[\d.]*$/.test(result)) {
          result = Number(result);
        }
        break;
      case 'boolean':
        result = Boolean(result);
        break;
      default:
        result = String(result);
    }
    obj[key] = result;

  }, this);

  return result;
});

/**
 * @description 应用程序管理器 - 中介者模式， 用于注册视图、模块、路由、模板等。
 * @class BbaseApp - 用户后台
 * @author yongjin<zjut_wyj@163.com> 2014/12/28
 */
var BbaseApplication = function (options) {
  this.options = options;
  BbaseEst.extend(this, options);
  this.initialize.apply(this, arguments);
};
BbaseEst.extend(BbaseApplication.prototype, {
  initialize: function () {
    this.data = { itemActiveList: [], sessionId: '' }; // 全局数据
    this.instance = {}; // 实例对象
    this.modules = {}; // 所有模块
    this.routes = {}; // 路由
    this.templates = {}; // 静态模板
    this.panels = {}; // 面板
    this.dialog = []; // 对话框
    this.dialogs = {}; // 带身份标识的dialog
    this.status = {}; // 状态
    if (typeof app !== 'undefined' && app.getStatus){
      this.status = BbaseEst.extend(this.status, app.getAllStatus());
    }
    this.cookies = []; // 会话
    this.models = []; // 实体对象
    this.compileTemps = {}; // 编译模版
    this.filters = { navigator: [], form: [] }; // 过滤器
    this.cache = {}; // 缓存
    this.directives = {}; // 指令
  },
  /**
   * 返回当前应用底层使用的是backbone版本
   *
   * @method [版本] - getAppType ( 获取App版本 )
   * @return {string}
   * @author wyj 15.5.20
   */
  getAppType: function () {
    return 'backbone';
  },
  /**
   * 视图添加， 当重新添加时会调用destroy方法
   *
   * @method [视图] - addRegion ( 添加视图[推荐使用] )
   * @param name
   * @param instance
   * @return {*}
   * @example
   *      BbaseApp.addRegion('productList', ProductList, {
   *        viewId: 'productList',     // 可省略
   *        el: '',
   *        args: args
   *      });
   */
  addRegion: function (name, instance, options) {
    var panel = BbaseEst.nextUid('region');

    if (!options.__panelId) {
      options.__panelId = options.el;
    }
    if (options.diff && BbaseApp.getView(options.viewId || name)) {
      BbaseApp.getView(options.viewId || name)._extend(options);
      BbaseApp.getView(options.viewId || name)._reset(options.data);
      return;
    }
    this.addPanel(name, {
      el: options.__panelId,
      template: '<div class="region ' + panel + '"></div>',
      append: options.append
    }, options);
    if (!options.viewId) {
      options.viewId = name;
    }
    if (options.viewId in this.instance) {
      this.removeView(options.viewId);
    }

    return this.addView(options.viewId, new instance(options));
  },
  /**
   * 添加面板
   *
   * @method [面板] - addPanel ( 添加面板 )
   * @param name
   * @param options
   * @return {BbaseApp}
   * @example
   *        BbaseApp.addPanel('product', new Panel());
   *        BbaseApp.addPanel('product', {
   *          el: '#product-panel',
   *          template: '<div clas="product-panel-inner"></div>'
   *        }).addView('aliPay', new AlipayView({
   *          el: '.product-panel-inner',
   *          viewId: 'alipayView'
   *        }));
   */
  addPanel: function (name, panel, options) {
    var isObject = BbaseEst.typeOf(panel.cid) === 'string' ? false : true;
    options = options || {};
    BbaseUtils.addLoading();
    if (isObject) {
      this.removePanel(name, panel);
      panel.$template = $(panel.template);
      if (options) options.el = panel.$template;
      panel.$template.addClass('__panel_' + name);
      panel.$template.attr('data-view', options.viewId || name);
      if (!panel.append) $(panel.el).empty();
      $(panel.el).append(panel.$template);
    }
    this.panels[name] = panel;
    return isObject ? this : panel;
  },
  /**
   * 移除面板
   *
   * @method [面板] - removePanel ( 移除面板 )
   * @param name
   * @author wyj 14.12.29
   */
  removePanel: function (name, panel) {
    try {
      var views = [];
      if (!panel) panel = this.panels[name];
      if (!panel) return;
      if (panel.el !== 'body') {
        $('.region', $(panel.el)).each(function () {
          views.push($(this).attr('data-view'));
        });
        views.reverse();
        BbaseEst.each(views, function (name) {
          BbaseApp.removeView(name);
        });
      }
      $('.__panel_' + name, $(panel.el)).off().remove();
      delete this.panels[name];
    } catch (e) {
      console.error(e);
    }
  },
  /**
   * 视图添加
   *
   * @method [视图] - addView ( 添加视图 )
   * @param name
   * @param instance
   * @return {*}
   * @example
   *      BbaseApp.addView('productList', new ProductList());
   */
  addView: function (name, instance) {
    if (name in this.instance) this.removeView(name);
    this.instance[name] = instance;

    instance = instance || {};
    instance.options = instance.options || {};
    instance.options.viewId = instance.options.viewId || name;

    this.setCurrentView(name);
    return this.instance[name];
  },
  /**
   * 视图移除， 移除视图绑定的事件及所有itemView的绑定事件,
   * 并移除所有在此视图创建的对话框
   *
   * @method [视图] - removeView ( 移除视图 )
   * @param name
   * @return {BbaseApp}
   * @example
   *        BbaseApp.removeView('productList');
   */
  removeView: function (name) {
    try {
      if (this.getView(name)) {
        if (this.getView(name).destroy) this.getView(name).destroy();
        if (this.getView(name)._destroy) this.getView(name)._destroy()
        if (this.getView(name)._empty) this.getView(name)._empty();
        if (this.getView(name).stopListening) this.getView(name).stopListening();
        if (this.getView(name).$el) this.getView(name).$el.off().remove();
      }
      delete this.instance[name];
    } catch (e) {
      console.log(e);
    }
    return this;
  },

  panel: function (name, panel) {
    return this.addPanel(name, panel);
  },
  /**
   * 显示视图
   *
   * @method [面板] - show ( 显示视图 )
   * @param view
   * @author wyj 14.12.29
   */
  show: function (view) {
    this.addView(this.currentView, view);
  },

  /**
   * 获取面板
   *
   * @method [面板] - getPanel ( 获取面板 )
   * @param name
   * @return {*}
   * @author wyj 14.12.28
   * @example
   *      BbaseApp.getPanelf('panel');
   */
  getPanel: function (name) {
    return this.panels[name];
  },

  add: function (name, instance) {
    return this.addView(name, instance);
  },

  /**
   * 设置当前视图
   * @method [视图] - setCurrentView ( 设置当前视图 )
   * @param name
   * @example
   *      BbaseApp.setCurrentView('list', new List());
   */
  setCurrentView: function (name) {
    this.currentView = name;
  },
  /**
   * 获取当前视图
   * @method [视图] - getCurrentView ( 获取当前视图 )
   * @return {*|BbaseApp.currentView}
   * @author wyj 15.1.9
   * @example
   *        BbaseApp.getCurrentView('list');
   */
  getCurrentView: function () {
    return this.currentView;
  },
  /**
   * 获取视图
   *
   * @method [视图] - getView ( 获取视图 )
   * @param name
   * @return {*}
   * @author wyj 14.12.28
   * @example
   *        BbaseApp.getView('productList');
   */
  getView: function (name) {
    return this.instance[name];
  },
  /**
   * 添加对话框
   *
   * @method [对话框] - addDailog ( 添加对话框 )
   * @param dialog
   * @return {*}
   * @example
   *      BbaseApp.addDialog(dialog, id);
   */
  addDialog: function (dialog, id) {
    this.dialog.push(dialog);
    if (id) {
      BbaseApp.addData('_curDialog', id);
      this.dialogs[id] = dialog;
    }
    return dialog;
  },
  /**
   * 获取所有对话框
   * @method [对话框] - getDialogs ( 获取所有对话框 )
   * @return {*}
   * @author wyj 15.1.23
   */
  getDialogs: function () {
    return this.dialog;
  },
  /**
   * 获取指定对话框
   * @method [对话框] - getDialog ( 获取指定对话框 )
   * @author wyj 15.03.20
   *
   */
  getDialog: function (id) {
    if (BbaseEst.isEmpty(id)) return this.dialogs;
    return this.dialogs[id];
  },
  /**
   * 获取最后打开的dialog对话框
   * @method [对话框] - getCurrentDialog ( 获取当前对话框 )
   * @return {*}
   * @author wyj 15.10.25
   */
  getCurrentDialog: function () {
    if (BbaseApp.getData('_curDialog')) {
      return this.dialogs[BbaseApp.getData('_curDialog')];
    }
    return null;
  },
  /**
   * 清空所有对话框, 当切换页面时移除所有对话框
   *
   * @method [对话框] - emptyDialog ( 清空所有对话框 )
   * @author wyj 14.12.28
   * @example
   *      BbaseApp.emptyDialog();
   */
  emptyDialog: function () {
    BbaseEst.each(this.dialog, function (item) {
      if (item && item.close) {
        item.close().remove();
      }
    });
    this.dialog = [];
    this.dialogs = {};
    BbaseApp.addData('_curDialog', null);
  },
  /**
   * 添加模型类
   * @method [模型] - addModel ( 添加模型类 )
   * @author wyj 15.1.23
   */
  addModel: function (model) {
    this.models.push(model);
    return model;
  },
  /**
   * 获取所有模型类
   * @method [模型] - getModels ( 获取所有模型类 )
   * @author wyj 15.1.23
   */
  getModels: function () {
    return this.models;
  },

  /**
   * 添加数据
   *
   * @method [数据] - addData ( 添加数据 )
   * @param name
   * @param data
   * @author wyj 14.12.28
   * @example
   *      BbaseApp.addData('productList', productList);
   */
  addData: function (name, data) {
    this.data[name] = data;
  },
  /**
   * 获取数据
   *
   * @method [数据] - getData ( 获取数据 )
   * @param name
   * @return {*}
   * @author wyj 14.12.28
   * @example
   *        BbaseApp.getData('productList');
   */
  getData: function (name) {
    return this.data[name];
  },
  /**
   * 添加模块 分拆seajs配置文件，
   * 实现每个模板都有自己的模块配置文件
   *
   * @method [模块] - addModule ( 添加模块 )
   * @param name
   * @param val
   * @author wyj 14.12.28
   * @example
   *        BbaseApp.addModule('ProductList', '/modules/product/controllers/ProductList.js');
   */
  addModule: function (name, val) {
    if (name in this['modules']) {
      console.log('module:' + name + ' isExisted');
    }
    this.modules[name] = val;
  },
  /**
   * 获取所有模块
   *
   * @method [模块] - getModules ( 获取所有模块 )
   * @return {*}
   * @author wyj 14.12.28
   * @example
   *
   */
  getModules: function () {
    return this.modules;
  },
  /**
   * 添加路由
   *
   * @method [路由] - addRoute ( 添加路由 )
   * @param name
   * @param fn
   * @author wyj 14.12.28
   * @example
   *      BbaseApp.addRoute('product', function(){
   *          seajs.use(['ProductList'], function(ProductList){
   *          });
   *      });
   */
  addRoute: function (name, fn) {
    if (name in this['routes']) {
      console.log('route:' + name + ' isExisted');
    }
    this.routes[name] = fn;
  },
  /**
   * 获取所有路由
   *
   * @method [路由] - getRoutes ( 获取所有路由 )
   * @return {*}
   * @author wyj 14.12.28
   *
   */
  getRoutes: function () {
    return this.routes;
  },
  /**
   * 添加模板, 目前无法解决seajs的实时获取问题
   *
   * @method [模板] - addTemplate ( 添加模板 )
   * @param name
   * @param fn
   * @author wyj 14.12.28
   * @example
   *        BbaseApp.addTemplate('template/photo_item', function (require, exports, module) {
              module.exports = require('modules/album/views/photo_item.html');
            });
   */
  addTemplate: function (name, fn) {
    this.templates[name] = fn;
  },
  /**
   * 获取所有模板
   *
   * @method [模板] - getTemplates ( 获取所有模板 )
   * @return {*}
   * @author wyj 14.12.28
   * @example
   *        BbaseApp.getTemplates();
   */
  getTemplates: function () {
    return this.templates;
  },
  /**
   * 添加session会话   登录成功后会添加__USER__ 用户信息会话， 获取：App.getSession('__USER__');
   * 当需要区分用户唯一性时， 在设置前先设置sessionId   BbaseApp.addData('sessionId', 'Enterprise_0000000000000000032');
   *
   * @method [会话] - addSession ( 添加session会话 )
   * @param name
   * @param value
   * @return {*}
   * @author wyj 15.4.22
   * @example
   *      App.addSession('__USER__', {username: 'ggggfj'});
   */
  addSession: function (name, value, isSession) {
    try {
      var sessionId = BbaseEst.typeOf(isSession) === 'undefined' ? '' : isSession ? this.data.sessionId : '';
      localStorage['___JHW_BACKBONE__' + BbaseEst.hash(sessionId + name)] = JSON.stringify(value);
    } catch (e) {
      debug('Error9 -> addSession -> ' + e); //debug__
    }
    return value;
  },
  /**
   * 读取session会话
   *
   * @method [会话] - getSession ( 读取session会话 )
   * @param name
   * @return {Object}
   * @example
   *      App.getSession('__USER__'); => {username: 'ggggfj'}
   */
  getSession: function (name, isSession) {
    try {
      var sessionId = BbaseEst.typeOf(isSession) === 'undefined' ? '' : isSession ? this.data.sessionId : '';
      return JSON.parse(localStorage['___JHW_BACKBONE__' + BbaseEst.hash(sessionId + name)]);
    } catch (e) {
      BbaseApp.addSession(name, '');
      return '';
    }

  },
  /**
   * 添加编译模板
   * @method [模板] - addCompileTemp ( 添加编译模板 )
   * @param name
   * @param compile
   */
  addCompileTemp: function (name, compile) {
    this.compileTemps[name] = compile;
  },
  /**
   * 获取编译模板
   * @method [模板] - getCompileTemp ( 获取编译模板 )
   * @param name
   * @return {*}
   */
  getCompileTemp: function (name) {
    return this.compileTemps[name];
  },
  /**
   * 添加状态数据
   *
   * @method [状态] - SSaatus ( 添加状态数据 )
   * @param name
   * @param value
   * @author wyj 15.1.7
   */
  addStatus: function (name, value) {
    this.status[name] = value;
  },
  /**
   * 获取状态数据
   *
   * @method [状态] - getStatus ( 获取状态数据 )
   * @param name
   * @param value
   * @author wyj 15.1.7
   */
  getStatus: function (name) {
    return this.status[name];
  },
  /**
   * 获取所有状态数据
   *
   * @method [状态] - getAllStatus ( 获取所有状态数据 )
   * @return {{}|*|BbaseApp.status}
   * @author wyj 15.1.9
   */
  getAllStatus: function () {
    return this.status;
  },
  /**
   * 添加参数配置对象
   *
   * @method [配置] - addOption ( 添加配置对象 )
   * @author wyj 15.9.19
   */
  addOption: function (name, value) {
    this.options[name] = value;
  },
  /**
   * 获取参数配置对象
   *
   * @method [配置] - getOption ( 获取配置对象 )
   * @param name
   * @return {*}
   * @author wyj 15.9.19
   */
  getOption: function (name) {
    return BbaseEst.cloneDeep(this.options[name]);
  },
  /**
   * 添加过滤器
   *
   * @method [过滤] - addFilter
   * @param {string} name
   * @param {fn} fn
   * @author wyj 15.6.22
   * @example
   *
   */
  addFilter: function (name, fn) {
    if (name === 'navigator') {
      this.filters[name].push(fn);
    } else {
      this.filters[name] = fn;
    }
  },
  /**
   * 获取过滤器
   *
   * @method [过滤] - getFilter
   * @param name
   * @return {*}
   * @author wyj 15.6.22
   * @example
   *      App.getFilter('navigator');
   */
  getFilter: function (name) {
    return this.filters[name];
  },
  /**
   * 获取过滤器
   *
   * @method [过滤] - getFilters
   * @param name
   * @return {*}
   * @author wyj 15.6.22
   * @example
   *      App.getFilters('navigator');
   */
  getFilters: function (name) {
    return this.filters[name];
  },
  /**
   * 获取参数hash值
   *
   * @method [cache] - getParamsHash ( 获取参数hash值 )
   * @param options
   * @author wyj 15.10.25
   */
  getParamsHash: function (options) {
    var params = '',
      cacheId = '';

    for (var key in options) {
      params += options[key];
    }
    cacheId = '_hash' + BbaseEst.hash(params);

    return cacheId;
  },
  /**
   * 缓存数据
   * @method [cache] - addCache ( 数据缓存 )
   * @param options
   * @author wyj 15.10.25
   */
  addCache: function (options, result) {
    try {
      var cacheId = '';

      if (!result.success) return;
      cacheId = this.getParamsHash(options);

      if (options.session && result) {
        BbaseApp.addSession(cacheId, result);
      } else {
        this.cache[cacheId] = result;
      }
    } catch (e) {
      debug('Error12 -> addCache -> ' + e); //debug__
    }
  },
  /**
   * 获取缓存数据
   *
   * @method [cache] - getCache ( 获取缓存数据 )
   * @param options
   * @author wyj 15.10.25
   * @return {*}
   */
  getCache: function (options) {
    var result = null;
    var cacheId = this.getParamsHash(options);
    // localStorage缓存
    if (options.session && !BbaseApp.getData('versionUpdated')) {
      result = BbaseApp.getSession(cacheId);
      if (result) {
        return JSON.parse(result);
      }
    } else {
      return this.cache[cacheId];
    }
  },
  /**
   * 清除缓存数据
   *
   * @method [cache] - removeCache ( 清除缓存数据 )
   * @param options
   * @author wyj 15.10.25
   * @example
   *      BbaseApp.removeCache();
   *      BbaseApp.removeCache(options);
   */
  removeCache: function (options) {
    var cacheId = null;
    if (options) {
      cacheId = this.getParamsHash(options);
      delete this.cache[cacheId];
      return;
    }
    this.cache = {};
  },
  /**
   * 添加cookie
   *
   * @method [cookie] - addCookie ( 添加cookie )
   * @author wyj 15.1.13
   */
  addCookie: function (name) {
    if (BbaseEst.findIndex(this.cookies, name) !== -1) {
      return;
    }
    this.cookies.push(name);
  },
  /**
   * 获取所有保存的cookie
   *
   * @method [cookie] - getCookies ( 获取所有保存的cookie )
   * @return {Array}
   * @author wyj 15.1.13
   */
  getCookies: function () {
    return this.cookies;
  },
  /**
   * 添加指令
   *
   * @method addDirective
   * @param {[type]} name [description]
   * @param {[type]} obj  [description]
   */
  addDirective: function (name, obj) {
    this.directives[name] = obj;
  },
  /**
   * 获取指令

   * @method getDirective
   * @return {[type]} [description]
   */
  getDirective: function (name) {
    return this.directives[name];
  }
});
window.BbaseApp = window.BbaseApp || new BbaseApplication({});
// 注释打开，状态helper将不可用
/*if (typeof app === 'undefined'){
  window.app = window.BbaseApp;
}
*/

/**
 * @description BbaseUtils
 * @class BbaseUtils - 底层工具类
 * @author yongjin<zjut_wyj@163.com> 2015/1/27
 */
var BbaseUtils = {
  /**
   * 对话框
   *
   * @method [对话框] - dialog
   * @param options [title: ][width: ][height: ][target: ][success: 确定按钮回调]
   * @author wyj 14.12.18
   * @example
   *      BbaseUtils.dialog({
   *         id: 'copyDialog',
   *         title: '复制图片',
   *         target: '.btn-email-bind',
   *         width: 800,
   *         quickClose: true, // 点击空白处关闭对话框
   *         hideCloseBtn: false, // 是否隐藏关闭按钮
   *         content: this.copyDetail({
   *           filename: this.model.get('filename'),
   *           serverPath: this.model.get('serverPath')
   *         }),
   *         cover: true, // 是否显示遮罩
   *         onshow: function(){// 对话框显示时回调
   *         },
   *         load: function(){ // iframe载入完成后回调
   *           ...base.js
   *         },
   *         success: function(){// 按确定按钮时回调
   *           this.close();
   *         }
   *       });
   */
  dialog: function(options) {
    var button = options.button || [];
    seajs.use(['dialog-plus'], function(dialog) {
      if (options.success) {
        button.push({
          value: CONST.LANG.CONFIRM,
          autofocus: true,
          callback: function() {
            options.success.apply(this, arguments);
          }
        });
      }
      if (!options.hideCloseBtn) {
        button.push({
          value: CONST.LANG.CLOSE,
          callback: function() {
            this.close().remove();
          }
        });
      }
      options = BbaseEst.extend({
        id: options.id || options.moduleId || BbaseEst.nextUid('dialog'),
        title: CONST.LANG.DIALOG_TIP,
        width: 150,
        content: '',
        button: button
      }, options);
      if (options.target) {
        options.target = $(options.target).get(0);
      }
      options.oniframeload = function() {
        try {
          this.iframeNode.contentWindow.topDialog = thisDialog;
          this.iframeNode.contentWindow.app = app;
          delete BbaseApp.getRoutes().index;
        } catch (e) {}
        if (typeof options.load === 'function') {
          options.load.call(this, arguments);
        }
      };
      if (options.cover) {
        //options.quickClose = false;
        BbaseApp.addDialog(dialog(options), options.viewId || options.dialogId).showModal(options.target);
      } else {
        BbaseApp.addDialog(dialog(options), options.viewId || options.dialogId).show(options.target);
      }
    });
  },
  /**
   * 提示信息
   *
   * @method [对话框] - initTip
   * @param msg
   * @param options
   * @author wyj 14.12.18
   * @example
   *      BbaseUtils.tip('提示内容', {
   *        time: 1000,
   *        title: '温馨提示'
   *      });
   */
  tip: function(msg, options) {
    options = BbaseEst.extend({
      id: 'tip-dialog' + BbaseEst.nextUid(),
      time: 3000,
      content: '<div style="padding: 10px;">' + msg + '</div>',
      title: null
    }, options);
    seajs.use(['dialog-plus'], function(dialog) {
      if (window.tipsDialog) window.tipsDialog.close().remove();
      window.tipsDialog = BbaseApp.addDialog(dialog(options)).show(options.target);
      setTimeout(function() {
        window.tipsDialog.close().remove();
      }, options.time);
    });
  },
  /**
   * 确认框， 比如删除操作
   *
   * @method [对话框] - confirm
   * @param opts [title: 标题][content: 内容][success: 成功回调]
   * @author wyj 14.12.8
   * @example
   *      BbaseUtils.confirm({
   *        title: '提示',
   *        target: this.$('.name').get(0),
   *        content: '是否删除?',
   *        success: function(){
   *          ...
   *        },
   *        cancel: function(){
   *          ...
   *        }
   *      });
   */
  confirm: function(opts, context) {
    var options = {
      title: CONST.LANG.WARM_TIP,
      content: CONST.LANG.DEL_CONFIRM,
      success: function() {},
      target: null
    };
    BbaseEst.extend(options, opts);
    if (!context) context = this;
    seajs.use(['dialog-plus'], function(dialog) {
      window.comfirmDialog = BbaseApp.addDialog(dialog({
        id: 'dialog' + BbaseEst.nextUid(),
        title: options.title,
        cover:options.cover,
        content: '<div style="padding: 20px;">' + options.content + '</div>',
        width: options.width || 200,
        button: [{
          value: opts.successValue || CONST.LANG.CONFIRM,
          autofocus: true,
          callback: function() {
            if (options.success) options.success.call(context);
          }
        }, {
          value: opts.cancelValue || CONST.LANG.CANCEL,
          callback: function() {
            window.comfirmDialog.close().remove();
            if (options.cancel) options.cancel.call(context);
          }
        }],
        onClose: function() {
          if (options.cancel) options.cancel.call(context);
        }
      })).show(options.target);
    });
  },
  /**
   * 添加加载动画
   * @method [加载] - addLoading
   * @param optoins
   * @author wyj 15.04.08
   * @example
   *      BbaseUtils.addLoading();
   */
  addLoading: function(options) {
    try {
      if (window.$loading) window.$loading.remove();
      window.$loading = $('<div id="loading" class="loading"><div class="object" id="object_one">' +
        '</div><div class="object" id="object_two"></div><div class="object" id="object_three"></div></div>');
      $('body').append(window.$loading);
      if (window.$loading_timer){
        clearTimeout(window.$loading_timer);
      }
      window.$loading_timer = setTimeout(function(){
        BbaseUtils.removeLoading();
      }, 30000);
    } catch (e) {}
    return window.$loading;
  },
  /**
   * 移除加载动画
   * @method [加载] - removeLoading
   * @author wyj 15.04.08
   * @example
   *      BbaseUtils.removeLoading();
   */
  removeLoading: function(options) {
    if (window.$loading) window.$loading.remove();
    else $('.loading').remove();
  },
  /**
   * 调用方法 - 命令模式[说明， 只有在需要记录日志，撤销、恢复操作等功能时调用该方法]
   *
   * @method [调用] - execute ( 调用方法 )
   * @param name
   * @return {*}
   * @author wyj 15.2.15
   * @example
   *      BbaseUtils.execute( "initSelect", {
   *        ...
   *      }, this);
   */
  execute: function(name) {
    return BbaseUtils[name] && BbaseUtils[name].apply(BbaseUtils, [].slice.call(arguments, 1));
  }
};

/**
 * @description BbaseService - 单例模式， 只创建一个实例化对象
 * @class BbaseService - 数据请求
 * @author yongjin<zjut_wyj@163.com> 2015/1/26
 */

var BbaseService = function() {
  if (typeof BbaseService.instance === 'object') {
    return BbaseService.instance;
  }
  BbaseService.instance = this;
}

BbaseService.prototype = {
  /**
   * 基础ajax
   *
   * @method ajax
   * @param options
   * @return {*}
   * @author wyj 15.1.26
   * @example
   *        new BbaseService().ajax(options).done(function (result) {
                if (result.attributes) {
                  ...
                }
              });
   */
  ajax: function(options) {
    var data = BbaseEst.extend({ _method: 'GET' }, options);
    return $.ajax({
      type: 'post',
      url: options.url,
      async: false,
      cache: options.cache,
      data: data,
      success: function(result) {}
    });
  },
  /**
   * 初始化树
   *
   * @method initTree
   * @private
   * @param options
   * @param result
   * @author wyj 15.1.26
   */
  initTree: function(options, result) {
    if (options.tree) {
      result.attributes.data = BbaseEst.bulidTreeNode(result.attributes.data, options.rootKey, options.rootValue, {
        categoryId: options.categoryId, // 分类ＩＤ
        belongId: options.belongId, // 父类ＩＤ
        childTag: options.childTag, // 子分类集的字段名称
        sortBy: options.sortBy, // 按某个字段排序
        callback: function(item) {
          if (options.tree) {
            item.text = item[options.text];
            item.value = item[options.value];
          }
        }
      });
    }
  },
  /**
   * 初始化选择框
   *
   * @method initSelect
   * @private
   * @param options
   * @param result
   * @author wyj 15.1.26
   */
  initSelect: function(options, result) {
    if (options.select) {
      BbaseEst.each(result.attributes.data, function(item) {
        item.text = item[options.text];
        item.value = item[options.value];
      });
      if (options.tree) {
        result.attributes.data = BbaseEst.bulidSelectNode(result.attributes.data, 1, {
          name: 'text'
        });
      }
    }
  },
  /**
   * 初始化是否展开
   *
   * @method initExtend
   * @private
   * @param options
   * @param result
   * @author wyj 15.1.27
   */
  initExtend: function(options, result) {
    if (options.extend) {
      result.attributes.data = BbaseEst.extendTree(result.attributes.data);
    }
  },
  /**
   * 添加默认选项
   *
   * @method initDefault
   * @private
   * @param options
   * @param result
   * @author wyj 15.1.27
   */
  initDefault: function(options, result) {
    if (result.attributes && options.defaults && BbaseEst.typeOf(result.attributes.data) === 'array') {
      result.attributes.data.unshift({ text: CONST.LANG.SELECT_DEFAULT, value: options.defaultValue });
    }
  },
  /**
   * 基础工厂类 - 工厂模式，通过不同的url请求不同的数据
   * 注意：这个方法获取的数据是list类型的， 适合列表或下拉框使用
   *
   * @method factory
   * @param options
   * @return {BbaseEst.promise}
   * @author wyj 15.1.26
   * @example
   *      new BbaseService().factory({
              url: '', // 请求地址
              data: { // 表单参数
              },
              session: true, // 永久记录，除非软件版本号更新
              cache: true // 暂时缓存， 浏览器刷新后需重新请求

              select: true, // 是否构建下拉框
              tree: true, // 是否构建树
              extend: true, // 是否全部展开
              defaults： false, // 是否添加默认选项
              defaultValue: '/', // 默认为 /

              // 如果tree为true时， 表示需要构建树， 则需补充以下字段
              rootKey: 'isroot', // 构建树时的父级字段名称
              rootValue: '01', // 父级字段值
              categoryId: 'categoryId', //分类 Id
              belongId: 'belongId', // 父类ID
              childTag: 'cates', // 子集字段名称
              sortBy: 'sort', // 根据某个字段排序

              // 如果select为true时 ，表示需要构建下拉框， 则下面的text与value必填
              text: 'name', // 下拉框名称
              value: 'categoryId', // 下拉框值
            });

   */
  factory: function(options) {
    var ctx = this;
    var $q = BbaseEst.promise;
    var params = '';
    var cacheId = '';
    var result = null;
    var ajaxTimeout = null;

    options = BbaseEst.extend({
      select: false,
      extend: false,
      defaults: false,
      tree: false,
      defaultValue: null,
      timeout: 10000,
      cache: false,
      complete: function(XMLHttpRequest, status) {
        BbaseUtils.removeLoading();
        if (status == 'timeout') {
          ajaxTimeout.abort();
          BbaseUtils.tip('服务器繁忙， 请稍后再试');
        }
      }
    }, options);

    for (var key in options) {
      params += options[key];
    }
    cacheId = '_hash' + BbaseEst.hash(params);

    // localStorage缓存
    if (options.session && !BbaseApp.getData('versionUpdated')) {
      result = BbaseApp.getSession(cacheId);
      if (result) {
        return new $q(function(topResolve, topReject) {
          topResolve(JSON.parse(result));
        });
      }
    }
    return new $q(function(topResolve, topReject) {
      if (CONST.DEBUG_LOCALSERVICE) {
        topResolve([]);
      } else {
        ajaxTimeout = ctx.ajax(options).done(function(result) {
          var list = null;

          if (result && result.msgType === 'notLogin') {
            BbaseEst.trigger('checkLogin', null, true);
          }
          if (BbaseEst.typeOf(result) === 'string') {
            if (options.session && result.attributes) {
              BbaseApp.addSession(cacheId, result);
            }
            topResolve(result);
            return;
          }
          if (result.attributes) {
            ctx.initTree(options, result);
            ctx.initSelect(options, result);
            ctx.initExtend(options, result);
          } else {
            result.attributes = result.attributes || {};
            result.attributes.data = [];
          }
          ctx.initDefault(options, result);
          list = result.attributes ? result.attributes.data : result;
          if (options.session && result.attributes) {
            BbaseApp.addSession(cacheId, list);
          }
          topResolve(list);
        });
      }
    });
  },
  /**
   * 基础工厂类 - 工厂模式，通过不同的url请求不同的数据
   * 注意：这个方法获取的数据是从任何类型的
   *
   * @method query
   * @param options
   * @return {BbaseEst.promise}
   * @author wyj 15.1.26
   * @example
   *      new BbaseService().query({
              url: '', // 请求地址
              data: { // 表单参数
              },
              session: true, // 永久记录，除非软件版本号更新
              cache: true // 暂时缓存， 浏览器刷新后需重新请求
            });
   */
  query: function(options) {
    var ctx = this;
    var $q = BbaseEst.promise;
    var params = '';
    var cacheId = '';
    var result = null;
    var ajaxTimeout = null;

    options = BbaseEst.extend({
      cache: false,
      timeout: 10000,
      complete: function(XMLHttpRequest, status) {
        BbaseUtils.removeLoading();
        if (status == 'timeout') {
          ajaxTimeout.abort();
          BbaseUtils.tip('服务器繁忙， 请稍后再试');
        }
      }
    }, options);

    for (var key in options) {
      params += options[key];
    }
    cacheId = '_hash' + BbaseEst.hash(params);

    // localStorage缓存
    if (options.session && !BbaseApp.getData('versionUpdated')) {
      result = BbaseApp.getSession(cacheId);
      if (result) {
        return new $q(function(topResolve, topReject) {
          topResolve(JSON.parse(result));
        });
      }
    }
    return new $q(function(topResolve, topReject) {
      if (CONST.DEBUG_LOCALSERVICE) {
        topResolve([]);
      } else {
        ajaxTimeout = ctx.ajax(options).done(function(result) {
          if (result.msgType === 'notLogin') {
            BbaseEst.trigger('checkLogin', null, true);
          }
          if (options.session && result) {
            BbaseApp.addSession(cacheId, result);
          }
          topResolve(result);
        });
      }
    });
  }
}

/**
 * @description 所有BaseXxx模块的超类， 子类继承超类的一切方法
 * @class BbaseSuperView - 所有BaseXxx模块的超类
 * @author yongjin<zjut_wyj@163.com> 2015/1/24
 */

var BbaseSuperView = BbaseBackbone.View.extend({
  /**
   * 传递options进来
   *
   * @method [private] - constructor
   * @private
   * @param options
   * @author wyj 14.12.16
   */
  constructor: function (options) {
    this.options = options || {};
    this._re_dup = {};
    this._re_selector = {};
    this._attr_list = {};
    this._directives_ = [];
    this._ready_component_ = false;
    if (this.init && BbaseEst.typeOf(this.init) !== 'function') {
      this._initialize(this.init);
    }
    if (this.initData && BbaseEst.typeOf(this.initData) !== 'function') {
      this._initialize(this.initData);
    }
    BbaseBackbone.View.apply(this, arguments);
  },
  /**
   * 调用父类方法
   *
   * @method [构造] - _super
   * @return {[type]} [description]
   */
  _super: function (type, args) {
    if (BbaseEst.typeOf(type) === 'object') {
      this._initialize(type);
    } else if (BbaseEst.isEmpty(type)) {
      return BbaseApp.getView(this.viewId);
    } else {
      switch (type) {
        case 'data':
          return BbaseApp.getView(this.viewId).model.toJSON();
        case 'view':
          return BbaseApp.getView(this.viewId);
        case 'model':
          return BbaseApp.getView(this.viewId).model;
        case 'options':
          if (BbaseApp.getView(this.viewId)) {
            return BbaseApp.getView(this.viewId)._options;
          } else {
            return this._options.data;
          }
          break;
        default:
          if (BbaseApp.getView(this.viewId) && BbaseApp.getView(this.viewId)[type]) {
            if (BbaseApp.getView(this.viewId)[type].timer) {
              clearTimeout(BbaseApp.getView(this.viewId)[type].timer);
            }
            BbaseApp.getView(this.viewId)[type].timer = setTimeout(this._bind(function () {
              BbaseApp.getView(this.viewId)[type](args);
              BbaseApp.getView(this.viewId)[type].timer = null;
            }), 20);
          } else if (this[type]) {
            this[type](args);
          }
          return this;
      }
    }
  },
  /**
   * 初始化
   *
   * @method [初始化] - initialize
   * @private
   * @return {[type]} [description]
   */
  initialize: function () {
    this._super('_initialize');
  },

  /**
   * 继承
   *
   * @method [继承] - _extend
   * @private
   * @param  {[type]} options [description]
   * @return {[type]}         [description]
   */
  _extend: function (options) {
    BbaseEst.extend(this.options, options);
  },
  /**
   * 获取视图
   *
   * @method [视图] - _view
   * @param  {[type]} viewId [description]
   * @return {[type]}        [description]
   */
  _view: function (viewId) {
    return BbaseApp.getView(viewId + this.cid);
  },
  /**
   * 添加视图区域
   *
   * @method [视图] - _region
   * @param  {[type]} name     [description]
   * @param  {[type]} instance [description]
   * @param  {[type]} options  [description]
   * @return {[type]}          [description]
   */
  _region: function (name, instance, options) {
    if (arguments.length === 1) {
      return this._view(name);
    }
    BbaseApp.addRegion(name + this.cid, instance, options);
  },
  /**
   * service服务
   *
   * @method _service
   * @return {[type]} [description]
   */
  _service: function (type, options) {
    return Service[type](options);
  },
  /**
   * 导航
   *
   * @method [导航] - _navigate ( 导航 )
   * @param name
   * @author wyj 15.1.13
   */
  _navigate: function (name, options) {
    options = options || true;
    typeof Backbone === 'undefined' ? BbaseBackbone.history.navigate(name, options)
    : Backbone.history.navigate(name, options);
  },
  /**
   *  watch system
   *
   * +------------+    .
   * | _watchBind |    .
   * +------------+    .
   *       |           .
   *       v           .
   * +------------+    .
   * |  bb-watch  |    .
   * |  bb-render |    .
   * |  bb-chnage |    .
   * +------------+    .                         +-----------+
   *       |           .            +-----------+|  observer |
   *       |           .            |            |  _set     |                      +--------------------+
   * +-----|------+    .            v            +-----------+                      | html,value,attr    |
   * |     |      |    .    +--------------+                     +------------+     | show,checked,event |
   * |     +-----------.--->|   bindName   |                     | directive  |<---+| ...                |
   * |            |    .    |              |     +------------+  |            |     |                    |
   * |   _watch   |    .    | selector:dir |<---+|_viewReplace|<-|------------|     +--------------------+
   * |            |    .    |              |     |  bb-render |  | selector   |
   * |            |    .    |   callback   |     +------------+  |            |
   * |     +-----------.--->|              |                     +------------+
   * |     |      |    .    +--------------+
   * +-----|------+    .            ^            +------------+
   *       |           .            |            |  callback  |
   *       +           .            +-----------+|  bb-change |
   * +-------------+   .                         +------------+
   * |   _bbBind   |   .
   * |-------------|   .
   * |   bb-model  |   .
   * |   bb-show   |   .
   * |   bb-checked|   .
   * |   bb-event  |   .
   * |   bb-...    |   .
   * +-------------+   .
   */

  /**
   * 单个模型字段绑定
   *
   * @method [绑定] - _singeBind
   * @param selector
   * @param model
   * @author wyj 15.7.20
   * @example
   * @private
   * @author wyj 15.7.20
   * @example
   *    this._singleBind('#model-name', this.model);
   */
  _singleBind: function (parent, selector, model, changeFn) {
    var _self = this;

    $(selector, parent || this.$el).each(function () {

      var bbModels = [];
      var bbModel = $(this).attr('bb-model');
      var bindType = $(this).attr('data-bind-type') || 'change';

      if (!BbaseEst.isEmpty(bbModel)) {
        bbModels = bbModel.split(':');
        bindType = bbModels.length > 1 ? bbModels[1] : 'change';
      }
      $(this).off(bindType).on(bindType, function (e) {
        var val, pass, modelId, name, bbMod;

        if (e.keyCode === 37 || e.keyCode === 39 ||
          e.keyCode === 38 || e.keyCode === 40) {
          return false;
        }
        modelId = $(this).attr('id');
        bbMod = $(this).attr('bb-model');
        if (!BbaseEst.isEmpty(bbMod)) bbMod = bbMod.split(':')[0];

        if (bbMod || (modelId && modelId.indexOf('model') !== -1)) {
          switch (this.type) {
            case 'radio':
              val = $(this).is(":checked") ? $(this).val() : pass = true;
              break;
            case 'checkbox':
              val = $(this).is(':checked') ? (BbaseEst.isEmpty($(this).attr('true-value')) ? true :
                  $(this).attr('true-value')) :
                (BbaseEst.isEmpty($(this).attr('false-value')) ? false : $(this).attr('false-value'));
              break;
            default:
              val = $(this).val();
              break;
          }
          if (!pass) {
            name = bbMod || modelId.replace(/^model\d?-(.+)$/g, "$1");
            _self._set(name, val);
            if (changeFn) changeFn.call(_self, name, e);
            //TODO 新版将移除update回调
            if (_self.update) _self.update.call(_self, name);
          }
        }
      });
    });
  },
  /**
   * 视图到模型类的绑定
   *
   * @method [绑定] - _modelBind
   * @private
   * @author wyj 14.12.25
   * @example
   *        this._modelBind();
   */
  _modelBind: function (parent, selector, changeFn) {
    var _self = this;
    if (selector) this._singleBind(parent, selector, this.model, changeFn);
    else this.$("input, textarea, select").each(function () {
      _self._singleBind(null, $(this), _self.model, changeFn);
    });
  },
  /**
   * 获取模板
   *
   * @method _getCompileTemp
   * @param  {string} attrName   属性名称
   * @param  {jquery} node       作用元素
   * @param  {string} selector   选择符
   * @param  {string} ngAttrName 属性名称(针对IE浏览器)
   * @return {Handlebar}         模板
   */
  _getCompileTemp: function (dirName, node, selector, ngDirName, fieldName) {
    var hbsStr = null,
      compileStr = '';

    switch (dirName) {
      case 'html':
        compileStr = this._parseHbs(node.html());
        return { compile: BbaseHandlebars.compile(compileStr), compileStr: compileStr };
      case 'checked':
        compileStr = '{{' + /bb-checked=\"(.*?)\"\s?/img.exec(selector)[1] + '}}';
        return { compile: BbaseEst.compile(compileStr), compileStr: compileStr };
      case 'show':
        hbsStr = node.attr('bb-show').split(':');
        if (hbsStr.length > 1) hbsStr = hbsStr[1];
        else hbsStr = hbsStr[0];
        compileStr = '{{' + hbsStr + '}}';
        return { compile: BbaseEst.compile(compileStr), compileStr: compileStr };
      default:
        if (BbaseApp.getDirective(dirName)) {
          compileStr = node.attr('bb-' + ngDirName);
          compileStr = compileStr || fieldName;
          return { compile: BbaseApp.getDirective(dirName).compile ? BbaseApp.getDirective(dirName).compile : compileStr.indexOf('{{') > -1 ? BbaseHandlebars.compile(compileStr) : BbaseEst.compile('{{' + compileStr + '}}'), compileStr: selector };
        } else {
          hbsStr = this._parseHbs(node.attr(ngDirName));
          if (!hbsStr && node.is('textarea')) hbsStr = this._parseHbs(node.html());
          compileStr = (BbaseEst.isEmpty(hbsStr) || hbsStr.indexOf('{{') === -1) ? '{{' + fieldName + '}}' : hbsStr;
          return {
            compile: BbaseHandlebars.compile(compileStr),
            compileStr: compileStr,
            directive: ngDirName === 'value' ? selector.indexOf('bb-model') > -1 ? 'model' : ngDirName : ngDirName
          };
        }
    }
  },
  /**
   * 元素替换
   *
   * @method [替换] - _replaceNode
   * @param  {string} attrName   属性名称
   * @param  {jquery} node       元素
   * @param  {string} result     模板结果字符串
   * @param  {string} selector   选择符
   * @param  {string} ngAttrName 属性名称(针对IE)
   */
  _replaceNode: function (attrName, node, result, selector, ngAttrName) {
    switch (attrName) {
      case 'value':
        if (node.is(':checkbox')) {
          if (result === 'false' || result === '0' || BbaseEst.isEmpty(result)) node.prop('checked', false);
          else node.prop('checked', true);
        }
        node.val(result);
        break;
      case 'html':
        node.html(result);
        break;
      case 'show':
        if ((result === 'false' || result === '0' || BbaseEst.isEmpty(result))) node.hide();
        else node.show();
        break;
      case 'checked':
        //node.prop('checked', this._get(/bb-checked=\"(.*?)\"\s?/img.exec(selector)[1]));
        if (this._get(/bb-checked=\"(.*?)\"\s?/img.exec(selector)[1])) {
          node.prop('checked', true);
        } else {
          node.prop('checked', false);
        }
        break;
      default:
        if (BbaseApp.getDirective(attrName) && BbaseApp.getDirective(attrName).update) {
          BbaseApp.getDirective(attrName).update.apply(this, [attrName, node, selector, result]);
        } else {
          node.attr(ngAttrName, result);
        }
    }
  },
  /**
   * 执行替换操作
   *
   * @method _handleReplace
   * @param  {object} item       缓存的替换对象集
   * @param  {object} model      模型类
   * @param  {string} selector   选择符
   * @param  {string} attrName   属性名称
   * @param  {string} ngAttrName 属性名称(针对IE)
   */
  _handleReplace: function (item, model, selector, attrName, ngAttrName, name) {
    var _result = '';
    /*if (this.collection && !BbaseEst.equal(model._previousAttributes.models, this.collection.models)) {
      model._previousAttributes.models = BbaseEst.clone(this.collection.models);
      BbaseEst.trigger(this.cid + 'models');
    }*/
    _result = item.compile(model.attributes);

    // 比对数据，若无改变则返回
    if (!(!BbaseEst.isEmpty(item.directive) && item.directive === 'model') &&
      item.result === _result) {
      return;
    }
    // 缓存node
    if (!item.node) {
      item.node = this.$(selector).eq(item.index);
      if (item.node.size() === 0) {
        // 针对bb-src
        item.node = this.$('.directive_' + BbaseEst.hash(selector)).eq(item.index);
        //console.error("error: call wyj for more info");
      }
    }
    // 赋值
    this._replaceNode(attrName, item.node, _result, selector, ngAttrName);
    // 缓存结果
    item.result = _result;
  },
  /**
   * 获取属性列表
   * .render:html:style
   *
   * @method _getAttrList
   * @param  {object} item 缓存的模板对象
   * @return {array}       属性列表
   */
  _getAttrList: function (item) {
    var tempList = [],
      list = [],
      t_list = [];

    var hash = BbaseEst.hash(item);
    if (hash in this._attr_list) return this._attr_list[hash];

    if (item.indexOf(']:') > -1) {
      tempList = item.split(']:');
      list = BbaseEst.map(tempList, function (_item, index) {
        if (index !== tempList.length - 1) {
          return _item + ']';
        } else {
          return _item;
        }
      });
      t_list = list[1].split(':');
      if (t_list.length > 1) {
        list.pop();
        list = list.concat(t_list);
      }
    } else if (item.indexOf('://') > -1) {
      list = [item];
    } else {
      list = item.split(':');
    }
    this._attr_list[hash] = list;
    return list;
  },
  /**
   * [bb-watch="signContent.icon:class:html,signContent.iconType:style"]:class:html,
   * signContent.iconType:style,[bb-watch="signContent.icon:src,signContent.iconType:style"]:src
   *
   * @method _getSelectorSplit
   * @param  {[type]} selector [description]
   * @return {[type]}          [description]
   */
  _getSelectorSplit: function (selector) {
    var hash = BbaseEst.hash(selector);
    if (hash in this._re_selector) return this._re_selector[hash];

    var list = selector.split(',');
    var list2 = [];
    var temp = '';

    if (selector.indexOf('[bb-watch=') > -1) {
      BbaseEst.each(list, function (item) {
        if (item.indexOf('[bb-') > -1 && item.indexOf(']') === -1) {
          temp = item;
        } else if (item.indexOf(']') > -1 && item.indexOf('[bb-') === -1) {
          temp += (',' + item);
          list2.push(temp);
        } else if (item.indexOf('[bb-') > -1 && item.indexOf(']') > -1) {
          list2.push(item);
        } else if (item.indexOf('[bb-') === -1 && item.indexOf(']') === -1) {
          temp += (',' + item);
        }
      });
    } else {
      list2 = list;
    }

    this._re_selector[hash] = list2;
    return list2;
  },
  /**
   * 视图重新渲染
   *
   * @method [渲染] - _viewReplace
   * @param selector
   * @param model
   * @author wyj 15.7.21
   * @example
   *      this._viewReplace('#model-name', this.model);
   */
  _viewReplace: function (selector, model, cbs, name) {
    try {
      if (!this._re_dup) this._re_dup = {};
      BbaseEst.each(this._getSelectorSplit(selector), this._bind(function (item) {
        var list = [],
          _$template = '',
          _result = '',
          _hash = '',
          node = '',
          ngAttrName = '',
          attrName = '';

        if (!BbaseEst.isEmpty(item)) {
          _hash = BbaseEst.hash(item);

          // 获取属性列表
          list = this._getAttrList(item);

          if (list.length > 1) {

            for (var i = 1; i < list.length; i++) {
              _hash = BbaseEst.hash(list[0] + list[i]);
              attrName = list[i];
              if (BbaseEst.msie()) {
                ngAttrName = 'ng-' + list[i];
                if (!this._re_dup[_hash])
                  _$template = this._options.template.replace(new RegExp('\\s' + attrName +
                    '=', "img"), ' ' + ngAttrName + '=');
              } else {
                ngAttrName = attrName;
                _$template = this.$template;
              }
              // 缓存模板
              if (!this._re_dup[_hash]) {

                this._re_dup[_hash] = [];
                node = $(_$template).find(list[0]);
                if (node.size() === 0) {
                  node = this.$el.find(list[0]);
                }

                $.each(node, $.proxy(function (index, node) {
                  this._re_dup[_hash].push(BbaseEst.extend(this._getCompileTemp(attrName, $(node), list[0], ngAttrName, name), {
                    hash: _hash + '' + index,
                    index: index
                  }));
                }, this));
              }
              BbaseEst.each(this._re_dup[_hash], function (item) {
                this._handleReplace(item, model, list[0], attrName, ngAttrName, name);
              }, this);
            }

          } else {
            if (BbaseEst.msie()) {
              if (!this['h_temp_' + _hash])
                _$template = this.$template.replace(new RegExp('\\sstyle=', "img"), ' ng-style=');
              //console.log(item);
              this['h_temp_' + _hash] = this['h_temp_' + _hash] ||
                BbaseHandlebars.compile($(_$template).find(item).wrapAll('<div>').parent().html().replace(/ng-style/img, 'style'));
            } else {
              this['h_temp_' + _hash] = this['h_temp_' + _hash] ||
                BbaseHandlebars.compile($(this.$template).find(item).wrapAll('<div>').parent().html());
            }
            _result = this['h_temp_' + _hash](model.attributes);
            if (this['h_temp_r_' + _hash] === _result) {
              return;
            }
            this.$(item).replaceWith(_result);
            this['h_temp_r_' + _hash] = _result;
          }
        }
      }));

      if (cbs) {
        BbaseEst.each(cbs, function (cb) {
          cb.call(this, name);
        }, this);
      }

    } catch (e) {
      debug('Error -> _viewReplace -> ' + e + 'selector:' + selector, {
        e: e
      });
    }
  },
  /**
   * 双向绑定
   *
   * @method [绑定] - _watch
   * @param name
   * @param selector
   * @param callback
   * @author wyj 15.7.20
   * @example
   *      <input id="model-link" data-bind-type="keyup" type="text"  value="{{link}}">
   *      // data-bind-type="keydown" 绑定方式，默认为change
   *      this._watch(['#model-name', '#model-color'], '#model-name,.model-name', function(){
   *
   *      });
   */
  _watch: function (name, selector, callback) {
    var _self = this,
      triggerName,
      cb_hash = null,
      temp_obj = {},
      list = [];

    if (!this.watchFields) this.watchFields = {};
    if (!this.cbMap) this.cbMap = {};

    if (BbaseEst.typeOf(name) === 'array') {
      list = name;
    } else {
      list.push(name);
    }

    BbaseEst.each(list, function (item) {
      var modelId = item.replace(/^#?model\d?-(.+)$/g, "$1");
      /* debugger
       if (typeof this._get(modelId) === 'undefined'){
         this._setDefault(modelId, '');
       }*/
      if (callback) {
        this.cbMap[modelId] = this.cbMap[modelId] || [];

        if (BbaseEst.typeOf(callback) === 'string') {

          cb_hash = BbaseEst.hash(modelId + callback);
          if (!(cb_hash in this.cbMap)) {
            this.cbMap[cb_hash] = true;
            this.cbMap[modelId].push(this[callback]);
          }

        } else {
          this.cbMap[modelId].push(callback);
        }
      }
      if (modelId in this.watchFields) {
        BbaseEst.each(this._getSelectorSplit(selector), function (item) {

          if (this.watchFields[modelId].indexOf(item) === -1) {
            this.watchFields[modelId] = this.watchFields[modelId] + ',' + item;
          }
        }, this);
      } else {
        this.watchFields[modelId] = selector;
      }

      selector = this.watchFields[modelId];
      triggerName = _self.cid + modelId;

      //if (!_self._options.modelBind || item.indexOf('model-') > -1) _self._modelBind(item);
      if (triggerName in temp_obj) return;

      BbaseEst.off(temp_obj[triggerName] = triggerName).on(triggerName, function (triggerName, name) {
        _self._viewReplace(selector, _self.model, _self.cbMap[modelId], modelId);
        if (_self.update) _self.update.call(_self, modelId);
      });

      _self.model.off('change:' + (temp_obj[modelId] = modelId.split('.')[0]))
        .on('change:' + temp_obj[modelId],
          function () {
            _self._viewReplace(selector, _self.model, _self.cbMap[modelId], modelId);
            if (_self.update) _self.update.call(_self, modelId);
          });

    }, this);
  },
  /**
   * 绑定模型类
   * @method [绑定] - _watchBind
   */
  _watchBind: function (template) {
    var list = [],
      models = [];

    this.cbMap = {};
    this.watchFields = {};

    if (BbaseEst.typeOf(template) === 'string') {
      models = template.match(new RegExp('(bb-watch=\\"(.+?)\"(\\s*)|bb-change=\\"(.+?)\"(\\s*)|bb-model=\\"(.+?)\"(\\s*))(bb-render=\\"(.+?)\\"\\s*)?(bb-change=\\"(.+?)\\"\\s*)?', 'img'));
      BbaseEst.each(models, this._bind(function (item) {
        var watch = '',
          model = '',
          change = '',
          w_list = [],
          watch_render = {},
          w_render = '',
          render = '';

        watch = /bb-watch=\"(.*?)\"\s?/img.exec(item) || '';
        render = /bb-render=\"(.*?)\"\s?/img.exec(item) || '';
        change = /bb-change=\"(.*?)\"\s?/img.exec(item) || '';
        model = /bb-model=\"(.*?)\"\s?/img.exec(item) || '';

        if (BbaseEst.isEmpty(watch) && BbaseEst.isEmpty(model)) return;
        if (watch.length > 1) {

          if (watch[1].indexOf(':') > -1) {
            watch_render = this._getWatchRender(watch, render);
            watch = watch_render.watch;
            render = watch_render.render;

          } else {
            w_list = watch[1].split(':');
            w_render = '[bb-watch="' + watch[1] + '"]' + watch[1].substring(watch[1].indexOf(':'), watch[1].length);

            if (w_list.length > 1) {
              if (render.length < 1) {
                render = ['', w_render];
              } else {
                render[1] += (',' + w_render);
              }
            }
            watch[1] = w_list[0];
          }
        }
        list.push({
          watch: watch.length > 1 ? watch[1] : model[1].split(':')[0],
          render: render.length > 1 ? render[1] : '',
          change:  change.length > 1 ? BbaseEst.trim(change[1].substring(0,
            change[1].indexOf('(') === -1 ? change[1].length : change[1].indexOf('('))) : null
        });
      }));
    }
    BbaseEst.each(list, this._bind(function (item) {
      this._watch(item.watch.split(','), item.render, BbaseEst.isEmpty(item.change) ? null : item.change);
    }));
    if (this.onWatch) {
      this.onWatch.call(this, arguments);
    }
  },
  /**
   * bb-watch="args.color:style,args.color1:html"
   *
   * @method _getWatchRender
   * @param  {[type]} watch  [description]
   * @param  {[type]} render [description]
   * @return {[type]}        [description]
   */
  _getWatchRender: function (watch, render) {
    var _watch = '';
    var _render = '';
    var _watchs = watch[1].split(',');

    BbaseEst.each(_watchs, function (item) {
      var w_list = [];

      w_list = item.split(':');
      _render += ((BbaseEst.isEmpty(_render) ? '' : ',') + '[bb-watch="' + watch[1] + '"]' +
        item.substring(item.indexOf(':'), item.length));
      _watch += ((BbaseEst.isEmpty(_watch) ? '' : ',') + w_list[0]);
    });

    watch[1] = _watch;
    if (render.length < 1) {
      render = ['', _render];
    } else {
      render[1] += (',' + _render);
    }

    return {
      watch: watch,
      render: render
    };
  },
  /**
   * 绑定模型类与事件
   *
   * @method [绑定] - _bbBind
   * @param  {[type]} template [description]
   * @param  {[type]} parent   [description]
   * @return {[type]}          [description]
   */
  _bbBind: function (template, parent) {
    var matchs = [],
      patt,
      hash,
      map = {},
      result;
    this.bbList = [];

    if (BbaseEst.typeOf(template) === 'string') {
      patt = new RegExp('\\bbb-([\\w\\.]+)=\\"(.+?)\\"\\s?', 'img');

      while ((result = patt.exec(template)) !== null) {
        this.bbList.push({
          name: result[1],
          value: result[2]
        });
      }
      BbaseEst.each(this.bbList, this._bind(function (item) {

        hash = BbaseEst.hash(item.name + item.value);
        if (hash in map) return;
        map[hash] = item;

        switch (item.name) {
          case 'watch':
            break;
          case 'render':
            break;
          case 'change':
            break;
          case 'show':
            var sep = item.value.split(':');
            var field = this._getField(item.value);
            this._watch([sep.length > 1 ? sep[0] : field], '[bb-show="' + item.value + '"]:show');
            if (!this._getBoolean(item.value)) {
              this.$('[bb-show="' + item.value + '"]').hide();
            }
            //BbaseEst.trigger(this.cid + field);
            break;
          case 'model':
            this._modelBind(parent, '[bb-model="' + item.value + '"]');
            this._watch([item.value.split(':')[0]], '[bb-model="' + item.value + '"]:value');
            this.$('[bb-model="' + item.value + '"]').val(this._get(item.value.split(':')[0]));
            break;
          case 'checked':
            var field = this._getField(item.value);
            if (typeof this._options._checkAppend === 'undefined'){
              this._set('_options._checkAppend', true);
            }
            this._watch([field], '[bb-checked="' + item.value + '"]:checked');
            this.$('[bb-checked="' + item.value + '"]').prop('checked', this._getBoolean(item.value));
            this.$('[bb-checked="' + item.value + '"]').change(this._bind(function(a){
              if (item.value === 'checked_all'){
                this._checkAll && this._checkAll(a);
              }else{
                this._check && this._check($(a.target).is(':checked'));
              }
            }, this));
            break;
          default:
            if (BbaseApp.getDirective(item.name)) {
              BbaseEst.extend(BbaseApp.getDirective(item.name), BbaseApp.getDirective(item.name).bind.call(this,
                item.value, '[bb-' + item.name + '="' + item.value + '"]'));
              this._directives_.push({ name: item.name, object: BbaseApp.getDirective(item.name) });
            } else {
              this._handleEvents(parent, item.name, item.value);
            }
        }
      }));
    }
    this._afterTransition();
  },
  /**
   * 处理事件与参数
   *
   * @method _handleEvents
   * @param  {node}   parent 父元素
   * @param  {string} name  字段名称
   * @param  {string} value 字符串
   * @return {void}
   */
  _handleEvents: function (parent, name, value) {
    var colonRe = /:([^:\$\s\(\)]*)/img,
      dollarRe = /\$([^:\$\s\(\)]*)/img,
      bracketRe = /\(([^:\$]*)\)/img,
      nameRe = /(.[^:\$\s\(\)]*).*/img;

    var args = [],
      fn = nameRe.exec(value)[1],
      colons = BbaseEst.map(value.match(colonRe) || [], function (str) {
        return str.replace(':', '');
      }),
      dollars = BbaseEst.map(value.match(dollarRe) || [], function (str) {
        return str.replace('$', '');
      });

    var brackets = value.match(bracketRe);
    if (brackets) {
      BbaseEst.each(brackets[0].split(','), this._bind(function (item) {
        var name = BbaseEst.trim(item.replace(/[\(|\)]/img, ''));
        if (!BbaseEst.isEmpty(name)) {
          if (name.indexOf('\'') > -1) {
            dollars.push(name.replace(/'/img, ''));
          } else if (/^[\d\.]+$/img.test(name)) {
            dollars.push(parseFloat(name));
          } else {
            dollars.push(this._get(name));
          }
        }
      }));
    }

    if (this[fn]) parent.find('[bb-' + name + '="' + value + '"]').off(name).on(name,
      this._bind(function (e) {
        if (colons.length > 0) {
          switch (colons[0]) {
            case 'enter':
              if (e.keyCode === 13) {
                this[fn].apply(this, dollars.concat([e]));
              }
              break;
            default:
              if (e.keyCode === parseInt(colons[0])) {
                this[fn].apply(this, dollars.concat([e]));
              }
          }
        } else {
          this[fn].apply(this, dollars.concat([e]));
        }
      }));
  },


  /**
   * 字段序列化成字符串
   *
   * @method [模型] - _stringifyJSON ( 字段序列化成字符串 )
   * @param array
   * @author wyj 15.1.29
   * @example
   *      this._stringify(['invite', 'message']);
   */
  _stringifyJSON: function (array) {
    var keys, result;
    if (!JSON.stringify) alert(CONST.LANG.JSON_TIP);

    BbaseEst.each(array, function (item) {
      keys = item.split('.');
      if (keys.length > 1) {

        result = BbaseEst.getValue(this.model.attributes, item);
        BbaseEst.setValue(this.model.attributes, item, JSON.stringify(result));
      } else {
        BbaseEst.setValue(this.model.attributes, item, JSON.stringify(this.model.get(item)));
      }
    }, this);
  },
  /**
   * 反序列化字符串
   *
   * @method [模型] - _parseJSON ( 反序列化字符串 )
   * @param array
   */
  _parseJSON: function (array) {
    var keys, result;
    var parse = JSON.parse || $.parseJSON;

    if (!parse) alert(CONST.LANG.JSON_TIP);

    BbaseEst.each(array, function (item) {
      keys = item.split('.');
      if (keys.length > 1) {
        result = BbaseEst.getValue(this.model.attributes, item);
        if (BbaseEst.typeOf(result) === 'string') {
          BbaseEst.setValue(this.model.attributes, item, parse(result));
        }
      } else {
        if (BbaseEst.typeOf(this.model.get(item)) === 'string') {
          if (!BbaseEst.isEmpty(this._get(item))) this._set(item, parse(this.model.get(item)));
        }
      }
    }, this);
  },
  /**
   * 设置参数
   *
   * @method [参数] - _setOption ( 设置参数 )
   * @param obj
   * @return {BbaseList}
   * @author wyj 14.12.12
   * @example
   *      BbaseApp.getView('categoryList')._setOption({
   *          sortField: 'orderList'
   *      })._moveUp(this.model);
   */
  _setOption: function (obj) {
    BbaseEst.extend(this._options, obj);
    return this;
  },
  /**
   * 回车事件
   *
   * @method [private] - _initEnterEvent
   * @private
   * @author wyj 14.12.10
   */
  _initEnterEvent: function (options) {
    if (options.speed > 1 && options.enter) {
      this.$('input').keyup($.proxy(function (e) {
        if (e.keyCode === CONST.ENTER_KEY) {
          this.$(options.enter).click();
        }
      }, this));
    }
  },
  /**
   * 获取配置参数
   *
   * @method [参数] - _getOption ( 获取配置参数 )
   * @param name
   * @return {*}
   * @author wyj 15.1.29
   */
  _getOption: function (name) {
    return this._options[name];
  },
  /**
   * 获取模板字符串
   *
   * @method _getTpl
   * @return {[type]} [description]
   */
  _getTpl: function () {
    return '<div>' + this._options.template + '</div>';
  },
  /**
   * 获取model值
   *
   * @method [模型] - _getValue ( 获取model值 )
   * @param path
   * @author wyj 15.1.30
   * @example
   *      this._getValue('tip.name');
   */
  _getValue: function (path) {
    return BbaseEst.getValue(this.model.attributes, path);
  },
  /**
   * 获取模型类的值
   *
   * @method [模型] - _get
   * @param  {string} path [description]
   * @return {*}      [description]
   */
  _get: function (path) {
    return this._getValue.call(this, path);
  },
  /**
   * 获取整数类型的值
   * @method _getInt
   * @param  {[type]} path [description]
   * @return {[type]}      [description]
   */
  _getInt: function (path) {
    return parseInt(this._get(path), 10);
  },
  /**
   * 获取浮点型数值
   * @method _getFloat
   * @param  {[type]} path [description]
   * @return {[type]}      [description]
   */
  _getFloat: function (path) {
    return parseFloat(this._get(path), 10);
  },
  /**
   * 获取model值,如果不存在，则设初始值
   *
   * @method [模型] - _getDefault ( 获取model值 )
   * @param path
   * @author wyj 15.1.30
   * @example
   *      this._getDefault('tip.name', 'd');
   */
  _getDefault: function (path, value) {
    this._setDefault(path, value);
    return BbaseEst.getValue(this.model.attributes, path);
  },
  /**
   * 设置初始值
   *
   * @method [模型] - _setDefault ( 设置初始值 )
   * @param path
   * @author wyj 15.1.30
   * @example
   *      this._setDefault('tip.name', 'd');
   */
  _setDefault: function (path, value) {
    var result = BbaseEst.getValue(this.model.attributes, path);
    if (BbaseEst.typeOf(result) === 'undefined' || BbaseEst.typeOf(result) === 'null') {
      BbaseEst.setValue(this.model.attributes, path, value);
    }
  },
  /**
   * 模型类初始化
   * @method [模型] - _initDefault
   * @return {[type]} [description]
   */
  _initDefault: function () {
    if (this.init && BbaseEst.typeOf(this.init) === 'function') {
      this.__def_vals_ = this.init.call(this, this._attributes) || {};
      BbaseEst.each(this.__def_vals_, this._bind(function (value, key) {
        this._setDefault(key, value);
      }));
    }
    if (this.initData && BbaseEst.typeOf(this.initData) === 'function') {
      this.__def_vals_ = this.initData.call(this, this._attributes) || {};
      BbaseEst.each(this.__def_vals_, this._bind(function (value, key) {
        this._setDefault(key, value);
      }));
    }
  },
  /**
   * 重置表单
   *
   * @method [表单] - _reset ( 重置表单 )
   * @author wyj 14.11.18
   */
  _reset: function (data) {
    this.model.attributes = {};
    data = BbaseEst.extend(BbaseEst.extend(this.model.defaults || {}, this.__def_vals_), data);
    this._set(this._getPath(data));
  },
  /**
   * 获取对象路径
   *
   * @method _getPath
   * @return {[type]} [description]
   */
  _getPath: function (data, pre) {
    var paths = [];
    var temp = data;
    if (!pre) { pre = ''; }

    if (temp.CONST) delete temp.CONST;
    if (temp._options) delete temp._options;
    if (temp._data) delete temp._data;
    if (temp._isAdd) delete temp._isAdd;
    if (temp.models) delete temp.models;
    if (temp.children) delete temp.children;

    while (BbaseEst.keys(temp).length > 0) {
      data = temp;
      BbaseEst.each(data, function (value, key) {
        if (BbaseEst.typeOf(value) === 'object') {
          BbaseEst.each(value, function (v, k) {
            temp[key + '.' + k] = v;
          });
        } else {
          paths.push({
            path: key,
            value: value
          });
        }
        delete temp[key];
      });
    }
    BbaseEst.each(paths, this._bind(function (item) {
      temp[pre + item.path] = item.value;
    }));

    return temp;
  },
  /**
   * 获取监听字段
   * 1. {{pipe 'args.logo.length'}}
   * 2. bb-show="models.length > 0"
   * 3. {{PIC pic_path 120}}
   * 4. {{profileImageUrl}}
   *
   * @method _getField
   * @param  {string} value [description]
   * @return {string}       [description]
   */
  _getField: function (value) {
    var str = "",
      list = [],
      result = null;

    str = value.replace(/^[!|(]*(\w+(?:\.\w+)*)(?:[\s|\.|>|<|!|:=])?.*$/img, '$1');
    list = str.replace(/({{|}})/img, '').split(/\s/);

    BbaseEst.each(list, this._bind(function (item) {
      result = this._loopField(item);
      if (result !== null) {
        return false;
      }
    }));

    return result ? result : list[0];
  },
  /**
   * 递归获取模型类可用字段

   * @method _loopField
   * @param  {[type]} value [description]
   * @return {[type]}       [description]
   */
  _loopField: function (value) {
    var list = [];

    if (BbaseEst.typeOf(this._get(value)) === 'undefined') {
      list = value.split('.');
      if (list.length === 1) {
        return null;
      }
      list.pop();
      return this._loopField(list.join('.'));
    } else {
      return value;
    }
  },
  /**
   * 获取boolean值，  比如字符串 'true' '1' 'str' 均为true, 'false', '0', '' 均为false
   *
   * @method _getBoolean
   * @param  {[type]} value [description]
   * @return {[type]}       [description]
   */
  _getBoolean: function (value) {
    if (BbaseEst.isEmpty(value)){return false;};
    var bool =  value;
    var field = this._getField(value);
    if (!BbaseEst.isEmpty(field)){
      bool = BbaseEst.compile('{{' + value + '}}', this.model.attributes);
    }

    if (bool === 'true' || bool === '1') {
      bool = true;
    } else if (bool === 'false' || bool === '0' || bool === '') {
      bool = false;
    } else if (BbaseEst.typeOf(bool) === 'string' && BbaseEst.isEmpty(this._get(bool))) {
      bool = true;
    } else if (BbaseEst.typeOf(this._get(bool)) === 'boolean') {
      bool = this._get(value);
    }
    return bool;
  },
  /**
   * 判断字符串是不是boolean类型
   *
   * @method _isBoolean
   * @param  {[type]}  str [description]
   * @return {Boolean}     [description]
   */
  _isBoolean: function (str) {
    return (str === 'true' || str === 'false');
  },
  /**
   * 获取对象，如："{name: 'aaa'}" => '{"name": "aaa"}' => {name: "aaa"}
   * "{moduleId:'AdminLangconfigList',title:'配置中文语言设置',data: {moduleId:id,lanId:1,key:'value'},cover:true,width:800,height:600}"
   *
   * @method _getObject
   * @param  {string} value 字符串
   * @return {object}
   */
  _getObject: function (str, ignore) {

    var result = '',
      object = { fields: {} },
      list = [],
      temp = '',
      items_o = BbaseEst.trim(str).substring(1, str.length - 1).split(',');

    BbaseEst.each(items_o, function (item) {
      if (BbaseEst.typeOf(item) === 'string' && item.indexOf('{') > -1) {
        temp += (item + ',');
      } else if (BbaseEst.typeOf(item) === 'string' && item.indexOf('}') > -1) {
        temp += item;
        list.push(temp);
        temp = '';
      } else if (temp.length > 0) {
        temp += (item + ',');
      } else {
        list.push(item);
      }
    });

    BbaseEst.each(list, function (item) {
      var list = item.split(':');
      var r = '';
      var fnInfo = {};
      list[0] = BbaseEst.trim(list[0]);
      list[1] = BbaseEst.trim(list[1]);
      if (ignore){
        if (BbaseEst.typeOf('ignore') === 'array'){
          var dx = BbaseEst.findIndex(ignore, function(a){
            return a === list[0];
          });
          if (dx !== -1){
            object[list[0]] = list[1];
            return true;
          }
        } else if (BbaseEst.typeOf('ignore') === 'string'){
          if (ignore === list[0]){
            object[list[0]] = list[1].replace(/'/img, '');
            return true;
          }
        }
      }
      if (BbaseEst.typeOf(list[1]) === 'string' && list[1].indexOf('{') > -1) {
        var key = list.shift();
        object[key] = this._getObject(list.join(':'));
      } else if (list[1].indexOf('\'') > -1) {
        object[list[0]] = list[1] === "''" ? '' : BbaseEst.trim(list[1].replace(/'/img, ''));
      } else if (list[1] in this.model.attributes) {
        object[list[0]] = this._get(list[1]);
        object.fields[list[0]] = list[1];
      } else if (this[list[1].replace(/(\(.*\))/img, '')]) {
        if (list[1].indexOf('(') > -1) {
          fnInfo = this._getFunction(list[1], this.model.attributes);
          object[list[0]] = this[fnInfo.key].apply(this, fnInfo.args);
        } else {
          object[list[0]] = this[list[1]];
        }

      } else if (this._isBoolean(list[1])) {
        object[list[0]] = this._getBoolean(list[1]);
      } else {
        object[list[0]] = BbaseEst.trim(BbaseEst.compile('{{' + list[1] + '}}', this.model.attributes));
      }
    }, this);

    return object;
  },
  /**
   * 获取方法与参数
   *
   * @method _getFunction
   * @param  {string} str 字符串
   * @param  {object} obj 模型类
   * @return {object}
   */
  _getFunction: function (str, obj) {
    var bracketRe = /\(([^:\$]*)\)/img,
      key = null,
      helper = BbaseEst.trim(str.replace(/\(.*\)/g, ''));
    args = [];

    var brackets = str.match(bracketRe);
    if (brackets) {
      BbaseEst.each(brackets[0].split(','), function (item) {
        var arg = BbaseEst.trim(item.split('.')[0].replace(/[\(|\)]/img, ''));
        if (!key) {
          key = arg;
        }
        if (!arg) return;
        if (arg.indexOf('\'') > -1) {
          args.push(arg.replace(/'/img, ''));
        } else if (/^[\d\.]+$/img.test(arg)) {
          args.push(parseFloat(arg));
        } else if (arg in obj) {
          args.push(BbaseEst.getValue(obj, arg));
        } else if (this[arg]) {
          args.push(this[arg].call(this));
        } else {
          args.push('');
        }
      }, this);
    }

    return {
      key: helper,
      args: args
    };
  },
  /**
   * 设置model值
   *
   * @method [模型] - _setValue ( 设置model值 )
   * @param path
   * @param val
   * @author wyj 15.1.30
   * @example
   *      this._setValue('tip.name', 'aaa');
   */
  _setValue: function (path, val) {
    // just for trigger
    if (!BbaseEst.equal(BbaseEst.getValue(this.model.attributes, path), val)) {
      BbaseEst.setValue(this.model.attributes, path, val);
      BbaseEst.trigger(this.cid + path, path, true);
      this._m_change_ = true;
    }
  },
  /**
   * 赋值模型类
   *
   * @method [模型] - _set
   * @param {string/object} path [description]
   * @param {string/object} val  [description]
   */
  _set: function (path, val) {
    this._m_change_ = false;

    if (BbaseEst.typeOf(path) === 'object') {
      this._baseSetValues(this._getPath(path));
    } else {
      this._setValue(path, val);
    }
    if (this._m_change_ && this._ready_component_) {
      if (this.options.onUpdate) {
        this.options.onUpdate.call(this, this.model.toJSON());
      }
      if (this.change && !this.change.timer) {
        this.change.timer = setTimeout(this._bind(function () {
          this.change.call(this, this.viewType, path);
          this.change.timer = null;
        }), 20);
      };
      if (this.viewType === 'item') {
        this._super('change', 'item');
      }
    }
  },
  /**
   * 批量赋值
   *
   * @method [模型] - _baseSetValues
   * @param  {object} keyVals [description]
   * @return {*}         [description]
   */
  _baseSetValues: function (keyVals) {
    BbaseEst.each(keyVals, this._bind(function (value, key) {
      this._setValue(key, value);
    }));
  },
  /**
   * 基础设置模型类属性值
   *
   * @method [模型] - _baseSetAttr
   * @param  {[type]} path [description]
   * @param  {[type]} val  [description]
   * @return {[type]}      [description]
   */
  _baseSetAttr: function (path, val) {
    if (BbaseEst.typeOf(path) === 'string') BbaseEst.setValue(this.model.attributes, path, val);
    else BbaseEst.each(path, this._bind(function (value, key) {
      BbaseEst.setValue(this.model.attributes, key, value);
    }));
  },
  /**
   * 设置多个model值, 如果当前视图参数设置里有onChange事件，则调用之
   *
   * @method [模型] - _setValues ( 新版将移除 )
   * @param {[type]} keyVals [description]
   * @example
   *       this._setValues({
   *         'args.styles.name.display': 'block'
   *       });
   */
  _setValues: function (keyVals) {
    this._baseSetValues(keyVals);
    if (this._options.onChange) {
      this._options.onChange.call(this, keyVals);
    }
  },

  /**
   * 设置多个model attributes值， 此方法将不触发模型类改变事件
   *
   * @method [模型] - _setAttr
   * @param {[type]} keyVals [description]
   */
  _setAttr: function (path, val) {
    this._baseSetAttr(path, val);
  },
  /**
   * 设置多个model attributes值， 此方法将不触发模型类改变事件
   * 如果当前视图参数设置里有onChange事件，则调用之
   *
   * @method [模型] - _setAttrValues ( 新版将移除 )
   * @param {[type]} keyVals [description]
   */
  _setAttributes: function (path, val) {
    this._baseSetAttr(path, val);
    if (this._options.onChange) {
      this._options.onChange.call(this, path);
    }
  },
  /**
   * 获取请求参数
   * @param  {[type]} name [description]
   * @return {[type]}      [description]
   */
  _getParam: function (name) {
    if (this.collection) {
      return this.collection.__params[name];
    } else {
      return this.model.params[name];
    }
  },
  /**
   * 设置请求参数
   * @param {[type]} name  [description]
   * @param {[type]} value [description]
   */
  _setParam: function (name, value) {
    if (this.collection) {
      this.collection._setParam(name, value);
    } else {
      this.model._setParam(name, value);
    }
  },
  /**
   * 获取点击事件源对象
   *
   * @method [事件] - _getTarget
   * @param e
   * @return {*|jQuery|HTMLElement}
   *  @example
   *      this._getTarget(e);
   */
  _getTarget: function (e) {
    return e.target ? $(e.target) : $(e.currentTarget);
  },
  /**
   * 获取绑定事件源对象
   *
   * @method [事件] - _getEventTarget
   * @param e
   * @return {*|jQuery|HTMLElement}
   *  @example
   *      this._getEventTarget(e);
   */
  _getEventTarget: function (e) {
    return e.currentTarget ? $(e.currentTarget) : $(e.target);
  },
  /**
   * 动画执行前
   *
   * @method _beforeTransition
   * @return {[type]} [description]
   */
  _beforeTransition: function () {
    this.$el.css({ 'visibility': 'hidden' });
  },
  /**
   * 动画执行后

   * @method _afterTransition
   * @return {[type]} [description]
   */
  _afterTransition: function () {
    this.$el.css({ 'visibility': 'visible' });
  },
  /**
   * 单次执行
   *
   * @method [事件] - _one
   * @param callback
   * @author wyj 15.6.14
   * @example
   *      this._one(['AwardList'], function (AwardList) {
   *          BbaseApp.addPanel('main', {
   *          el: '#Award',
   *          template: '<div class="leaflet-award"></div>'
   *      }).addView('awardList', new AwardList({
   *          el: '.leaflet-award',
   *          viewId: 'awardList'
   *      }));
   *  });
   */
  _one: function (name, callback) {
    try {
      var _name, isArray = BbaseEst.typeOf(name) === 'array';
      var _nameList = [];
      var _one = null;

      _name = isArray ? name.join('_') : name;
      _one = '_one_' + _name;
      this[_one] = BbaseEst.typeOf(this[_one]) === 'undefined' ? true : false;

      if (this[_one]) {
        if (isArray) {
          BbaseEst.each(name, function (item) {
            _nameList.push(item.replace(/^(.+)-(\d+)?$/g, "$1"));
          });
          this._require(_nameList, callback);
        } else if (callback) {
          callback.call(this);
        }
      }
    } catch (e) {
      debug('Error -> BbaseSuperView._one ->' + JSON.stringify(name) + e, { type: 'error' }); //debug__
    }
  },
  /**
   * 异步加载
   *
   * @method [加载] - _require
   * @param dependent
   * @param callback
   * @author wyj 15.6.14
   * @example
   *        this._require(['Module'], function(Module){
   *            new Module();
   *        });
   */
  _require: function (dependent, callback) {
    seajs.use(dependent, BbaseEst.proxy(callback, this));
  },
  /**
   * 延迟执行
   *
   * @method [加载] - _delay
   * @param time
   * @author wyj 15.12.3
   * @example
   *  this._delay(function(){}, 5000);
   */
  _delay: function (fn, time) {
    setTimeout(BbaseEst.proxy(function () {
      setTimeout(BbaseEst.proxy(function () {
        if (fn) fn.call(this);
      }, this), time);
    }, this), 0);
  },
  /**
   * 代理
   *
   * @method [事件] - _bind
   * @param  {Function} fn [description]
   * @return {[type]}      [description]
   */
  _bind: function (fn) {
    return BbaseEst.proxy(fn, this);
  },
  /**
   * handlebar if 增强
   *
   * @method _parseHbs
   * @param  {[type]} template [description]
   * @return {[type]}          [description]
   */
  _parseHbs: function (template) {
    if (BbaseEst.isEmpty(template)) {
      return null;
    }
    if (template.indexOf('_quote_') > -1) {
      return template;
    }
    return template.replace(/{{#If\s+(.*?)}}/mg, function (expression) {
      return "{{#If '" + (expression + "&& '1'").replace(/{{#If\s+(.*)}}/mg, '$1').replace(/'/mg, '_quote_') + "'}}";
    });
  },
  _empty: function () {},
  /**
   * 销毁系统绑定的事件及其它
   *
   * @method [销毁] - _destroy
   * @return {[type]} [description]
   */
  _destroy: function () {
    this._re_dup = null;
    BbaseEst.each(this._directives_, this._bind(function (item) {
      if (BbaseApp.getDirective(item.name) && BbaseApp.getDirective(item.name).unbind) {
        BbaseApp.getDirective(item.name).unbind.call(this, item.object);
      }
    }));
  },
  /**
   * 关闭对话框
   *
   * @method _close
   */
  _close: function () {
    if (BbaseApp.getDialog(this.viewId)) {
      BbaseApp.getDialog(this.viewId).close().remove();
    }
  },
  render: function () {
    this._render();
  },
  /**
   * 静态对话框， 当你需要显示某个组件的视图但不是以iframe形式打开时
   * 对话框参数将作为模块里的options参数
   *
   * @method [对话框] - _dialog ( 静态对话框 )
   * @param options
   * @author wyj 15.1.22
   * @example
   *        // 获取对话框
   *          BbaseApp.getDialog('moduleId || id');
   *          this._dialog({
   *                moduleId: 'SeoDetail', // 模块ID
   *                title: 'Seo修改', // 对话框标题
   *                id: this.model.get('id'), // 初始化模块时传入的ID， 如productId
   *                width: 600, // 对话框宽度
   *                height: 250, // 对话框高度
   *                skin: 'form-horizontal', // className
   *                hideSaveBtn: false, // 是否隐藏保存按钮， 默认为false
   *                autoClose: true, // 提交后按确定按钮  自动关闭对话框
   *                quickClose: true, // 点击空白处关闭对话框
   *                button: [ // 自定义按钮
   *                  {
   *                    value: '保存',
   *                    callback: function () {
   *                    this.title('正在提交..');
   *                    $("#SeoDetail" + " #submit").click(); // 弹出的对话ID选择符为id
   *                     (注：当不存在id时，为moduleId值)
   *                    BbaseApp.getView('SeoDetail'); // 视图为moduleId
   *                    return false; // 去掉此行将直接关闭对话框
   *                  }}
   *                ],
   *                onShow: function(){ // 对话框弹出后调用   [注意，当调用show方法时，
   *                 对话框会重新渲染模块视图，若想只渲染一次， 可以在这里返回false]
   *                    return true;
   *                },
   *                onClose: function(){
   *                    this._reload(); // 列表刷新
   *                    this.collection.push(BbaseEst.cloneDeep(BbaseApp.getModels()));
   *                    // 向列表末尾添加数据, 注意必须要深复制
   *                    this.model.set(BbaseApp.getModels().pop()); // 修改模型类
   *                }
   *            }, this);
   */
  _dialog: function (options, context) {
    var ctx = context || this;
    var viewId = options.viewId ? options.viewId :
      BbaseEst.typeOf(options.dialogId) === 'string' ? options.dialogId : options.moduleId;
    if (BbaseEst.typeOf(viewId) === 'function') viewId = BbaseEst.nextUid('dialog_view');
    options.viewId = viewId + this.cid;
    var comm = {
      width: 'auto',
      title: null,
      cover: false,
      autofocus: false,
      hideOkBtn: true,
      hideCloseBtn: true,
      button: [],
      quickClose: options.cover ? false :
        (BbaseEst.typeOf(options.autofocus) === 'boolean' ? options.quickClose : false),
      skin: 'dialog_min'
    };

    if (options.moduleId && BbaseApp.getStatus(options.moduleId)) {
      comm = BbaseEst.extend(comm, BbaseApp.getStatus(options.moduleId));
    }
    options = BbaseEst.extend(comm, options);

    options = BbaseEst.extend(options, {
      el: '#base_item_dialog' + options.viewId,
      content: options.content || '<div id="' + options.viewId + '"></div>',
      viewId: options.viewId,
      onshow: function () {
        try {
          var result = options.onShow && options.onShow.call(this, options);
          if (typeof result !== 'undefined' && !result)
            return;
          if (BbaseEst.typeOf(options.moduleId) === 'function') {
            options.dialogId = options.dialogId || options.viewId;
            BbaseApp.addPanel(options.viewId, {
              el: '#' + options.dialogId,
              template: '<div id="base_item_dialog' + options.dialogId + '" class="region ' +
                options.viewId + '"></div>'
            }).addView(options.viewId, new options.moduleId(options));
          } else if (BbaseEst.typeOf(options.moduleId) === 'string') {
            seajs.use([options.moduleId], function (instance) {
              try {
                if (!instance) {
                  console.error(options.moduleId + ' is not defined');
                }
                BbaseApp.addPanel(options.viewId, {
                  el: '#' + options.viewId,
                  template: '<div id="base_item_dialog' + options.viewId + '" class="region"></div>'
                }).addView(options.viewId, new instance(options));
              } catch (e) {
                console.error(e);
              }
            });
          }
        } catch (e) {
          console.log(e);
        }
      },
      onclose: function () {
        if (BbaseApp.getPanel(options.viewId)) BbaseApp.removePanel(options.viewId);
        if (options.onClose) options.onClose.call(ctx, options);
        BbaseApp.getDialogs().pop();
      }
    });
    BbaseUtils.dialog(options);
  },
  /**
   * title提示
   *
   * @method [提示] - _initToolTip ( title提示 )
   * @author wyj 15.9.5
   * @example
   *      <div class="tool-tip" title="提示内容">content</div>
   *      this._initToolTip();
   */
  _initToolTip: function ($parent, className) {
    var _className = className || '.tool-tip';
    var $tip = $parent ? $(_className, $parent) : this.$(_className);

    $tip.hover(function (e) {
      var title = $(this).attr('data-title') || $(this).attr('title');
      var offset = $(this).attr('data-offset') || 0;
      if (BbaseEst.isEmpty(title)) return;

      var hash = BbaseEst.hash(title || 'error:446');

      if (!BbaseApp.getData('toolTipList')) BbaseApp.addData('toolTipList', []);
      if (BbaseEst.indexOf(BbaseApp.getData('toolTipList'), hash) > -1){
        BbaseApp.getDialog(hash) && BbaseApp.getDialog(hash).show();
        return;
      }

      BbaseUtils.dialog({
        dialogId: hash,
        title: null,
        width: 'auto',
        offset: parseInt(offset, 10),
        skin: 'tool-tip-dialog',
        align: $(this).attr('data-align') || 'top',
        content: '<div style="padding: 5px 6px;;font-size: 12px;">' + title + '</div>',
        hideCloseBtn: true,
        autofocus: false,
        target: $(this).get(0)
      });

      BbaseApp.getData('toolTipList').push(BbaseEst.hash(title));

      $(window).one('click', BbaseEst.proxy(function () {
        BbaseEst.each(BbaseApp.getData('toolTipList'), function (item) {
          if (BbaseApp.getDialog(item)) BbaseApp.getDialog(item).close();
        });
        BbaseApp.addData('toolTipList', []);

      }, this));

    }, function () {
      try {
        BbaseApp.getDialog(BbaseEst.hash($(this).attr('data-title') || $(this).attr('title'))).close();
      } catch (e) {}
    });
  }
});

/**
 * @description 普通视图
 *
 *  - el: 目标元素Id 如 "#jhw-main"
 *  - initialize 实现父类_initialize
 *  - render 实现父类_render
 *  - 事件
 *      var panel = new Panel();
 *      panel.on('after', function(){
 *        this.albumList = BbaseApp.addView('albumList', new AlbumList());
 *        this.photoList = BbaseApp.addView('photoList', new PhotoList());
 *      });
 *      panel.render(); // 渲染
 *
 * @class BbaseView - 普通视图
 * @author yongjin<zjut_wyj@163.com> 2014/12/8
 */


var BbaseView = BbaseSuperView.extend({
  /**
   * 初始化
   *
   * @method [初始化] - _initialize ( 初始化 )
   * @param options [template: 字符串模板][model: 实例模型]
   * @author wyj 14.11.20
   * @example
   *      this._initialize({
   *         viewId: 'productList'，
   *         template: 字符串模板，
   *         data: 对象数据
   *         // 可选
   *         enterRender: 执行回车后的按钮点击的元素选择符 如 #submit .btn-search
   *         append: false // 视图是否是追加,
   *         toolTip: true, // 是否显示title提示框   html代码： <div class="tool-tip" title="提示内容">内容</div>
   *         beforeRender: function(){},
   *         afterRender: function(){}
   *      });
   */
  _initialize: function(options) {
    this._initOptions(options);
    this._initTemplate(this._options.template);
    this._initModel(this._options.data, BbaseModel.extend({
      fields: this._options.fields
    }));
    this._initBind(this._options);
    this.render();
    return this;
  },
  /**
   * 初始化参数
   *
   * @method [private] - _initOptions
   * @private
   * @author wyj 15.1.12
   */
  _initOptions: function(options) {
    this._options = BbaseEst.extend(this.options, options || {});
    this._options.data = this._options.data || {};
    this.viewId = this._options.viewId;
    this.viewType = 'view';
  },
  /**
   * 初始化模板， 若传递一个Template模板字符中进来， 则渲染页面
   *
   * @method [private] - _initTemplate
   * @private
   * @author wyj 15.1.12
   */
  _initTemplate: function(template) {
    if (template) {
      template = this._parseHbs(template);
      this.template = BbaseHandlebars.compile(template);
      this.$template = '<div>' + template + '</div>';
    }
  },
  /**
   * 初始化模型类, 设置index索引
   *
   * @method [private] - _initModel
   * @private
   * @param model
   * @author wyj 14.11.20
   */
  _initModel: function(data, model) {
    if (data) data.CONST = CONST;
    this.model = new model(data);
  },
  /**
   * 绑定事件， 如添加事件， 重置事件
   *
   * @method [private] - _initBind
   * @private
   * @author wyj 14.11.16
   */
  _initBind: function(options) {
    this.model.bind('reset', this.render, this);
  },
  /**
   * 渲染
   *
   * @method [渲染] - _render ( 渲染 )
   * @author wyj 14.11.20
   * @example
   *        this._render();
   */
  _render: function() {
    if (this._initDefault) this._initDefault.call(this);
    if (this.beforeRender) this.beforeRender.call(this, this._options);
    if (this._options.append) this.$el.append(this.template(this.model.attributes));
    else this.$el.html(this.template(this.model.attributes));

    if (this._options.modelBind) setTimeout(this._bind(function() {
      this._modelBind();
    }), 0);
    if (this.afterRender) setTimeout(this._bind(function() {
      this.afterRender.call(this, this._options);
    }), 0);
    if (this._options.onReady) setTimeout(this._bind(function() {
      this._options.onReady.call(this, this._options);
    }), 0);
    if (this._watchBind) setTimeout(this._bind(function() {
      this._watchBind.call(this, this._options.template);
    }), 0);
    if (this._bbBind) setTimeout(this._bind(function() {
      this._bbBind.call(this, this._options.template, this.$el);
    }), 0);
    if (this._options.toolTip) setTimeout(this._bind(function() {
      this._initToolTip();
    }), 0);

    this._initEnterEvent(this._options);
    this._ready_component_ = true;
    BbaseUtils.removeLoading();
  },
  render: function() {
    this._render();
  }
});

/**
 * @description 列表视图
 * @class BbaseList - 列表视图
 * @author yongjin<zjut_wyj@163.com> 2014/12/8
 */


var BbaseList = BbaseSuperView.extend({
  /**
   * 传递options进来
   *
   * @method [private] - constructor
   * @private
   * @param options
   * @author wyj 14.12.16
   */
  /*constructor: function (options) {
   BbaseEst.interface.implements(this, new BbaseEst.interface('BbaseList', ['initialize', 'render']));
   this.constructor.__super__.constructor.apply(this, arguments);
   },*/
  /**
   * 初始化
   *
   * @method [初始化] - _initialize ( 初始化 )
   * @param options
   * @author wyj 14.11.20
   * @example
   *      this._initialize({
       *        model: ProductModel, // 模型类,
       *        collection:  ProductCollection,// 集合,
       *        item: ProductItem, // 单视图
       *        // 以下为可选
       *        template: listTemp, 字符串模板,
       *        render: '.product-list', 插入列表的容器选择符, 若为空则默认插入到$el中
       *        items: [], // 数据不是以url的形式获取时 (可选), items可为function形式传递;
       *        data: {}, // 附加的数据 BbaseList、BbaseView[js: this._options.data & template: {{name}}] ;
       *                     BbaseItem中为[this._options.data &{{_options._data.name}}] BaseCollecton为this._options.data BbaseModel为this.get('_data')
       *        append: false, // 是否是追加内容， 默认为替换
       *        checkAppend: false, // 鼠标点击checkbox， checkbox是否追加  需在BbaseItem事件中添加 'click .toggle': '_check',
       *        checkToggle: true,// 是否选中切换
       *        enterRender: (可选) 执行回车后的按钮点击的元素选择符 如 #submit .btn-search
       *        pagination: true/selector, // 是否显示分页 view视图中相应加入<div id="pagination-container"></div>; pagination可为元素选择符
       *        page: parseInt(BbaseEst.cookie('orderList_page')) || 1, //设置起始页 所有的分页数据都会保存到cookie中， 以viewId + '_page'格式存储， 注意cookie取的是字符串， 要转化成int
       *        pageSize: parseInt(BbaseEst.cookie('orderList_pageSize')) || 16, // 设置每页显示个数
       *        max: 5, // 限制显示个数
       *        sortField: 'sort', // 上移下移字段名称， 默认为sort
       *        itemId: 'Category_00000000000123', // 当需要根据某个ID查找列表时， 启用此参数， 方便
       *        filter: [ {key: 'name', value: this.searchKey }] // 过滤结果
       *        toolTip: true, // 是否显示title提示框   html代码： <div class="tool-tip" title="提示内容">内容</div>
       *        clearDialog: true, // 清除所有的对话框， 默认为true
       *        beforeLoad: function(collection){ // collection载入列表前执行
       *            this.setCategoryId(options.categoryId); // collection载入后执行
       *          },
       *        afterLoad: function(){ // collection载入之后
       *            if (this.collection.models.length === 0 ||
                      !this.options._isAdd){
                      this.addOne();
                    }
       *        },
       *        beforeRender: function(thisOpts){}, // 渲染前回调
       *        afterRender: function(thisOpts){ // 渲染后回调， 包括items渲染完成
       *          if (this.collection.models.length === 0 ||
                      !this.options._isAdd){
                      this.addOne();
                    }
       *        },
       *        cache: true, // 数据缓存到内存中
       *        session: true, // 数据缓存到浏览器中，下次打开浏览器，请求的数据直接从浏览器缓存中读取
       *        // 以下为树型列表时 需要的参数
       *        subRender: '.node-tree', // 下级分类的容器选择符
       *        collapse: '.node-collapse' 展开/收缩元素选择符
       *        parentId: 'belongId', // 分类 的父类ID
       *        categoryId: 'categoryId', // 分类 的当前ID
       *        rootId: 'isroot', // 一级分类字段名称
       *        rootValue: '00' // 一级分类字段值  可为数组[null, 'Syscode_']   数组里的选项可为方法， 返回true与false
       *        extend: true // false收缩 true为展开
       *       });
   */
  _initialize: function (options) {
    this.dx = 0;
    this.views = [];
    return this._initOpt(options.collection, options);
  },
  /**
   * 初始化集合类
   *
   * @method [private] - _init
   * @private
   * @param collection 对应的collection集合类， 如ProductCollection
   * @param options [beforeLoad: 加载数据前执行] [item: 集合单个视图] [model: 模型类]
   * @author wyj 14.11.16
   */
  _initOpt: function (collection, options) {

    this._initOptions(options);
    this._initDataModel(BbaseModel.extend({}));
    this._initTemplate(this._options);
    this._initEnterEvent(this._options, this);
    this._initList(this._options);
    this._initCollection(this._options, collection);
    this._initItemView(this._options.item, this);
    this._initModel(this._options.model);
    this._initBind(this.collection);
    this._initPagination(this._options);
    this._load(this._options);
    return this;
  },
  /**
   * 初始化参数
   *
   * @method [private] - _initOptions
   * @private
   * @author wyj 15.1.12
   */
  _initOptions: function (options) {
    this._options = BbaseEst.extend(this.options, options || {});
    this._options.sortField = 'sort';
    this._options.max = this._options.max || 99999;
    this._options.speed = this._options.speed || 9;
    this.viewId = this._options.viewId;
    this.viewType = 'list';
  },
  /**
   * 初始化模型类, 设置index索引
   *
   * @method [private] - _initDataModel
   * @private
   * @param model
   * @author wyj 14.11.20
   */
  _initDataModel: function (model) {
    if (this._options.data) {
      this._options.data.CONST = CONST;
    }
    this.model = new model(this._options.data);

    this._set('models', []);
  },
  /**
   * 初始化模板， 若传递一个Template模板字符中进来， 则渲染页面
   *
   * @method [private] - _initTemplate ( 待优化， 模板缓存 )
   * @private
   * @author wyj 15.1.12
   */
  _initTemplate: function (options) {
    this._data = options.data = options.data || {};
    if (options.template) {
      options.template = this._parseHbs(options.template);
      if (this._initDefault) this._initDefault.call(this);
      if (this.beforeRender) this.beforeRender.call(this);
      this.$template = $('<div>' + options.template + '</div>');
      if (options.render) {
        if (BbaseEst.msie()) {
          this.__template = options.template.replace(new RegExp('\\sstyle=', 'img'), ' ng-style=');
          options.itemTemp = $('<div>' + this.__template + '</div>').find(options.render).html();
          if (!BbaseEst.isEmpty(options.itemTemp)) {
            options.itemTemp = options.itemTemp.replace(/ng-style/img, 'style')
          }
        } else {
          options.itemTemp = this.$template.find(options.render).html();
        }
        if (typeof this._options.empty === 'undefined' || this._options.empty){
          this.$template.find(options.render).empty();
        }
      } else {
        if (BbaseEst.msie()) {
          this.__template = options.template.replace(new RegExp('\\sstyle=', 'img'), ' ng-style=');
          options.itemTemp = $('<div>' + this.__template + '</div>').html();
          if (!BbaseEst.isEmpty(options.itemTemp)) {
            options.itemTemp = options.itemTemp.replace(/ng-style/img, 'style')
          }
        } else {
          options.itemTemp = this.$template.html();
        }
        this.$template.empty();
      }
      this.template = BbaseHandlebars.compile(BbaseEst.isEmpty(options.itemTemp) ? options.template :
        this.$template.html());

      if (this._options.append) {
        this.$el.empty();
        this.$el.append(this.template(this.model.attributes));
      } else {
        this.$el.html(this.template(this.model.attributes));
      }
    }
    if (options.modelBind) this._modelBind();
  },
  /**
   * 回车事件
   *
   * @method [private] - _initEnterEvent
   * @private
   * @author wyj 14.12.10
   */
  _initEnterEvent: function (options, ctx) {
    if (options.enterRender) {
      ctx.$('input').keyup(function (e) {
        if (e.keyCode === CONST.ENTER_KEY) {
          ctx.$(options.enterRender).click();
        }
      });
    }
  },
  /**
   * 初始化列表视图容器
   *
   * @method [private] - _initList
   * @private
   * @author wyj 15.1.12
   */
  _initList: function (options) {
    var ctx = this;
    this.list = options.render ? this.$(options.render) : this.$el;
    if (this.list.size() === 0)
      this.list = $(options.render);
  },
  /**
   * 初始化collection集合
   *
   * @method [private] - _initCollection
   * @param collection
   * @private
   */
  _initCollection: function (options, collection) {
    if (!collection.prototype.hasOwnProperty('model')) { collection.prototype.model = this._options.model };
    if (!this.collection || (this.collection && !this.collection.remove))
      this.collection = new collection(options);
    if (options.itemId) this.collection._setItemId(options.itemId);
    //TODO 分类过滤
    if (options.subRender) this.composite = true;
  },
  /**
   * 初始化单个枚举视图
   *
   * @method [private] - _initItemView
   * @private
   * @param itemView
   * @author wyj 14.11.16
   */
  _initItemView: function (itemView) {
    this.item = itemView;
  },
  /**
   * 初始化模型类, 设置index索引
   *
   * @method [private] - _initModel
   * @private
   * @param model
   * @author wyj 14.11.20
   */
  _initModel: function (model) {
    this.initModel = model;
  },
  /**
   * 绑定事件， 如添加事件， 重置事件
   * @method [private] - _initBind
   * @private
   * @author wyj 14.11.16
   */
  _initBind: function (collection) {
    if (collection) {
      collection.bind('add', this._addOne, this);
      collection.bind('reset', this._render, this);
    }
    if (this._watchBind) this._watchBind.call(this, this._options.template);
    if (this._bbBind) this._bbBind.call(this, this._options.template, this.$el);
  },
  /**
   * 初始化分页
   *
   * @method [private] - _initPagination
   * @param options
   * @private
   * @author wyj 14.11.17
   */
  _initPagination: function (options) {
    var ctx = this;
    if (ctx.collection && ctx.collection.paginationModel) {
      // 单一观察者模式， 监听reloadList事件
      ctx.collection.paginationModel.on('reloadList',
        function (model) {
          ctx._set('checked_all', false);
          if (!ctx._options.diff) ctx._clear.call(ctx);
          ctx._load.call(ctx, options, model);
        });
    }
  },
  /**
   * 获取集合数据 当append为true时，只追加数据。
   * 类似有个_reload  这个方法无论append是否为true， 都会清空列表重新加载
   *
   * @method [渲染] - _load ( 获取集合数据 )
   * @param options [beforeLoad: 载入前方法][page: 当前页][pageSize: 每页显示条数]
   * @param model 分页模型类 或为全查必填
   * @author wyj 14.11.16
   * @example
   *        baseListCtx._load({
   *          page: 1,
   *          pageSize: 16,
   *          beforeLoad: function () {
   *            this.collection.setCategoryId(options.categoryId);
   *          },
   *          afterLoad: function(){
   *
   *          }
   *        }).then(function () {
   *          ctx.after();
   *        });
   */
  _load: function (options, model) {
    var ctx = this;
    options = options || this._options || {};
    this._beforeLoad(options);
    if (options.page || options.pageSize) {
      if (options.page)
        ctx._setPage(options.page || 1);
      // 备份page
      options._page = options.page;
      if (options.pageSize)
        ctx._setPageSize(options.pageSize || 16);
      // 备份pageSize
      options._pageSize = options.pageSize;
      model = ctx.collection.paginationModel;
      //TODO 移除BbaseList默认的page 与pageSize使每页显示条数生效
      options.page = options.pageSize = null;
    }
    //TODO 若存在items且有page与pageSize  处理静态分页
    if (this._options.items) {
      if (!this._options.diff) this._empty();
      this._initItems();
    }
    // page pageSize保存到cookie中
    if (this._options.viewId && ctx.collection.paginationModel &&
      ctx._getPageSize() < 999) {
      BbaseApp.addCookie(this._options.viewId + '_page');
      //BbaseEst.cookie(this._options.viewId + '_page', ctx._getPage());
      BbaseApp.addCookie(this._options.viewId + '_pageSize');
      //BbaseEst.cookie(this._options.viewId + '_pageSize', ctx._getPageSize());
    }
    // 判断是否存在url
    if (ctx.collection.url && !this._options.items) {

      if (ctx._options.filter) ctx.filter = true;
      // 处理树结构
      if (ctx._options.subRender) {
        ctx.composite = true;
        ctx._setPage(1);
        ctx._setPageSize(9000);
      }
      // 数据载入
      BbaseUtils.addLoading()
      ctx.collection._load(ctx.collection, ctx, model || this.collection.paginationModel).
      done(function (result) {
        if (result && result.msg && result.msg === CONST.LANG.AUTH_FAILED) {
          BbaseUtils.tip(CONST.LANG.AUTH_LIMIT + '！', {
            time: 2000
          });
        }
        if (!result) {
          result = { success: false, msg: '请求未知错误' };
          ctx.errorFetch && ctx.errorFetch.call(ctx, result);
        }
        if (result && !result.success && ctx.errorFetch) {
          ctx.errorFetch.call(ctx, result);
        }
        ctx._removeNoResult();
        try {
          if (ctx._getTotalPage() === ctx._getPage()) {
            ctx._set('load_completed', true);
          }
          if (BbaseEst.isEmpty(result) || BbaseEst.isEmpty(result.attributes) || result.attributes.data.length === 0) {
            ctx._handleListNode();
            if (result.msgType === 'notLogin') {
              BbaseEst.trigger('checkLogin', null, true);
            }
          }
        } catch (e) {
          BbaseEst.trigger('checkLogin', null, true);
          debug('Error4 -> _load -> ' + result.msg); //debug__
        }
        ctx._afterLoad(result);
        //if (ctx._options.diff) ctx._setModels();
        if (ctx._options.subRender) ctx._filterRoot();
        //if (ctx._options.filter) ctx._filterCollection();
        if (result.attributes && result.attributes.model) {
          ctx._options.data = BbaseEst.extend(ctx._options.data, result.attributes.model);
        }
        ctx._filter();
        ctx._resetModels();
        if (!ctx._ready_component_) {
          ctx._finally();
        }
        if (options && options.afterRender){
          options.afterRender.call(ctx);
        }
      });
    } else {
      ctx._afterLoad();
      ctx._resetModels();
      if (!ctx._ready_component_) {
        ctx._finally();
      }
    }
  },
  /**
   * 初始化完成后执行
   *
   * @method [private] - _finally
   * @private
   */
  _finally: function () {
    if (this.afterRender) setTimeout(this._bind(function () {
      this.afterRender.call(this, this._options)
    }), 0);
    if (this._options.onReady) setTimeout(this._bind(function () {
      this._options.onReady.call(this, this._options)
    }), 0);
    if (this._options.toolTip) setTimeout(this._bind(function () {
      this._initToolTip();
    }), 0);
    this._ready_component_ = true;
  },
  _resetModels: function () {
    this._set('models', this.collection.models);
    if (this.cms) {
      BbaseEst.off(this.cid + 'models', this.cms);
    }
    this.cms = BbaseEst.on(this.cid + 'models', this._bind(function () {
      //debug('reset model models');
      this._set('models', this.collection.models);
    }));
    BbaseUtils.removeLoading();
  },
  _filter: function () {
    if (this.filter) {
      this._appendAble_ = true;
      this.filter.call(this);
      this.collection.each(this._addOne, this);
      this._appendAble_ = false;
    }
  },
  _handleListNode: function () {
    this._set('result_none', true);
    this._options.append ? this.list.append('<div class="no-result">' + CONST.LANG.LOAD_ALL + '</div>') :
      this.list.append('<div class="no-result">' + CONST.LANG.NO_RESULT + '</div>');
    if (this._getPage() === 1) {
      this.trigger('resultListNone' + this._options.viewId, {});
    }
  },
  _removeNoResult: function () {
    this.list.find('.no-result').remove();
  },
  /**
   * 刷新列表 会清空已存在的数据
   *
   * @method [渲染] - _reload ( 刷新列表 )
   * @author wyj 15.1.24
   * @example
   *        this._reload();
   */
  _reload: function (options) {
    this._empty.call(this); // 清空视图
    this.collection.reset(); // 清空collection
    this.list.empty(); // 清空DOM
    this._load(options); // 重新加载数据
  },

  /**
   * 列表载入前执行
   *
   * @method [private] - _beforeLoad
   * @param options
   * @private
   */
  _beforeLoad: function (options) {
    if (this.beforeLoad)
      this.beforeLoad.call(this, this.collection);
  },
  /**
   * 列表载入后执行
   *
   * @method [private] - _afterLoad
   * @private
   */
  _afterLoad: function (response) {
    if (this.afterLoad)
      this.afterLoad.call(this, response);
  },
  /**
   * 初始化items
   *
   * @method [private] - _initItems
   * @private
   * @author wyj 15.1.8
   */
  _initItems: function () {
    if (BbaseEst.typeOf(this._options.items) === 'function') {
      this._options.items = this._options.items.apply(this, arguments);
    }
    /*if (this._options.filter) {
      this.collection.push(this._options.items);
      this._filterCollection();
      this._options.items = BbaseEst.pluck(BbaseEst.cloneDeep(this.collection.models, function() {}, this), 'attributes');
    }*/
    if (this._options._page || this._options._pageSize) {
      this._renderListByPagination();
    } else {
      BbaseEst.each(this._options.items, function (item) {
        if (this._checkStop()) return false;
        this.collection.push(new this.initModel(item));
      }, this);
      if (this._options.subRender) this._filterRoot();
    }
    this._filter();
    if (this._options.items.length === 0) {
      this._handleListNode();
    }
  },
  /**
   * 缓存编译模板
   *
   * @method [private] - _setTemplate
   * @private
   * @author wyj 15.2.14
   */
  _setTemplate: function (compile) {
    this.compileTemp = compile;
  },
  /**
   * 获取编译模板
   *
   * @method [private] - _getTemplate
   * @private
   * @author wyj 15.2.14
   */
  _getTemplate: function () {
    return this.compileTemp;
  },
  /**
   * 停止遍历
   *
   * @method [渲染] - _stop ( 停止遍历 )
   * @author wyj 15.1.27
   * @example
   *        this._stop();
   */
  _stop: function () {
    this.stopIterator = true;
  },
  /**
   * 检查是否停止遍历
   *
   * @method [private] - _checkStop
   * @private
   * @return {boolean}
   * @author wyj 15.1.27
   */
  _checkStop: function () {
    if (this.stopIterator) {
      this.stopIterator = false;
      return true;
    }
    return false;
  },
  /**
   * 渲染视图
   *
   * @method [渲染] - _render ( 渲染视图 )
   * @author wyj 14.11.16
   * @example
   *
   */
  _render: function () {
    this._addAll();
    this.trigger('after', this);
  },
  /**
   * 过滤父级元素
   *
   * @method [private] - _filterRoot
   * @private
   * @author wyj 14.12.9
   */
  _filterRoot: function () {
    var ctx = this;
    var temp = [];
    var roots = [];
    ctx.composite = false;
    /* ctx.collection.comparator = function (model) {
     return model.get('sort');
     }
     ctx.collection.sort();*/
    BbaseEst.each(ctx.collection.models, function (item) {
      temp.push({
        categoryId: item.attributes[ctx._options.categoryId],
        belongId: item.attributes[ctx._options.parentId]
      });
    });
    this.collection.each(function (thisModel) {
      var i = temp.length,
        _children = [];
      while (i > 0) {
        var item = temp[i - 1];
        if ((item.belongId + '') === (thisModel.get(ctx._options.categoryId) + '')) {
          _children.unshift(item.categoryId);
          temp.splice(i - 1, 1);
        }
        i--;
      }
      thisModel.set('children', _children);
      thisModel.set('id', thisModel.get(ctx._options.categoryId));
      // 添加父级元素

      if (BbaseEst.typeOf(ctx._options.rootValue) === 'array') {
        //TODO 如果存入的rootValue为数组
        BbaseEst.each(ctx._options.rootValue, BbaseEst.proxy(function (item) {
          if (BbaseEst.typeOf(item) === 'function') {
            // 判断是否是方法， 如果返回true则添加到roots中
            if (item.call(this, item)) {
              thisModel.set('level', 1);
              roots.push(thisModel);
            }
          } else {
            if (!BbaseEst.isEmpty(item) && thisModel.get(ctx._options.rootId) &&
              thisModel.get(ctx._options.rootId).indexOf(item) > -1) {
              // 判断不为null 且索引是否大于-1
              thisModel.set('level', 1);
              roots.push(thisModel);
            } else if (thisModel.get(ctx._options.rootId) === item) {
              // 如果为null值， 则直接===比较， true则添加到roots中
              thisModel.set('level', 1);
              roots.push(thisModel);
            }
          }
        }, this));
      } else if (thisModel.get(ctx._options.rootId) === ctx._options.rootValue) {
        thisModel.set('level', 1);
        thisModel.set('isroot', '01');
        roots.push(thisModel);
      }
    });
    BbaseEst.each(roots, function (model) {
      model.set('isroot', '01');
      if (!ctx._options.diff) {
        ctx._addOne(model);
      }
    });
    if (ctx._options.diff) {
      this._setModels(roots);
    }
  },
  _remove: function (start, end) {
    var end = typeof end === 'undefined' ? (start + 1) : end;
    if (end > this.collection.models.length) {
      return;
    }
    while (end > start) {
      this.collection.models[end - 1].attributes.id = null;
      this.collection.models[end - 1].view._remove(this.collection.models[end - 1].get('dx'));
      end--;
    }
  },
  _setModels: function (list) {
    var len_c = this.collection.models.length;
    var len_l = list.length;
    var dx = (this._getPageSize() || 16) *
        ((this._getPage() - 1) || 0);
    if (len_l > 0 && list[0].view) {
      list = BbaseEst.map(list, function (model) {
        return model.attributes;
      });
    }
    this.collection.each(this._bind(function (model, i) {
      if (i > len_l - 1) {} else {
        if (list[i]) {
          list[i]['dx'] = dx;
          dx++;
          model.view._set(this._getPath(list[i]));
        }
      }
    }));
    if (len_l > len_c) { // 添加
      for (var j = len_c + 1; j <= len_l; j++) {
        list[j-1]['dx'] = dx;
        dx++;
        this._push(new this._options.model(this._getPath(list[j - 1])));
      }
    } else if (len_l < len_c) {
      this._remove(len_l, len_c);
    }
  },
  /**
   * 向视图添加元素
   *
   * @method [private] - _addOne
   * @private
   * @param model
   * @author wyj 14.11.16
   */
  _addOne: function (model, arg1, arg2) {
    var ctx = this;
    if (!this.composite && this.dx < this._options.max) {
      model.set({
        'dx': this.dx++
      });
      switch (this._options.speed) {
        case 1:
          model.set('_options', {});
          break;
        case 9:
          model.set('_options', {
            _speed: this._options.speed,
            _item: ctx._options.item,
            _items: ctx._options.items ? true : false,
            _model: ctx._options.model,
            _collection: BbaseEst.isEmpty(ctx._options.subRender) ? null : ctx.collection,
            _subRender: ctx._options.subRender,
            _collapse: ctx._options.collapse,
            _extend: ctx._options.extend,
            _checkAppend: ctx._options.checkAppend,
            _checkToggle: ctx._options.checkToggle,
            _data: ctx.options.data || ctx._options.data
          });
      }
      //BbaseApp.addData('maxSort', model.get('dx') + 1);
      var itemView = new this.item({
        model: model,
        viewId: this._options.viewId,
        speed: this._options.speed,
        data: this._data,
        views: this.views,
        itemTemp: this._options.itemTemp
      });
      itemView._setInitModel(this.initModel);
      //TODO 优先级 new对象里的viewId > _options > getCurrentView()
      itemView._setViewId(this._options.viewId || BbaseApp.getCurrentView());

      if (arg2 && arg2.at < this.collection.models.length - 1 &&
        this.collection.models.length > 1) {
        this.collection.models[arg2.at === 0 ? 0 :
          arg2.at - 1].view.$el.after(itemView._render().el);
      } else if (!this.filter || this._appendAble_) {
        this.list.append(itemView._render().el);
      }
      this.views.push(itemView);
    }
  },
  /**
   * 向列表中添加数据
   * @method [集合] - _push ( 向列表中添加数据 )
   * @param model
   * @param opts
   * @author wyj 15.6.10
   * @example
   *        this._push(new model());
   *        this._push(new model(), 0); // 表示在第一个元素后面添加新元素
   *        this._push(new pictureModel(model), this._findIndex(curModel) + 1);
   */
  _push: function (model, index) {
    // 判断第二个参数是否是数字， 否-> 取当前列表的最后一个元素的索引值
    // 判断index是否大于列表长度
    // 若存在items， 则相应插入元素
    var obj, _index = BbaseEst.typeOf(index) === 'number' ? index + 1 :
      this.collection.models.length === 0 ? 0 : this.collection.models.length + 1;
    var opts = {
      at: _index > this.collection.models.length ?
        this.collection.models.length + 2 : _index
    };
    if (!model.cid) model = new this.initModel(model);
    if (this._options.items) {
      obj = BbaseEst.typeOf(model) === 'array' ? BbaseEst.pluck(model, function (item) {
        return item.attributes;
      }) : model.attributes;
      if (!this._options.diff) this._options.items.splice(opts.at - 1, 0, obj);
    }
    this._appendAble_ = true;
    this.collection.push(model, opts);
    this._appendAble_ = false;
    if (!BbaseEst.isEmpty(index) && this._getLength() > 1) {
      this._exchangeOrder(_index - 1, _index, {});
    }
    this._resetDx();
    this._setValue('checked_all', false);

    BbaseEst.trigger(this.cid + 'models', null, true);

    if (this._get('result_none')) {
      this.list.find('.no-result').remove();
      this._set('result_none', false);
    }
  },
  /**
   * 通过索引值获取当前视图的jquery对象
   * @method [集合] - _eq
   * @param  {number} index 索引值
   * @return {array}       [description]
   */
  _eq: function (index) {
    return this.collection.models[index].view.$el;
  },
  /**
   * 重新排序dx列表
   * @method [private] - _resetDx
   * @private
   * @author wyj 15.9.3
   */
  _resetDx: function () {
    var _dx = (this._getPageSize() || 16) *
        ((this._getPage() - 1) || 0);;
    BbaseEst.each(this.collection.models, function (item) {
      item.view._set('dx', _dx);
      _dx++;
    });
    this.dx = this.collection.models.length;
  },
  /**
   * 获取当前模型类在集合类中的索引值
   * @method [集合] - _findIndex ( 索引值 )
   * @param model
   * @return {number}
   * @author wyj 15.6.10
   * @example
   *      this._findIndex(this.curModel); ==> 1
   */
  _findIndex: function (model) {
    return BbaseEst.findIndex(this.collection.models, {
      cid: model.cid
    });
  },
  /**
   * 过滤集合
   *
   * @method [private] - _filterCollection
   * @private
   * @author wyj 15.1.10
   */
  /*_filterCollection: function() {
    this._filter(this._options.filter, this._options);
  },*/
  /**
   * 静态分页
   *
   * @method [private] - _renderListByPagination
   * @private
   * @author wyj 15.1.8
   */
  _renderListByPagination: function () {
    this.page = this._getPage();
    this.pageSize = this._getPageSize();
    this.startIndex = (this.page - 1) * parseInt(this.pageSize, 10);
    this.endIndex = this.startIndex + parseInt(this.pageSize, 10);

    if (this._options.diff) {
      var models = [];
      for (var i = this.startIndex; i < this.endIndex; i++) {
        if (this._options.items[i]){
          var model = BbaseEst.cloneDeep(this._options.items[i]);
          model['dx'] = this.startIndex + i;
          models.push(model);
        }
      }
      this._setModels(models);
    } else {
      for (var i = this.startIndex; i < this.endIndex; i++) {
        this.collection.push(this._options.items[i]);
      }
    }

    // 渲染分页
    this._setCount(this._options.items.length);
    this.collection._paginationRender();
    return this.collection;
  },

  /**
   * 清空列表， 并移除所有绑定的事件
   *
   * @method [集合] - _empty ( 清空列表 )
   * @author wyj 14.11.16
   * @private
   * @example
   *      this._empty();
   */
  _empty: function () {
    this.dx = 0;
    if (this._options.append) {
      return this.collection;
    }
    if (this.collection && !this.collection.remove) {}
    if (this.collection._reset) this.collection._reset();
    if (this.collection) {
      var len = this.collection.length;
      while (len > -1) {
        this.collection.remove(this.collection[len]);
        len--;
      }
    }
    // 设置当前页的起始索引， 如每页显示20条，第2页为20
    if (this.collection.paginationModel) {
      this.dx = (this._getPageSize() || 16) *
        ((this._getPage() - 1) || 0);
    }
    //遍历views数组，并对每个view调用BbaseBackbone的remove
    BbaseEst.each(this.views, function (view) {
      view.remove().off();
    });
    //清空views数组，此时旧的view就变成没有任何被引用的不可达对象了
    //垃圾回收器会回收它们
    this.views = [];

    BbaseEst.trigger(this.cid + 'models', null, true);
    //this.list.empty();
    return this.collection;
  },
  /**
   * 清空DOM列表
   *
   * @method [集合] - _clear ( 清空DOM列表 )
   * @author wyj 15.1.24
   * @private
   * @example
   *        this._clear();
   */
  _clear: function () {
    this._empty.call(this);
    this.list.empty();
    this.collection.models.length = 0;
  },
  /**
   * 添加所有元素， 相当于刷新视图
   *
   * @method [private] - _addAll
   * @private
   * @author wyj 14.11.16
   */
  _addAll: function () {
    this._empty();
    this.collection.each(this._addOne, this);
  },
  /**
   * 搜索(新版将移除)
   *
   * @method [搜索] - _search ( 搜索 )
   * @param options [onBeforeAdd: 自定义过滤]
   * @author wyj 14.12.8
   * @example
   *      this._search({
   *        filter: [
   *         {key: 'name', value: this.searchKey },
   *         {key: 'prodtype', value: this.searchProdtype} ,
   *         {key: 'category', value: this.searchCategory},
   *         {key: 'loginView', value: this.searchLoginView},
   *         {key: 'ads', value: this.searchAds}
   *         ],
   *        onBeforeAdd: function(item){
   *          // 自定义过滤， 即通过上面的filter后还需要经过这一层过滤
   *          // 若通过返回true
   *          return item.attributes[obj.key].indexOf(obj.value) !== -1;
   *       }});
   */
  /*  _search: function(options) {
      var ctx = this;
      this._clear();
      this.filter = true;
      options = BbaseEst.extend({
        onBeforeAdd: function() {}
      }, options);
      this._load({
        page: 1,
        pageSize: 5000,
        afterLoad: function() {
          ctx.filter = false;
          if (!ctx._options.items) {
            ctx._filter(options.filter || ctx._options.filter, options);
          } else {
            ctx._filterItems(options.filter || ctx._options.filter, options);
          }
        }
      });
    },*/
  /**
   * 过滤collection(新版将移除)
   *
   * @method [private] - _filter
   * @param array
   * @param options
   * @private
   * @author wyj 14.12.8
   */
  /*_filter: function(array, options) {
    var ctx = this;
    var result = [];
    var len = ctx.collection.models.length;
    ctx.filter = false;
    while (len > 0) {
      if (this._checkStop()) len = -1;

      var item = ctx.collection.models[len - 1];
      var pass = true;

      BbaseEst.each(array, function(obj) {
        var match = false;
        var keyval = BbaseEst.getValue(item.attributes, obj.key);

        if (BbaseEst.typeOf(obj.match) === 'regexp') {
          match = !obj.match.test(keyval);
        } else {
          match = BbaseEst.isEmpty(keyval) || (keyval.indexOf(obj.value) === -1);
        }
        if (pass && !BbaseEst.isEmpty(obj.value) && match) {
          ctx.collection.remove(item);
          pass = false;
          return false;
        }
      });
      if (pass && options.onBeforeAdd) {
        var _before_add_result = options.onBeforeAdd.call(this, item);
        if (BbaseEst.typeOf(_before_add_result) === 'boolean' && !_before_add_result) {
          pass = false;
        }
      }
      if (pass) {
        result.unshift(item);
      }
      len--;
    }
    BbaseEst.each(result, function(item) {
      item.set('_isSearch', true);
      ctx._addOne(item);
    });
    BbaseEst.trigger(this.cid + 'models');
  },*/
  /**
   * 过滤items(新版将移除)
   *
   * @method [private] - _filterItems
   * @param array
   * @param options
   * @private
   * @author wyj 14.12.8
   */
  /*_filterItems: function(array, options) {
    var ctx = this;
    var result = [];
    var items = BbaseEst.cloneDeep(ctx._options.items);
    var len = items.length;
    ctx.filter = false;
    while (len > 0) {
      if (this._checkStop()) break;
      var item = items[len - 1];
      var pass = true;
      BbaseEst.each(array, function(obj) {
        var match = false;
        var keyval = BbaseEst.getValue(item, obj.key);
        if (BbaseEst.typeOf(obj.match) === 'regexp') {
          match = !obj.match.test(keyval);
        } else {
          match = BbaseEst.isEmpty(keyval) || (keyval.indexOf(obj.value) === -1);
        }
        if (pass && !BbaseEst.isEmpty(obj.value) && match) {
          items.splice(len, 1);
          pass = false;
          return false;
        }
      });
      if (pass && options.onBeforeAdd) {
        var _before_add_result = options.onBeforeAdd.call(this, item);
        if (BbaseEst.typeOf(_before_add_result) === 'boolean' && !_before_add_result) {
          pass = false;
        }
      }
      if (pass) {
        result.unshift(item);
      }
      len--;
    }
    BbaseEst.each(result, function(item) {
      item = new ctx.initModel(item);
      item.set('_isSearch', true);
      ctx.collection.push(item);
      //ctx._addOne(item);
    });
  },*/
  /**
   * 全选checkbox选择框, 只能全选中， 不能全不选中(新版将移除)
   *
   * @method [选取] - _checkAll ( 全选checkbox选择框 )
   * @author wyj 14.11.16
   */
  _checkAll: function (e) {
    var checked,
      _self = this,
      $check = null;

    if (BbaseEst.typeOf(e) === 'boolean') {
      // 直接指定true/false
      this._setValue('checked_all', e);
    } else if (e) {
      // node元素
      $check = this._getEventTarget(e);
      if ($check.is('checkbox')) {
        this._setValue('checked_all', $check.get(0).checked);
      } else {
        this._setValue('checked_all', !this._getValue('checked_all'));
      }
    } else {
      // handle click
      this._setValue('checked_all', !this._getValue('checked_all'));
    }
    checked = this._getValue('checked_all');
    this.collection.each(function (model) {
      model._set('checked', checked);
      //if (!_self._options.diff) model.view.render();
    });
    this._checkedAll(this._getValue('checked_all'));
  },
  /**
   * 是否全选
   * @method [选取] - _checkedAll
   * @param  {[type]} checked [description]
   * @return {[type]}         [description]
   */
  _checkedAll: function (checked) {
    this._setValue('checked_all', checked);
  },
  /**
   * 保存sort值
   *
   * @method [保存] - _saveSort ( 保存sort值 )
   * @param model
   * @author wyj 14.12.4
   */
  _saveSort: function (model) {
    var sortOpt = {
      id: model.get('id')
    };
    sortOpt[this._options.sortField || 'sort'] = model.get(this._options.sortField);
    model._saveField(sortOpt, this, {
      async: false,
      hideTip: true
    });
  },
  _saveSorts: function (model, args) {
    var sortOpt = {
      id: model.get('id')
    };
    sortOpt.sorts = args;
    model._saveField(sortOpt, this, {
      async: false,
      hideTip: true
    });
  },
  /**
   * 插序 常用于sortable
   *
   * @method [移动] - _insertOrder
   * @param begin
   * @param end
   * @author wyj 15.9.26
   * @example
   *    this._insertOrder(1, 6);
   */
  _insertOrder: function (begin, end, callback) {
    if (begin < end) {
      end++;
    }
    BbaseEst.arrayInsert(this.collection.models, begin, end, {
      arrayExchange: BbaseEst.proxy(function (list, begin, end, opts) {
        this._exchangeOrder(begin, end, {
          path: this._options.sortField || 'sort',
          success: function (thisNode, nextNode) {
            if (thisNode.get('id') && nextNode.get('id')) {
              //this._saveSort(thisNode);
              //this._saveSort(nextNode);
              thisNode.stopCollapse = false;
              nextNode.stopCollapse = false;
            } else {
              debug('Error8 -> _insertOrder'); //debug__
            }
          }
        });
      }, this),
      callback: function (list) {
        if (callback) callback.call(this, list);
      }
    });
    this._resetDx();
  },
  /**
   * 交换位置
   *
   * @method [private] - _exchangeOrder
   * @param original_index
   * @param new_index
   * @param options
   * @return {BbaseList}
   * @private
   * @author wyj 14.12.5
   */
  _exchangeOrder: function (original_index, new_index, options) {
    var tempObj = {},
      nextObj = {};
    var temp = this.collection.at(original_index);
    var next = this.collection.at(new_index);

    // 互换dx
    if (temp.view && next.view) {
      var thisDx = temp.view.model.get('dx');
      var nextDx = next.view.model.get('dx');
      tempObj.dx = nextDx;
      nextObj.dx = thisDx;
    }
    // 互换sort值
    if (options.path) {
      var thisValue = temp.view.model.get(options.path);
      var nextValue = next.view.model.get(options.path);
      tempObj[options.path] = nextValue;
      nextObj[options.path] = thisValue;
    }
    temp.view.model.stopCollapse = true;
    next.view.model.stopCollapse = true;
    // 交换model
    this.collection.models[new_index] = this.collection.models.splice(original_index, 1, this.collection.models[new_index])[0];
    temp.view._set(tempObj);
    next.view._set(nextObj);

    // 交换位置
    if (original_index < new_index) {
      temp.view.$el.before(next.view.$el).removeClass('hover');
    } else {
      temp.view.$el.after(next.view.$el).removeClass('hover');
    }
    if (temp.view.$el.hasClass('bui-grid-row-even')) {
      temp.view.$el.removeClass('bui-grid-row-even');
      next.view.$el.addClass('bui-grid-row-even');
    } else {
      temp.view.$el.addClass('bui-grid-row-even');
      next.view.$el.removeClass('bui-grid-row-even');
    }
    if (options.success) {
      options.success.call(this, temp, next);
    }
    return this;
  },
  /**
   * 上移, 默认以sort为字段进行上移操作， 如果字段不为sort， 则需重载并设置options
   *
   * @method [移动] - _moveUp ( 上移 )
   * @param model
   * @author wyj 14.12.4
   * @example
   *      BbaseApp.getView('attributesList')._setOption({
   *        sortField: 'orderList'
   *      })._moveUp(this.model);
   */
  _moveUp: function (model) {
    var ctx = this;
    var first = this.collection.indexOf(model);
    var last, parentId;
    var result = [];
    if (this._options.subRender) {
      parentId = model.get(this._options.parentId);
      this.collection.each(function (thisModel) {
        if (parentId === thisModel.get(ctx._options.parentId)) {
          result.push(thisModel);
        }
      });
      //TODO 找出下一个元素的索引值
      var thisDx = BbaseEst.findIndex(result, function (item) {
        return item.get('id') === model.get('id');
      });
      if (thisDx === 0) return;
      last = this.collection.indexOf(result[thisDx - 1]);
    } else {
      if (first === 0) return;
      last = first - 1;
    }
    //model.stopCollapse = true;
    this._exchangeOrder(first, last, {
      path: this._options.sortField || 'sort',
      success: function (thisNode, nextNode) {
        if (thisNode.get('id') && nextNode.get('id')) {
          //this._saveSort(thisNode);
          //this._saveSort(nextNode);
          this._saveSorts(thisNode, {
            ids: thisNode.get('id') + ',' + nextNode.get('id'),
            sorts: thisNode.get(this._options.sortField || 'sort') + ',' +
              nextNode.get(this._options.sortField || 'sort')
          });
          thisNode.stopCollapse = false;
          nextNode.stopCollapse = false;
        } else {
          debug('Error8 -> _moveUp'); //debug__
        }
      }
    });
  },
  /**
   * 下移
   *
   * @method [移动] - _moveDown ( 下移 )
   * @param model
   * @author wyj 14.12.4
   */
  _moveDown: function (model) {
    var ctx = this;
    var first = this.collection.indexOf(model);
    var last, parentId;
    var result = [];
    if (this._options.subRender) {
      parentId = model.get(ctx._options.parentId);
      this.collection.each(function (thisModel) {
        if (parentId === thisModel.get(ctx._options.parentId)) {
          result.push(thisModel);
        }
      });
      //TODO 找出上一个元素的索引值
      var thisDx = BbaseEst.findIndex(result, function (item) {
        return item.get('id') === model.get('id');
      });
      if (thisDx === result.length - 1) return;
      last = this.collection.indexOf(result[thisDx + 1]);
    } else {
      if (first === this.collection.models.length - 1) return;
      last = first + 1;
    }
    //model.stopCollapse = true;
    this._exchangeOrder(first, last, {
      path: this._options.sortField,
      success: function (thisNode, nextNode) {
        if (thisNode.get('id') && nextNode.get('id')) {
          //this._saveSort(thisNode);
          //this._saveSort(nextNode);
          this._saveSorts(thisNode, {
            ids: thisNode.get('id') + ',' + nextNode.get('id'),
            sorts: thisNode.get(this._options.sortField || 'sort') + ',' +
              nextNode.get(this._options.sortField || 'sort')
          });
          thisNode.stopCollapse = false;
          nextNode.stopCollapse = false;
        } else {
          debug('Error8 -> _moveDown'); //debug__
        }
      }
    });
  },
  /**
   *  获取checkbox选中项所有ID值列表
   *
   * @method [选取] - _getCheckedIds ( 获取checkbox选中项所有ID值列表 )
   * @return {*}
   * @author wyj 14.12.8
   * @example
   *      this._getCheckedIds(); => ['id1', 'id2', 'id3', ...]
   */
  _getCheckedIds: function (field) {
    return BbaseEst.pluck(this._getCheckedItems(), BbaseEst.isEmpty(field) ? 'id' : ('attributes.' + field));
  },
  __filter: function (item) {
    return item.attributes.checked;
  },
  /**
   *  获取checkbox选中项
   *
   * @method [选取] - _getCheckedItems ( 获取checkbox选中项 )
   * @return {*}
   * @author wyj 14.12.8
   * @example
   *      this._getCheckedItems(); => [{model}, {model}, {model}, ...]
   *      this._getCheckedItems(true); => [{item}, {item}, {item}, ...]
   */
  _getCheckedItems: function (pluck) {
    return pluck ? BbaseEst.chain(this.collection.models).filter(this.__filter).pluck('attributes').value() :
      BbaseEst.chain(this.collection.models).filter(this.__filter).value();
  },
  /**
   * 转换成[{key: '', value: ''}, ... ] 数组格式 并返回 （频繁调用存在性能问题）
   *
   * @method [集合] - _getItems ( 获取所有列表项 )
   * @author wyj 15.1.15
   * @example
   *      BbaseApp.getView('productList').getItems();
   */
  _getItems: function (options) {
    return BbaseEst.map(this.collection.models, function (model) {
      return model.toJSON(options);
    });
  },
  /**
   * 获取集合中某个元素
   *
   * @method [集合] - getItem ( 获取集合中某个元素 )
   * @param index
   * @return {*}
   * @author wyj 15.5.22
   */
  _getItem: function (index) {
    var list = this._getItems();
    index = index || 0;
    if (list.length > index) return list[index];
    return null;
  },
  /**
   * 向集合末尾添加元素
   *
   * @method [集合] - _add ( 向集合末尾添加元素 )
   * @author wyj 15.1.15
   * @example
   *      BbaseApp.getView('productList')._add(new model());
   */
  _add: function (model) {
    this.collection.push(model);
  },
  /**
   * 批量删除， 隐藏等基础接口
   *
   * @method [批量] - _batch ( 批量删除 )
   * @param options [url: 批量请求地址] [tip: 操作成功后的消息提示]
   * @author wyj 14.12.14
   * @example
   *        this._batch({
                url: ctx.collection.batchDel,
                tip: '删除成功'
              });
   *
   */
  _batch: function (options) {
    var ctx = this;
    options = BbaseEst.extend({
      tip: CONST.LANG.SUCCESS + '！'
    }, options);
    this.checkboxIds = this._getCheckedIds(options.field || 'id');
    if (this.checkboxIds.length === 0) {
      BbaseUtils.tip(CONST.LANG.SELECT_ONE + '！');
      return;
    }
    if (options.url) {
      $.ajax({
        type: 'POST',
        async: false,
        url: options.url,
        data: {
          ids: ctx.checkboxIds.join(',')
        },
        success: function (result) {
          if (!result.success) {
            BbaseUtils.tip(result.msg);
          } else
            BbaseUtils.tip(options.tip);
          ctx._load();
          BbaseEst.trigger(ctx.cid + 'models', null, true);
          if (options.callback)
            options.callback.call(ctx, result);
        }
      });
    } else {
      BbaseEst.each(this._getCheckedItems(), function (item) {
        item.destroy();
      });
      BbaseEst.trigger(ctx.cid + 'models', null, true);
      if (options.callback)
        options.callback.call(ctx);
    }

  },
  /**
   * 批量删除
   *
   * @method [批量] - _batchDel ( 批量删除 )
   * @param options
   * @author wyj 14.12.14
   * @example
   *      this._batchDel({
   *        url: CONST.API + '/message/batch/del',
   *        field: 'id',
   *      });
   */
  _batchDel: function (options, callback) {
    var ctx = this;
    var url = null;
    var field = 'id';
    var $target = this._getEventTarget(options);
    // options 为 event
    if ($target.size() > 0) {
      url = $target.attr('data-url');
      field = $target.attr('data-field') || 'id';
    } else {
      url = options.url;
      id = options.id || 'id';
    }

    this.checkboxIds = this._getCheckedIds(field);
    if (this.checkboxIds && this.checkboxIds.length === 0) {
      BbaseUtils.tip(CONST.LANG.SELECT_ONE);
      return;
    }
    BbaseUtils.confirm({
      success: function () {
        ctx._batch({
          url: url,
          field: field,
          tip: CONST.LANG.DEL_SUCCESS,
          callback: callback
        });
      }
    });
  },
  /**
   * 使所有的checkbox初始化为未选择状态
   *
   * @method [选取] - _clearChecked ( 所有选取设置为未选择状态 )
   * @author wyj 14.12.14
   * @example
   *      this._clearChecked();
   */
  _clearChecked: function (focus) {
    BbaseEst.each(this.collection.models, function (model) {
      if ((!BbaseEst.equal(model._previousAttributes.checked, model.attributes.checked) || focus) && model.view) {
        model.attributes.checked = false;
        BbaseEst.trigger(model.view.cid + 'checked', 'checked', true);
      }
    });
  },
  _getPage: function () {
    return this.collection.paginationModel.get('page');
  },
  _setPage: function (page) {
    this.collection.paginationModel.set('page', page);
  },
  _getTotalPage: function () {
    return this._getCount() % this._getPageSize() == 0 ? this._getCount() / this._getPageSize() : Math.floor(this._getCount() / this._getPageSize()) + 1;
  },
  _getCount: function () {
    return this.collection.paginationModel.get('count');
  },
  _setCount: function (count) {
    this.collection.paginationModel.set('count', count);
  },
  _getPageSize: function () {
    return this.collection.paginationModel.get('pageSize');
  },
  _setPageSize: function (pageSize) {
    this.collection.paginationModel.set('pageSize', pageSize);
  },
  _getLength: function () {
    return this.collection.models.length;
  }
});

/**
 * @description 单视图
 *
 *  - el: 目标元素Id 如 "#jhw-main"
 *  - tagName: 'tr',
 *  - className: 'bui-grid-row',
 *  - events: {
 *     'click .btn-del': '_del', // 删除
       'click .btn-move-up': '_moveUp', // 上移
       'click .btn-move-down': '_moveDown', // 下移
       'click .btn-toggle': '_check',// 全选按钮
       'change .input-sort': '_saveSort', // 保存sort字段
       'click .btn-more': '_more', // 更多
 *  }，
 *  - initialize: function(){this._render()}
 *  - render: function(){this._render()}
 *
 * @class BbaseItem - 单视图
 * @author yongjin<zjut_wyj@163.com> 2014/12/8
 */

var BbaseItem = BbaseSuperView.extend({
  /**
   * 初始化, 若该视图的子元素有hover选择符， 则自动为其添加鼠标经过显示隐藏事件
   *
   * @method [初始化] - _initialize ( 初始化 )
   * @param {Object} options [template: 模板字符串]
   * @author wyj 14.11.16
   * @example
   *        this._initialize({
       *            template: itemTemp, // 模板字符串
       *            // 可选
       *            modelBind: false, // 绑定模型类， 比如文本框内容改变， 模型类相应改变; 当元素为checkbox是， 需设置true-value="01" false-value="00",
       *            若不设置默认为true/false
       *            detail: '#/product', // 详细页面路由  如果不是以dialog形式弹出时 ， 此项不能少 , 且开头为“#/”  需配置路由如： BbaseApp.addRoute('product/:id', function (id) {
                            productDetail(BbaseEst.decodeId(id, 'Product_', 32));
                            }); 如果需要弹出对话框， 则route为具体的详细页模块 如：ProductDetail
                    encodeUrl: false, // 是否缩减url    如： #/product/Product_000000000000000000099 =>> #/product/99  路由中需解码：BbaseEst.decodeId(id, 'Product_', 32)
       *            filter: function(model){ // 过滤模型类
       *            },
       *            beforeRender: function(model){},
       *            afterRender: function(model){},
       *            enterRender: '#submit' // 执行回车后的按钮点击的元素选择符
       *        });
   */
  _initialize: function(options) {
    this._initOptions(options);
    this._initCollapse(this.model.get('_options'));
    this._initTemplate(this._options);
    this._initBind(this._options);
    this._initView(this._options);
    this._initStyle(this._options);
    this._initEnterEvent(this._options);
  },
  /**
   * 初始化参数
   *
   * @method [private] - _initOptions
   * @private
   * @author wyj 15.1.12
   */
  _initOptions: function(options) {
    this._options = BbaseEst.extend(this.options, options || {});
    this._options.speed = this._options.speed || 9;
    this.viewId = this._options.viewId;
    this.viewType = 'item';
  },
  /**
   * 初始化展开收缩
   *
   * @method [private] - _initCollapse
   * @param options
   * @private
   * @author wyj 15.2.14
   */
  _initCollapse: function(options) {
    if (options._speed > 1) {
      this.model.stopCollapse = false;
      this.collapsed = options ? options._extend : false;
    }
  },
  /**
   * 初始化模板， 若传递一个Template模板字符中进来， 则渲染页面
   *
   * @method [private] - _initTemplate
   * @private
   * @author wyj 15.1.12
   */
  _initTemplate: function(options) {
    options.template = this.template || options.template || options.itemTemp;
    if (options.template) {
      this.$template = '<div>' + options.template + '</div>';
      if (options.viewId) {
        if (!BbaseApp.getCompileTemp(options.viewId)) {
          BbaseApp.addCompileTemp(options.viewId, BbaseHandlebars.compile(this._parseHbs(options.template)));
        }
      } else {
        this.hbstemplate = BbaseHandlebars.compile(this._parseHbs(options.template));
      }
    }
  },
  /**
   * 绑定事件， 如添加事件， 重置事件
   *
   * @method [private] - _initBind
   * @private
   * @author wyj 14.11.16
   */
  _initBind: function(options) {
    if (options.speed > 1) {
      this.model.bind('reset', this.render, this);
      this.model.bind('change', this.render, this);
      this.model.bind('destroy', this.remove, this);
    }
  },
  /**
   * 初始化视图
   *
   * @method [private] - _initView
   * @param options
   * @private
   * @author wyj 15.2.14
   */
  _initView: function(options) {
    if (options.speed > 1) {
      if (this.model.view) this.model.view.remove();
      this.model.view = this;
    }
  },
  /**
   * 初始化样式
   *
   * @method [private] - _initStyle
   * @private
   * @author wyj 15.2.14
   */
  _initStyle: function(options) {
    if (options.speed > 1) {
      var item_id = this._get('id') ? (this._get('id') + '') : (this._get('dx') + 1 + '');
      if (this._get('dx') % 2 === 0) this.$el.addClass('bui-grid-row-even');
      this.$el.addClass('_item_el_' + (this.viewId || '') + '_' + item_id.replace(/^[^1-9]+/, ""));
      if (this.$el.hover) {
        this.$el.hover(function() {
          $(this).addClass('hover');
        }, function() {
          $(this).removeClass('hover');
        });
      }
    }
  },
  /**
   * 渲染
   *
   * @method [渲染] - _render ( 渲染 )
   * @return {BbaseCollection}
   * @author wyj 14.11.18
   */
  _render: function() {
    this._onBeforeRender();
    if (this._options && this._options.filter){
      var fresult = this._options.filter.call(this, this.model);
      if (typeof fresult !== 'undefined' && !fresult){
        this.$el.remove();
        return ;
      }
    }
    // 添加判断是否存在this.$el
    this._beforeTransition();
    this.$el.html(this.hbstemplate ? this.hbstemplate(this.model.attributes) :
      this.viewId && BbaseApp.getCompileTemp(this.viewId) && BbaseApp.getCompileTemp(this.viewId)(this.model.attributes));
    this._onAfterRender();
    // 判断是否存在子元素
    var modelOptions = this._get('_options');
    if (modelOptions && modelOptions._subRender && this._get('children') &&

      this._get('children').length > 0) {
      // Build child views, insert and render each
      var ctx = this;
      var childView = null;
      var level = this._get('level') || 1;

      var tree = this.$(modelOptions._subRender + ':first');
      this._setupEvents(modelOptions);

      BbaseEst.each(this.model._getChildren(modelOptions._collection), function(newmodel) {
        var childView = null;

        newmodel.set('_options', modelOptions);
        newmodel.set('level', level + 1);

        childView = new modelOptions._item({
          model: newmodel,
          data: ctx._options._data
        });
        childView._setInitModel(ctx.initModel);
        childView._setViewId(ctx._options.viewId);
        //TODO 解决子类下的移序问题
        newmodel.view = childView;

        tree.append(childView.$el);
        if (ctx._options.views) {
          ctx._options.views.push(childView);
        }
        childView._render();
      });
      /* Apply some extra styling to views with children */
      if (childView) {
        // Add bootstrap plus/minus icon
        //this.$('> .node-collapse').prepend($('<i class="icon-plus"/>'));
        // Fixup css on last item to improve look of tree
        //childView.$el.addClass('last-item').before($('<li/>').addClass('dummy-item'));
      }
    }

    return this;
  },
  /**
   * 设置viewId
   *
   * @method [参数] - _setViewId ( 设置viewId )
   * @param name
   * @private
   * @author wyj 14.12.20
   */
  _setViewId: function(name) {
    if (this._options) this._options.viewId = this.viewId = name;
  },
  /**
   * 设置模型类
   *
   * @method [private] - _setInitModel
   * @private
   * @param model
   * @author wyj 14.11.20
   */
  _setInitModel: function(model) {
    this.initModel = model;
  },
  /**
   * 绑定展开收缩事件
   *
   * @method [private] - _setupEvents
   * @private
   * @author wyj 14.12.9
   */
  _setupEvents: function(opts) {
    // Hack to get around event delegation not supporting ">" selector
    var that = this;
    that._toggleCollapse.call(this, opts);
    this.$(opts._collapse + ':first').click(function() {
      that._toggleCollapse.call(that, opts);
    });
  },
  /**
   * 展开收缩
   *
   * @method [private] - _toggleCollapse
   * @private
   * @author wyj 14.12.9
   */
  _toggleCollapse: function(opts) {
    var ctx = this;
    if (this.model.stopCollapse) {
      this.$(opts._subRender + ':first').addClass('hide');
      return;
    }
    ctx.collapsed = !ctx.collapsed;

    if (ctx.collapsed) {
      this.$(opts._collapse + ':first').removeClass('x-caret-down');
      this.$(opts._subRender + ':first').slideUp(CONST.COLLAPSE_SPEED).addClass('hide');
    } else {
      this.$(opts._collapse + ':first').addClass('x-caret-down');
      this.$(opts._subRender + ':first').slideDown(CONST.COLLAPSE_SPEED).removeClass('hide');
    }
  },
  /**
   * 渲染前事件
   *
   * @method [private] - _onBeforeRender
   * @private
   * @author wyj 14.12.3
   */
  _onBeforeRender: function() {
    if (this._initDefault) this._initDefault.call(this);
    if (this.beforeRender) this.beforeRender.call(this, this.model);
  },
  /**
   * 渲染后事件
   *
   * @method [private] - _onAfterRender
   * @private
   * @author wyj 14.12.3
   */
  _onAfterRender: function() {
    if (this._options.modelBind) setTimeout(this._bind(function() {
      this._modelBind();
    }), 0);
    if (this._options.toolTip) setTimeout(this._bind(function() {
      this._initToolTip();
    }), 0);
    if (this.afterRender) setTimeout(this._bind(function() {
      this.afterRender.call(this, this.model);
    }), 0);
    if (this._watchBind) setTimeout(this._bind(function() {
      this._watchBind.call(this, this._options.template);
    }), 0);
    if (this._bbBind) setTimeout(this._bind(function() {
      this._bbBind.call(this, this._options.template, this.$el);
    }), 0);

    this._ready_component_ = true;
  },
  /**
   * 移除监听
   *
   * @method [private] - _close
   * @private
   * @author wyj 14.11.16
   */
  _close: function() {
    this.stopListening();
  },
  /**
   * 移除此模型
   *
   * @method [private] - _clear
   * @private
   * @author wyj 14.11.16
   */
  _clear: function() {
    this.model.destroy();
  },
  /**
   * checkbox选择框转换
   *
   * @method [选取] - _check ( checkbox选择框转换 )
   * @author wyj 14.11.16
   * @example
   *      itemClick: function(e){
   *        e.stopImmediatePropagation();
   *        this.loadPhoto();
   *        this._check(e);
   *      }
   */
  _check: function(e) {
    var checked = this._get('checked');
    var beginDx = null;
    var endDx = null;
    var dx = null;
    var checked_all = true;

    this._checkAppend = typeof this._get('_options')._checkAppend === 'undefined' ? false :
      this._get('_options')._checkAppend;
    this._checkToggle = typeof this._get('_options')._checkToggle === 'undefined' ? false :
      this._get('_options')._checkToggle;

    // 单选， 清除选中项
    if (!this._checkAppend) {
      if (this.viewId) {
        if (BbaseApp.getView(this.viewId))
          BbaseApp.getView(this.viewId)._clearChecked();
      }
    }

    if (this._checkToggle) {
      this._set('checked', BbaseEst.typeOf(e) === 'boolean' ? e : !checked);
    } else {
      this._set('checked', BbaseEst.typeOf(e) === 'boolean' ? e : true);
      this._itemActive({
        add: this._checkAppend
      }, e);
    }
    if (this._get('checked') && this._checkToggle) {
      this._itemActive({
        add: this._checkAppend
      }, e);
    } else if (this._checkToggle) {
      this.$el.removeClass('item-active');
      this._set('checked', false);
    }
    //TODO shift + 多选
    if (e && e.shiftKey && this._checkAppend) {
      beginDx = BbaseApp.getData('curChecked');
      endDx = this._get('dx');
      BbaseEst.each(this.model.collection.models, function(model) {
        dx = model.get('dx');
        if (beginDx < dx && dx < endDx) {
          model.view._set('checked', true);
          model.view.$el.addClass('item-active');
        }
      });
    } else {
      BbaseApp.addData('curChecked', this._get('dx'));
    }
    //TODO 如果
    if (BbaseEst.typeOf(e) !== 'boolean' && e)
    //e.stopImmediatePropagation();
      BbaseEst.trigger(this.cid + 'checked', 'checked', true);
    if (!this._get('checked')) {
      checked_all = false;
    } else {
      BbaseEst.each(this.model.collection.models, function(model) {
        if (!model.attributes.checked) {
          checked_all = false;
        }
      });
    }
    if (BbaseApp.getView(this.viewId))
      BbaseApp.getView(this.viewId)._set('checked_all',checked_all);
  },
  /**
   * 添加当前ITEM的CLASS为item-active
   *
   * @method [选取] - _itemActive ( 设置为选中状态 )
   * @param options [add: true 是否为添加模式]
   * @author wyj 14.12.13
   * @example
   *        this._itemActive({
   *          add: true         //是否为添加模式
   *        });
   */
  _itemActive: function(options, e) {
    var _class = null;
    options = options || {};
    if (!BbaseApp.getData('itemActiveList' + this.viewId))
      BbaseApp.addData('itemActiveList' + this.viewId, []);
    var list = BbaseApp.getData('itemActiveList' + this.viewId);
    if (!options.add) {
      BbaseEst.each(list, BbaseEst.proxy(function(selecter) {
        $('.' + selecter, BbaseApp.getView(this.viewId) ?
          BbaseApp.getView(this.viewId).$el : $("body")).removeClass('item-active');
      }, this));
      list.length = 0;
    }
    if (BbaseEst.typeOf(e) === 'boolean' && !e) return;
    this.$el.addClass('item-active');

    _class = this.$el.attr('class').replace(/^.*(_item_el_.+?)\s+.*$/g, "$1");
    if (BbaseEst.findIndex(list, function(item) {
        return item === _class;
      }) === -1) {
      list.push(_class);
    }
  },
  /**
   * 上移
   *
   * @method [移动] - _moveUp ( 上移 )
   * @param e
   * @author wyj 14.12.14
   */
  _moveUp: function(e) {
    e.stopImmediatePropagation();
    this.collapsed = true;
    if (!this.viewId) {
      return false;
    }
    BbaseApp.getView(this.viewId)._moveUp(this.model);
  },
  /**
   * 下移
   *
   * @method [移动] - _moveDown ( 下移 )
   * @param e
   * @author wyj 14.12.14
   */
  _moveDown: function(e) {
    e.stopImmediatePropagation();
    this.collapsed = true;
    if (!this.viewId) {
      return false;
    }
    BbaseApp.getView(this.viewId)._moveDown(this.model);
  },
  /**
   * 保存sort排序
   *
   * @method [保存] - _saveSort ( 保存sort排序 )
   * @author wyj 14.12.14
   */
  _saveSort: function() {
    var ctx = this;
    var sort = this.$('.input-sort').val();
    this.model._saveField({
      id: this._get('id'),
      sort: sort
    }, ctx, {
      success: function() {
        ctx.model.set('sort', sort);
      },
      fail: function() {

      },
      hideTip: true
    });
  },
  /**
   * 保存模型类
   * @method _save
   * @return {[type]} [description]
   */
  _save: function() {
    if (this.model.attributes._response) delete this.model.attributes._response;
    if (this.beforeSave) this.beforeSave.call(this);
    BbaseEst.off('errorSave' + this.model.cid).on('errorSave' + this.model.cid, this._bind(function(type, response) {
      if (this.errorSave) this.errorSave.call(this, response);
    }));
    var response = this.model.save({}, {
      silent: this._options.diff,
      wait: true
    });
    if (this.afterSave) this.afterSave.call(this, response);
  },
  /**
   * 获取当前列表第几页
   *
   * @method [分页] - _getPage ( 获取当前列表第几页 )
   * @return {*}
   * @author wyj 14.12.31
   *
   */
  _getPage: function() {
    var paginationModel = this.model.collection.paginationModel;
    if (!paginationModel) return 1;
    return paginationModel.get('page');
  },
  /**
   *  删除模型类
   *
   *  @method [删除] - _del ( 删除模型类 )
   *  @author wyj 14.11.16
   */
  _del: function(e, callback) {
    if (e)
      e.stopImmediatePropagation();
    var context = this;
    if (BbaseApp.getData('delItemDialog')) BbaseApp.getData('delItemDialog').close();
    if (context.model.get('children').length > 0) {
      BbaseUtils.confirm({
        title: CONST.LANG.TIP,
        width: 300,
        content: CONST.LANG.DEL_TIP
      });
      return;
    }
    BbaseApp.addData('delItemDialog', BbaseUtils.confirm({
      title: null,
      content: '<div class="item-delete-confirm">' + CONST.LANG.DEL_CONFIRM + '</div>',
      target: e && this._getTarget(e).get(0),
      success: function(resp) {
        if (BbaseEst.isEmpty(context.model.url())) {
          context.model.attributes.id = null;
        }
        context.model.destroy({
          wait: true,
          error: function(model, resp) {
            var buttons = [];
            buttons.push({
              value: CONST.LANG.CONFIRM,
              callback: function() {
                this.close();
              },
              autofocus: true
            });
            BbaseUtils.dialog({
              title: CONST.LANG.TIP + '：',
              content: resp.msg,
              width: 250,
              button: buttons
            });
          },
          success: function(model, response, xhr) {
            context._removeFromItems(context.model.get('dx'));
            if (context.model.deleteTip) {
              BbaseUtils.tip(response.msg);
            }
            if (callback) callback.call(context);
          }
        });
      }
    }));
  },
  /**
   * 直接移除，不提示
   * @method _remove
   * @param  {[type]}   e        [description]
   * @param  {Function} callback [description]
   * @return {[type]}            [description]
   */
  _remove: function(e, callback) {
    this.model.destroy({
      wait: true,
      success: this._bind(function() {
        this._removeFromItems(this.model.get('dx'));
        if (callback) callback.call(this);
      })
    });
  },
  /**
   * 从this._options.items中通过dx移除元素
   * @method [集合] - _removeFromItems
   * @param dx
   * @private
   * @author wyj 15.6.10
   * @example
   *      this._removeFromItems(context.model.get('dx'));
   */
  _removeFromItems: function(dx) {
    BbaseEst.trigger(this._super('view').cid + 'models', null, true);
    if (BbaseEst.typeOf(dx) === 'undefined') return;
    if (BbaseApp.getView(this.viewId)) {
      if (BbaseApp.getView(this.viewId)._options.items){
        if (!BbaseApp.getView(this.viewId)._options.diff){
          BbaseApp.getView(this.viewId)._options.items.splice(dx, 1);
        }
      }
      BbaseApp.getView(this.viewId)._resetDx();
    }
  }
});

/**
 * @description 基础集合类
 *
 * - url: CONST.API + '/product/list', // 如果是function形式构建的时候，记得带上page 与pageSize; // 可选
 * - batchDel: CONST.API + '/product/batch/del', // 可选
 * - model: ProductModel,
 * - initialize: function(){this._initialize();} // 可选
 *
 * @classb BbaseCollection 集合类
 * @author yongjin<zjut_wyj@163.com> 2014/11/6
 */

var BbasePaginationModel = BbaseBackbone.Model.extend({
  defaults: {
    page: 1,
    pageSize: 16,
    count: 0
  },
  initialize: function() {}
});

var BbaseCollection = BbaseBackbone.Collection.extend({
  //localStorage: new BbaseBackbone.LocalStorage('base-collection'),
  /**
   * 传递options进来
   *
   * @method [private] - constructor
   * @private
   * @param options
   * @author wyj 14.12.16
   */
  constructor: function(options) {
    this.options = options || {};
    BbaseBackbone.Collection.apply(this, [null, arguments]);
  },
  /**
   * 调用父类方法
   * @method [构造] - _super
   * @return {[type]} [description]
   */
  _super: function(type, args) {
    if (BbaseEst.typeOf(type) === 'object') {
      this._initialize(type);
    } else {
      switch (type) {
        case 'data':
          if (BbaseApp.getView(this.options.viewId)) {
            return BbaseApp.getView(this.options.viewId).model.toJSON();
          } else {
            return this.options.data;
          }
          break;
        case 'model':
          if (BbaseApp.getView(this.options.viewId)) {
            return BbaseApp.getView(this.options.viewId).model;
          } else {
            var model = this.model;
            return new model(this.options.data);
          }
          break;
        case 'view':
          return BbaseApp.getView(this.options.viewId);
        default:
          if (BbaseApp.getView(this.options.viewId)[type]) BbaseApp.getView(this.options.viewId)[type](args);
          return this;
      }
    }
  },
  /**
   * 初始化
   *
   * @method [初始化] - _initialize ( 初始化 )
   * @author wyj 14.11.16
   * @example
   initialize: function () {
                this._initialize();
              }
   */
  _initialize: function() {
    this._baseUrl = this.url;
    this.__params = this.__params || {};
    if (!this.paginationModel) {
      this.paginationModel = new BbasePaginationModel({
        page: this.options.page || 1,
        pageSize: this.options.pageSize || 16
      });
    }
  },
  initialize: function() {
    this._initialize();
  },
  /**
   * 处理url 与 分页
   *
   * @method [private] - _parse (  )
   * @private
   * @param resp
   * @param xhr
   * @return {attributes.data|*}
   * @author wyj 14.11.16
   */
  parse: function(resp, xhr) {
    var ctx = this;
    if (BbaseEst.isEmpty(resp)) {
      return [];
    }
    if (!resp.success && resp.msg) {
      if (resp.msgType === "notLogin" && !BbaseEst.isEmpty(this.url)) {
        BbaseEst.trigger('checkLogin', null, true);
      }
      else if (resp.msgType === "nopriv" && CONST.NO_PRIV){
        if (CONST.NO_PRIV.indexOf('#/') > -1){
          ctx._navigate(CONST.NO_PRIV, true);
        }else{
          window.location.href=CONST.NO_PRIV;
        }
      }
       else{
        BbaseUtils.tip(resp.msg, { zIndex: 5000 });
      }
    }
    this._parsePagination(resp);
    this._parseUrl(this.paginationModel);
    //TODO this.options.pagination 防止被其它无分页的列表覆盖
    if (this.options.pagination && this.paginationModel) {
      this._paginationRender();
    }
    return resp.attributes.data;
  },
  /**
   * 处理url地址， 加上分页参数
   *
   * @method [private] - _parseUrl (  )
   * @private
   * @param model
   * @author wyj 14.11.16
   */
  _parseUrl: function(model) {
    var page = 1,
      pageSize = 16;
    if (model && model.get('pageSize')) {
      pageSize = model.get('pageSize');
      page = model.get('page');
    }
    if (this.options.subRender) {
      page = 1;
      pageSize = 9000;
    }
    if (typeof this.url !== 'function') {
      var end = '';
      if (!BbaseEst.isEmpty(this._itemId)) end = '/' + this._itemId;
      this.url = this._baseUrl + end + '?page=' + page + '&pageSize=' + pageSize + this._getParams();
    }
  },
  /**
   * 设置请求参数
   * @method _setParam
   *
   * @param {[type]} name  [description]
   * @param {[type]} value [description]
   */
  _setParam: function(name, value) {
    this.__params[name] = value;
    this._parseUrl(this.paginationModel);
  },
  /**
   * 获取请求参数
   * @param  {[type]} name [description]
   * @return {[type]}      [description]
   */
  _getParam: function (name) {
    return this.__params[name];
  },
  /**
   * 拼装请求参数
   * @method _getParams
   *
   * @return {[type]} [description]
   */
  _getParams: function() {
    var result = '';
    BbaseEst.each(this.__params, function(val, key) {
      result += ('&' + key + '=' + val);
    }, this);
    return result;
  },
  /**
   * 设置分页模型类
   *
   * @method [private] - _parsePagination
   * @private
   * @param resp
   * @author wyj 14.11.16
   */
  _parsePagination: function(resp) {
    resp.attributes = resp.attributes || {
      page: 1,
      per_page: 10,
      count: 10
    };
    if (this.paginationModel) {
      this.paginationModel.set('page', resp.attributes.page || 1);
      this.paginationModel.set('pageSize', resp.attributes.per_page || 16);
      this.paginationModel.set('count', resp.attributes.count || 1);
    }
  },
  /**
   * 渲染分页
   *
   * @method [private] - _paginationRender
   * @private
   * @author wyj 14.11.16
   */
  _paginationRender: function() {
    seajs.use(['BbasePagination'], BbaseEst.proxy(function(Pagination) {
      if (!Pagination) return;
      if (!this.pagination) {
        var $el = $(this.options.el);
        var isStr = BbaseEst.typeOf(this.options.pagination) === 'string';
        var _$el = $(!isStr ? "#pagination-container" :
          this.options.pagination, $el.size() > 0 ? $el : $('body'));
        if (isStr) {
          this.paginationModel.set('numLength', parseInt(_$el.attr('data-numLength') || 7, 10));
        }
        this.pagination = new Pagination({
          el: _$el,
          model: this.paginationModel
        });
      } else {
        this.pagination.render();
      }
    }, this));
  },
  /**
   * 加载列表
   *
   * @method [集合] - _load ( 加载列表 )
   * @param instance 实例对象
   * @param context 上下文
   * @param model 模型类
   * @return {ln.promise} 返回promise
   * @author wyj 14.11.15
   * @example
   *      if (this.collection.url){
   *             this.collection._load(this.collection, this, model)
   *                 .then(function(result){
   *                     resolve(result);
   *                 });
   *         }
   */
  _load: function(instance, context, model) {
    this._parseUrl(model);
    return instance.fetch({
      success: function() {
        if (!context.options.diff) context._empty();
      },
      cacheData: this.options.cache,
      session: this.options.session
    });
  },
  /**
   * 设置itemId
   *
   * @method [分类] - _setItemId ( 设置itemId )
   * @param itemId
   * @author wyj 14.12.16
   * @example
   *        this._setItemId('Category00000000000000000032');
   */
  _setItemId: function(itemId) {
    this._itemId = itemId;
  },
  /**
   * 设置列表
   * @method _set
   * @param {[type]} list [description]
   */
  _set: function(list) {
    return this._super('view')._setModels(list);
  },
  /**
   * 清空列表
   *
   * @method [集合] - _empty ( 清空列表 )
   * @author wyj 14.11.15
   */
  _empty: function() {
    if (this.collection) {
      var len = this.collection.length;
      while (len > -1) {
        this.collection.remove(this.collection[len]);
        len--;
      }
      BbaseEst.trigger(this._super('view').cid + 'models', null, true)
    }
  },
  _getPage: function () {
    return this.paginationModel.get('page');
  },
  _setPage: function (page) {
    this.paginationModel.set('page', page);
  },
  _getTotalPage: function () {
    return this._getCount() % this._getPageSize() == 0 ? this._getCount() / this._getPageSize() : Math.floor(this._getCount() / this._getPageSize()) + 1;
  },
  _getCount: function () {
    return this.paginationModel.get('count');
  },
  _setCount: function (count) {
    this.paginationModel.set('count', count);
  },
  _getPageSize: function () {
    return this.paginationModel.get('pageSize');
  },
  _setPageSize: function (pageSize) {
    this.paginationModel.set('pageSize', pageSize);
  }
});

/**
 * @description 模型类
 *
 *    - initialize (可选) 实现父类_initialize // 可选
 *    - defaults (可选) 默认值  如 BbaseEst.extend({}, BbaseModel.prototype.defaults);
 *    - baseId (可选) ID标识符 如 productId
 *    - baseUrl (可选) 服务器交互地址 // 可选
 *    - params (可选) 附加参数 如  mobile=true&type=01 // 可选
 *    - validate (可选) 当需要实现单个字段保存时， 需要调用父类_validation, 参照ProductModel
 *
 * @class BbaseModel - 模型类
 * @author yongjin<zjut_wyj@163.com> 2014/11/10
 */


var BbaseModel = BbaseBackbone.Model.extend({
  defaults: { checked: false, checked_all: false, load_completed: false, result_none: false, children: [] },
  baseId: '',
  /**
   * 初始化请求连接, 判断是否为新对象， 否自动加上ID
   *
   * @method [private] - url
   * @private
   * @return {*}
   * @author wyj 14.11.16
   */
  url: function() {
    var base = this.baseUrl;
    var _url = '';
    if (!base) return '';
    if (BbaseEst.typeOf(base) === 'function')
      base = base.call(this);
    this.params = this.params ? this.params + this._getParams(): this._getParams();
    var sep = BbaseEst.isEmpty(this.params) ? '' : '?';
    if (this.isNew() && BbaseEst.isEmpty(this.id)) return base + sep + this.params;
    _url = base + (base.charAt(base.length - 1) == '/' ? '' : '/') + this.id + sep + this.params;
    return _url;
  },
  /**
   * 模型类初始化
   *
   * @method [初始化] - _initialize ( 初始化 )
   * @author wyj 14.11.16
   * @example
   *      this._initialize();
   */
  _initialize: function(options) {
    this.validateMsg = null;
    this.__params = this.__params || {};
  },
  /**
   * 过滤结果, 并提示信息对话框, 若不想提示信息可以设置hideTip为true
   *
   * step 1:
   *  当服务器有返回msg消息 并参数设置hideTip为false时  弹出提示信息
   *  成功保存后 当为添加元素时 添加“继续添加”按钮， 点击继续添加按钮， 重新设置id为null, baseId为null, 使其变为新对象
   *  当参数hideOkBtn为false时添加 “确定”按钮， 当点击按钮地， 触发_dialog_submit_callback事件， 关闭_dialog对话框，
   *  关闭当前消息对话框， 当文档中存在btn-back按钮时， 返回列表页面
   * step 2:
   *  当success为false时， 直接返回服务器错误的response信息
   * step 3:
   *  处理data数据， 并把data数据赋值到response对象上
   * step 4:
   *  设置backbone 模型类里的id值， 默认不选中， 设置时间戳
   *
   * this.model.hideTip = true; // 无提示信息弹出框
   * this.model.hideOkBtn = true; // 隐藏保存按钮
   * this.model.hideAddBtn = true; // 隐藏继续添加按钮
   * this.model.autoHide = true; // 自动隐藏提示信息
   * this.model.autoBack = true; // 保存成功后自动返回列表页面
   * this.model.stopCheckLogin = true; // 取消登录判断
   *
   * @method [private] - parse
   * @param response
   * @param options
   * @return {*}
   * @author wyj 14.11.16
   */
  parse: function(response, options) {
    var ctx = this,
      buttons = [],
      _isNew = false;
    if ('msg' in response) BbaseUtils.removeLoading();
    if (BbaseEst.isEmpty(response)) {
      var url = BbaseEst.typeOf(this.url) === 'function' ? this.url() : this.url;
      BbaseUtils.tip(CONST.LANG.REQUIRE_FAILED);
      return false;
    }
    if (response && response.msg && response.msg === CONST.LANG.AUTH_FAILED) {
      BbaseUtils.tip(CONST.LANG.AUTH_LIMIT, { time: 2000 });
    }
    if (response.msgType === 'notLogin' && !this.stopCheckLogin) {
      BbaseEst.trigger('checkLogin', null, true);
    }
    else if (response.msgType === "nopriv" && CONST.NO_PRIV){
        if (CONST.NO_PRIV.indexOf('#/') > -1){
          ctx._navigate(CONST.NO_PRIV, true);
        }else{
          window.location.href=CONST.NO_PRIV;
        }
      }
    // 当服务器有返回msg消息 并参数设置hideTip为false时  弹出提示信息
    // 成功保存后 当为添加元素时 添加“继续添加”按钮， 点击继续添加按钮， 重新设置id为null, baseId为null, 使其变为新对象
    // 当参数hideOkBtn为false时添加 “确定”按钮， 当点击按钮地， 触发_dialog_submit_callback事件， 关闭_dialog对话框，
    // 关闭当前消息对话框， 当文档中存在btn-back按钮时， 返回列表页面
    if (response.msg && !this.hideTip) {
      if (response.success) {
        if (ctx.isNew() && this.continueAdd) {
          buttons.push({
            value: CONST.LANG.ADD_CONTINUE,
            callback: function() {
              ctx.set('id', null);
              ctx.set(ctx.baseId, null);
            }
          });
          _isNew = true;
        }
      }
      if (this.saveTip) {
        buttons.push({
          value: CONST.LANG.CONFIRM,
          callback: function() {
            this.close();
          },
          autofocus: true
        });
      }
      if (buttons.length > 0) {
        var dialog_msg = BbaseUtils.dialog({
          id: 'dialog_msg',
          title: CONST.LANG.TIP,
          content: '<div style="padding: 20px;">' + response.msg + '</div>',
          width: 250,
          button: buttons
        });
        if (!this.continueAdd) {
          setTimeout(function() {
            BbaseApp.getDialog('dialog_msg') && (ctx.autoHide || !_isNew) &&
              BbaseApp.getDialog('dialog_msg').close().remove();
          }, 2000);
        }
      }
    }
    // 当success为false时， 直接返回服务器错误的response信息
    if (BbaseEst.typeOf(response.success) === 'boolean' && !response.success) {
      ctx.attributes._response = response;
      BbaseEst.trigger('errorSave' + ctx.cid, response, true);
      return ctx.attributes;
    }
    // 处理data数据， 并把data数据赋值到response对象上
    if (response.attributes && response.attributes.data) {
      var keys = BbaseEst.keys(response.attributes);
      if (keys.length > 1) {
        BbaseEst.each(keys, function(item) {
          if (item !== 'data')
            response.attributes['data'][item] = response.attributes[item];
        });
      }
      response = response.attributes.data;
    }
    // 设置backbone 模型类里的id值， 默认不选中， 设置时间戳
    if (response) {
      response.id = response[ctx.baseId || 'id'];
      response.checked = false;
      response.time = new Date().getTime();
    }
    return response;
  },
  /**
   * 保存模型类
   *
   * @method [保存] - _saveField ( 保存模型类 )
   * @param keyValue
   * @param ctx
   * @param options [success: 成功回调][async: 是否异步]
   * @author wyj 14.11.16
   * @example
   *        this.model._saveField({
   *          id: thisNode.get('id'),
   *          sort: thisNode.get('sort')
   *        }, ctx, { // ctx须初始化initModel
   *          success: function(){}, // 保存成功回调
   *          async: false, // 是否同步
   *          hideTip: false // 是否隐藏提示
   *          hideOkBtn: false // 是否隐藏确定按钮
   *        });
   */
  _saveField: function(keyValue, ctx, options) {
    var wait = options.async || true;
    var newModel = new ctx.initModel({
      id: keyValue.id || ctx.model.get('id')
    });
    newModel.clear();
    newModel.set(keyValue);
    newModel.set('silent', true);
    if (options.hideTip) newModel.hideTip = true;
    newModel.hideOkBtn = true;
    newModel.set('editField', true);
    if (newModel.baseUrl) {
      newModel.save(null, {
        success: function(model, result) {
          if (result.msgType === 'notLogin' && !this.stopCheckLogin) {
            BbaseEst.trigger('checkLogin', null, true);
          }
          if (typeof options.success != 'undefined') {
            options.success && options.success.call(ctx, keyValue, result);
          }
        },
        wait: wait
      });
    } else {
      options.success && options.success.call(ctx, keyValue, {});
    }
  },
  /**
   * 获取子模型
   *
   * @method [private] - _getChildren
   * @private
   * @return {*}
   * @author wyj 14.12.18
   */
  _getChildren: function(collection) {
    return BbaseEst.map(this.get('children'), function(ref) {
      // Lookup by ID in parent collection if string/num
      if (typeof(ref) == 'string' || typeof(ref) == 'number')
        return collection.get(ref);
      // Else assume its a real object
      return ref;
    });
  },
  /**
   * 隐藏保存后的提示对话框
   *
   * @method [对话框] - _hideTip ( 隐藏提示对话框 )
   * @author wyj 15.1.29
   * @example
   *      this.model._hideTip();
   */
  _hideTip: function() {
    this.hideTip = true;
  },
  /**
   * 设置checkbox选择框状态
   *
   * @method [选取] - _toggle ( 设置checkbox选择框状态 )
   * @author wyj 14.11.16
   * @example
   *      this.model._toggle();
   */
  _toggle: function() {
    this.set('checked', !this.get('checked'));
  },
  /**
   * 预处理验证， 若模型类里有silent=true字段，则取消验证
   *
   * @method [验证] - _validate ( 预处理验证 )
   * @param attributes
   * @param callback
   * @author wyj 14.11.21
   * @example
   *        validate: function (attrs) {
   *          return this._validation(attrs, function (attrs) {
   *            if (!attrs.sort || attrs.sort < 0) {
   *            this.validateMsg = "sort不能为空";
   *          }
   *         });
   *        }
   */
  _validation: function(attributes, callback) {
    if (!attributes.silent && callback) {
      callback.call(this, attributes);
    }
    return this.validateMsg;
  },
  /**
   * 获取model值
   *
   * @method [获取] - _getValue ( 获取model值 )
   * @param path
   * @author wyj 15.1.30
   * @example
   *      this._getValue('tip.name');
   */
  _getValue: function(path) {
    return BbaseEst.getValue(this.attributes, path);
  },
  /**
   * 设置model值
   *
   * @method [设置] - _setValue ( 设置model值 )
   * @param path
   * @param val
   * @author wyj 15.1.30
   * @example
   *      this._setValue('tip.name', 'aaa');
   */
  _setValue: function(path, val) {
    BbaseEst.setValue(this.attributes, path, val);
  },
  /**
   * 设置模型类值
   * @method _set
   * @param {[type]} path [description]
   * @param {[type]} val  [description]
   */
  _set: function(path, val) {
    return this.view ? this.view._set(path, val) : this._setValue(path, val);
  },
  /**
   * 获取模型类值
   * @method _get
   * @param  {[type]} path [description]
   * @return {[type]}      [description]
   */
  _get: function(path) {
    return this.view ? this.view._get(path) : this._getValue(path);
  },
  /**
   * 获取整型值
   * @method _getInt
   * @param  {[type]} path [description]
   * @return {[type]}      [description]
   */
  _getInt: function(path) {
    return parseInt(this._get(path), 10);
  },
  /**
   * 获取浮点型数值
   * @method _getFloat
   * @param  {[type]} path [description]
   * @return {[type]}      [description]
   */
  _getFloat: function(path) {
    return parseFloat(this._get(path), 10);
  },
    /**
   * 设置请求参数
   * @method _setParam
   *
   * @param {[type]} name  [description]
   * @param {[type]} value [description]
   */
  _setParam: function (name, value) {
    this.__params[name] = value;
  },
  /**
   * 获取请求参数
   * @param  {[type]} name [description]
   * @return {[type]}      [description]
   */
  _getParam: function (name) {
    return this.__params[name];
  },
  /**
   * 拼装请求参数
   * @method _getParams
   *
   * @return {[type]} [description]
   */
  _getParams: function () {
    var result = '';
    BbaseEst.each(this.__params, function (val, key) {
      result += ('&' + key + '=' + val);
    }, this);
    return result;
  },
  initialize: function() {
    this._initialize();
  }
});

/**
 * @description BbaseDetail
 * @class BbaseDetail - 详细页面
 * @author yongjin<zjut_wyj@163.com> 2014.11.12
 */

var BbaseDetail = BbaseSuperView.extend({
  /**
   * 初始化
   *
   * @method [初始化] - _initialize ( 初始化 )
   * @param options
   * @author wyj 14.11.20
   * @example
   *      this._initialize({
       *         template : template, // 字符串模板
       *         model: ProductModel, // 模型类
       *         // 可选
       *         hideSaveBtn: true, // 保存成功后的弹出提示框中是否隐藏保存按钮
       *         hideOkBtn: true, // 保存成功后的弹出提示框中是否隐藏确定按钮
       *         autoHide: true, // 保存成功后是否自动隐藏提示对话框
       *         enterRender: '#submit' // 执行回车后的按钮点击的元素选择符
       *         modelBind: true, // 表单元素与模型类 双向绑定
       *         toolTip: true, // 是否显示title提示框   html代码： <div class="tool-tip" title="提示内容">内容</div>
       *         id: ctx.model.get('id'), // 当不是以dialog形式打开的时候， 需要传递ID值
                 page: ctx._getPage() // 点击返回按钮且需要定位到第几页时， 传入page值，
                 data: {} // 附加数据  获取方法为  _data.name
       *      });
   */
  _initialize: function (options) {
    this._initOptions(options);
    this._initTemplate(this._options);
    this._initList(this._options);
    this._initModel(options.model, this);
    this._initEnterEvent(this._options);
  },
  /**
   * 初始化参数
   *
   * @method [private] - _initOptions
   * @private
   * @author wyj 15.1.12
   */
  _initOptions: function (options) {
    this._options = BbaseEst.extend(this.options, options || {});
    this._options.speed = this._options.speed || 9;
    this.viewId = this._options.viewId;
    this.viewType = 'detail';
  },
  /**
   * 初始化模板， 若传递一个Template模板字符中进来， 则渲染页面
   *
   * @method [private] - _initTemplate
   * @private
   * @author wyj 15.1.12
   */
  _initTemplate: function (options) {
    this._data = options.data = options.data || {};
    if (options.template) {
      this.template = BbaseHandlebars.compile(this._parseHbs(options.template));
      this.$template = '<div>' + options.template + '</div>';
      //this.$el.append(this.template(options.data));
    }
    return this._data;
  },
  /**
   * 初始化列表视图容器
   *
   * @method [private] - _initList
   * @private
   * @author wyj 15.1.12
   */
  _initList: function (options) {
    var ctx = this;
    this.list = options.render ? this.$(options.render) : this.$el;
    if (this.list.size() === 0)
      this.list = $(options.render);
    return this.list;
  },
  /**
   * 渲染
   *
   * @method [渲染] - _render ( 渲染 )
   * @author wyj 14.11.20
   * @example
   *        this._render();
   */
  _render: function () {
    if (this.beforeRender) this.beforeRender.call(this, this._options);
    if (!this._options.append) this.list.empty();

    this.list.append(this.template(this.model.attributes));

    if (this._options.modelBind) setTimeout(this._bind(function () {
      this._modelBind();
    }), 0);
    if (window.topDialog) this.$('.form-actions').hide();
    if (this._watchBind) setTimeout(this._bind(function () {
      this._watchBind.call(this, this._options.template);
    }), 0);
    if (this._bbBind) setTimeout(this._bind(function () {
      this._bbBind.call(this, this._options.template, this.$el);
    }), 0);
    if (this.afterRender) setTimeout(this._bind(function () {
      this.afterRender.call(this, this._options);
    }), 0);
    if (this._options.onReady) setTimeout(this._bind(function () {
      this._options.onReady.call(this, this._options);
    }), 0);
    if (this._options.toolTip) setTimeout(this._bind(function () {
      this._initToolTip();
    }), 0);
    if (this._options.form) {
      this._formList = this._options.form.split(':');
      this._form(this._formList[0])._initSubmit({
        beforeSave: this.beforeSave,
        afterSave: this.afterSave
      }, this._formList.length > 1 ? this._formList[1] : null);
    }

    this._ready_component_ = true;

    BbaseUtils.removeLoading();
  },
  /**
   * 初始化模型类 将自动判断是否有ID传递进来，
   * 若存在则从服务器端获取详细内容
   * 若为添加， 则在ctx 与模型类里设置 _isAdd = true
   *
   * @method [private] - _initModel
   * @private
   * @param model
   * @param ctx
   * @author wyj 14.11.15
   */
  _initModel: function (model, ctx) {
    this._options.id = BbaseEst.typeOf(this._options.id) === 'number' ? this._options.id + '' : this._options.id;
    this._options.data.id = BbaseEst.typeOf(this._options.data.id) === 'number' ? this._options.data.id + '' : this._options.data.id;
    ctx.passId = this.options.id || this._options.data.id || BbaseEst.getUrlParam('id', window.location.href);

    if (!BbaseEst.isEmpty(this.passId)) {
      ctx.model = new model();
      ctx.model.set('id', ctx.passId);
      ctx.model.set('_data', ctx._options.data);
      ctx.model.set('CONST', CONST);
      if (ctx._initDefault) ctx._initDefault.call(this);
      if (ctx.beforeLoad) ctx.beforeLoad.call(this);
      ctx.model.fetch().done(function (response) {
        if (response.msgType === 'notLogin') {
          BbaseEst.trigger('checkLogin', null, true);
        }
        if (!response.success) {
          if (ctx.errorFetch) {
            ctx.errorFetch.call(ctx, response);
          }
        }
        ctx._attributes = response.attributes;
        ctx.model.set('_isAdd', ctx._isAdd = false);
        if (ctx.afterLoad) ctx.afterLoad.call(ctx, response);
        ctx.render();
      });
    } else {
      ctx.passId = new Date().getTime();
      ctx.model = new model(this._options.data || {});
      ctx.model.set('_data', ctx._options.data);
      ctx.model.set('_isAdd', ctx._isAdd = true);
      if (ctx._initDefault) ctx._initDefault.call(this);
      ctx.render();
    }

    if (this._options.hideOkBtn) ctx.model.hideOkBtn = true;
    if (this._options.hideSaveBtn) ctx.model.hideSaveBtn = true;
    if (this._options.autoHide) ctx.model.autoHide = true;

  },
  /**
   * form包装器， 传递表单选择符
   *
   * @method [表单] - _form ( form包装器 )
   * @param {String} formSelector 选择器
   * @return {BbaseDetail}
   * @author wyj on 14.11.15
   * @example
   *        this._form('#J_Form')._validate()._initSubmit({
   *          beforeSave: function(){
   *            // 处理特殊字段
   *            this.model.set('taglist', BbaseEst.map(ctx.tagInstance.collection.models, function (item) {
   *              return item.get('name');
   *            }).join(','));
   *          },
   *          afterSave : function(response){
   *             if(response.attributes.success == false ){
   *                ctx.refreshCode();
   *                return true;
   *             }
   *            BbaseUtils.tip('请验证邮箱后再登录!');
   *            window.location.href = '/member/modules/login/login.html';
   *          }
   *        });
   */
  _form: function (formSelector) {
    this.formSelector = formSelector;
    this.formElemnet = this.$(this.formSelector);
    return this;
  },
  /**
   * 启用表单验证
   *
   * @method [表单] - _validate ( 表单验证 )
   * @return {BbaseDetail}
   * @param options [url: 远程验证地址][fields{Array}: 字段名称]
   * @author wyj 14.11.15
   * @example
   *        this._form('#J_Form')._validate({
   *            url: CONST.API + '/user/validate',
   *            fields: ['vali-username', 'vali-email'] // 注意， 字段前加vali-
   *        });
   */
  _validate: function (options) {
    return this;
  },
  /**
   * 绑定提交按钮
   *
   * @method [表单] - _init ( 绑定提交按钮 )
   * @param options [beforeSave: 保存前方法] [afterSave: 保存后方法]
   * @author wyj 14.11.15
   * @example
   *        this._form()._validate()._initSubmit({
   *            beforeSave: function(){},
   *            afterSave: function(){},
   *            onErrorSave: function(){}
   *        });
   *
   *
   *        <input id="model-music.custom" name="music.custom" value="{{music.custom}}" type="text" class="input-large">
   *
   */
  _initSubmit: function (options, selector) {
    var ctx = this,
      passed = true,
      modelObj = {},
      isPassed = true;

    options = options || {};
    $(selector || '#submit', this.$el).on('click', function () {
      var $button = $(this);
      var bt = $button.is('input');
      var preText = ctx.preText = bt ? $button.val() : $button.html();
      passed = true; // 设置验证通过
      try {
        ctx.formElemnet.submit();
      } catch (e) {

      }
      $("input, textarea, select", $(ctx.formElemnet)).each(function () {
        var name, val, pass, modelKey, modelList;
        name = $(this).attr('name');
        if ($(this).hasClass('bui-form-field-error')) {
          passed = false;
        }
        var modelId = $(this).attr('id');
        if (modelId && modelId.indexOf('model') !== -1) {
          switch (this.type) {
            case 'radio':
              val = $(this).is(":checked") ? $(this).val() : pass = true;
              break;
            case 'checkbox':
              val = $(this).is(':checked') ? (BbaseEst.isEmpty($(this).attr('true-value')) ? true : $(this).attr('true-value')) :
                (BbaseEst.isEmpty($(this).attr('false-value')) ? false : $(this).attr('false-value'));
              break;
            default:
              val = $(this).val();
              break;
          }
          if (!pass) {
            modelKey = modelId.replace(/^model\d?-(.+)$/g, "$1");
            modelList = modelKey.split('.');
            if (modelList.length > 1) {
              try {
                if (!ctx.model.attributes[modelList[0]]) {
                  ctx.model.attributes[modelList[0]] = {};
                }
                BbaseEst.setValue(ctx.model.attributes, modelKey, val);
              } catch (e) {
                debug('Error18 -> _initSubmit -> ' + e); //debug__
              }
              //ctx.model.set(modelList[0], modelObj[modelList[0]]);
            } else {
              ctx.model.set(modelList[0], val);
            }
          }
        }
      });
      if (passed) {
        if (typeof options.beforeSave !== 'undefined')
          isPassed = options.beforeSave.call(ctx);
        if (BbaseEst.typeOf(isPassed) !== 'undefined' && !isPassed) return false;
        if (bt) {
          $button.val(CONST.LANG.SUBMIT);
        } else {
          $button.html(CONST.LANG.SUBMIT);
        }
        $button.prop('disabled', true);

        if (!BbaseEst.isEmpty(ctx.model.url())) ctx._save(function (response) {
          if (options.afterSave) {
            options.afterSave = BbaseEst.inject(options.afterSave, function (response) {
              return new BbaseEst.setArguments(arguments);
            }, function (response) {
              if (bt) {
                $button.val(preText);
              } else {
                $button.html(preText);
              }
              $button.prop('disabled', false);
            });
            options.afterSave.call(ctx, response, BbaseEst.typeOf(response) === 'string' ? { msg: null, msgType: null, success: true } : BbaseEst.typeOf(BbaseEst.getValue(response, 'attributes._response.success')) === 'boolean' ?
              BbaseEst.getValue(response, 'attributes._response') : { msg: null, msgType: null, success: true });
          }
          $button.html(preText);
        }, function (response) {
          if (response.msgType === 'notLogin') {
            BbaseEst.trigger('checkLogin', null, true);
          }
          if (ctx.errorSave) ctx.errorSave.call(ctx, response);
          if (options.onErrorSave) options.onErrorSave.call(ctx, response);
        });
        setTimeout(function () {
          $button.html(preText);
          $button.prop('disabled', false);
        }, 5000);
      }
      return false;
    });
  },
  /**
   * 保存结果
   *
   * @method [private] - _save
   * @private
   * @author wyj 14.11.18
   */
  _save: function (callback, error) {
    this._saveItem(callback, error);
  },
  /**
   * 保存表单
   *
   * @method [private] - _saveItem
   * @private
   * @param callback
   * @param context
   * @author wyj 14.11.15
   */
  _saveItem: function (callback, error) {
    if (BbaseEst.isEmpty(this.model.url())) {
      return;
    }
    if (this.model.attributes._response) {
      delete this.model.attributes._response;
    }

    BbaseEst.off('errorSave' + this.model.cid).on('errorSave' + this.model.cid, this._bind(function (type, response) {
      if (this.errorSave) this.errorSave.call(this, response);
    }));

    this.model.save(null, {
      wait: true,
      success: function (response) {
        BbaseApp.addModel(BbaseEst.cloneDeep(response.attributes));
        try {
          if (top && top.model) {
            top.model = response.attributes;
          }
        } catch (e) {}
        if (callback && typeof callback === 'function')
          callback.call(this, response);
      },
      error: function (model, XMLHttpRequest, errorThrown) {
        if (XMLHttpRequest.status === 200) {
          callback.call(this, XMLHttpRequest.responseText);
        } else if (error && typeof error === 'function')
          error.call(this, XMLHttpRequest, model, errorThrown);
      }
    });
  },
  /**
   * 清空视图， 并移除所有绑定的事件
   *
   * @method [渲染] - _empty ( 清空视图 )
   * @author wyj 14.11.16
   * @example
   *      this._empty();
   */
  _empty: function () {
    this.model.off();
    this.$el.empty().off();
  }
});

window.BbaseModel = BbaseModel;
window.BbaseCollection = BbaseCollection;
window.BbaseItem = BbaseItem;
window.BbaseDetail = BbaseDetail;
window.BbaseList = BbaseList;
window.BbaseService = BbaseService;
window.BbaseView = BbaseView;
window.BbaseUtils = BbaseUtils;
window.BbaseHandlebars = BbaseHandlebars;
// bb-disabled="models.length"
BbaseApp.addDirective('disabled', {

  bind: function (value, selector) {
    // 为某个字段绑定监听
    this._watch([this._getField(value)], selector + ':disabled');
    // 设置是否失效
    this.$(selector).prop('disabled', this._getBoolean(value));
    // 返回一个编译模板
    // 当没有返回compile时， 系统自动会加上以这个指令的表达式为字符串的模板引擎
    return {
      compile: BbaseEst.compile('{{' + value + '}}')
    }
  },

  // 绑定的字段变化时回调
  update: function (name, node, selector, result) {
    node.prop('disabled', this._getBoolean(result));
  }

});

// bb-src="{{PIC pic_path 120}}"  或 bb-src="pic_path"
BbaseApp.addDirective('src', {

  bind: function (value, selector) {
    var isHbs = false,
      result = '';

    // 判断是否是handlebar模板
    if (value.indexOf('{{') > -1) {
      isHbs = true;
      result = BbaseHandlebars.compile(value)(this.model.attributes);
    } else {
      result = BbaseEst.compile('{{' + value + '}}', this.model.attributes);
    }
    // 替换handlebars编译后的$amp;转译内容
    result = result.replace(/&amp;/img, '&').replace(/\\/img, '/');
    var $node = this.$('[bb-src="' + result + '"]').eq(0);
    if ($node.size() === 0) {
      $node = this.$('[bb-src="' + value + '"]').eq(0);
    }
    $node.attr('src', result);
    $node.attr('bb-src', value);
    $node.addClass('directive_' + BbaseEst.hash('[bb-src="' + value + '"]'));

    // 注意，watch中的选择符必需跟实际dom中的选择符一致
    this._watch([this._getField(value)], '[bb-src="' + value + '"]' + ':src');
  },

  update: function (name, node, selector, result) {
    node.attr('src', result);
  }
});
if (typeof Bbase !== 'undefined') {
  BbaseEst.each(Bbase.DIRECTIVE, function (val, key) {
    BbaseApp.addDirective(key, val);
  });
}

var status = {};
if (typeof app !== 'undefined' && app.getAllStatus){
  status = app.getAllStatus();
} else if (typeof STATUS !== 'undefined'){
  status = STATUS;
}
BbaseEst.each(status, function (val, key) {
  BbaseHandlebars.registerHelper(key, function (str, options) {
    var result = '';
    if (BbaseEst.isEmpty(options)) {
      return this[key];
    }
    BbaseEst.each(val, function (item) {
      if (item.value === str) {
        result = BbaseEst.isEmpty(item.html) ? item.text : item.html;
        return false;
      }
    });
    return result;
  });
});

  module.exports = window.BbaseApp;
});